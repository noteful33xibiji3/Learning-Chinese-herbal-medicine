<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿç‰ˆå¾Œå° | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .form-container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 80px; }
        .required::after { content: " *"; color: red; }
        
        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .img-upload-box { border: 2px dashed #ddd; padding: 15px; border-radius: 8px; text-align: center; background: #fafafa; }
        .img-preview { max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 5px; display: none; margin-left: auto; margin-right: auto; }
        .file-info { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .size-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .size-badge.ok { color: green; background: #e8f5e9; }
        .size-badge.warn { color: orange; background: #fff3e0; }
        .size-badge.bad { color: red; background: #ffebee; }

        /* è¨­å®šå€èˆ‡è¼‰å…¥å€ */
        .panel { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .panel h4 { margin-top: 0; margin-bottom: 10px; color: #555; }
        .api-settings { display: none; background: #333; color: white; }
        .api-settings.show { display: block; }
        .api-settings input { background: #555; border: none; color: white; margin-bottom: 10px; }
        .toggle-btn { text-align: right; font-size: 0.8rem; color: #666; cursor: pointer; margin-bottom: 5px; text-decoration: underline; }
        
        /* æœå°‹çµæœ */
        .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; display: none; margin-top: 5px; background: white; position: absolute; width: 88%; z-index: 10; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .search-item:hover { background: #f0f0f0; }
        .search-wrapper { position: relative; }

        #status-msg { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; text-align: center; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #cce5ff; color: #004085; }
    </style>
</head>
<body>
    <nav>
        <div class="logo">ğŸ“± æ‰‹æ©Ÿå¾Œå°</div>
        <ul class="menu">
            <li><a href="index.html">å›å‰å°</a></li>
        </ul>
    </nav>

    <main>
        <div class="form-container">
            <div class="toggle-btn" onclick="toggleSettings()">âš™ï¸ è¨­å®š GitHub é€£ç·š</div>
            <div id="settings-panel" class="panel api-settings">
                <h4>GitHub é€£ç·šè¨­å®š</h4>
                <input type="text" id="gh_owner" placeholder="Owner (e.g. yourname)">
                <input type="text" id="gh_repo" placeholder="Repo (e.g. tcm-learning)">
                <input type="password" id="gh_token" placeholder="Token (ghp_...)">
                <button class="btn-secondary" onclick="saveSettings()" style="width:100%">å„²å­˜è¨­å®š</button>
            </div>

            <div class="panel" style="border-left: 5px solid var(--primary);">
                <h4>ğŸ” æœå°‹ä¸¦ä¿®æ”¹èˆŠè³‡æ–™</h4>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="loadHerbsFromGitHub()" id="load-btn" style="white-space: nowrap;">ğŸ“¥ è¼‰å…¥è³‡æ–™åº«</button>
                    <div class="search-wrapper" style="flex-grow: 1;">
                        <input type="text" id="edit-search" placeholder="è¼‰å…¥å¾Œåœ¨æ­¤æœå°‹..." disabled oninput="searchLocalHerbs(this.value)">
                        <div id="search-results" class="search-results"></div>
                    </div>
                </div>
            </div>

            <h2>ğŸ“ ç·¨è¼¯ / æ–°å¢ä¸­è—¥</h2>
            
            <div class="form-group">
                <label class="required">ä¸­è—¥å (æª”åè­˜åˆ¥)</label>
                <input type="text" id="cname" placeholder="ä¾‹å¦‚ï¼šé»ƒé€£">
            </div>

            <div class="form-group">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡ (é¸å¡«)</label>
                <div class="img-upload-box">
                    <input type="file" id="img-input" accept="image/*" onchange="processImage()">
                    
                    <div style="margin-top:10px; display:flex; gap:10px; justify-content: center;">
                        <select id="img-quality" onchange="processImage()" style="width:auto; padding:5px;">
                            <option value="0.7">è‡ªå‹•å£“ç¸® (æ¨è–¦, <500KB)</option>
                            <option value="1.0">ä¿æŒåŸåœ– (æ…ç”¨)</option>
                        </select>
                    </div>

                    <div id="file-info" class="file-info"></div>
                    <img id="preview" class="img-preview">
                    <input type="hidden" id="current-image-path">
                    <input type="hidden" id="upload-base64">
                </div>
            </div>

            <div class="form-group" style="background:#f9f9f9; padding:10px; border-radius:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥å­¸åˆ†é¡</label>
                <div style="display:flex; gap:10px; flex-direction: column;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å…ˆé¸å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å†é¸å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <div class="form-group"><label class="required">ç§‘å</label><input type="text" id="family"></div>
            <div class="form-group"><label>å­¸å / åŸºåŸ</label><input type="text" id="latin"></div>
            <div class="form-group"><label>è—¥ç”¨éƒ¨ä½</label><input type="text" id="part"></div>
            <div class="form-group"><label>ä¸»è¦æˆåˆ†</label><input type="text" id="chemistry"></div>
            <div class="form-group"><label>åŠŸæ•ˆ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="effects"></div>
            <div class="form-group"><label>ä¸»æ²» / ç­†è¨˜</label><textarea id="indication"></textarea></div>
            <div class="form-group"><label>å¹´ç´š</label><select id="grade"><option value="å¤§ä¸€">å¤§ä¸€</option><option value="å¤§äºŒ">å¤§äºŒ</option><option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option><option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option><option value="å¤§ä¸‰">å¤§ä¸‰</option></select></div>

            <button class="btn-primary" onclick="handleSubmission()" style="width:100%; padding:15px; font-size:1.1rem;">ğŸš€ ä¸Šå‚³ä¸¦å„²å­˜</button>
            <div id="status-msg"></div>
        </div>
    </main>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let loadedHerbs = [];
        const categories = {
            "é…ç³–é«”": { "en": "Glycosides", "subs": [{"zh":"å¼·å¿ƒé…é†£é«”"}, {"zh":"è”¥é†Œé¡é…é†£é«”"}, {"zh":"çš‚ç´ é…é†£é«”"}, {"zh":"æ°°è‹·é…é†£é«”"}, {"zh":"ç•°ç¡«æ°°é…é†£é«”"}, {"zh":"é†‡é¡é…é†£é«”"}, {"zh":"é†›é¡é…é†£é«”"}, {"zh":"é…šé¡é…é†£é«”"}, {"zh":"å…¶ä»–é…é†£é«”"}] },
            "ç”Ÿç‰©é¹¼": { "en": "Alkaloids", "subs": [{"zh":"å¡å•¶-å“Œå•¶é¡"}, {"zh":"æ‰˜çƒ·é¡"}, {"zh":"å–¹å•‰é¡"}, {"zh":"ç•°å–¹å•‰é¡"}, {"zh":"å²å“šé¡"}, {"zh":"å’ªå”‘é¡"}, {"zh":"å˜Œå‘¤é¡"}, {"zh":"ç”¾é«”é¡"}, {"zh":"å…¶ä»–ç”Ÿç‰©é¹¼"}] },
            "å¤šé†£é¡": { "en": "Carbohydrates", "subs": [{"zh":"æ¾±ç²‰"}, {"zh":"æ¨¹è† "}, {"zh":"é»æ¶²è³ª"}, {"zh":"æœè† "}] },
            "è‹¯ä¸™çƒ·é¡": { "en": "Phenylpropanoids", "subs": [{"zh":"ç°¡å–®è‹¯ä¸™çƒ·é¡"}, {"zh":"é¦™è±†ç´ "}, {"zh":"æœ¨è³ªç´ "}] },
            "æœ¨é…šç´ ": { "en": "Lignans", "subs": [{"zh":"æœ¨é…šç´ "}, {"zh":"æ–°æœ¨é…šç´ "}] },
            "é¡é»ƒé…®": { "en": "Flavonoids", "subs": [{"zh":"é»ƒé…®é¡"}, {"zh":"é»ƒé…®é†‡é¡"}, {"zh":"ç•°é»ƒé…®é¡"}, {"zh":"èŠ±é’ç´ "}] },
            "é£è³ª": { "en": "Tannins", "subs": [{"zh":"æ°´è§£å‹é£è³ª"}, {"zh":"ç¸®åˆå‹é£è³ª"}] },
            "èœé¡": { "en": "Terpenoids", "subs": [{"zh":"å–®èœ"}, {"zh":"å€åŠèœ"}, {"zh":"äºŒèœ"}, {"zh":"ä¸‰èœ"}] },
            "æ®ç™¼æ²¹": { "en": "Volatile Oils", "subs": [{"zh":"å«æ°§å–®èœ"}, {"zh":"å€åŠèœé¡"}, {"zh":"èŠ³é¦™æ—"}] },
            "æ¨¹è„‚": { "en": "Resins", "subs": [{"zh":"æ²¹æ¨¹è„‚"}, {"zh":"è† æ¨¹è„‚"}, {"zh":"æ²¹è† æ¨¹è„‚"}, {"zh":"é¦™æ¨¹è„‚"}] },
            "è„‚è³ª": { "en": "Lipids", "subs": [{"zh":"è„‚è‚ªæ²¹"}, {"zh":"è Ÿ"}] }
        };

        const mainSelect = document.getElementById('chem_main');
        const subSelect = document.getElementById('chem_sub');

        // åˆå§‹åŒ–é¸å–®
        for (let key in categories) {
            let option = document.createElement("option");
            option.text = key; option.value = key;
            mainSelect.add(option);
        }

        // åˆå§‹åŒ–è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('gh_owner').value = localStorage.getItem('tcm_owner') || '';
            document.getElementById('gh_repo').value = localStorage.getItem('tcm_repo') || '';
            document.getElementById('gh_token').value = localStorage.getItem('tcm_token') || '';
            if(!localStorage.getItem('tcm_token')) toggleSettings();
        });

        // --- åŠŸèƒ½å‡½å¼ ---
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('show'); }
        function saveSettings() {
            localStorage.setItem('tcm_owner', document.getElementById('gh_owner').value.trim());
            localStorage.setItem('tcm_repo', document.getElementById('gh_repo').value.trim());
            localStorage.setItem('tcm_token', document.getElementById('gh_token').value.trim());
            alert('è¨­å®šå·²å„²å­˜ï¼'); toggleSettings();
        }

        function updateSubCats() {
            const selectedMain = mainSelect.value;
            subSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å­åˆ†é¡ --</option>';
            if (selectedMain && categories[selectedMain]) {
                const subList = categories[selectedMain].subs || [];
                subList.forEach(subObj => {
                    let option = document.createElement("option");
                    option.text = subObj.zh || subObj; option.value = subObj.zh || subObj;
                    subSelect.add(option);
                });
            }
        }

        // --- 1. è¼‰å…¥èˆ‡æœå°‹åŠŸèƒ½ ---
        async function loadHerbsFromGitHub() {
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');
            const token = localStorage.getItem('tcm_token');
            const btn = document.getElementById('load-btn');
            const searchInput = document.getElementById('edit-search');

            if (!owner || !repo || !token) { alert('è«‹å…ˆè¨­å®š GitHub é€£ç·šï¼'); return; }

            btn.innerText = 'â³ è¼‰å…¥ä¸­...'; btn.disabled = true;
            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/data/herbs.json`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } });
                const data = await res.json();
                const content = decodeURIComponent(escape(window.atob(data.content)));
                loadedHerbs = JSON.parse(content);

                btn.innerText = 'âœ… è¼‰å…¥æˆåŠŸ'; searchInput.disabled = false; searchInput.placeholder = `å·²è¼‰å…¥ ${loadedHerbs.length} ç­†è³‡æ–™...`;
            } catch (err) { alert('è¼‰å…¥å¤±æ•—'); btn.disabled = false; }
        }

        function searchLocalHerbs(keyword) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            if (!keyword) { resultsDiv.style.display = 'none'; return; }
            const matches = loadedHerbs.filter(h => h.chinese_name.includes(keyword));
            if (matches.length > 0) {
                resultsDiv.style.display = 'block';
                matches.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerText = `${h.chinese_name} (${h.grade})`;
                    div.onclick = () => fillForm(h);
                    resultsDiv.appendChild(div);
                });
            } else resultsDiv.style.display = 'none';
        }

        function fillForm(herb) {
            // å¡«å¯«æ–‡å­—æ¬„ä½
            document.getElementById('cname').value = herb.chinese_name;
            document.getElementById('family').value = herb.family || '';
            document.getElementById('latin').value = herb.latin_name || '';
            document.getElementById('part').value = herb.used_part || '';
            document.getElementById('chemistry').value = herb.chemistry || '';
            document.getElementById('effects').value = (herb.effects || []).join(', ');
            document.getElementById('indication').value = herb.indications || '';
            document.getElementById('grade').value = herb.grade || 'å¤§äºŒ';

            // è™•ç†åˆ†é¡é¸å–®
            if (herb.chem_main) {
                mainSelect.value = herb.chem_main;
                updateSubCats();
                if (herb.chem_sub) subSelect.value = herb.chem_sub;
            }

            // è™•ç†ç¾æœ‰åœ–ç‰‡ (é¡¯ç¤ºä½†ä¸é‡æ–°ä¸Šå‚³ï¼Œé™¤éä½¿ç”¨è€…é¸æ–°åœ–)
            if (herb.image) {
                document.getElementById('current-image-path').value = herb.image;
                document.getElementById('file-info').innerText = `ç›®å‰ä½¿ç”¨åœ–ç‰‡ï¼š${herb.image}`;
                // è‹¥æ˜¯ç›¸å°è·¯å¾‘ï¼Œé€™è£¡å¯èƒ½é è¦½ä¸åˆ°ï¼Œä½†åŠŸèƒ½æ˜¯æ­£å¸¸çš„
                document.getElementById('preview').src = herb.image; 
                document.getElementById('preview').style.display = 'block';
            } else {
                document.getElementById('current-image-path').value = "";
                document.getElementById('preview').style.display = 'none';
            }

            // æ¸…ç©ºä¸Šå‚³æš«å­˜
            document.getElementById('img-input').value = '';
            document.getElementById('upload-base64').value = '';

            document.getElementById('search-results').style.display = 'none';
            document.getElementById('edit-search').value = '';
        }

        // --- 2. åœ–ç‰‡å£“ç¸®åŠŸèƒ½ ---
        function processImage() {
            const fileInput = document.getElementById('img-input');
            const file = fileInput.files[0];
            if (!file) return;

            const quality = parseFloat(document.getElementById('img-quality').value);
            const preview = document.getElementById('preview');
            const info = document.getElementById('file-info');
            const hiddenBase64 = document.getElementById('upload-base64');

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function (event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_WIDTH = 1024; // é™åˆ¶æœ€å¤§å¯¬åº¦
                    if (width > MAX_WIDTH && quality < 1.0) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    preview.src = dataUrl; preview.style.display = 'block';
                    
                    const compressedSize = (Math.round((dataUrl.length - 22) * 3 / 4) / 1024).toFixed(1);
                    let badgeClass = compressedSize > 500 ? (compressedSize > 1000 ? 'bad' : 'warn') : 'ok';
                    info.innerHTML = `<span class="size-badge ${badgeClass}">ä¸Šå‚³å¤§å°: ${compressedSize} KB</span>`;
                    hiddenBase64.value = dataUrl.split(',')[1];
                };
            };
        }

        // --- 3. æäº¤èˆ‡ä¸Šå‚³ ---
        async function handleSubmission() {
            const msg = document.getElementById('status-msg');
            const cname = document.getElementById('cname').value.trim();
            const token = localStorage.getItem('tcm_token');
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');

            if(!cname) { alert('ä¸­è—¥åå¿…å¡«'); return; }
            msg.style.display = 'block'; msg.className = 'loading'; msg.innerText = 'â³ è™•ç†ä¸­...';

            try {
                // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦ä¸Šå‚³æ–°åœ–ç‰‡
                let imagePath = document.getElementById('current-image-path').value || "images/placeholder.jpg";
                const base64Image = document.getElementById('upload-base64').value;

                if (base64Image) {
                    msg.innerText = 'ğŸ“¸ æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...';
                    const fileName = `${Date.now()}_${cname}.jpg`; 
                    const imgUrl = `https://api.github.com/repos/${owner}/${repo}/contents/images/${fileName}`;
                    
                    const imgRes = await fetch(imgUrl, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Upload image for ${cname}`, content: base64Image })
                    });
                    if (!imgRes.ok) throw new Error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
                    imagePath = `images/${fileName}`;
                }

                // 2. æ›´æ–° JSON
                msg.innerText = 'ğŸ“„ æ­£åœ¨æ›´æ–°è³‡æ–™åº«...';
                await uploadJsonToGitHub(imagePath);

            } catch (error) {
                console.error(error);
                msg.className = 'error'; msg.innerText = `âŒ å¤±æ•—ï¼š${error.message}`;
            }
        }

        async function uploadJsonToGitHub(finalImagePath) {
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');
            const token = localStorage.getItem('tcm_token');
            const path = 'data/herbs.json'; 
            const msg = document.getElementById('status-msg');
            const cname = document.getElementById('cname').value.trim();

            // è®€å–é ç«¯æœ€æ–° JSON
            const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const getRes = await fetch(getUrl, { headers: { 'Authorization': `token ${token}` } });
            const fileData = await getRes.json();
            const content = decodeURIComponent(escape(window.atob(fileData.content)));
            let currentHerbs = JSON.parse(content);
            const fileSha = fileData.sha;

            // åˆ¤æ–·æ–°å¢æˆ–æ›´æ–°
            const existingIndex = currentHerbs.findIndex(h => h.chinese_name === cname);
            const inputEffects = document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);

            const newHerbData = {
                id: existingIndex !== -1 ? currentHerbs[existingIndex].id : Date.now(),
                chinese_name: cname,
                latin_name: document.getElementById('latin').value,
                family: document.getElementById('family').value,
                used_part: document.getElementById('part').value,
                chemistry: document.getElementById('chemistry').value,
                chem_main: document.getElementById('chem_main').value,
                chem_sub: document.getElementById('chem_sub').value,
                effects: inputEffects,
                indications: document.getElementById('indication').value,
                grade: document.getElementById('grade').value,
                image: finalImagePath, // ä½¿ç”¨æ–°çš„æˆ–èˆŠçš„åœ–ç‰‡è·¯å¾‘
                wrong_effects: existingIndex !== -1 ? currentHerbs[existingIndex].wrong_effects : []
            };

            let actionType = existingIndex !== -1 ? "æ›´æ–°" : "æ–°å¢";
            if (existingIndex !== -1) currentHerbs[existingIndex] = newHerbData;
            else currentHerbs.push(newHerbData);

            // ä¸Šå‚³ JSON
            const newContent = JSON.stringify(currentHerbs, null, 2);
            const encodedContent = window.btoa(unescape(encodeURIComponent(newContent)));

            const putRes = await fetch(getUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `${actionType} ${cname} via Mobile Admin`,
                    content: encodedContent,
                    sha: fileSha
                })
            });

            if (putRes.ok) {
                msg.className = 'success';
                msg.innerText = `âœ… æˆåŠŸ${actionType}ã€Œ${cname}ã€ï¼`;
                // æ›´æ–°æš«å­˜
                loadedHerbs = currentHerbs;
                
                // å¦‚æœæ˜¯æ–°å¢å®Œï¼Œæ¸…ç©ºè¡¨å–®ï¼›å¦‚æœæ˜¯æ›´æ–°å®Œï¼Œä¿ç•™ç•«é¢è®“ä½¿ç”¨è€…çŸ¥é“
                if(actionType === "æ–°å¢") {
                    document.querySelectorAll('input:not(#grade), textarea').forEach(el => el.value = '');
                    document.getElementById('preview').style.display = 'none';
                    document.getElementById('file-info').innerText = '';
                }
            } else throw new Error('è³‡æ–™åº«æ›´æ–°å¤±æ•—');
        }
    </script>
</body>
</html>
