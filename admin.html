<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ± | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        /* === æ¨£å¼å€ (ä¿ç•™åŸæ¨£) === */
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); margin-bottom: 20px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #4A7C59; color: white; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f8e9; }
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        textarea { height: 80px; resize: vertical; }
        .btn { padding: 8px 15px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #4A7C59; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-info { background: #607d8b; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; align-items: flex-start; justify-content: center; padding-top: 50px; padding-bottom: 100px; }
        .modal-content { background: white; width: 600px; max-width: 90%; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; margin-bottom: 50px; }
        .dynamic-list-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; background: #fafafa; margin-bottom: 15px; }
        .dynamic-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: white; padding: 5px; border: 1px solid #ddd; border-radius: 8px; }
        .dynamic-row input { margin: 0; flex: 1; border: none; outline: none; }
        .chem-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #fafafa; }
        .chem-row { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .chem-img-preview { max-height: 100px; display: block; margin-top: 10px; border: 1px solid #eee; padding: 5px; background: white; border-radius: 5px; }
        #preview-img { max-height: 200px; border-radius: 8px; display: none; margin: 10px auto; border: 1px solid #ddd; }
        .search-box-wrapper { position: relative; }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>

    <nav style="background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
        <div class="nav-left">
            <a href="admin_menu.html" style="text-decoration:none; font-size:1.2rem; font-weight:bold; color:#2C5E4F;">â¬… å›é¸å–®</a>
            
            <a href="index.html" style="text-decoration:none; background:#e8f5e9; color:#2C5E4F; padding:5px 12px; border-radius:15px; font-size:0.9rem; margin:0 10px; border:1px solid #4A7C59;">
                ğŸ  å›å‰å°
            </a>

            <span style="color:#ddd; margin-right: 10px;">|</span>
            <span style="font-weight:bold; color:#4A7C59;">ä¸­è—¥è³‡æ–™åº«ç®¡ç†</span>
        </div>
        <div>
            <span id="status-text" style="font-size:0.9rem; color:#666; margin-right:10px;"></span>
            <button onclick="logout()" class="btn btn-danger" style="font-size:0.9rem;">ğŸšª ç™»å‡º</button>
        </div>
    </nav>

    <main style="max-width: 1000px; margin: 30px auto; padding: 0 15px;">
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="margin:0; color:#2C5E4F;">
                    <span id="view-title">è—¥ææ¸…å–®</span>
                    <span id="herb-total-count" style="background:#2C5E4F; color:white; padding:2px 12px; border-radius:20px; font-size:0.9rem; margin-left:10px; vertical-align:middle;">è¼‰å…¥ä¸­...</span>
                </h2>
                <div class="search-box-wrapper" style="flex:1; max-width: 300px; margin-left: 20px;">
                    <input type="text" id="admin-search" placeholder="ğŸ” æœå°‹ä¸­è—¥ / å­¸å..." oninput="handleSearchInput()" style="margin-bottom:0;">
                    <div id="suggestions" class="suggestions-list"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="toggle-trash-btn" onclick="toggleTrashView()" class="btn btn-info">ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶</button>
                    <button onclick="openEditModal()" class="btn btn-primary">â• æ–°å¢è—¥æ</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="herb-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å¹´ç´š</th>
                            <th>ä¸­è—¥å</th>
                            <th>åŸºåŸ</th>
                            <th>æ˜“æ··æ·†</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:#2C5E4F;">ç·¨è¼¯è—¥æ</h3>
            <input type="hidden" id="edit-id">

            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div>
                    <label>å¹´ç´š</label>
                    <select id="edit-grade">
                        <option value="å¤§ä¸€">å¤§ä¸€</option>
                        <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                        <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                        <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                    </select>
                </div>
                <div>
                    <label>ä¸­è—¥å (Chinese Name) *</label>
                    <input type="text" id="chinese_name">
                </div>
            </div>

            <label>åŸºåŸ/å­¸å (Origin) *</label>
            <div class="dynamic-list-container">
                <div id="origin-rows-wrapper"></div>
                <button type="button" onclick="addOriginRow()" class="btn btn-sm" style="background:#81c784; width:100%;">+ æ–°å¢åŸºåŸ</button>
            </div>

            <label>ç”Ÿè—¥å (Latin Name)</label>
            <input type="text" id="latin_name" placeholder="ä¾‹å¦‚ï¼šEphedrae Herba">
            
            <label>è—¥ç”¨éƒ¨ä½ (Medicinal Part)</label>
            <input type="text" id="part" placeholder="ä¾‹å¦‚ï¼šä¹¾ç‡¥è‰è³ªè–">

            <label>ç§‘å (Family)</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="family_ch" placeholder="ä¸­æ–‡ (ä¾‹å¦‚ï¼šéº»é»ƒç§‘)">
                <input type="text" id="family_en" placeholder="è‹±æ–‡ (ä¾‹å¦‚ï¼šEphedraceae)">
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <label>ä¸»è¦æˆåˆ†èˆ‡çµæ§‹ *</label>
            <div class="chem-container">
                <div id="chem-rows-wrapper"></div>
                <button type="button" onclick="addChemRow()" class="btn btn-primary" style="width:100%; margin-top:10px;">+ æ–°å¢æˆåˆ†</button>
            </div>

            <label style="margin-top:15px;">åŠŸæ•ˆ (Effects)</label>
            <input type="text" id="effects" placeholder="è«‹ç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚ï¼šç™¼æ±—, å¹³å–˜)">
            
            <label style="color:#d32f2f;">âš ï¸ æ˜“æ··æ·† (Confusing Drugs)</label>
            <div class="dynamic-list-container" style="border-color:#ffcdd2; background:#ffebee;">
                <div id="confusing-rows-wrapper"></div>
                <button type="button" onclick="addConfusingRow()" class="btn btn-sm" style="background:#e57373; color:white; width:100%;">+ æ–°å¢æ˜“æ··æ·†è—¥æ</button>
            </div>

            <label>å‚™è¨» (Indications) - æ”¯æ´åœ–æ–‡ç·¨è¼¯</label>
            <textarea id="indications"></textarea>

            <div style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center; margin-top:15px;">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡</label>
                <input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <img id="preview-img" src="">
                <input type="hidden" id="old-image-path">
                <p id="img-status" style="font-size:0.8rem; color:#666;"></p>
            </div>

            <div style="display:flex; gap:15px; margin-top:30px; padding-top:20px; border-top:1px solid #eee;">
                <button onclick="closeEditModal()" class="btn" style="background:#90a4ae; color:white; flex:1; padding:12px;">å–æ¶ˆ</button>
                <button onclick="saveAndUpload()" class="btn btn-primary" style="flex:1; padding:12px;">ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>

    <script>
        // === 1. å…¨åŸŸè®Šæ•¸ ===
        let allHerbs = [];
        let sha = ""; 
        let newImageBase64 = null; 
        let hasUnsavedChanges = false;
        let currentView = 'active';
        
        // åˆ†é¡è³‡æ–™
        const categories = {
            "é…ç³–é«” (Glycoside)": [
                "å¼·å¿ƒé…é†£é«” (Cardiac Glycosides)",
                "è’½é†Œé¡é…é†£é«” (Anthraquinone Glycosides)",
                "çš‚ç´ é…é†£é«” (Saponin Glycosides)",
                "æ°°é¡é…é†£é«” (Cyanogenic Glycosides)",
                "ç•°ç¡«æ°°é…¸é…é†£é«” (Isothiocyanate Glycosides)",
                "é†‡é¡é…é†£é«” (Alcohol Glycosides)",
                "é†›é¡é…é†£é«” (Aldehyde Glycosides)",
                "é…šé¡é…é†£é«” (Phenol Glycosides)"
            ],
            "ç”Ÿç‰©é¹¼ (Alkaloid)": [
                "å¡å•¶-å“Œå•¶é¡ (Pyridine-Piperidine alkaloid)",
                "æ‰˜çƒ·é¡ (Tropane alkaloid)",
                "å–¹å•‰é¡ (Quinoline alkaloid)",
                "ç•°å–¹å•‰é¡ (Isoquinoline alkaloid)",
                "å’ªå”‘é¡ (Imidazole alkaloid)",
                "å²å“šé¡ (Indole alkaloid)",
                "å˜Œå‘¤é¡ (Purine base / Xanthine)",
                "å›ºé†‡é¡ç”Ÿç‰©é¹¼ (Steroidal alkaloid)",
                "ç”Ÿç‰©é¹¼èƒº (Alkaloidal amine)"
            ],
            "å¤šé†£é¡ (Polysaccharides)": [
                "åŒè³ªèšé†£ (Homoglycan)",
                "ç•°è³ªèšé†£ (Heteroglycan)"
            ],
            "è‹¯ä¸™çƒ·é¡ (Phenylpropanoids)": [
                "ç°¡å–®è‹¯ä¸™çƒ·é¡ (Simple phenylpropanoids)",
                "æœ¨é…šç´ å’Œæ–°æœ¨é…šç´  (Lignans and Neolignans)",
                "é¡é»ƒé…® (Flavonoids)",
                "å–®å¯§/é£è³ª (Tannins)",
                "æœ¨è³ªç´  (Lignins)"
            ],
            "èœé¡ (Terpenoids)": [
                "å–®èœ (Monoterpenoids)",
                "å€åŠèœ (Sesquiterpene)",
                "äºŒèœ (Diterpene)",
                "ä¸‰èœ (Triterpene)",
                "è‚†èœ/é¡èƒ¡è˜¿è””ç´  (Tetraterpene / Carotenoids)"
            ],
            "æ®ç™¼æ²¹ (Volatile oil)": [
                "èœé¡æ®ç™¼æ²¹ (Terpenoids Volatile)",
                "èŠ³é¦™é¡æ®ç™¼æ²¹ (Aromatic Volatile)",
                "å…¶ä»–æ®ç™¼æ²¹ (Other Volatile)"
            ],
            "æ¨¹è„‚ (Resins)": [
                "æ¨¹è„‚é¡ (Resins)",
                "æ²¹æ¨¹è„‚é¡ (Oleoresins)",
                "æ²¹è† æ¨¹è„‚é¡ (Oleogumresins)",
                "é¦™è† é¡ (Balsams)"
            ],
            "æ²¹è„‚ (Lipids/Oil)": [
                "é£½å’Œå›ºå®šæ²¹ (Saturated Fixed Oil)",
                "å–®ä¸é£½å’Œå›ºå®šæ²¹ (Monounsaturated Fixed Oil)",
                "å¤šä¸é£½å’Œå›ºå®šæ²¹ (Polyunsaturated Fixed Oil)",
                "è„‚è‚ªåŠå…¶ç›¸é—œåŒ–åˆç‰© (Fats and Related Compounds)",
                "è Ÿè³ª (Waxes)"
            ]
        };

        // === 2. åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', async () => {
            // 3. åˆå§‹åŒ– TinyMCE ç·¨è¼¯å™¨ (æ›è¼‰åœ¨ #indications)
            tinymce.init({
                selector: '#indications',
                height: 300,
                plugins: 'table lists link image code preview searchreplace autolink fullscreen charmap',
                toolbar: 'undo redo | cut copy paste | blocks fontfamily fontsize | ' +
                         'bold italic underline strikethrough forecolor backcolor | ' +
                         'alignleft aligncenter alignright alignjustify | ' +
                         'bullist numlist outdent indent | table image link | removeformat code fullscreen',
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; color: #333; }',
                branding: false,
                menubar: true
            });

            initCategories();
            
            const savedConfig = localStorage.getItem('tcm_admin_config');
            if (!savedConfig) {
                alert("è«‹å…ˆå¾ä¸»é¸å–®ç™»å…¥ï¼");
                window.location.href = 'admin_menu.html';
                return;
            }
            
            const config = JSON.parse(savedConfig);
            try {
                await initGitHubConfig(config.token, config.user, config.repo);
                await loadData();
            } catch (e) {
                alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
                window.location.href = 'admin_menu.html';
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; }
        });

        // === 3. è³‡æ–™å­˜å– ===
        async function loadData() {
            try {
                const result = await fetchJSON('data/herbs.json');
                allHerbs = result.data;
                sha = result.sha;
                updateDisplayCount();
                renderTable();
            } catch (e) {
                if (e.message.includes('404')) {
                    allHerbs = [];
                    renderTable();
                } else {
                    throw e;
                }
            }
        }

        async function syncToGitHub(message) {
            try {
                document.getElementById('status-text').innerText = "â³ åŒæ­¥ä¸­...";
                const res = await saveJSON('data/herbs.json', allHerbs, sha, message);
                sha = res.content.sha;
                
                updateDisplayCount();
                renderTable();
                alert("ğŸ‰ æ“ä½œæˆåŠŸï¼");
                document.getElementById('status-text').innerText = `âœ… å·²é€£ç·š (${allHerbs.length}ç­†)`;
                return true;
            } catch(e) { 
                alert("åŒæ­¥å¤±æ•—: " + e.message); 
                return false; 
            }
        }

        // === 4. è¼”åŠ©å‡½å¼ ===
        function initCategories() {
            const mainSel = document.getElementById('chem_main');
            for(let key in categories) {
                let opt = document.createElement('option');
                opt.value = key; opt.text = key;
                mainSel.add(opt);
            }
        }
        function updateSubCats() {
            const mainVal = document.getElementById('chem_main').value;
            const subSel = document.getElementById('chem_sub');
            subSel.innerHTML = '<option value="">-- å­åˆ†é¡ --</option>';
            if(mainVal && categories[mainVal]) {
                categories[mainVal].forEach(sub => {
                    let opt = document.createElement('option');
                    opt.value = sub; opt.text = sub;
                    subSel.add(opt);
                });
            }
        }
        function updateDisplayCount() {
            const countLabel = document.getElementById('herb-total-count');
            const activeCount = allHerbs.filter(h => !h.isTrash).length;
            const trashCount = allHerbs.filter(h => h.isTrash).length;
            if (countLabel) countLabel.innerText = `æ­£å¸¸: ${activeCount} | æ¡¶: ${trashCount}`;
        }
        
        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦è¿”å›ä¸»é¸å–®ï¼Ÿ")) {
                localStorage.removeItem('tcm_admin_config');
                window.location.href = 'admin_menu.html';
            }
        }

        // === 5. è¡¨æ ¼èˆ‡æœå°‹ ===
        function toggleTrashView() {
            const btn = document.getElementById('toggle-trash-btn');
            const title = document.getElementById('view-title');
            if (currentView === 'active') {
                currentView = 'trash';
                btn.innerText = "ğŸ”™ å›åˆ°æ¸…å–®";
                btn.style.background = "#455a64";
                title.innerText = "ğŸ—‘ï¸ åƒåœ¾æ¡¶";
            } else {
                currentView = 'active';
                btn.innerText = "ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶";
                btn.style.background = "#607d8b";
                title.innerText = "è—¥ææ¸…å–®";
            }
            renderTable();
        }

        function renderTable(filterList = null) {
            const list = filterList || allHerbs;
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            
            const displayList = list.filter(h => currentView === 'trash' ? h.isTrash : !h.isTrash);

            [...displayList].sort((a,b) => b.id - a.id).forEach(herb => {
                const tr = document.createElement('tr');
                let originPrev = '-';
                if (herb.origin) {
                    if (Array.isArray(herb.origin) && herb.origin.length > 0) {
                        const first = herb.origin[0];
                        originPrev = (typeof first === 'object') ? `${first.lat||''} ${first.ch||''}` : first;
                        if (herb.origin.length > 1) originPrev += ' ...';
                    } else if (typeof herb.origin === 'string') {
                        originPrev = herb.origin;
                    }
                }
                
                let confusingPrev = herb.confusing_drugs && herb.confusing_drugs.length > 0 
                    ? `<span style="color:#d32f2f; font-weight:bold;">âš ï¸ ${herb.confusing_drugs.length}</span>` : '-';

                let actionButtons = currentView === 'active' 
                    ? `<button class="btn btn-edit btn-sm" onclick="openEditModal(${herb.id})">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="softDelete(${herb.id})">ğŸ—‘ï¸</button>`
                    : `<button class="btn btn-success btn-sm" onclick="restoreHerb(${herb.id})">âª é‚„åŸ</button> <button class="btn btn-danger btn-sm" onclick="hardDelete(${herb.id})">ğŸ”¥ æ°¸ä¹…åˆªé™¤</button>`;

                tr.innerHTML = `<td>${herb.id}</td><td><span style="background:#e8f5e9; color:#2C5E4F; padding:2px 8px; border-radius:10px; font-size:0.85rem;">${herb.grade}</span></td><td style="font-weight:bold;">${herb.chinese_name}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${originPrev}">${originPrev}</td><td>${confusingPrev}</td><td>${actionButtons}</td>`;
                tbody.appendChild(tr);
            });
        }

        function handleSearchInput() {
            const term = document.getElementById('admin-search').value.trim().toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            if (!term) { suggestionsDiv.style.display = 'none'; renderTable(); return; }
            
            const matches = allHerbs.filter(h => {
                return (h.chinese_name && h.chinese_name.includes(term)) ||
                       (h.latin_name && h.latin_name.toLowerCase().includes(term));
            });
            renderTable(matches);
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.slice(0,5).map(h => `<div class="suggestion-item" onclick="openEditModal(${h.id})"><span>${h.chinese_name}</span> <small style="color:#888;">${h.latin_name||''}</small></div>`).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // === 6. ç·¨è¼¯ã€åˆªé™¤ã€åœ–ç‰‡è™•ç† ===
        function openEditModal(id = null) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'flex';
            document.getElementById('edit-id').value = id || "";
            document.getElementById('img-input').value = "";
            document.getElementById('suggestions').style.display = 'none'; 
            newImageBase64 = null;
            hasUnsavedChanges = false;

            document.getElementById('origin-rows-wrapper').innerHTML = "";
            document.getElementById('confusing-rows-wrapper').innerHTML = "";
            document.getElementById('chem-rows-wrapper').innerHTML = "";

            // æ¸…ç©ºç·¨è¼¯å™¨
            tinymce.get('indications').setContent("");

            if (id) {
                const h = allHerbs.find(i => i.id === id);
                document.getElementById('modal-title').innerText = "ç·¨è¼¯è—¥æ";
                document.getElementById('edit-grade').value = h.grade;
                document.getElementById('chinese_name').value = h.chinese_name;
                
                if(Array.isArray(h.origin)) h.origin.forEach(o => addOriginRow(o)); else addOriginRow(h.origin);
                if(h.confusing_drugs) h.confusing_drugs.forEach(c => addConfusingRow(c));

                document.getElementById('latin_name').value = h.latin_name || "";
                document.getElementById('part').value = h.part || "";
                document.getElementById('family_ch').value = h.family_ch || "";
                document.getElementById('family_en').value = h.family_en || "";
                document.getElementById('effects').value = (h.effects || []).join(', ');
                
                // 4. è®€å–èˆŠçš„ indications åˆ°ç·¨è¼¯å™¨ä¸­ (å¦‚æœæ˜¯ HTML æ ¼å¼æœƒè‡ªå‹•æ¸²æŸ“)
                tinymce.get('indications').setContent(h.indications || "");

                document.getElementById('chem_main').value = h.chem_main || ""; updateSubCats();
                document.getElementById('chem_sub').value = h.chem_sub || "";

                document.getElementById('old-image-path').value = h.image || "";
                const preview = document.getElementById('preview-img');
                preview.src = h.image || "";
                preview.style.display = h.image ? 'block' : 'none';
                document.getElementById('img-status').innerText = h.image ? "âœ… æ—¢æœ‰åœ–ç‰‡" : "";

                if (h.chemistry) {
                    let list = Array.isArray(h.chemistry) ? h.chemistry : (typeof h.chemistry === 'string' ? h.chemistry.split(/[,ï¼Œ]/).map(s=>({name_en:s})) : []);
                    list.forEach(c => addChemRow(c));
                } else {
                    addChemRow();
                }
            } else {
                document.getElementById('modal-title').innerText = "æ–°å¢è—¥æ";
                document.querySelectorAll('#edit-modal input[type=text], #edit-modal textarea').forEach(e => e.value="");
                addOriginRow(); addChemRow();
                document.getElementById('preview-img').style.display = 'none';
            }
            const inputs = document.querySelectorAll('#edit-modal input, #edit-modal textarea, #edit-modal select');
            inputs.forEach(input => { input.oninput = () => { hasUnsavedChanges = true; }; });
        }

        function closeEditModal() {
            if (hasUnsavedChanges && !confirm("âš ï¸ æ¨æ£„è®Šæ›´ï¼Ÿ")) return;
            document.getElementById('edit-modal').style.display = 'none';
            hasUnsavedChanges = false; 
        }

        // å‹•æ…‹åˆ—è¡¨ (å«ä¿®æ­£çš„ chem row)
        function addOriginRow(d) { 
            const w=document.getElementById('origin-rows-wrapper'); const v=document.createElement('div'); v.className='dynamic-row origin-row'; 
            v.innerHTML=`<input type="text" class="origin-lat" value="${d?.lat||(typeof d==='string'?d:'')}" placeholder="å­¸å"><input type="text" class="origin-ch" value="${d?.ch||''}" placeholder="ä¸­æ–‡"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v); 
        }
        function addConfusingRow(d) {
            const w=document.getElementById('confusing-rows-wrapper'); const v=document.createElement('div'); v.className='dynamic-row confusing-row';
            v.innerHTML=`<div style="flex:1"><div style="display:flex;gap:5px"><input class="conf-ch" value="${d?.name_ch||''}" placeholder="ä¸­æ–‡"><input class="conf-en" value="${d?.name_en||''}" placeholder="å­¸å"></div><input class="conf-note" value="${d?.note||''}" placeholder="å‚™è¨»"></div><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v);
        }
        function addChemRow(d) {
            const w=document.getElementById('chem-rows-wrapper'); const idx=Math.floor(Date.now()+Math.random()*1000); const v=document.createElement('div'); v.className='chem-row';
            let nEn="", nCh="", img=""; if(d){ if(typeof d==='string') nEn=d; else{ nEn=d.name_en||d.name||""; nCh=d.name_ch||""; img=d.image||""; } }
            v.innerHTML=`<div style="display:flex;gap:10px;margin-bottom:8px"><input class="chem-en" value="${nEn}" placeholder="è‹±æ–‡"><input class="chem-ch" value="${nCh}" placeholder="ä¸­æ–‡"><button class="btn btn-danger btn-sm" onclick="this.closest('.chem-row').remove()">X</button></div>
            <label style="cursor:pointer;background:#eee;padding:5px;border-radius:5px;display:block;text-align:center">ğŸ“¸ ä¸Šå‚³çµæ§‹ <input type="file" style="display:none" onchange="handleChemImg(this,'c-${idx}')"></label>
            <img id="c-${idx}" src="${img}" class="chem-img-preview" style="display:${img?'block':'none'}"><input type="hidden" class="chem-old-img" value="${img}"><input type="hidden" class="chem-new-base64">`;
            w.appendChild(v);
        }

        // åœ–ç‰‡èˆ‡å„²å­˜ (ä½¿ç”¨ utils.js çš„é‚è¼¯)
        function handleImagePreview() {
            const file = document.getElementById('img-input').files[0]; if(!file)return;
            const reader = new FileReader(); reader.onload=e=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{
                const c=document.createElement('canvas'); const s=800/img.width; c.width=800; c.height=img.height*s;
                c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                newImageBase64 = c.toDataURL('image/jpeg', 0.7);
                document.getElementById('preview-img').src=newImageBase64;
                document.getElementById('preview-img').style.display='block';
                document.getElementById('img-status').innerText="âœ… æº–å‚™ä¸Šå‚³";
            }}; reader.readAsDataURL(file);
        }
        function handleChemImg(input, id) {
            const file = input.files[0]; if(!file)return;
            const reader = new FileReader(); reader.onload=e=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{
                const c=document.createElement('canvas'); const s=500/img.width; c.width=500; c.height=img.height*s;
                c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                const b64 = c.toDataURL('image/jpeg', 0.7);
                document.getElementById(id).src=b64; document.getElementById(id).style.display='block';
                input.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.value=b64;
            }}; reader.readAsDataURL(file);
        }

        async function saveAndUpload() {
            const name = document.getElementById('chinese_name').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥ä¸­è—¥å");
            const idVal = document.getElementById('edit-id').value;
            const btn = document.querySelector('#edit-modal .btn-primary');
            btn.innerText = "â³ è™•ç†ä¸­..."; btn.disabled = true;

            try {
                let finalImg = document.getElementById('old-image-path').value;
                if(newImageBase64) finalImg = await uploadBase64(newImageBase64, 'herbs');

                const chemData=[]; const rows=document.querySelectorAll('.chem-row');
                for(let row of rows){
                    const en=row.querySelector('.chem-en').value; const ch=row.querySelector('.chem-ch').value;
                    let cImg=row.querySelector('.chem-old-img').value; const cNew=row.querySelector('.chem-new-base64').value;
                    if(cNew) cImg = await uploadBase64(cNew, 'structures');
                    if(en||ch) chemData.push({name_en:en, name_ch:ch, image:cImg});
                }
                
                const originData=[]; document.querySelectorAll('.origin-row').forEach(r=>{ const l=r.querySelector('.origin-lat').value; const c=r.querySelector('.origin-ch').value; if(l||c) originData.push({lat:l,ch:c}) });
                const confData=[]; document.querySelectorAll('.confusing-row').forEach(r=>{ const c=r.querySelector('.conf-ch').value; const e=r.querySelector('.conf-en').value; const n=r.querySelector('.conf-note').value; if(c||e||n) confData.push({name_ch:c,name_en:e,note:n}) });

                let finalId = idVal ? parseInt(idVal) : (allHerbs.reduce((max,h)=>Math.max(max,h.id||0),0)+1);
                
                // 5. å–å¾—ç·¨è¼¯å™¨å…§å®¹ (HTML æ ¼å¼)
                const indicationsHTML = tinymce.get('indications').getContent();

                const newItem = {
                    id: finalId, grade: document.getElementById('edit-grade').value, chinese_name: name,
                    origin: originData, confusing_drugs: confData, latin_name: document.getElementById('latin_name').value,
                    part: document.getElementById('part').value, family_ch: document.getElementById('family_ch').value, family_en: document.getElementById('family_en').value,
                    chem_main: document.getElementById('chem_main').value, chem_sub: document.getElementById('chem_sub').value,
                    chemistry: chemData, effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s),
                    indications: indicationsHTML, // å­˜å…¥ HTML
                    image: finalImg, isTrash: false
                };

                if(idVal) allHerbs[allHerbs.findIndex(h=>h.id==idVal)] = newItem; else allHerbs.push(newItem);
                
                await syncToGitHub(`Update ${name}`);
                hasUnsavedChanges = false; document.getElementById('edit-modal').style.display='none';

            } catch(e) { alert("éŒ¯èª¤: "+e.message); }
            finally { btn.innerText = "ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³"; btn.disabled = false; }
        }

        async function uploadBase64(b64, folder) {
            const fileName = `images/${folder}/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
            const content = b64.split(',')[1];
            const url = `https://api.github.com/repos/${JSON.parse(localStorage.getItem('tcm_admin_config')).user}/${JSON.parse(localStorage.getItem('tcm_admin_config')).repo}/contents/${fileName}`;
            const res = await fetch(url, {
                method: 'PUT', headers: {'Authorization': `token ${JSON.parse(localStorage.getItem('tcm_admin_config')).token}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({message:"Upload img", content: content})
            });
            if(!res.ok) throw new Error("åœ–å‚³å¤±æ•—");
            return (await res.json()).content.download_url;
        }

        async function softDelete(id) { if(confirm("ç§»è‡³åƒåœ¾æ¡¶ï¼Ÿ")){ allHerbs.find(h=>h.id==id).isTrash=true; syncToGitHub(`Trash ${id}`); } }
        async function restoreHerb(id) { allHerbs.find(h=>h.id==id).isTrash=false; syncToGitHub(`Restore ${id}`); }
        async function hardDelete(id) { if(confirm("æ°¸ä¹…åˆªé™¤ï¼Ÿ")){ allHerbs=allHerbs.filter(h=>h.id!=id); syncToGitHub(`Delete ${id}`); } }
    </script>
</body>
</html>
