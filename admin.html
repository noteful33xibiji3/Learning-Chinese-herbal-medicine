<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ± | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           âœ¨ æ¨£å¼å€ (å®Œå…¨ä¿ç•™æ‚¨çš„åŸç‰ˆæ¨£å¼)
           ========================================= */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            margin-bottom: 20px;
            position: relative;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #4A7C59; color: white; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f8e9; }
        
        /* è¼¸å…¥æ¡†èˆ‡è¡¨å–® */
        input, select, textarea {
            padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; margin-bottom: 10px;
        }
        textarea { height: 80px; resize: vertical; }

        .btn {
            padding: 8px 15px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-primary { background: #4A7C59; color: white; }
        .btn-primary:hover { background: #2C5E4F; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-info { background: #607d8b; color: white; } /* æ–°å¢ï¼šåƒåœ¾æ¡¶æŒ‰éˆ•é¡è‰² */
        .btn-success { background: #4caf50; color: white; } /* æ–°å¢ï¼šé‚„åŸæŒ‰éˆ•é¡è‰² */
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
        
        /* ç™»å…¥è¦–çª— */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px; width: 400px; max-width: 90%;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* ç·¨è¼¯è¦–çª— (Modal) */
        #edit-modal {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            overflow-y: auto;
            align-items: flex-start; 
            justify-content: center; 
            padding-top: 50px; 
            padding-bottom: 100px;
        }
        .modal-content {
            background: white; width: 600px; max-width: 90%; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative;
            margin-bottom: 50px;
        }

        /* å‹•æ…‹åˆ—è¡¨æ¨£å¼ */
        .dynamic-list-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; background: #fafafa; margin-bottom: 15px; }
        .dynamic-row { 
            display: flex; gap: 10px; align-items: center; margin-bottom: 10px; 
            background: white; padding: 5px; border: 1px solid #ddd; border-radius: 8px;
        }
        .dynamic-row input { margin: 0; flex: 1; border: none; outline: none; }
        
        /* åŒ–å­¸æˆåˆ†å°ˆç”¨æ¨£å¼ */
        .chem-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #fafafa; }
        .chem-row { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .chem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .chem-img-preview { max-height: 100px; display: block; margin-top: 10px; border: 1px solid #eee; padding: 5px; background: white; border-radius: 5px; }
        
        /* åœ–ç‰‡é è¦½ */
        #preview-img { max-height: 200px; border-radius: 8px; display: none; margin: 10px auto; border: 1px solid #ddd; }

        /* æœå°‹å»ºè­° */
        .search-box-wrapper { position: relative; }
        .suggestions-list {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: white; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10;
            max-height: 200px; overflow-y: auto; display: none;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>

    <nav style="background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
        <div class="nav-left">
            <a href="index.html" style="text-decoration:none; font-size:1.2rem; font-weight:bold; color:#2C5E4F;">ğŸŒ¿ å¾Œå°ç®¡ç†ç³»çµ±</a>
        </div>
        <div>
            <span id="status-text" style="font-size:0.9rem; color:#666; margin-right:10px;"></span>
            <button onclick="logout()" class="btn btn-danger" style="font-size:0.9rem;">ğŸšª ç™»å‡º</button>
        </div>
    </nav>

    <main style="max-width: 1000px; margin: 30px auto; padding: 0 15px;">
        
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="margin:0; color:#2C5E4F;">
                    <span id="view-title">è—¥æè³‡æ–™åº«ç®¡ç†</span>
                    <span id="herb-total-count" style="background:#2C5E4F; color:white; padding:2px 12px; border-radius:20px; font-size:0.9rem; margin-left:10px; vertical-align:middle;">è¼‰å…¥ä¸­...</span>
                </h2>
                <div class="search-box-wrapper" style="flex:1; max-width: 300px; margin-left: 20px;">
                    <input type="text" id="admin-search" placeholder="ğŸ” æœå°‹ä¸­è—¥ / å­¸å..." oninput="handleSearchInput()" style="margin-bottom:0;">
                    <div id="suggestions" class="suggestions-list"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="toggle-trash-btn" onclick="toggleTrashView()" class="btn btn-info">ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶</button>
                    <button onclick="openEditModal()" class="btn btn-primary">â• æ–°å¢è—¥æ</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="herb-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å¹´ç´š</th>
                            <th>ä¸­è—¥å</th>
                            <th>åŸºåŸ</th>
                            <th>æ˜“æ··æ·†</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="login-overlay" style="display:none;">
        <div class="login-box">
            <h2 style="color:#2C5E4F;">ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">è«‹è¼¸å…¥ GitHub è¨­å®š</p>
            
            <input type="text" id="gh-user" placeholder="GitHub å¸³è™Ÿ">
            <input type="text" id="gh-repo" placeholder="å€‰åº«åç¨± (Repository)">
            <input type="password" id="gh-token" placeholder="Token (ghp_...)">
            <input type="text" id="gh-path" placeholder="æª”æ¡ˆè·¯å¾‘" value="data/herbs.json">
            
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="login()">ğŸš€ é€£ç·šä¸¦ç™»å…¥</button>
            <div id="login-msg" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:#2C5E4F;">ç·¨è¼¯è—¥æ</h3>
            <input type="hidden" id="edit-id">

            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div>
                    <label>å¹´ç´š</label>
                    <select id="edit-grade">
                        <option value="å¤§ä¸€">å¤§ä¸€</option>
                        <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                        <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                        <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                    </select>
                </div>
                <div>
                    <label>ä¸­è—¥å (Chinese Name) *</label>
                    <input type="text" id="chinese_name">
                </div>
            </div>

            <label>åŸºåŸ/å­¸å (Origin) *</label>
            <div class="dynamic-list-container">
                <div id="origin-rows-wrapper"></div>
                <button type="button" onclick="addOriginRow()" class="btn btn-sm" style="background:#81c784; width:100%;">+ æ–°å¢åŸºåŸ</button>
            </div>

            <label>ç”Ÿè—¥å (Latin Name)</label>
          <input type="text" id="latin_name" placeholder="ä¾‹å¦‚ï¼šEphedrae Herba">
            
            <label>è—¥ç”¨éƒ¨ä½ (Medicinal Part)</label>
<input type="text" id="part" placeholder="ä¾‹å¦‚ï¼šä¹¾ç‡¥è‰è³ªè– (Dried herbaceous stem)">

            <label>ç§‘å (Family)</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
               <input type="text" id="family_ch" placeholder="ä¸­æ–‡ (ä¾‹å¦‚ï¼šéº»é»ƒç§‘)">
<input type="text" id="family_en" placeholder="è‹±æ–‡ (ä¾‹å¦‚ï¼šEphedraceae)">
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <label>ä¸»è¦æˆåˆ†èˆ‡çµæ§‹ *</label>
            <div class="chem-container">
                <div id="chem-rows-wrapper"></div>
                <button type="button" onclick="addChemRow()" class="btn btn-primary" style="width:100%; margin-top:10px;">+ æ–°å¢æˆåˆ†</button>
            </div>

            <label style="margin-top:15px;">åŠŸæ•ˆ (Effects)</label>
          <input type="text" id="effects" placeholder="è«‹ç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚ï¼šç™¼æ±—, å¹³å–˜)">
            
            <label style="color:#d32f2f;">âš ï¸ æ˜“æ··æ·† (Confusing Drugs)</label>
            <div class="dynamic-list-container" style="border-color:#ffcdd2; background:#ffebee;">
                <div id="confusing-rows-wrapper"></div>
                <button type="button" onclick="addConfusingRow()" class="btn btn-sm" style="background:#e57373; color:white; width:100%;">+ æ–°å¢æ˜“æ··æ·†è—¥æ</button>
            </div>

            <label>å‚™è¨» (Indications)</label>
            <textarea id="indications"></textarea>

            <div style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center; margin-top:15px;">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡</label>
                <input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <img id="preview-img" src="">
                <input type="hidden" id="old-image-path">
                <p id="img-status" style="font-size:0.8rem; color:#666;"></p>
            </div>

            <div style="display:flex; gap:15px; margin-top:30px; padding-top:20px; border-top:1px solid #eee;">
                <button onclick="closeEditModal()" class="btn" style="background:#90a4ae; color:white; flex:1; padding:12px;">
                    å–æ¶ˆ
                </button>
                 <button onclick="saveAndUpload()" class="btn btn-primary" style="flex:1; padding:12px;">
                    ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³
                </button>
            </div>
        </div>
    </div>

    <script>
        // === 1. å…¨åŸŸè®Šæ•¸ & åˆ†é¡è³‡æ–™ ===
        let allHerbs = [];
        let sha = ""; 
        let config = {};
        let newImageBase64 = null; 
        
        // â˜… è¿½è¹¤æ˜¯å¦æœ‰æœªå„²å­˜çš„è®Šæ›´
        let hasUnsavedChanges = false;
        // â˜… è¿½è¹¤ç›®å‰è¦–åœ– ('active' æ­£å¸¸ / 'trash' åƒåœ¾æ¡¶)
        let currentView = 'active';

        const categories = {
            "é…ç³–é«”": ["å¼·å¿ƒé…é†£é«”", "è”¥é†Œé¡é…é†£é«”", "çš‚ç´ é…é†£é«”", "æ°°è‹·é…é†£é«”", "ç•°ç¡«æ°°é…é†£é«”", "é†‡é¡é…é†£é«”", "é†›é¡é…é†£é«”", "é…šé¡é…é†£é«”", "å…¶ä»–é…é†£é«”"],
            "ç”Ÿç‰©é¹¼": ["å¡å•¶-å“Œå•¶é¡", "æ‰˜çƒ·é¡", "å–¹å•‰é¡", "ç•°å–¹å•‰é¡", "å²å“šé¡", "å’ªå”‘é¡", "å˜Œå‘¤é¡", "ç”¾é«”é¡", "å…¶ä»–ç”Ÿç‰©é¹¼"],
            "å¤šé†£é¡": ["æ¾±ç²‰", "æ¨¹è† ", "é»æ¶²è³ª", "æœè† "],
            "è‹¯ä¸™çƒ·é¡": ["ç°¡å–®è‹¯ä¸™çƒ·é¡", "é¦™è±†ç´ ", "æœ¨è³ªç´ "],
            "æœ¨é…šç´ ": ["æœ¨é…šç´ ", "æ–°æœ¨é…šç´ "],
            "é¡é»ƒé…®": ["é»ƒé…®é¡", "é»ƒé…®é†‡é¡", "ç•°é»ƒé…®é¡", "èŠ±é’ç´ "],
            "é£è³ª": ["æ°´è§£å‹é£è³ª", "ç¸®åˆå‹é£è³ª"],
            "èœé¡": ["å–®èœ", "å€åŠèœ", "äºŒèœ", "ä¸‰èœ"],
            "æ®ç™¼æ²¹": ["å«æ°§å–®èœ", "å€åŠèœé¡", "èŠ³é¦™æ—"],
            "æ¨¹è„‚": ["æ²¹æ¨¹è„‚", "è† æ¨¹è„‚", "æ²¹è† æ¨¹è„‚", "é¦™æ¨¹è„‚"],
            "è„‚è³ª": ["è„‚è‚ªæ²¹", "è Ÿ"]
        };

        // === 2. åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            initCategories();
            const savedConfig = localStorage.getItem('tcm_admin_config');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                loadFromGitHub();
            } else {
                showLogin();
            }
        });

        // â˜… é˜²æ­¢èª¤é—œç¶²é 
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = ''; 
            }
        });

        function initCategories() {
            const mainSel = document.getElementById('chem_main');
            for(let key in categories) {
                let opt = document.createElement('option');
                opt.value = key; opt.text = key;
                mainSel.add(opt);
            }
        }
        function updateSubCats() {
            const mainVal = document.getElementById('chem_main').value;
            const subSel = document.getElementById('chem_sub');
            subSel.innerHTML = '<option value="">-- å­åˆ†é¡ --</option>';
            if(mainVal && categories[mainVal]) {
                categories[mainVal].forEach(sub => {
                    let opt = document.createElement('option');
                    opt.value = sub; opt.text = sub;
                    subSel.add(opt);
                });
            }
        }

        // === 3. ç™»å…¥/GitHub ç›¸é—œ ===
        function showLogin() { document.getElementById('login-overlay').style.display = 'flex'; }
        
        function login() {
            const token = document.getElementById('gh-token').value.trim();
            const user = document.getElementById('gh-user').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const path = document.getElementById('gh-path').value.trim();
            if (!token || !user || !repo) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            
            config = { token, user, repo, path };
            document.getElementById('login-msg').innerText = "é€£ç·šä¸­...";
            loadFromGitHub(true);
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºï¼Ÿ")) {
                localStorage.removeItem('tcm_admin_config');
                location.reload();
            }
        }

        async function loadFromGitHub(isLoginCheck = false) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                sha = data.sha;
                const content = decodeURIComponent(escape(window.atob(data.content)));
                
                try {
                    allHerbs = JSON.parse(content);
                } catch(e) { throw new Error("JSON æ ¼å¼éŒ¯èª¤"); }

                if (isLoginCheck) {
                    localStorage.setItem('tcm_admin_config', JSON.stringify(config));
                    document.getElementById('login-overlay').style.display = 'none';
                }
                updateDisplayCount(); // æ›´æ–°æ•¸é‡
                renderTable();
            } catch (err) {
                console.error(err);
                if (isLoginCheck) document.getElementById('login-msg').innerText = "é€£ç·šå¤±æ•—: " + err.message;
                else { alert("é€£ç·šéŒ¯èª¤: " + err.message); }
            }
        }

        // â˜… æ›´æ–°ç•«é¢ç¸½æ•¸
        function updateDisplayCount() {
            const countLabel = document.getElementById('herb-total-count');
            const statusText = document.getElementById('status-text');
            const activeCount = allHerbs.filter(h => !h.isTrash).length;
            const trashCount = allHerbs.filter(h => h.isTrash).length;
            
            if (countLabel) countLabel.innerText = `æ­£å¸¸: ${activeCount} | æ¡¶: ${trashCount}`;
            if (statusText) statusText.innerText = `âœ… å·²é€£ç·š: ${config.repo}`;
        }

        // â˜… åˆ‡æ›åƒåœ¾æ¡¶/æ­£å¸¸è¦–åœ–
        function toggleTrashView() {
            const btn = document.getElementById('toggle-trash-btn');
            const title = document.getElementById('view-title');
            
            if (currentView === 'active') {
                currentView = 'trash';
                btn.innerText = "ğŸ”™ å›åˆ°æ¸…å–®";
                btn.style.background = "#455a64"; // ç°è‰²
                title.innerText = "ğŸ—‘ï¸ åƒåœ¾æ¡¶ç®¡ç†";
            } else {
                currentView = 'active';
                btn.innerText = "ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶";
                btn.style.background = "#607d8b"; // è—ç°è‰²
                title.innerText = "è—¥æè³‡æ–™åº«ç®¡ç†";
            }
            renderTable();
        }

        // === 4. è¡¨æ ¼èˆ‡æœå°‹ (ä¿®æ”¹ç‰ˆ) ===
        function renderTable(filterList = null) {
            const list = filterList || allHerbs;
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            
            // â˜… éæ¿¾é‚è¼¯ï¼šæ­£å¸¸è¦–åœ–ä¸é¡¯ç¤ºåƒåœ¾ï¼Œåƒåœ¾è¦–åœ–åªé¡¯ç¤ºåƒåœ¾
            const displayList = list.filter(h => {
                if (currentView === 'trash') return h.isTrash === true;
                return !h.isTrash; 
            });

            // æ’åº (ID å¤§åˆ°å°)
            [...displayList].sort((a,b) => b.id - a.id).forEach(herb => {
                const tr = document.createElement('tr');
                
                // åŸºåŸé¡¯ç¤º
                let originPrev = '-';
                if (herb.origin) {
                    if (Array.isArray(herb.origin) && herb.origin.length > 0) {
                        const first = herb.origin[0];
                        originPrev = (typeof first === 'object') ? `${first.lat||''} ${first.ch||''}` : first;
                        if (herb.origin.length > 1) originPrev += ' ...';
                    } else if (typeof herb.origin === 'string') {
                        originPrev = herb.origin;
                    }
                }

                // æ˜“æ··æ·†é¡¯ç¤º
                let confusingPrev = '-';
                if (herb.confusing_drugs && Array.isArray(herb.confusing_drugs) && herb.confusing_drugs.length > 0) {
                    confusingPrev = `<span style="color:#d32f2f; font-weight:bold;">âš ï¸ ${herb.confusing_drugs.length}</span>`;
                }

                // â˜… æ“ä½œæŒ‰éˆ•æ ¹æ“šè¦–åœ–æ”¹è®Š
                let actionButtons = "";
                if (currentView === 'active') {
                    // æ­£å¸¸æ¨¡å¼ï¼šç·¨è¼¯ & ç§»è‡³åƒåœ¾æ¡¶
                    actionButtons = `
                        <button class="btn btn-edit btn-sm" onclick="openEditModal(${herb.id})">âœï¸</button>
                        <button class="btn btn-danger btn-sm" onclick="softDelete(${herb.id})">ğŸ—‘ï¸</button>
                    `;
                } else {
                    // åƒåœ¾æ¡¶æ¨¡å¼ï¼šé‚„åŸ & æ°¸ä¹…åˆªé™¤
                    actionButtons = `
                        <button class="btn btn-success btn-sm" onclick="restoreHerb(${herb.id})">âª é‚„åŸ</button>
                        <button class="btn btn-danger btn-sm" onclick="hardDelete(${herb.id})">ğŸ”¥ æ°¸ä¹…åˆªé™¤</button>
                    `;
                }

                tr.innerHTML = `
                    <td>${herb.id}</td>
                    <td><span style="background:#e8f5e9; color:#2C5E4F; padding:2px 8px; border-radius:10px; font-size:0.85rem;">${herb.grade}</span></td>
                    <td style="font-weight:bold;">${herb.chinese_name}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${originPrev}">${originPrev}</td>
                    <td>${confusingPrev}</td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function handleSearchInput() {
            const term = document.getElementById('admin-search').value.trim().toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (!term) {
                suggestionsDiv.style.display = 'none';
                renderTable(); 
                return;
            }

            // æœå°‹æ‰€æœ‰è—¥æ (ä¸ç®¡æœ‰æ²’æœ‰åœ¨åƒåœ¾æ¡¶)ï¼Œä½†åœ¨ renderTable æ™‚æœƒè‡ªå‹•éæ¿¾
            const matches = allHerbs.filter(h => {
                if (h.chinese_name && h.chinese_name.includes(term)) return true;
                if (h.latin_name && h.latin_name.toLowerCase().includes(term)) return true;
                if (h.origin) {
                    if (Array.isArray(h.origin)) {
                        return h.origin.some(o => (o.lat && o.lat.toLowerCase().includes(term)));
                    } else if (typeof h.origin === 'string') {
                        return h.origin.toLowerCase().includes(term);
                    }
                }
                return false;
            });

            renderTable(matches);
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = matches.slice(0,5).map(h => `
                    <div class="suggestion-item" onclick="openEditModal(${h.id})">
                        <span>${h.chinese_name}</span> <small style="color:#888;">${h.latin_name||''}</small>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // === 5. ç·¨è¼¯è¦–çª—é‚è¼¯ ===
        function openEditModal(id = null) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'flex';
            document.getElementById('edit-id').value = id || "";
            document.getElementById('img-input').value = "";
            document.getElementById('suggestions').style.display = 'none'; 
            newImageBase64 = null;

            hasUnsavedChanges = false; // é‡ç½®

            // æ¸…ç©ºåˆ—è¡¨
            document.getElementById('origin-rows-wrapper').innerHTML = "";
            document.getElementById('confusing-rows-wrapper').innerHTML = "";
            document.getElementById('chem-rows-wrapper').innerHTML = "";

            if (id) {
                const h = allHerbs.find(i => i.id === id);
                document.getElementById('modal-title').innerText = "ç·¨è¼¯è—¥æ";
                document.getElementById('edit-grade').value = h.grade;
                document.getElementById('chinese_name').value = h.chinese_name;
                
                if(Array.isArray(h.origin)) h.origin.forEach(o => addOriginRow(o));
                else if(h.origin) addOriginRow(h.origin);
                else addOriginRow();

                if(h.confusing_drugs && Array.isArray(h.confusing_drugs)) {
                    h.confusing_drugs.forEach(c => addConfusingRow(c));
                }

                document.getElementById('latin_name').value = h.latin_name || "";
                document.getElementById('part').value = h.part || "";
                document.getElementById('family_ch').value = h.family_ch || h.family || "";
                document.getElementById('family_en').value = h.family_en || "";
                document.getElementById('effects').value = (h.effects || []).join(', ');
                document.getElementById('indications').value = h.indications || "";
                
                document.getElementById('chem_main').value = h.chem_main || "";
                updateSubCats();
                document.getElementById('chem_sub').value = h.chem_sub || "";

                document.getElementById('old-image-path').value = h.image || "";
                document.getElementById('preview-img').src = h.image || "";
                document.getElementById('preview-img').style.display = h.image ? 'block' : 'none';

                if (h.chemistry) {
                    let list = Array.isArray(h.chemistry) ? h.chemistry : h.chemistry.split(',').map(s=>({name_en:s}));
                    list.forEach(c => addChemRow(c));
                }
            } else {
                document.getElementById('modal-title').innerText = "æ–°å¢è—¥æ";
                document.querySelectorAll('#edit-modal input[type=text], #edit-modal textarea').forEach(e => e.value="");
                addOriginRow();
                addChemRow();
                document.getElementById('preview-img').style.display = 'none';
            }

            const inputs = document.querySelectorAll('#edit-modal input, #edit-modal textarea, #edit-modal select');
            inputs.forEach(input => {
                input.oninput = () => { hasUnsavedChanges = true; };
                input.onchange = () => { hasUnsavedChanges = true; };
            });
        }

        function closeEditModal() {
            if (hasUnsavedChanges && !confirm("âš ï¸ æ‚¨æœ‰æœªå„²å­˜çš„è³‡æ–™ï¼ç¢ºå®šè¦æ¨æ£„è®Šæ›´å—ï¼Ÿ")) {
                return; 
            }
            document.getElementById('edit-modal').style.display = 'none';
            hasUnsavedChanges = false; 
        }

        // --- å‹•æ…‹åˆ—è¡¨ç”¢ç”Ÿå™¨ (ä¿æŒä¸è®Š) ---
        function addOriginRow(data = null) {
            const wrapper = document.getElementById('origin-rows-wrapper');
            const div = document.createElement('div');
            div.className = 'dynamic-row origin-row';
            let valLat = "", valCh = "";
            if (data) {
                if (typeof data === 'string') valLat = data;
                else { valLat = data.lat || ""; valCh = data.ch || ""; }
            }
            div.innerHTML = `
                <input type="text" class="origin-lat" value="${valLat}" placeholder="å­¸å (Ephedra sinica)">
                <input type="text" class="origin-ch" value="${valCh}" placeholder="ä¸­æ–‡ (è‰éº»é»ƒ)">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>
            `;
            wrapper.appendChild(div);
        }

        function addConfusingRow(data = null) {
            const wrapper = document.getElementById('confusing-rows-wrapper');
            const div = document.createElement('div');
            div.className = 'dynamic-row confusing-row';
            let valCh="", valEn="", valNote="";
            if(data) { valCh=data.name_ch||""; valEn=data.name_en||""; valNote=data.note||""; }
            
            div.innerHTML = `
                <div style="flex:1;">
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="text" class="conf-ch" ... placeholder="ä¸­æ–‡å (å»£é˜²å·±)">
            <input type="text" class="conf-en" ... placeholder="å­¸å (Aristolochia fangchi)">
        </div>
        <input type="text" class="conf-note" ... placeholder="å‚™è¨» (ä¾‹å¦‚ï¼šå«é¦¬å…œéˆ´é…¸ï¼Œå…·è…æ¯’æ€§)">
    </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>
            `;
            wrapper.appendChild(div);
        }

        function addChemRow(d) { 
    const w = document.getElementById('chem-rows-wrapper'); 
    const idx = Date.now() + Math.random(); 
    
    // 1. é€™è£¡å®šç¾©åç¨±
    const div = document.createElement('div'); 
    div.className = 'chem-row'; 
    
    // 2. é€™è£¡åç¨±è¦ä¸€è‡´
    div.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
            <input type="text" class="chem-en" placeholder="è‹±æ–‡" value="${d?.name_en || (typeof d==='string'?d:'') || ''}" style="margin:0; flex:1;">
            <input type="text" class="chem-ch" placeholder="ä¸­æ–‡" value="${d?.name_ch || ''}" style="margin:0; flex:1;">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.chem-row').remove()">X</button>
        </div>
        <label style="cursor:pointer; background:#eee; padding:5px; border-radius:5px; font-size:0.8rem; display:block; text-align:center;">
            ğŸ“¸ ä¸Šå‚³çµæ§‹åœ– <input type="file" style="display:none" onchange="handleChemImg(this, 'c-img-${idx}')">
        </label>
        <img id="c-img-${idx}" src="${d?.image || ''}" class="chem-img-preview" style="display:${d?.image ? 'block' : 'none'}">
        <input type="hidden" class="chem-old-img" value="${d?.image || ''}">
        <input type="hidden" class="chem-new-base64">
    `; 
    
    // 3. é€™è£¡ä¹Ÿè¦ä¸€è‡´
    w.appendChild(div); 
}
        // --- åœ–ç‰‡è™•ç† (ä¿æŒä¸è®Š) ---
        function handleImagePreview() {
            const file = document.getElementById('img-input').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image(); img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 800 / img.width; 
                    canvas.width = 800; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    newImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-img').src = newImageBase64;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('img-status').innerText = "æº–å‚™ä¸Šå‚³...";
                }
            };
            reader.readAsDataURL(file);
        }

        function handleChemImg(input, imgId) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const s = 500/img.width; c.width=500; c.height=img.height*s;
                    c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                    const b64 = c.toDataURL('image/jpeg', 0.7);
                    document.getElementById(imgId).src = b64;
                    document.getElementById(imgId).style.display = 'block';
                    input.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.value = b64;
                }
            };
            reader.readAsDataURL(file);
        }

        async function uploadImageToGitHub(base64Data, folder) {
            const fileName = `images/${folder}/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
            const content = base64Data.split(',')[1];
            const res = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${fileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Upload image", content: content })
            });
            if(!res.ok) throw new Error("åœ–ç‰‡ä¸Šå‚³å¤±æ•—");
            const data = await res.json();
            return data.content.download_url;
        }

        // === 6. çµ±ä¸€åŒæ­¥èˆ‡åƒåœ¾æ¡¶é‚è¼¯ ===
        
        // â˜… çµ±ä¸€çš„ä¸Šå‚³åŠŸèƒ½ (æ¸›å°‘é‡è¤‡ä»£ç¢¼)
        async function syncToGitHub(message) {
            try {
                document.getElementById('status-text').innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
                const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(allHerbs, null, 2))));
                const res = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, content: content, sha: sha })
                });
                if(!res.ok) throw new Error("JSON æ›´æ–°å¤±æ•—");
                const data = await res.json();
                sha = data.content.sha;
                
                updateDisplayCount();
                renderTable();
                alert("ğŸ‰ æ“ä½œæˆåŠŸï¼");
                document.getElementById('status-text').innerText = `âœ… å·²é€£ç·š: ${config.repo} (${allHerbs.length}ç­†)`;
                return true;
            } catch(e) { 
                alert("åŒæ­¥å¤±æ•—: " + e.message); 
                return false;
            }
        }

        // â˜… 1. è»Ÿåˆªé™¤ (ç§»è‡³åƒåœ¾æ¡¶)
        async function softDelete(id) {
            if(!confirm("ç¢ºå®šè¦å°‡æ­¤è—¥æç§»è‡³åƒåœ¾æ¡¶å—ï¼Ÿ")) return;
            const herb = allHerbs.find(h => h.id == id);
            if(herb) {
                herb.isTrash = true;
                await syncToGitHub(`Trash ID ${id}`);
            }
        }

        // â˜… 2. é‚„åŸ
        async function restoreHerb(id) {
            const herb = allHerbs.find(h => h.id == id);
            if(herb) {
                herb.isTrash = false;
                await syncToGitHub(`Restore ID ${id}`);
            }
        }

        // â˜… 3. æ°¸ä¹…åˆªé™¤
        async function hardDelete(id) {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ­¤è³‡æ–™ä¸”ç„¡æ³•æ¢å¾©ï¼ç¢ºå®šå—ï¼Ÿ")) return;
            allHerbs = allHerbs.filter(h => h.id != id);
            await syncToGitHub(`Permanent Delete ID ${id}`);
        }

        // â˜… 4. å„²å­˜æ–°å¢/ä¿®æ”¹ (å«è‡ªå‹• ID)
        async function saveAndUpload() {
            const idVal = document.getElementById('edit-id').value;
            const name = document.getElementById('chinese_name').value;
            if(!name) return alert("è«‹è¼¸å…¥ä¸­è—¥å");

            try {
                let finalMainImg = document.getElementById('old-image-path').value;
                if(newImageBase64) {
                    finalMainImg = await uploadImageToGitHub(newImageBase64, 'herbs');
                }

                const chemData = [];
                const rows = document.querySelectorAll('.chem-row');
                for(let row of rows) {
                    const en = row.querySelector('.chem-en').value;
                    const ch = row.querySelector('.chem-ch').value;
                    let cImg = row.querySelector('.chem-old-img').value;
                    const cNew = row.querySelector('.chem-new-base64').value;
                    if(cNew) cImg = await uploadImageToGitHub(cNew, 'structures');
                    if(en || ch) chemData.push({name_en:en, name_ch:ch, image:cImg});
                }

                const originData = [];
                document.querySelectorAll('.origin-row').forEach(row => {
                    const lat = row.querySelector('.origin-lat').value.trim();
                    const ch = row.querySelector('.origin-ch').value.trim();
                    if(lat || ch) originData.push({ lat, ch });
                });

                const confusingData = [];
                document.querySelectorAll('.confusing-row').forEach(row => {
                    const ch = row.querySelector('.conf-ch').value.trim();
                    const en = row.querySelector('.conf-en').value.trim();
                    const note = row.querySelector('.conf-note').value.trim();
                    if(ch || en || note) confusingData.push({ name_ch: ch, name_en: en, note: note });
                });

                // â˜… è‡ªå‹•æµæ°´è™Ÿé‚è¼¯
                let finalId;
                if (idVal) {
                    finalId = parseInt(idVal);
                } else {
                    const maxId = allHerbs.reduce((max, item) => Math.max(max, item.id || 0), 0);
                    finalId = maxId + 1;
                }

                const newHerb = {
                    id: finalId,
                    grade: document.getElementById('edit-grade').value,
                    chinese_name: name,
                    origin: originData,
                    confusing_drugs: confusingData,
                    latin_name: document.getElementById('latin_name').value,
                    part: document.getElementById('part').value.trim(),
                    family_ch: document.getElementById('family_ch').value,
                    family_en: document.getElementById('family_en').value,
                    chem_main: document.getElementById('chem_main').value,
                    chem_sub: document.getElementById('chem_sub').value,
                    chemistry: chemData,
                    effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s),
                    indications: document.getElementById('indications').value,
                    image: finalMainImg,
                    isTrash: false // é è¨­ä¸æ˜¯åƒåœ¾
                };

                if(idVal) {
                    const idx = allHerbs.findIndex(h => h.id == idVal);
                    allHerbs[idx] = newHerb;
                } else {
                    allHerbs.push(newHerb);
                }

                const success = await syncToGitHub(`Update ${name}`);
                if (success) {
                    hasUnsavedChanges = false;
                    document.getElementById('edit-modal').style.display = 'none';
                }
            } catch(e) { alert("å„²å­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤: " + e.message); }
        }
    </script>
</body>
</html>
