<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æ©Ÿç‰ˆå¾Œå° | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .form-container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; } /* font-size 16px é˜²æ­¢æ‰‹æ©Ÿç¸®æ”¾ */
        textarea { height: 80px; }
        .required::after { content: " *"; color: red; }
        
        /* API è¨­å®šå€å¡Š */
        .api-settings { background: #333; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .api-settings.show { display: block; }
        .api-settings input { background: #555; border: none; color: white; margin-bottom: 10px; }
        .toggle-settings { text-align: right; font-size: 0.8rem; color: #666; cursor: pointer; margin-bottom: 10px; text-decoration: underline; }

        /* ç‹€æ…‹è¨Šæ¯ */
        #status-msg { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; text-align: center; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #cce5ff; color: #004085; }
    </style>
</head>
<body>
    <nav>
        <div class="logo">ğŸ“± æ‰‹æ©Ÿå¾Œå°</div>
        <ul class="menu">
            <li><a href="index.html">å›å‰å°</a></li>
        </ul>
    </nav>

    <main>
        <div class="form-container">
            <div class="toggle-settings" onclick="toggleSettings()">âš™ï¸ è¨­å®š GitHub é€£ç·š</div>
            
            <div id="settings-panel" class="api-settings">
                <h4>GitHub é€£ç·šè¨­å®š (åªå­˜æ‰‹æ©Ÿç«¯)</h4>
                <div class="form-group">
                    <label>GitHub ç”¨æˆ¶å (Owner)</label>
                    <input type="text" id="gh_owner" placeholder="ä¾‹å¦‚: yourname">
                </div>
                <div class="form-group">
                    <label>å°ˆæ¡ˆåç¨± (Repo)</label>
                    <input type="text" id="gh_repo" placeholder="ä¾‹å¦‚: tcm-learning">
                </div>
                <div class="form-group">
                    <label>Token (æ¬Šæ–)</label>
                    <input type="password" id="gh_token" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <button class="btn-secondary" onclick="saveSettings()" style="width:100%">å„²å­˜è¨­å®š</button>
            </div>

            <h2>ğŸ“ æ–°å¢ä¸­è—¥</h2>
            
            <div class="form-group">
                <label class="required">ä¸­è—¥å</label>
                <input type="text" id="cname" placeholder="ä¾‹å¦‚ï¼šé»ƒé€£">
            </div>

            <div class="form-group" style="background:#f9f9f9; padding:10px; border-radius:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥å­¸åˆ†é¡</label>
                <div style="display:flex; gap:10px; flex-direction: column;">
                    <select id="chem_main" onchange="updateSubCats()">
                        <option value="">-- å…ˆé¸å¤§åˆ†é¡ --</option>
                    </select>
                    <select id="chem_sub">
                        <option value="">-- å†é¸å­åˆ†é¡ --</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="required">ç§‘å</label>
                <input type="text" id="family">
            </div>
            <div class="form-group">
                <label>å­¸å / åŸºåŸ</label>
                <input type="text" id="latin">
            </div>
            <div class="form-group">
                <label>è—¥ç”¨éƒ¨ä½</label>
                <input type="text" id="part">
            </div>
            <div class="form-group">
                <label>ä¸»è¦æˆåˆ†</label>
                <input type="text" id="chemistry">
            </div>
            <div class="form-group">
                <label>åŠŸæ•ˆ (é€—è™Ÿåˆ†éš”)</label>
                <input type="text" id="effects">
            </div>
            <div class="form-group">
                <label>ä¸»æ²» / ç­†è¨˜</label>
                <textarea id="indication"></textarea>
            </div>
            <div class="form-group">
                <label>å¹´ç´š</label>
                <select id="grade">
                    <option value="å¤§ä¸€">å¤§ä¸€</option>
                    <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                    <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                    <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                </select>
            </div>

            <button class="btn-primary" onclick="uploadToGitHub()" style="width:100%; padding:15px; font-size:1.1rem;">ğŸš€ ä¸Šå‚³ä¸¦å„²å­˜</button>
            
            <div id="status-msg"></div>
        </div>
    </main>

    <script>
        // --- 1. åˆå§‹åŒ–è³‡æ–™èˆ‡é¸å–® ---
        const categories = {
            "é…ç³–é«”": { "en": "Glycosides", "subs": ["å¼·å¿ƒé…é†£é«”", "è”¥é†Œé¡é…é†£é«”", "çš‚ç´ é…é†£é«”", "æ°°è‹·é…é†£é«”", "ç•°ç¡«æ°°é…é†£é«”", "é†‡é¡é…é†£é«”", "é†›é¡é…é†£é«”", "é…šé¡é…é†£é«”", "å…¶ä»–é…é†£é«”"] },
            "ç”Ÿç‰©é¹¼": { "en": "Alkaloids", "subs": ["å¡å•¶-å“Œå•¶é¡", "æ‰˜çƒ·é¡", "å–¹å•‰é¡", "ç•°å–¹å•‰é¡", "å²å“šé¡", "å’ªå”‘é¡", "å˜Œå‘¤é¡", "ç”¾é«”é¡", "å…¶ä»–ç”Ÿç‰©é¹¼"] },
            "å¤šé†£é¡": { "en": "Carbohydrates", "subs": ["æ¾±ç²‰", "æ¨¹è† ", "é»æ¶²è³ª", "æœè† "] },
            "è‹¯ä¸™çƒ·é¡": { "en": "Phenylpropanoids", "subs": ["ç°¡å–®è‹¯ä¸™çƒ·é¡", "é¦™è±†ç´ ", "æœ¨è³ªç´ "] },
            "æœ¨é…šç´ ": { "en": "Lignans", "subs": ["æœ¨é…šç´ ", "æ–°æœ¨é…šç´ "] },
            "é¡é»ƒé…®": { "en": "Flavonoids", "subs": ["é»ƒé…®é¡", "é»ƒé…®é†‡é¡", "ç•°é»ƒé…®é¡", "èŠ±é’ç´ "] },
            "é£è³ª": { "en": "Tannins", "subs": ["æ°´è§£å‹é£è³ª", "ç¸®åˆå‹é£è³ª"] },
            "èœé¡": { "en": "Terpenoids", "subs": ["å–®èœ", "å€åŠèœ", "äºŒèœ", "ä¸‰èœ"] },
            "æ®ç™¼æ²¹": { "en": "Volatile Oils", "subs": ["å«æ°§å–®èœ", "å€åŠèœé¡", "èŠ³é¦™æ—"] },
            "æ¨¹è„‚": { "en": "Resins", "subs": ["æ²¹æ¨¹è„‚", "è† æ¨¹è„‚", "æ²¹è† æ¨¹è„‚", "é¦™æ¨¹è„‚"] },
            "è„‚è³ª": { "en": "Lipids", "subs": ["è„‚è‚ªæ²¹", "è Ÿ"] }
        };

        const mainSelect = document.getElementById('chem_main');
        const subSelect = document.getElementById('chem_sub');

        // å¡«å……é¸å–®
        for (let key in categories) {
            let option = document.createElement("option");
            option.text = key;
            option.value = key;
            mainSelect.add(option);
        }

        function updateSubCats() {
            const selectedMain = mainSelect.value;
            subSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å­åˆ†é¡ --</option>';
            if (selectedMain && categories[selectedMain]) {
                categories[selectedMain].subs.forEach(sub => {
                    let option = document.createElement("option");
                    option.text = sub;
                    option.value = sub;
                    subSelect.add(option);
                });
            }
        }

        // --- 2. è¨­å®šå„²å­˜åŠŸèƒ½ (Local Storage) ---
        // è¼‰å…¥é é¢æ™‚è®€å–è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('gh_owner').value = localStorage.getItem('tcm_owner') || '';
            document.getElementById('gh_repo').value = localStorage.getItem('tcm_repo') || '';
            document.getElementById('gh_token').value = localStorage.getItem('tcm_token') || '';
            
            // å¦‚æœæ²’è¨­å®šéï¼Œè‡ªå‹•æ‰“é–‹è¨­å®šé¢æ¿
            if(!localStorage.getItem('tcm_token')) toggleSettings();
        });

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('show');
        }

        function saveSettings() {
            localStorage.setItem('tcm_owner', document.getElementById('gh_owner').value.trim());
            localStorage.setItem('tcm_repo', document.getElementById('gh_repo').value.trim());
            localStorage.setItem('tcm_token', document.getElementById('gh_token').value.trim());
            alert('è¨­å®šå·²å„²å­˜ï¼ä¸‹æ¬¡ä¸ç”¨å†å¡«äº†ã€‚');
            toggleSettings();
        }

        // --- 3. æ ¸å¿ƒï¼šä¸Šå‚³åˆ° GitHub ---
        async function uploadToGitHub() {
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');
            const token = localStorage.getItem('tcm_token');
            const path = 'data/herbs.json'; // ç›®æ¨™æª”æ¡ˆè·¯å¾‘
            
            const msg = document.getElementById('status-msg');
            
            if (!owner || !repo || !token) {
                alert('è«‹å…ˆé»æ“Šä¸Šæ–¹ã€Œâš™ï¸ è¨­å®šã€å¡«å¯« GitHub é€£ç·šè³‡è¨Šï¼');
                toggleSettings();
                return;
            }

            // æª¢æŸ¥å¿…å¡«
            const cname = document.getElementById('cname').value;
            const family = document.getElementById('family').value;
            if(!cname || !family) { alert('ä¸­è—¥åå’Œç§‘åæ˜¯å¿…å¡«çš„ï¼'); return; }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            msg.style.display = 'block';
            msg.className = 'loading';
            msg.innerText = 'â³ æ­£åœ¨è®€å– GitHub è³‡æ–™åº«...';

            try {
                // (1) å–å¾—ç›®å‰çš„ herbs.json (éœ€è¦ SHA æ‰èƒ½æ›´æ–°)
                const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const getRes = await fetch(getUrl, {
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getRes.ok) throw new Error('è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶å/å°ˆæ¡ˆå/Token æ˜¯å¦æ­£ç¢º');
                const fileData = await getRes.json();
                
                // GitHub çš„å…§å®¹æ˜¯ Base64 ç·¨ç¢¼çš„ï¼Œéœ€è¦è§£ç¢¼ (æ”¯æ´ä¸­æ–‡)
                const content = decodeURIComponent(escape(window.atob(fileData.content)));
                const currentHerbs = JSON.parse(content);
                const fileSha = fileData.sha;

                // (2) æº–å‚™æ–°è³‡æ–™
                const effectsArr = document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
                const newHerb = {
                    id: Date.now(),
                    chinese_name: cname,
                    latin_name: document.getElementById('latin').value || "",
                    family: family,
                    chem_main: document.getElementById('chem_main').value || "",
                    chem_sub: document.getElementById('chem_sub').value || "",
                    used_part: document.getElementById('part').value || "",
                    chemistry: document.getElementById('chemistry').value || "",
                    effects: effectsArr,
                    indications: document.getElementById('indication').value || "",
                    grade: document.getElementById('grade').value,
                    image: "images/placeholder.jpg",
                    wrong_effects: []
                };

                // (3) åŠ å…¥é™£åˆ—
                currentHerbs.push(newHerb);

                // (4) ç·¨ç¢¼å› Base64 (æ”¯æ´ä¸­æ–‡)
                const newContent = JSON.stringify(currentHerbs, null, 2);
                const encodedContent = window.btoa(unescape(encodeURIComponent(newContent)));

                // (5) ä¸Šå‚³æ›´æ–° (PUT)
                msg.innerText = 'ğŸš€ æ­£åœ¨ä¸Šå‚³æ–°è³‡æ–™...';
                const putRes = await fetch(getUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add ${cname} via Mobile Admin`, // Commit è¨Šæ¯
                        content: encodedContent,
                        sha: fileSha // å¿…é ˆé™„ä¸ŠåŸæœ¬çš„ SHA
                    })
                });

                if (putRes.ok) {
                    msg.className = 'success';
                    msg.innerText = `âœ… æˆåŠŸæ–°å¢ã€Œ${cname}ã€ï¼è«‹ç­‰å¾…å¹¾ç§’é˜ç¶²ç«™æ›´æ–°ã€‚`;
                    // æ¸…ç©ºè¡¨å–®ï¼Œä¿ç•™å¹´ç´š
                    const savedGrade = document.getElementById('grade').value;
                    document.querySelectorAll('input:not(#grade), textarea').forEach(el => el.value = '');
                    document.getElementById('grade').value = savedGrade;
                } else {
                    throw new Error('ä¸Šå‚³å¤±æ•—');
                }

            } catch (error) {
                console.error(error);
                msg.className = 'error';
                msg.innerText = `âŒ éŒ¯èª¤ï¼š${error.message}`;
            }
        }
    </script>
</body>
</html>
