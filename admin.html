<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ± | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === æ¨£å¼å€ === */
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; font-family: 'Noto Sans TC', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); margin-bottom: 20px; position: relative; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #4A7C59; color: white; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f8e9; }
        
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        textarea { height: 80px; resize: vertical; }

        .btn { padding: 8px 15px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #4A7C59; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-info { background: #607d8b; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        
        .count-badge { background: #2C5E4F; color: white; padding: 2px 12px; border-radius: 20px; font-size: 0.9rem; margin-left: 10px; vertical-align: middle; }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 400px; max-width: 90%; text-align: center; }
        
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; align-items: flex-start; justify-content: center; padding: 50px 0 100px 0; }
        .modal-content { background: white; width: 600px; max-width: 90%; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 50px; }

        .dynamic-list-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; background: #fafafa; margin-bottom: 15px; }
        .dynamic-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: white; padding: 5px; border: 1px solid #ddd; border-radius: 8px; }
        .chem-row { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .chem-img-preview { max-height: 100px; display: block; margin-top: 10px; border: 1px solid #eee; padding: 5px; background: white; border-radius: 5px; }
        #preview-img { max-height: 200px; border-radius: 8px; display: none; margin: 10px auto; border: 1px solid #ddd; }
        .search-box-wrapper { position: relative; }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 10; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <nav style="background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
        <div class="nav-left">
            <a href="index.html" style="text-decoration:none; font-size:1.2rem; font-weight:bold; color:#2C5E4F;">ğŸŒ¿ å¾Œå°ç®¡ç†ç³»çµ±</a>
        </div>
        <div>
            <span id="status-text" style="font-size:0.9rem; color:#666; margin-right:10px;"></span>
            <button onclick="logout()" class="btn btn-danger" style="font-size:0.9rem;">ğŸšª ç™»å‡º</button>
        </div>
    </nav>

    <main style="max-width: 1000px; margin: 30px auto; padding: 0 15px;">
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap:10px;">
                <h2 style="margin:0; color:#2C5E4F;">
                    <span id="view-title">è—¥æè³‡æ–™åº«ç®¡ç†</span>
                    <span id="herb-total-count" class="count-badge">è¼‰å…¥ä¸­...</span>
                </h2>
                <div class="search-box-wrapper" style="flex:1; max-width: 300px;">
                    <input type="text" id="admin-search" placeholder="ğŸ” æœå°‹ä¸­è—¥ / å­¸å..." oninput="handleSearchInput()" style="margin-bottom:0;">
                    <div id="suggestions" class="suggestions-list"></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="toggle-trash-btn" onclick="toggleTrashView()" class="btn btn-info">ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶</button>
                    <button onclick="openEditModal()" class="btn btn-primary">â• æ–°å¢è—¥æ</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="herb-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å¹´ç´š</th>
                            <th>ä¸­è—¥å</th>
                            <th>åŸºåŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="login-overlay" style="display:none;">
        <div class="login-box">
            <h2 style="color:#2C5E4F;">ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
            <input type="text" id="gh-user" placeholder="GitHub å¸³è™Ÿ">
            <input type="text" id="gh-repo" placeholder="å€‰åº«åç¨±">
            <input type="password" id="gh-token" placeholder="Token (ghp_...)">
            <input type="text" id="gh-path" placeholder="è·¯å¾‘" value="herbs.json">
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="login()">ğŸš€ ç™»å…¥</button>
            <div id="login-msg" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:#2C5E4F;">ç·¨è¼¯è—¥æ</h3>
            <input type="hidden" id="edit-id">
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div><label>å¹´ç´š</label><select id="edit-grade"><option value="å¤§ä¸€">å¤§ä¸€</option><option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option><option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option><option value="å¤§ä¸‰">å¤§ä¸‰</option></select></div>
                <div><label>ä¸­è—¥å *</label><input type="text" id="chinese_name"></div>
            </div>
            <label>åŸºåŸ/å­¸å *</label>
            <div class="dynamic-list-container"><div id="origin-rows-wrapper"></div><button type="button" onclick="addOriginRow()" class="btn btn-sm btn-success" style="width:100%;">+ æ–°å¢åŸºåŸ</button></div>
            <label>ç”Ÿè—¥å</label><input type="text" id="latin_name">
            <label>ç§‘å</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><input type="text" id="family_ch" placeholder="ä¸­æ–‡"><input type="text" id="family_en" placeholder="è‹±æ–‡"></div>
            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin:10px 0;">
                <label>ğŸ§ª åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><select id="chem_main" onchange="updateSubCats()"></select><select id="chem_sub"></select></div>
            </div>
            <label>æˆåˆ† *</label>
            <div class="chem-container"><div id="chem-rows-wrapper"></div><button type="button" onclick="addChemRow()" class="btn btn-primary" style="width:100%;">+ æ–°å¢æˆåˆ†</button></div>
            <label style="margin-top:15px;">åŠŸæ•ˆ</label><input type="text" id="effects" placeholder="é€—è™Ÿåˆ†éš”">
            <label style="color:#d32f2f;">âš ï¸ æ˜“æ··æ·†</label>
            <div class="dynamic-list-container" style="border-color:#ffcdd2; background:#ffebee;"><div id="confusing-rows-wrapper"></div><button type="button" onclick="addConfusingRow()" class="btn btn-sm" style="background:#e57373; color:white; width:100%;">+ æ–°å¢æ˜“æ··æ·†</button></div>
            <label>å‚™è¨»</label><textarea id="indications"></textarea>
            <div style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center;">
                <label>ğŸ“¸ åœ–ç‰‡</label><input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <img id="preview-img" src=""><input type="hidden" id="old-image-path">
            </div>
            <div style="display:flex; gap:15px; margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                <button onclick="closeEditModal()" class="btn" style="background:#90a4ae; color:white; flex:1;">å–æ¶ˆ</button>
                <button onclick="saveAndUpload()" class="btn btn-primary" style="flex:1;">ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script>
        let allHerbs = [];
        let sha = ""; 
        let config = {};
        let newImageBase64 = null; 
        let hasUnsavedChanges = false;
        let currentView = 'active';

        const categories = { "é…ç³–é«”": ["å¼·å¿ƒé…é†£é«”", "è”¥é†Œé¡é…é†£é«”", "çš‚ç´ é…é†£é«”", "æ°°è‹·é…é†£é«”", "ç•°ç¡«æ°°é…é†£é«”", "é†‡é¡é…é†£é«”", "é†›é¡é…é†£é«”", "é…šé¡é…é†£é«”", "å…¶ä»–é…é†£é«”"], "ç”Ÿç‰©é¹¼": ["å¡å•¶-å“Œå•¶é¡", "æ‰˜çƒ·é¡", "å–¹å•‰é¡", "ç•°å–¹å•‰é¡", "å²å“šé¡", "å’ªå”‘é¡", "å˜Œå‘¤é¡", "ç”¾é«”é¡", "å…¶ä»–ç”Ÿç‰©é¹¼"], "å¤šé†£é¡": ["æ¾±ç²‰", "æ¨¹è† ", "é»æ¶²è³ª", "æœè† "], "è‹¯ä¸™çƒ·é¡": ["ç°¡å–®è‹¯ä¸™çƒ·é¡", "é¦™è±†ç´ ", "æœ¨è³ªç´ "], "æœ¨é…šç´ ": ["æœ¨é…šç´ ", "æ–°æœ¨é…šç´ "], "é¡é»ƒé…®": ["é»ƒé…®é¡", "é»ƒé…®é†‡é¡", "ç•°é»ƒé…®é¡", "èŠ±é’ç´ "], "é£è³ª": ["æ°´è§£å‹é£è³ª", "ç¸®åˆå‹é£è³ª"], "èœé¡": ["å–®èœ", "å€åŠèœ", "äºŒèœ", "ä¸‰èœ"], "æ®ç™¼æ²¹": ["å«æ°§å–®èœ", "å€åŠèœé¡", "èŠ³é¦™æ—"], "æ¨¹è„‚": ["æ²¹æ¨¹è„‚", "è† æ¨¹è„‚", "æ²¹è† æ¨¹è„‚", "é¦™æ¨¹è„‚"], "è„‚è³ª": ["è„‚è‚ªæ²¹", "è Ÿ"] };

        document.addEventListener('DOMContentLoaded', () => {
            initCategories();
            const savedConfig = localStorage.getItem('tcm_admin_config');
            if (savedConfig) { config = JSON.parse(savedConfig); loadFromGitHub(); } else { showLogin(); }
        });

        window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; } });

        function initCategories() {
            const mainSel = document.getElementById('chem_main');
            mainSel.innerHTML = '<option value="">-- å¤§åˆ†é¡ --</option>';
            for(let key in categories) { let opt = document.createElement('option'); opt.value = key; opt.text = key; mainSel.add(opt); }
        }
        function updateSubCats() {
            const mainVal = document.getElementById('chem_main').value;
            const subSel = document.getElementById('chem_sub');
            subSel.innerHTML = '<option value="">-- å­åˆ†é¡ --</option>';
            if(mainVal && categories[mainVal]) { categories[mainVal].forEach(sub => { let opt = document.createElement('option'); opt.value = sub; opt.text = sub; subSel.add(opt); }); }
        }

        async function loadFromGitHub(isLoginCheck = false) {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${config.token}` } });
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                sha = data.sha;
                allHerbs = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                if (isLoginCheck) { localStorage.setItem('tcm_admin_config', JSON.stringify(config)); document.getElementById('login-overlay').style.display = 'none'; }
                updateDisplayCount(); renderTable();
            } catch (err) { alert("é€£ç·šéŒ¯èª¤: " + err.message); }
        }

        function updateDisplayCount() {
            const activeList = allHerbs.filter(h => !h.isTrash);
            const trashList = allHerbs.filter(h => h.isTrash);
            document.getElementById('herb-total-count').innerText = `æ­£å¸¸: ${activeList.length} | æ¡¶: ${trashList.length}`;
            document.getElementById('status-text').innerText = `âœ… å·²é€£ç·š: ${config.repo}`;
        }

        function toggleTrashView() {
            currentView = (currentView === 'active') ? 'trash' : 'active';
            document.getElementById('view-title').innerText = (currentView === 'trash') ? 'ğŸ—‘ï¸ åƒåœ¾æ¡¶ç®¡ç†' : 'è—¥æè³‡æ–™åº«ç®¡ç†';
            document.getElementById('toggle-trash-btn').innerText = (currentView === 'trash') ? 'ğŸ”™ å›åˆ°æ¸…å–®' : 'ğŸ—‘ï¸ æŸ¥çœ‹åƒåœ¾æ¡¶';
            renderTable();
        }

        function renderTable(filterList = null) {
            const list = (filterList || allHerbs).filter(h => currentView === 'trash' ? h.isTrash : !h.isTrash);
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            [...list].sort((a,b) => b.id - a.id).forEach(herb => {
                const tr = document.createElement('tr');
                let originPrev = '-';
                if (herb.origin?.length > 0) { const first = herb.origin[0]; originPrev = (typeof first === 'object') ? `${first.lat||''} ${first.ch||''}` : first; }
                
                let actions = currentView === 'active' 
                    ? `<button class="btn btn-edit btn-sm" onclick="openEditModal(${herb.id})">âœï¸</button><button class="btn btn-danger btn-sm" onclick="softDelete(${herb.id})">ğŸ—‘ï¸</button>`
                    : `<button class="btn btn-success btn-sm" onclick="restoreHerb(${herb.id})">âª é‚„åŸ</button><button class="btn btn-danger btn-sm" onclick="hardDelete(${herb.id})">ğŸ”¥ æ°¸ä¹…åˆªé™¤</button>`;

                tr.innerHTML = `<td>${herb.id}</td><td>${herb.grade}</td><td style="font-weight:bold;">${herb.chinese_name}</td><td style="font-size:0.85rem;">${originPrev}</td><td>${actions}</td>`;
                tbody.appendChild(tr);
            });
        }

        async function softDelete(id) {
            if(!confirm("ç¢ºå®šè¦ç§»è‡³åƒåœ¾æ¡¶ï¼Ÿ")) return;
            const herb = allHerbs.find(h => h.id == id);
            if(herb) herb.isTrash = true;
            await syncToGitHub(`Trash ID ${id}`);
        }

        async function restoreHerb(id) {
            const herb = allHerbs.find(h => h.id == id);
            if(herb) herb.isTrash = false;
            await syncToGitHub(`Restore ID ${id}`);
        }

        async function hardDelete(id) {
            if(!confirm("âš ï¸ æ°¸ä¹…åˆªé™¤å¾Œç„¡æ³•æ¢å¾©ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            allHerbs = allHerbs.filter(h => h.id != id);
            await syncToGitHub(`Permanent Delete ID ${id}`);
        }

        async function syncToGitHub(msg) {
            try {
                document.getElementById('status-text').innerText = "â³ åŒæ­¥ä¸­...";
                const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(allHerbs, null, 2))));
                const res = await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${config.path}`, {
                    method: 'PUT', headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, content: content, sha: sha })
                });
                if(!res.ok) throw new Error("åŒæ­¥å¤±æ•—");
                const data = await res.json(); sha = data.content.sha;
                alert("ğŸ‰ æ“ä½œæˆåŠŸï¼");
                updateDisplayCount(); renderTable();
            } catch(e) { alert(e.message); loadFromGitHub(); }
        }

        function openEditModal(id = null) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'flex';
            document.getElementById('edit-id').value = id || "";
            document.getElementById('img-input').value = "";
            newImageBase64 = null;
            hasUnsavedChanges = false;
            document.getElementById('origin-rows-wrapper').innerHTML = ""; 
            document.getElementById('confusing-rows-wrapper').innerHTML = ""; 
            document.getElementById('chem-rows-wrapper').innerHTML = "";

            if (id) {
                const h = allHerbs.find(i => i.id === id);
                document.getElementById('modal-title').innerText = "ç·¨è¼¯è—¥æ";
                document.getElementById('edit-grade').value = h.grade || "å¤§äºŒä¸Š";
                document.getElementById('chinese_name').value = h.chinese_name;
                if(Array.isArray(h.origin)) h.origin.forEach(o => addOriginRow(o)); else addOriginRow(h.origin);
                if(h.confusing_drugs) h.confusing_drugs.forEach(c => addConfusingRow(c));
                document.getElementById('latin_name').value = h.latin_name || "";
                document.getElementById('family_ch').value = h.family_ch || "";
                document.getElementById('family_en').value = h.family_en || "";
                document.getElementById('effects').value = (h.effects || []).join(', ');
                document.getElementById('indications').value = h.indications || "";
                document.getElementById('chem_main').value = h.chem_main || ""; updateSubCats();
                document.getElementById('chem_sub').value = h.chem_sub || "";
                document.getElementById('old-image-path').value = h.image || "";
                document.getElementById('preview-img').src = h.image || ""; document.getElementById('preview-img').style.display = h.image ? 'block' : 'none';
                if(h.chemistry) h.chemistry.forEach(c => addChemRow(c));
            } else {
                document.getElementById('modal-title').innerText = "æ–°å¢è—¥æ";
                document.querySelectorAll('#edit-modal input[type=text], #edit-modal textarea').forEach(e => e.value="");
                addOriginRow(); addChemRow();
            }

            const inputs = document.querySelectorAll('#edit-modal input, #edit-modal textarea, #edit-modal select');
            inputs.forEach(input => { input.oninput = () => hasUnsavedChanges = true; });
        }

        async function saveAndUpload() {
            const name = document.getElementById('chinese_name').value.trim();
            if(!name) return alert("è—¥åå¿…å¡«");
            const idVal = document.getElementById('edit-id').value;
            
            try {
                let finalImg = document.getElementById('old-image-path').value;
                if(newImageBase64) finalImg = await uploadImageToGitHub(newImageBase64, 'herbs');

                const chemData = []; 
                for(let row of document.querySelectorAll('.chem-row')) {
                    const en = row.querySelector('.chem-en').value; const ch = row.querySelector('.chem-ch').value;
                    let cImg = row.querySelector('.chem-old-img').value; const cNew = row.querySelector('.chem-new-base64').value;
                    if(cNew) cImg = await uploadImageToGitHub(cNew, 'structures');
                    if(en || ch) chemData.push({name_en:en, name_ch:ch, image:cImg});
                }

                const originData = []; document.querySelectorAll('.origin-row').forEach(row => { const lat = row.querySelector('.origin-lat').value; const ch = row.querySelector('.origin-ch').value; if(lat || ch) originData.push({lat, ch}); });
                const confusingData = []; document.querySelectorAll('.confusing-row').forEach(row => { const ch = row.querySelector('.conf-ch').value; const en = row.querySelector('.conf-en').value; const nt = row.querySelector('.conf-note').value; if(ch||en||nt) confusingData.push({name_ch:ch, name_en:en, note:nt}); });

                let finalId = idVal ? parseInt(idVal) : (allHerbs.reduce((max, h) => Math.max(max, h.id || 0), 0) + 1);

                const newHerb = { id: finalId, grade: document.getElementById('edit-grade').value, chinese_name: name, origin: originData, confusing_drugs: confusingData, latin_name: document.getElementById('latin_name').value, family_ch: document.getElementById('family_ch').value, family_en: document.getElementById('family_en').value, chem_main: document.getElementById('chem_main').value, chem_sub: document.getElementById('chem_sub').value, chemistry: chemData, effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s), indications: document.getElementById('indications').value, image: finalImg, isTrash: false };

                if(idVal) allHerbs[allHerbs.findIndex(h => h.id == idVal)] = newHerb; else allHerbs.push(newHerb);

                hasUnsavedChanges = false;
                await syncToGitHub(`Update ${name}`);
                document.getElementById('edit-modal').style.display = 'none';
            } catch(e) { alert(e.message); }
        }

        function addOriginRow(d) { const w = document.getElementById('origin-rows-wrapper'); const v = document.createElement('div'); v.className='dynamic-row origin-row'; v.innerHTML=`<input type="text" class="origin-lat" value="${d?.lat||(typeof d==='string'?d:'')}" placeholder="å­¸å"><input type="text" class="origin-ch" value="${d?.ch||''}" placeholder="ä¸­æ–‡"><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v); }
        function addConfusingRow(d) { const w = document.getElementById('confusing-rows-wrapper'); const v = document.createElement('div'); v.className='dynamic-row confusing-row'; v.innerHTML=`<div style="flex:1;"><div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="conf-ch" value="${d?.name_ch||''}" placeholder="ä¸­æ–‡"><input type="text" class="conf-en" value="${d?.name_en||''}" placeholder="å­¸å"></div><input type="text" class="conf-note" value="${d?.note||''}" placeholder="å‚™è¨»"></div><button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v); }
        function addChemRow(d) { const w = document.getElementById('chem-rows-wrapper'); const idx = Date.now()+Math.random(); const v = document.createElement('div'); v.className='chem-row'; v.innerHTML=`<div class="chem-header">ğŸ§ª æˆåˆ†<button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ç§»é™¤</button></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><input type="text" class="chem-en" placeholder="è‹±æ–‡" value="${d?.name_en||(typeof d==='string'?d:'')}"><input type="text" class="chem-ch" placeholder="ä¸­æ–‡" value="${d?.name_ch||''}"></div><label style="cursor:pointer; background:#eee; padding:5px; border-radius:5px; font-size:0.8rem;">ğŸ“¸ çµæ§‹åœ– <input type="file" style="display:none" onchange="handleChemImg(this, 'c-img-${idx}')"></label><img id="c-img-${idx}" src="${d?.image||''}" class="chem-img-preview" style="display:${d?.image?'block':'none'}"><input type="hidden" class="chem-old-img" value="${d?.image||''}"><input type="hidden" class="chem-new-base64">`; w.appendChild(v); }

        function handleSearchInput() {
            const t = document.getElementById('admin-search').value.trim().toLowerCase();
            if(!t) { document.getElementById('suggestions').style.display='none'; renderTable(); return; }
            const matches = allHerbs.filter(h => h.chinese_name.includes(t) || h.latin_name?.toLowerCase().includes(t));
            renderTable(matches);
            const sug = document.getElementById('suggestions'); sug.style.display='block'; sug.innerHTML = matches.slice(0,5).map(h=>`<div class="suggestion-item" onclick="openEditModal(${h.id})">${h.chinese_name}</div>`).join('');
        }

        function handleImagePreview() { const f = document.getElementById('img-input').files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ const i = new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=800/i.width; c.width=800; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); newImageBase64=c.toDataURL('image/jpeg', 0.7); document.getElementById('preview-img').src=newImageBase64; document.getElementById('preview-img').style.display='block'; }; }; r.readAsDataURL(f); }
        function handleChemImg(i, id) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const c=document.createElement('canvas'); const s=500/img.width; c.width=500; c.height=img.height*s; c.getContext('2d').drawImage(img,0,0,c.width,c.height); const b64=c.toDataURL('image/jpeg', 0.7); document.getElementById(id).src=b64; document.getElementById(id).style.display='block'; i.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.value=b64; }; }; r.readAsDataURL(f); }
        async function uploadImageToGitHub(b64, folder) { const fName=`images/${folder}/${Date.now()}.jpg`; const res=await fetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${fName}`,{method:'PUT',headers:{'Authorization':`token ${config.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:"Upload image",content:b64.split(',')[1]})}); if(!res.ok)throw new Error("åœ–å‚³å¤±æ•—"); const data=await res.json(); return data.content.download_url; }
        function showLogin() { document.getElementById('login-overlay').style.display = 'flex'; }
        function login() { config={token:document.getElementById('gh-token').value.trim(),user:document.getElementById('gh-user').value.trim(),repo:document.getElementById('gh-repo').value.trim(),path:document.getElementById('gh-path').value.trim()}; loadFromGitHub(true); }
        function logout() { localStorage.removeItem('tcm_admin_config'); location.reload(); }
        function closeEditModal() { if(hasUnsavedChanges && !confirm("æ¨æ£„è®Šæ›´ï¼Ÿ")) return; document.getElementById('edit-modal').style.display='none'; hasUnsavedChanges=false; }
    </script>
</body>
</html>
