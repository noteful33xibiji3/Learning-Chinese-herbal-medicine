<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›´æ–°è³‡æ–™åº« | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸å®šç¾© (é˜²æ­¢æŒ‰éˆ•éš±å½¢) --- */
        :root {
            --primary: #4A7C59;
            --secondary: #2C5E4F;
            --accent: #E8F5E9;
        }

        /* --- Admin é é¢æ¨£å¼ --- */
        body { background-color: #f4f7f6; font-family: 'Noto Sans TC', sans-serif; }
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { background: #e8f5e9; color: #2e7d32; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .status-bar.error { background: #ffebee; color: #c62828; }
        
        /* --- æœå°‹å€ (æ™ºæ…§æœå°‹æ¨£å¼) --- */
        .search-section { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px dashed #eee; position: relative; }
        .search-box-wrapper { display: flex; gap: 10px; max-width: 500px; margin: 0 auto; position: relative; z-index: 100; }
        .search-input { flex: 1; padding: 12px 20px; border: 2px solid #ddd; border-radius: 50px; font-size: 1.1rem; outline: none; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 4px 10px rgba(74, 124, 89, 0.2); }
        
        /* æ™ºæ…§æœå°‹å»ºè­°é¸å–® */
        .suggestions-list {
            position: absolute; top: 110%; left: 0; right: 0;
            background: white; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            max-height: 300px; overflow-y: auto;
            display: none; text-align: left; border: 1px solid #eee;
        }
        .suggestion-item { padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background-color: #f5f5f5; color: var(--primary); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .action-btn { padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; background: var(--primary); transition: 0.2s; white-space: nowrap; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-new { background: #ff9800; display: block; margin: 20px auto; } 

        /* --- æœå°‹çµæœå¡ç‰‡ (3D ç«‹é«”æ„Ÿå„ªåŒ–) --- */
        .result-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .mini-card { 
            background: white; border: 1px solid #eee; padding: 20px; border-radius: 12px; 
            cursor: pointer; transition: all 0.3s ease; text-align: left;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden;
        }
        .mini-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: #ddd; transition: 0.3s; }
        .mini-card:hover { 
            border-color: transparent; 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
        }
        .mini-card:hover::before { background: var(--primary); }
        .mini-card h4 { margin: 0 0 5px 0; color: #333; font-size: 1.1rem; }
        .mini-card p { margin: 0; font-size: 0.85rem; color: #888; }

        /* è¡¨å–®å€ */
        #edit-form-area { display: none; animation: fadeIn 0.5s; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-title { font-size: 1.5rem; font-weight: bold; color: var(--secondary); margin: 0; }
        .mode-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .mode-update { background: #e3f2fd; color: #1565c0; }
        .mode-create { background: #fff3e0; color: #ef6c00; }

        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 80px; resize: vertical; }
        
        /* åœ–ç‰‡é è¦½ */
        .img-preview-box { text-align: center; margin-top: 10px; }
        #preview-img { max-height: 150px; border-radius: 8px; display: none; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- åŒ–å­¸æˆåˆ†å‹•æ…‹åˆ—è¡¨æ¨£å¼ --- */
        .chem-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #fafafa; }
        .chem-row { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; position: relative; animation: fadeIn 0.3s; }
        .chem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .chem-header h5 { margin: 0; color: #666; }
        .btn-del { background: #ffebee; color: #c62828; border: none; padding: 4px 10px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .btn-del:hover { background: #ef9a9a; color: white; }
        .chem-img-preview { max-height: 100px; display: block; margin-top: 10px; border: 1px solid #eee; padding: 5px; background: white; border-radius: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <nav>
        <div class="logo">ğŸ› ï¸ æ›´æ–°è³‡æ–™åº«</div>
        <ul class="menu">
            <li><a href="index.html">å›å‰å°</a></li>
        </ul>
    </nav>

    <div class="admin-container">
        <div id="status-bar" class="status-bar">
            <span id="status-text">â³ æ­£åœ¨é€£ç·š GitHub è³‡æ–™åº«...</span>
            <button onclick="toggleSettings()" style="background:none; border:none; text-decoration:underline; cursor:pointer; color:inherit;">âš™ï¸ è¨­å®š</button>
        </div>

        <div id="settings-panel" style="display:none; background:#333; color:white; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h4>GitHub é€£ç·šè¨­å®š</h4>
            <input type="text" id="gh_owner" placeholder="Owner (e.g. yourname)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <input type="text" id="gh_repo" placeholder="Repo (e.g. tcm-learning)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <input type="password" id="gh_token" placeholder="Token (ghp_...)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <button onclick="saveSettings()" class="action-btn" style="width:100%;">å„²å­˜ä¸¦é€£ç·š</button>
        </div>

        <div class="search-section">
            <h3 style="margin-bottom:15px; color:#555;">ä½ è¦ç·¨è¼¯å“ªä¸€å‘³è—¥ï¼Ÿ</h3>
            <div class="search-box-wrapper">
                <input type="text" id="admin-search" class="search-input" placeholder="è¼¸å…¥ä¸­è—¥å..." oninput="handleSearchInput()">
                <div id="suggestions" class="suggestions-list"></div>
            </div>
            
            <div id="no-result-msg" style="display:none; margin-top:20px;">
                <p>è³‡æ–™åº«è£¡æ²’æœ‰é€™å‘³è—¥ã€‚</p>
                <button onclick="startCreateNew()" class="action-btn btn-new">â• æ–°å¢æ­¤ä¸­è—¥</button>
            </div>
            
            <div id="search-results" class="result-list"></div>
        </div>

        <div id="edit-form-area">
            <div class="form-header">
                <h3 class="form-title">ğŸ“ ç·¨è¼¯è³‡æ–™</h3>
                <span id="edit-mode-badge" class="mode-badge mode-update">æ›´æ–°æ¨¡å¼</span>
            </div>

            <div class="form-group">
                <label>ä¸­è—¥åç¨± (Chinese Name) *</label>
                <input type="text" id="chinese_name">
            </div>

            <div class="form-group">
                <label>åŸºåŸ/å­¸å (Origin) * <small style="color:var(--primary)">å¦‚æœæ˜¯å¤šåŸºåŸï¼Œè«‹å…¨éƒ¨åˆ—å‡º</small></label>
                <textarea id="origin" placeholder="ä¾‹å¦‚ï¼šEphedra sinica (è‰éº»é»ƒ), Ephedra equisetina (æœ¨è³Šéº»é»ƒ)"></textarea>
            </div>

            <div class="form-group">
                <label>ç”Ÿè—¥å (Latin Name)</label>
                <input type="text" id="latin_name" placeholder="ä¾‹å¦‚ï¼šEphedrae Herba">
            </div>

           <div class="form-group">
                <label>ç§‘å (Family) *</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="family_ch" placeholder="ä¸­æ–‡ (å¦‚: éº»é»ƒç§‘)">
                    <input type="text" id="family_en" placeholder="è‹±æ–‡ (å¦‚: Ephedraceae)">
                </div>
            </div>

            <div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <div class="form-group">
                <label>ä¸»è¦æˆåˆ†èˆ‡çµæ§‹ (Chemical Components) *</label>
                <div class="chem-container">
                    <div id="chem-rows-wrapper"></div>
                    <button type="button" onclick="addChemRow()" class="action-btn" style="background:#4caf50; width:100%; margin-top:10px; box-shadow:none;">+ æ–°å¢ä¸€å€‹æˆåˆ†</button>
                </div>
            </div>

            <div class="form-group">
                <label>åŠŸæ•ˆ (Effects) <small>ç”¨é€—è™Ÿåˆ†éš”</small></label>
                <input type="text" id="effects" placeholder="ç™¼æ±—è§£è¡¨, å®£è‚ºå¹³å–˜">
            </div>

            <div class="form-group">
                <label>å‚™è¨» / ç­†è¨˜ (Indications)</label>
                <textarea id="indications"></textarea>
            </div>

            <div class="form-group">
                <label>å¹´ç´š</label>
                <select id="grade">
                    <option value="å¤§ä¸€">å¤§ä¸€</option>
                    <option value="å¤§äºŒ">å¤§äºŒ</option>
                    <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                    <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                    <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                </select>
            </div>

            <div class="form-group" style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center;">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡ (é¸å¡«)</label>
                <input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <div class="img-preview-box">
                    <img id="preview-img" src="" alt="é è¦½">
                    <p id="img-status" style="font-size:0.8rem; color:#666;"></p>
                </div>
                <input type="hidden" id="old-image-path">
            </div>

            <div style="display:flex; gap:10px; margin-top:30px;">
                <button onclick="cancelEdit()" class="action-btn" style="background:#666; flex:1;">å–æ¶ˆ</button>
                <button onclick="saveAndUpload()" class="action-btn" style="flex:2;">ğŸš€ å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let allHerbs = [];
        let currentHerbId = null; 
        let newImageBase64 = null; 

        // åˆ†é¡è³‡æ–™
        const categories = {
            "é…ç³–é«”": ["å¼·å¿ƒé…é†£é«”", "è”¥é†Œé¡é…é†£é«”", "çš‚ç´ é…é†£é«”", "æ°°è‹·é…é†£é«”", "ç•°ç¡«æ°°é…é†£é«”", "é†‡é¡é…é†£é«”", "é†›é¡é…é†£é«”", "é…šé¡é…é†£é«”", "å…¶ä»–é…é†£é«”"],
            "ç”Ÿç‰©é¹¼": ["å¡å•¶-å“Œå•¶é¡", "æ‰˜çƒ·é¡", "å–¹å•‰é¡", "ç•°å–¹å•‰é¡", "å²å“šé¡", "å’ªå”‘é¡", "å˜Œå‘¤é¡", "ç”¾é«”é¡", "å…¶ä»–ç”Ÿç‰©é¹¼"],
            "å¤šé†£é¡": ["æ¾±ç²‰", "æ¨¹è† ", "é»æ¶²è³ª", "æœè† "],
            "è‹¯ä¸™çƒ·é¡": ["ç°¡å–®è‹¯ä¸™çƒ·é¡", "é¦™è±†ç´ ", "æœ¨è³ªç´ "],
            "æœ¨é…šç´ ": ["æœ¨é…šç´ ", "æ–°æœ¨é…šç´ "],
            "é¡é»ƒé…®": ["é»ƒé…®é¡", "é»ƒé…®é†‡é¡", "ç•°é»ƒé…®é¡", "èŠ±é’ç´ "],
            "é£è³ª": ["æ°´è§£å‹é£è³ª", "ç¸®åˆå‹é£è³ª"],
            "èœé¡": ["å–®èœ", "å€åŠèœ", "äºŒèœ", "ä¸‰èœ"],
            "æ®ç™¼æ²¹": ["å«æ°§å–®èœ", "å€åŠèœé¡", "èŠ³é¦™æ—"],
            "æ¨¹è„‚": ["æ²¹æ¨¹è„‚", "è† æ¨¹è„‚", "æ²¹è† æ¨¹è„‚", "é¦™æ¨¹è„‚"],
            "è„‚è³ª": ["è„‚è‚ªæ²¹", "è Ÿ"]
        };

        document.addEventListener('DOMContentLoaded', () => {
            initCategories();
            loadDatabase();
        });

        function initCategories() {
            const mainSel = document.getElementById('chem_main');
            for(let key in categories) {
                let opt = document.createElement('option');
                opt.value = key; opt.text = key;
                mainSel.add(opt);
            }
        }
        function updateSubCats() {
            const mainVal = document.getElementById('chem_main').value;
            const subSel = document.getElementById('chem_sub');
            subSel.innerHTML = '<option value="">-- å­åˆ†é¡ --</option>';
            if(mainVal && categories[mainVal]) {
                categories[mainVal].forEach(sub => {
                    let opt = document.createElement('option');
                    opt.value = sub; opt.text = sub;
                    subSel.add(opt);
                });
            }
        }

        // --- GitHub é€£ç·šèˆ‡è®€å– ---
        async function loadDatabase() {
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');
            const token = localStorage.getItem('tcm_token');
            const statusText = document.getElementById('status-text');
            const statusBar = document.getElementById('status-bar');

            if (!owner || !repo || !token) {
                statusText.innerText = "âŒ æœªè¨­å®š GitHubï¼Œè«‹é»æ“Šè¨­å®š";
                statusBar.className = "status-bar error";
                toggleSettings();
                return;
            }

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/data/herbs.json`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if(!res.ok) throw new Error("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token");
                
                const data = await res.json();
                const content = decodeURIComponent(escape(window.atob(data.content)));
                allHerbs = JSON.parse(content);
                localStorage.setItem('herbs_sha', data.sha);

                statusText.innerText = `âœ… è³‡æ–™åº«å·²åŒæ­¥ (å…± ${allHerbs.length} ç­†)`;
                statusBar.className = "status-bar";
            } catch (err) {
                console.error(err);
                statusText.innerText = "âŒ è®€å–å¤±æ•—ï¼š" + err.message;
                statusBar.className = "status-bar error";
            }
        }

        // --- æ™ºæ…§æœå°‹åŠŸèƒ½ ---
        function handleSearchInput() {
            const term = document.getElementById('admin-search').value.trim().toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            const resultDiv = document.getElementById('search-results');
            const noResultMsg = document.getElementById('no-result-msg');
            const formArea = document.getElementById('edit-form-area');

            // éš±è—è¡¨å–®å’Œçµæœ
            formArea.style.display = "none";
            noResultMsg.style.display = "none";
            resultDiv.innerHTML = "";

            if (!term) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // æœå°‹åŒ¹é…
            const matches = allHerbs.filter(h => 
                h.chinese_name.includes(term) || 
                (h.latin_name && h.latin_name.toLowerCase().includes(term))
            );

            if (matches.length > 0) {
                // é¡¯ç¤ºä¸‹æ‹‰å»ºè­°
                suggestionsDiv.innerHTML = matches.map(h => `
                    <div class="suggestion-item" onclick="loadHerbToFormByID(${h.id})">
                        <span>${h.chinese_name}</span>
                        <span style="color:#888; font-size:0.85rem;">${h.latin_name || ''}</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';

                // åŒæ™‚é¡¯ç¤º 3D å¡ç‰‡çµæœ
                matches.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'mini-card';
                    div.innerHTML = `<h4>${h.chinese_name}</h4><p>${h.latin_name || ''}</p>`;
                    div.onclick = () => loadHerbToFormByID(h.id);
                    resultDiv.appendChild(div);
                });

            } else {
                suggestionsDiv.style.display = 'none';
                noResultMsg.style.display = 'block'; // é¡¯ç¤ºæ–°å¢æŒ‰éˆ•
            }
        }

        // è¼”åŠ©ï¼šç”¨ ID æ‰¾è—¥æä¸¦è¼‰å…¥
        function loadHerbToFormByID(id) {
            const herb = allHerbs.find(h => h.id === id);
            if(herb) loadHerbToForm(herb);
        }

        // --- è¼‰å…¥è³‡æ–™åˆ°è¡¨å–® ---
        function loadHerbToForm(herb) {
            document.getElementById('suggestions').style.display = 'none'; // é—œé–‰å»ºè­°
            document.getElementById('search-results').innerHTML = ""; 
            document.getElementById('edit-form-area').style.display = "block";
            document.getElementById('edit-mode-badge').innerText = "æ›´æ–°ç¾æœ‰è³‡æ–™";
            document.getElementById('edit-mode-badge').className = "mode-badge mode-update";

            currentHerbId = herb.id;
            document.getElementById('chinese_name').value = herb.chinese_name;
            // --- ä¿®æ”¹å‰ ---
// document.getElementById('origin').value = herb.origin || "";

// --- ä¿®æ”¹å¾Œ (æ”¯æ´ Array èˆ‡ String) ---
const originWrapper = document.getElementById('origin-rows-wrapper');
originWrapper.innerHTML = ""; // å…ˆæ¸…ç©º

if (Array.isArray(herb.origin)) {
    // å¦‚æœå·²ç¶“æ˜¯æ–°æ ¼å¼ (é™£åˆ—)ï¼Œè·‘è¿´åœˆ
    herb.origin.forEach(or => addOriginRow(or));
} else if (herb.origin) {
    // å¦‚æœæ˜¯èˆŠæ ¼å¼ (å­—ä¸²)ï¼Œç”¨é€—è™Ÿåˆ‡é–‹æˆ–æ˜¯ç›´æ¥ç•¶ä½œä¸€æ ¼
    // å‡è¨­ä½ ä»¥å‰æ˜¯ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¯ä»¥ splitï¼Œå¦‚æœä¸æ˜¯å°±ç›´æ¥ä¸Ÿé€²å»
    // é€™è£¡ä¿éšªèµ·è¦‹ï¼Œç›´æ¥ç•¶ä½œä¸€æ ¼
    addOriginRow(herb.origin);
} else {
    addOriginRow(); // ç©ºçš„
}
            document.getElementById('latin_name').value = herb.latin_name || "";
            // ... (å‰é¢çš„ä»£ç¢¼)
            document.getElementById('latin_name').value = herb.latin_name || "";
            
            // â˜… ä¿®æ”¹é€™è£¡ï¼šè®€å–åˆ†é–‹çš„ç§‘å
            document.getElementById('family_ch').value = herb.family_ch || ""; 
            document.getElementById('family_en').value = herb.family_en || "";
            
            // å¦‚æœæ˜¯èˆŠè³‡æ–™åªæœ‰ family æ¬„ä½ï¼Œå˜—è©¦è‡ªå‹•å¡«å…¥è‹±æ–‡æ¬„ä½(æˆ–æ‰‹å‹•è£œ)
            if(herb.family) {
                 // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœèˆŠæ¬„ä½æœ‰å€¼ä½†æ–°æ¬„ä½æ²’å€¼ï¼Œæš«æ™‚å¡«åˆ°ä¸­æ–‡é‚£æ ¼æé†’ä½ æ”¹
                 if(!herb.family_ch && !herb.family_en) document.getElementById('family_ch').value = herb.family;
            }

            document.getElementById('effects').value = (herb.effects || []).join(', ');
            // ... (å¾Œé¢çš„ä»£ç¢¼)
            document.getElementById('effects').value = (herb.effects || []).join(', ');
            document.getElementById('indications').value = herb.indications || "";
            document.getElementById('grade').value = herb.grade || "å¤§äºŒ";
            document.getElementById('old-image-path').value = herb.image || "";

            // åˆ†é¡
            document.getElementById('chem_main').value = herb.chem_main || "";
            updateSubCats();
            document.getElementById('chem_sub').value = herb.chem_sub || "";

            // --- æ ¸å¿ƒä¿®æ”¹ï¼šè®€å–æˆåˆ† ---
            const chemWrapper = document.getElementById('chem-rows-wrapper');
            chemWrapper.innerHTML = "";
            
            if (Array.isArray(herb.chemistry)) {
                herb.chemistry.forEach(item => addChemRow(item));
            } else if (herb.chemistry) {
                // èˆŠæ ¼å¼ç›¸å®¹
                const parts = herb.chemistry.split(/[,ï¼Œ]/);
                parts.forEach(p => addChemRow(p.trim()));
            } else {
                addChemRow();
            }

            // åœ–ç‰‡
            const img = document.getElementById('preview-img');
            if(herb.image && herb.image.startsWith('http')) {
                 img.src = herb.image;
            } else {
                 img.src = ""; 
                 document.getElementById('img-status').innerText = `ç›®å‰åœ–ç‰‡ï¼š${herb.image}`;
            }
            img.style.display = herb.image ? "block" : "none";
            newImageBase64 = null;
            document.getElementById('img-input').value = "";
        }

        // --- é–‹å•Ÿæ–°å¢æ¨¡å¼ ---
        function startCreateNew() {
            const searchTerm = document.getElementById('admin-search').value;
            document.getElementById('no-result-msg').style.display = "none";
            document.getElementById('edit-form-area').style.display = "block";
            document.getElementById('edit-mode-badge').innerText = "æ–°å¢ä¸€ç­†è³‡æ–™";
            document.getElementById('edit-mode-badge').className = "mode-badge mode-create";

            currentHerbId = null; 
            document.querySelectorAll('input, textarea').forEach(el => el.value = "");
            document.getElementById('chinese_name').value = searchTerm;

            // æ¸…ç©ºä¸¦æ–°å¢ä¸€å€‹æˆåˆ†æ ¼
            document.getElementById('chem-rows-wrapper').innerHTML = "";
            addChemRow(); 

            document.getElementById('preview-img').style.display = "none";
            document.getElementById('img-status').innerText = "";
            newImageBase64 = null;
        }

        function cancelEdit() {
            document.getElementById('edit-form-area').style.display = "none";
            document.getElementById('admin-search').value = "";
            document.getElementById('suggestions').style.display = "none";
        }

        // --- åœ–ç‰‡è™•ç† ---
        function handleImagePreview() {
            const file = document.getElementById('img-input').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; 
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    newImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-img').src = newImageBase64;
                    document.getElementById('preview-img').style.display = "block";
                    document.getElementById('img-status').innerText = "æº–å‚™ä¸Šå‚³æ–°åœ–ç‰‡...";
                }
            };
            reader.readAsDataURL(file);
        }

        // --- å‹•æ…‹æˆåˆ†è™•ç†é‚è¼¯ (åªæœ‰é€™ä¸€ä»½ï¼Œä¸æœƒæ‰“æ¶äº†) ---
        // --- ä¿®æ”¹å¾Œçš„ addChemRow (æ”¯æ´ä¸­è‹±æ–‡æˆåˆ†å) ---
        function addChemRow(data = null) {
            const wrapper = document.getElementById('chem-rows-wrapper');
            const idx = Date.now() + Math.floor(Math.random() * 1000);
            
            const div = document.createElement('div');
            div.className = 'chem-row';
            div.id = `row-${idx}`;
            
            // åˆå§‹åŒ–è®Šæ•¸
            let nameEn = "";
            let nameCh = "";
            let imgVal = "";

            if (data) {
                if (typeof data === 'string') {
                    // èˆŠè³‡æ–™ç›¸å®¹ (å¦‚æœåªæœ‰å­—ä¸²ï¼Œé è¨­ç•¶ä½œè‹±æ–‡)
                    nameEn = data; 
                } else {
                    // æ–°è³‡æ–™çµæ§‹
                    nameEn = data.name_en || data.name || ""; // ç›¸å®¹èˆŠçš„ name
                    nameCh = data.name_ch || "";
                    imgVal = data.image || "";
                }
            }

            div.innerHTML = `
                <div class="chem-header">
                    <h5>ğŸ§ª æˆåˆ† #${wrapper.children.length + 1}</h5>
                    <button type="button" class="btn-del" onclick="removeChemRow('row-${idx}')">ç§»é™¤</button>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <input type="text" class="chem-en" placeholder="è‹±æ–‡å (Ephedrine)" value="${nameEn}">
                    <input type="text" class="chem-ch" placeholder="ä¸­æ–‡å (éº»é»ƒé¹¼)" value="${nameCh}">
                </div>

                <div style="font-size:0.9rem;">
                    <label style="display:inline-block; cursor:pointer; background:#eee; padding:5px 10px; border-radius:5px;">
                        ğŸ“¸ ä¸Šå‚³çµæ§‹åœ–
                        <input type="file" accept="image/*" style="display:none" onchange="handleChemImg(this, 'preview-${idx}')">
                    </label>
                    <span style="font-size:0.8rem; color:#888;">(è‡ªå‹•å£“ç¸®)</span>
                </div>
                <img id="preview-${idx}" src="${imgVal}" class="chem-img-preview" style="display:${imgVal ? 'block' : 'none'}">
                <input type="hidden" class="chem-old-img" value="${imgVal}">
                <input type="hidden" class="chem-new-base64">
            `;
            wrapper.appendChild(div);
        }

        function removeChemRow(id) {
            const row = document.getElementById(id);
            if(row) row.remove();
        }

        function handleChemImg(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 600; 
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    const preview = document.getElementById(previewId);
                    preview.src = base64;
                    preview.style.display = 'block';
                    input.closest('.chem-row').querySelector('.chem-new-base64').value = base64;
                }
            };
            reader.readAsDataURL(file);
        }

        // --- æ ¸å¿ƒï¼šå„²å­˜ä¸¦ä¸Šå‚³ ---
        async function saveAndUpload() {
            const owner = localStorage.getItem('tcm_owner');
            const repo = localStorage.getItem('tcm_repo');
            const token = localStorage.getItem('tcm_token');
            const sha = localStorage.getItem('herbs_sha');
            
            if(!document.getElementById('chinese_name').value) {
                alert("è«‹è‡³å°‘å¡«å¯«ä¸­è—¥åç¨±ï¼"); return;
            }

            const statusText = document.getElementById('status-text');
            statusText.innerText = "ğŸš€ æ­£åœ¨è™•ç†åœ–ç‰‡èˆ‡è³‡æ–™...";

            try {
                // 1. è™•ç†ä¸»åœ–ç‰‡
                let mainImagePath = document.getElementById('old-image-path').value || "";
                if(newImageBase64) {
                    statusText.innerText = "æ­£åœ¨ä¸Šå‚³ä¸­è—¥å¤–è§€åœ–...";
                    mainImagePath = await uploadImageToGitHub(owner, repo, token, newImageBase64, 'herbs');
                }

                2. è™•ç†æˆåˆ†åˆ—è¡¨ (æŠ“å–ä¸­è‹±æ–‡)
                const chemRows = document.querySelectorAll('.chem-row');
                const chemistryData = [];
                for (let i = 0; i < chemRows.length; i++) {
                    const row = chemRows[i];
                    const nameEn = row.querySelector('.chem-en').value.trim(); // æŠ“è‹±æ–‡
                    const nameCh = row.querySelector('.chem-ch').value.trim(); // æŠ“ä¸­æ–‡
                    
                    if (!nameEn && !nameCh) continue; // å…©æ ¼éƒ½ç©ºæ‰è·³é

                    const oldImg = row.querySelector('.chem-old-img').value;
                    const newBase64 = row.querySelector('.chem-new-base64').value;
                    let finalChemImg = oldImg; 
                    
                    if (newBase64) {
                        statusText.innerText = `æ­£åœ¨ä¸Šå‚³æˆåˆ†åœ–ç‰‡ (${i+1}/${chemRows.length})...`;
                        finalChemImg = await uploadImageToGitHub(owner, repo, token, newBase64, 'structures');
                    }
                    
                    // â˜… å­˜æˆæ–°æ ¼å¼ç‰©ä»¶
                    chemistryData.push({ 
                        name_en: nameEn, 
                        name_ch: nameCh, 
                        image: finalChemImg 
                    });
                }
                const originRows = document.querySelectorAll('.origin-input');
const originData = [];
originRows.forEach(input => {
    if(input.value.trim()) originData.push(input.value.trim());
});

                // 3. æ•´ç†ç‰©ä»¶
                
                const newHerb = {
                    id: currentHerbId || Date.now(),
                    chinese_name: document.getElementById('chinese_name').value.trim(),
                    origin: originData,
                    latin_name: document.getElementById('latin_name').value.trim(),
                    family_ch: document.getElementById('family_ch').value.trim(),
                    family_en: document.getElementById('family_en').value.trim(),
                    chem_main: document.getElementById('chem_main').value,
                    chem_sub: document.getElementById('chem_sub').value,
                    chemistry: chemistryData, 
                    effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s),
                    indications: document.getElementById('indications').value.trim(),
                    grade: document.getElementById('grade').value,
                    image: mainImagePath
                };

                // 4. æ›´æ–° Array
                if (currentHerbId) {
                    const idx = allHerbs.findIndex(h => h.id === currentHerbId);
                    if(idx !== -1) allHerbs[idx] = newHerb;
                } else {
                    allHerbs.push(newHerb);
                }

                // 5. ä¸Šå‚³
                statusText.innerText = "æ­£åœ¨æ›´æ–°è³‡æ–™åº«...";
                const jsonString = JSON.stringify(allHerbs, null, 2);
                const encodedContent = window.btoa(unescape(encodeURIComponent(jsonString)));

                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data/herbs.json`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${newHerb.chinese_name} (Admin)`,
                        content: encodedContent,
                        sha: sha
                    })
                });

                if(!res.ok) throw new Error("JSON æ›´æ–°å¤±æ•—");
                const data = await res.json();
                localStorage.setItem('herbs_sha', data.content.sha);
                
                statusText.innerText = `âœ… ${newHerb.chinese_name} æ›´æ–°æˆåŠŸï¼`;
                alert("ğŸ‰ æ›´æ–°æˆåŠŸï¼");
                cancelEdit();
                document.getElementById('admin-search').value = "";
                document.getElementById('suggestions').style.display = "none";

            } catch (err) {
                console.error(err);
                alert("ä¸Šå‚³å¤±æ•—ï¼š" + err.message);
                statusText.innerText = "âŒ éŒ¯èª¤";
            }
        }

        async function uploadImageToGitHub(owner, repo, token, base64Data, folder) {
            const fileName = `images/${folder}/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
            const content = base64Data.split(',')[1]; 
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`, {
                method: 'PUT',
                headers: { 
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Upload image to ${folder}`,
                    content: content
                })
            });
            if(!res.ok) throw new Error(`åœ–ç‰‡ä¸Šå‚³å¤±æ•— (${folder})`);
            const result = await res.json();
            return result.content.path; 
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if(panel.style.display === 'block') {
                document.getElementById('gh_owner').value = localStorage.getItem('tcm_owner') || '';
                document.getElementById('gh_repo').value = localStorage.getItem('tcm_repo') || '';
                document.getElementById('gh_token').value = localStorage.getItem('tcm_token') || '';
            }
        }
        function saveSettings() {
            localStorage.setItem('tcm_owner', document.getElementById('gh_owner').value.trim());
            localStorage.setItem('tcm_repo', document.getElementById('gh_repo').value.trim());
            localStorage.setItem('tcm_token', document.getElementById('gh_token').value.trim());
            alert('è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é‡æ–°é€£ç·š...');
            toggleSettings();
            loadDatabase();
        }
    </script>
</body>
</html>
