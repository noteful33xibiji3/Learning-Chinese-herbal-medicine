<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ± | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* === 1. åŸºç¤æ¨£å¼ === */
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; font-family: 'Noto Sans TC', sans-serif; margin: 0; }
        * { box-sizing: border-box; }

        /* === 2. å°è¦½åˆ— === */
        nav {
            background: white; padding: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .nav-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .nav-title { font-weight: bold; color: #4A7C59; white-space: nowrap; }

        /* === 3. ä¸»å€å¡Š (ç»ç’ƒé¢æ¿) === */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); 
            margin-bottom: 20px; 
        }

        /* === 4. è¡¨æ ¼æ¨£å¼ (é›»è…¦ç‰ˆé è¨­) === */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #4A7C59; color: white; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f8e9; }

        /* === 5. æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† === */
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; width: 100%; margin-bottom: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap; }
        .btn-primary { background: #4A7C59; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-info { background: #607d8b; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-sm { padding: 5px 12px; font-size: 0.9rem; }

        /* === 6. æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– (é‡é»ä¿®æ”¹) === */
        @media (max-width: 768px) {
            /* å°è¦½åˆ—èª¿æ•´ */
            nav { flex-direction: column; gap: 10px; padding: 10px; }
            .nav-left { justify-content: center; width: 100%; }
            
            /* æœå°‹å€èˆ‡æŒ‰éˆ•å †ç–Š */
            .top-controls { flex-direction: column; align-items: stretch !important; gap: 15px; }
            .search-box-wrapper { max-width: 100% !important; margin: 0 !important; }
            .btn-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            
            /* â˜… è¡¨æ ¼è®Šå½¢ç‚ºå¡ç‰‡ (Table to Cards) â˜… */
            thead { display: none; } /* éš±è—è¡¨é ­ */
            
            tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 15px;
                background: white;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                padding: 5px 0;
            }
            
            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #f5f5f5;
                padding: 12px 15px;
                font-size: 0.95rem;
                text-align: right;
            }
            
            td:last-child {
                border-bottom: none;
                justify-content: flex-end;
                background: #fafafa;
                border-radius: 0 0 15px 15px;
                padding: 10px 15px;
            }

            /* åˆ©ç”¨ data-label å±¬æ€§é¡¯ç¤ºæ¬„ä½åç¨± */
            td::before {
                content: attr(data-label); /* æŠ“å– JS å¡é€²å»çš„æ¨™é¡Œ */
                font-weight: bold;
                color: #4A7C59;
                text-align: left;
                margin-right: 15px;
                min-width: 70px; /* æ¨™é¡Œå›ºå®šå¯¬åº¦ */
            }
        }

        /* Modal èˆ‡å…¶ä»–æ¨£å¼ç¶­æŒä¸è®Š */
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; align-items: flex-start; justify-content: center; padding: 50px 0; }
        .modal-content { background: white; width: 600px; max-width: 95%; padding: 30px; border-radius: 15px; margin: 0 10px 50px; }
        .dynamic-list-container { border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px; background: #fafafa; margin-bottom: 15px; }
        .dynamic-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: white; padding: 5px; border: 1px solid #ddd; border-radius: 8px; }
        .chem-row { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 10; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        
        @media print {
            nav, .search-box-wrapper, #toggle-trash-btn, .btn-action-group, .btn-edit, .btn-danger, .btn-success { display: none !important; }
            body { background: white; } .glass-panel { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <a href="admin_menu.html" style="text-decoration:none; font-size:1.2rem; font-weight:bold; color:#2C5E4F;">â¬… å›é¸å–®</a>
            <a href="index.html" style="text-decoration:none; background:#e8f5e9; color:#2C5E4F; padding:5px 12px; border-radius:15px; font-size:0.9rem; border:1px solid #4A7C59;">
                ğŸ  å›å‰å°
            </a>
            <span class="nav-title" style="margin-left:5px;">| ä¸­è—¥è³‡æ–™åº«</span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="status-text" style="font-size:0.9rem; color:#666;"></span>
            <button onclick="logout()" class="btn btn-danger" style="font-size:0.85rem;">ğŸšª ç™»å‡º</button>
        </div>
    </nav>

    <main style="max-width: 1000px; margin: 30px auto; padding: 0 15px;">
        <div class="glass-panel">
            <div class="top-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h2 style="margin:0; color:#2C5E4F; display:flex; align-items:center; gap:10px;">
                    <span id="view-title">è—¥ææ¸…å–®</span>
                    <span id="herb-total-count" style="background:#2C5E4F; color:white; padding:2px 10px; border-radius:20px; font-size:0.8rem;">è¼‰å…¥ä¸­...</span>
                </h2>
                
                <div class="search-box-wrapper" style="flex:1; max-width: 300px; position:relative;">
                    <input type="text" id="admin-search" placeholder="ğŸ” æœå°‹ä¸­è—¥ / å­¸å..." oninput="handleSearchInput()" style="margin-bottom:0;">
                    <div id="suggestions" class="suggestions-list"></div>
                </div>
                
                <div class="btn-action-group">
                    <input type="file" id="import-file" accept=".xlsx, .xls" style="display:none;" onchange="importFromExcel(this)">
                    <button onclick="document.getElementById('import-file').click()" class="btn" style="background:#ff9800; color:white;">ğŸ“¥ åŒ¯å…¥</button>
                    <button onclick="exportToExcel()" class="btn" style="background:#217346; color:white;">ğŸ“Š åŒ¯å‡º</button>
                    <button onclick="window.print()" class="btn" style="background:#555; color:white;">ğŸ–¨ï¸ PDF</button>
                    <button id="toggle-trash-btn" onclick="toggleTrashView()" class="btn btn-info">ğŸ—‘ï¸ åƒåœ¾æ¡¶</button>
                    <button onclick="openEditModal()" class="btn btn-primary">â• æ–°å¢</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="herb-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å¹´ç´š</th>
                            <th>ä¸­è—¥å</th>
                            <th>åŸºåŸ</th>
                            <th>æ˜“æ··æ·†</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:#2C5E4F;">ç·¨è¼¯è—¥æ</h3>
            <input type="hidden" id="edit-id">

            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div>
                    <label>å¹´ç´š</label>
                    <select id="edit-grade">
                        <option value="å¤§ä¸€">å¤§ä¸€</option>
                        <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                        <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                        <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                    </select>
                </div>
                <div>
                    <label>ä¸­è—¥å (Chinese Name) *</label>
                    <input type="text" id="chinese_name">
                </div>
            </div>

            <label>åŸºåŸ/å­¸å (Origin) *</label>
            <div class="dynamic-list-container">
                <div id="origin-rows-wrapper"></div>
                <button type="button" onclick="addOriginRow()" class="btn btn-sm" style="background:#81c784; width:100%;">+ æ–°å¢åŸºåŸ</button>
            </div>

            <label>ç”Ÿè—¥å (Latin Name)</label>
            <input type="text" id="latin_name" placeholder="ä¾‹å¦‚ï¼šEphedrae Herba">
            
            <label>è—¥ç”¨éƒ¨ä½ (Medicinal Part)</label>
            <input type="text" id="part" placeholder="ä¾‹å¦‚ï¼šä¹¾ç‡¥è‰è³ªè–">

            <label>ç§‘å (Family)</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="family_ch" placeholder="ä¸­æ–‡ (ä¾‹å¦‚ï¼šéº»é»ƒç§‘)">
                <input type="text" id="family_en" placeholder="è‹±æ–‡ (ä¾‹å¦‚ï¼šEphedraceae)">
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <label>ä¸»è¦æˆåˆ†èˆ‡çµæ§‹ *</label>
            <div class="chem-container">
                <div id="chem-rows-wrapper"></div>
                <button type="button" onclick="addChemRow()" class="btn btn-primary" style="width:100%; margin-top:10px;">+ æ–°å¢æˆåˆ†</button>
            </div>

            <label style="margin-top:15px;">åŠŸæ•ˆ (Effects)</label>
            <input type="text" id="effects" placeholder="è«‹ç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚ï¼šç™¼æ±—, å¹³å–˜)">
            
            <label style="color:#d32f2f;">âš ï¸ æ˜“æ··æ·† (Confusing Drugs)</label>
            <div class="dynamic-list-container" style="border-color:#ffcdd2; background:#ffebee;">
                <div id="confusing-rows-wrapper"></div>
                <button type="button" onclick="addConfusingRow()" class="btn btn-sm" style="background:#e57373; color:white; width:100%;">+ æ–°å¢æ˜“æ··æ·†è—¥æ</button>
            </div>

            <label>å‚™è¨» (Indications) - æ”¯æ´åœ–æ–‡ç·¨è¼¯</label>
            <textarea id="indications"></textarea>

            <div style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center; margin-top:15px;">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡</label>
                <input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <img id="preview-img" src="" style="max-height:200px; display:none; margin:10px auto;">
                <input type="hidden" id="old-image-path">
                <p id="img-status" style="font-size:0.8rem; color:#666;"></p>
            </div>

            <div style="display:flex; gap:15px; margin-top:30px; padding-top:20px; border-top:1px solid #eee;">
                <button onclick="closeEditModal()" class="btn" style="background:#90a4ae; color:white; flex:1; padding:12px;">å–æ¶ˆ</button>
                <button onclick="saveAndUpload()" class="btn btn-primary" style="flex:1; padding:12px;">ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>

    <script>
        // ... (å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ–é‚è¼¯) ...
        let allHerbs = [];
        let sha = ""; 
        let newImageBase64 = null; 
        let hasUnsavedChanges = false;
        let currentView = 'active';
        
        // åˆ†é¡è³‡æ–™
        const categories = {
            "é…ç³–é«” (Glycoside)": ["å¼·å¿ƒé…é†£é«” (Cardiac Glycosides)","è’½é†Œé¡é…é†£é«” (Anthraquinone Glycosides)","çš‚ç´ é…é†£é«” (Saponin Glycosides)","æ°°é¡é…é†£é«” (Cyanogenic Glycosides)","ç•°ç¡«æ°°é…¸é…é†£é«” (Isothiocyanate Glycosides)","é†‡é¡é…é†£é«” (Alcohol Glycosides)","é†›é¡é…é†£é«” (Aldehyde Glycosides)","é…šé¡é…é†£é«” (Phenol Glycosides)"],
            "ç”Ÿç‰©é¹¼ (Alkaloid)": ["å¡å•¶-å“Œå•¶é¡ (Pyridine-Piperidine alkaloid)","æ‰˜çƒ·é¡ (Tropane alkaloid)","å–¹å•‰é¡ (Quinoline alkaloid)","ç•°å–¹å•‰é¡ (Isoquinoline alkaloid)","å’ªå”‘é¡ (Imidazole alkaloid)","å²å“šé¡ (Indole alkaloid)","å˜Œå‘¤é¡ (Purine base / Xanthine)","å›ºé†‡é¡ç”Ÿç‰©é¹¼ (Steroidal alkaloid)","ç”Ÿç‰©é¹¼èƒº (Alkaloidal amine)"],
            "å¤šé†£é¡ (Polysaccharides)": ["åŒè³ªèšé†£ (Homoglycan)","ç•°è³ªèšé†£ (Heteroglycan)"],
            "è‹¯ä¸™çƒ·é¡ (Phenylpropanoids)": ["ç°¡å–®è‹¯ä¸™çƒ·é¡ (Simple phenylpropanoids)","æœ¨é…šç´ å’Œæ–°æœ¨é…šç´  (Lignans and Neolignans)","é¡é»ƒé…® (Flavonoids)","å–®å¯§/é£è³ª (Tannins)","æœ¨è³ªç´  (Lignins)"],
            "èœé¡ (Terpenoids)": ["å–®èœ (Monoterpenoids)","å€åŠèœ (Sesquiterpene)","äºŒèœ (Diterpene)","ä¸‰èœ (Triterpene)","è‚†èœ/é¡èƒ¡è˜¿è””ç´  (Tetraterpene / Carotenoids)"],
            "æ®ç™¼æ²¹ (Volatile oil)": ["èœé¡æ®ç™¼æ²¹ (Terpenoids Volatile)","èŠ³é¦™é¡æ®ç™¼æ²¹ (Aromatic Volatile)","å…¶ä»–æ®ç™¼æ²¹ (Other Volatile)"],
            "æ¨¹è„‚ (Resins)": ["æ¨¹è„‚é¡ (Resins)","æ²¹æ¨¹è„‚é¡ (Oleoresins)","æ²¹è† æ¨¹è„‚é¡ (Oleogumresins)","é¦™è† é¡ (Balsams)"],
            "æ²¹è„‚ (Lipids/Oil)": ["é£½å’Œå›ºå®šæ²¹ (Saturated Fixed Oil)","å–®ä¸é£½å’Œå›ºå®šæ²¹ (Monounsaturated Fixed Oil)","å¤šä¸é£½å’Œå›ºå®šæ²¹ (Polyunsaturated Fixed Oil)","è„‚è‚ªåŠå…¶ç›¸é—œåŒ–åˆç‰© (Fats and Related Compounds)","è Ÿè³ª (Waxes)"]
        };

   document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–ç·¨è¼¯å™¨ (åŠ å…¥åœ–ç‰‡ä¸Šå‚³èˆ‡å£“ç¸®åŠŸèƒ½)
            tinymce.init({
                selector: '#indications', 
                height: 300,
                // â˜… 1. ç¢ºä¿æœ‰ image å¤–æ›
                plugins: 'table lists link image code preview searchreplace autolink fullscreen charmap',
                
                // â˜… 2. å·¥å…·åˆ—è¦æœ‰ image æŒ‰éˆ•
                toolbar: 'undo redo | blocks | bold italic forecolor backcolor | alignleft aligncenter | bullist numlist table link image | code',
                
                branding: false, 
                menubar: false,
                contextmenu: 'cut copy paste pastetext selectall | link image table', 

                // â˜… 3. é—œéµï¼šè‡ªè¨‚åœ–ç‰‡ä¸Šå‚³è™•ç†å™¨ (å«å£“ç¸®)
                images_upload_handler: (blobInfo, progress) => new Promise(async (resolve, reject) => {
                    try {
                        const file = blobInfo.blob(); // å–å¾—åŸå§‹æª”æ¡ˆ
                        
                        // A. åŸ·è¡Œå£“ç¸® (é™åˆ¶å¯¬åº¦ 800px, å“è³ª 0.7)
                        const compressedBase64 = await compressFile(file, 0.7, 800);
                        
                        // B. ä¸Šå‚³åˆ° GitHub (å­˜åˆ° images/notes/ è³‡æ–™å¤¾)
                        // æ³¨æ„ï¼šé€™è£¡å‘¼å«æ‚¨åŸæœ¬å¯«å¥½çš„ uploadBase64 å‡½å¼
                        const imageUrl = await uploadBase64(compressedBase64, 'notes');
                        
                        // C. å‘Šè¨´ç·¨è¼¯å™¨åœ–ç‰‡ç¶²å€ (æˆåŠŸ)
                        resolve(imageUrl);
                    } catch (e) {
                        console.error(e);
                        reject("åœ–ç‰‡ä¸Šå‚³å¤±æ•—: " + e.message);
                    }
                }),

                // æ‰‹æ©Ÿç‰ˆè¨­å®š
                mobile: { theme: 'silver', toolbar_mode: 'wrap' },
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; color: #333; } img { max-width: 100%; height: auto; }'
            });
            initCategories();
            const savedConfig = localStorage.getItem('tcm_admin_config');
            if (!savedConfig) { alert("è«‹å…ˆç™»å…¥ï¼"); window.location.href = 'admin_menu.html'; return; }
            const config = JSON.parse(savedConfig);
            try { await initGitHubConfig(config.token, config.user, config.repo); await loadData(); } 
            catch (e) { alert("é€£ç·šå¤±æ•—ï¼š" + e.message); window.location.href = 'admin_menu.html'; }
        });

        async function loadData() {
            try {
                const result = await fetchJSON('data/herbs.json');
                allHerbs = result.data; sha = result.sha;
                updateDisplayCount(); renderTable();
            } catch (e) { if (e.message.includes('404')) { allHerbs = []; renderTable(); } else throw e; }
        }

        // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ¸²æŸ“è¡¨æ ¼æ™‚åŠ å…¥ data-label å±¬æ€§ï¼Œè®“ CSS çŸ¥é“æ¬„ä½åç¨±
        function renderTable(filterList = null) {
            const list = filterList || allHerbs;
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            const displayList = list.filter(h => currentView === 'trash' ? h.isTrash : !h.isTrash);

            [...displayList].sort((a,b) => b.id - a.id).forEach(herb => {
                const tr = document.createElement('tr');
                let originPrev = '-';
                if (herb.origin) {
                    if (Array.isArray(herb.origin) && herb.origin.length > 0) {
                        const first = herb.origin[0];
                        originPrev = (typeof first === 'object') ? `${first.lat||''} ${first.ch||''}` : first;
                        if (herb.origin.length > 1) originPrev += ' ...';
                    } else if (typeof herb.origin === 'string') originPrev = herb.origin;
                }
                
                let confusingPrev = herb.confusing_drugs && herb.confusing_drugs.length > 0 ? `<span style="color:#d32f2f; font-weight:bold;">âš ï¸ ${herb.confusing_drugs.length}</span>` : '-';
                
                let actionButtons = currentView === 'active' 
                    ? `<button class="btn btn-edit btn-sm" onclick="openEditModal(${herb.id})">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="softDelete(${herb.id})">ğŸ—‘ï¸</button>`
                    : `<button class="btn btn-success btn-sm" onclick="restoreHerb(${herb.id})">âª</button> <button class="btn btn-danger btn-sm" onclick="hardDelete(${herb.id})">ğŸ”¥</button>`;

                // â˜… é€™è£¡åŠ å…¥äº† data-label="..."
                tr.innerHTML = `
                    <td data-label="ID">${herb.id}</td>
                    <td data-label="å¹´ç´š"><span style="background:#e8f5e9; color:#2C5E4F; padding:2px 8px; border-radius:10px; font-size:0.85rem;">${herb.grade}</span></td>
                    <td data-label="ä¸­è—¥å" style="font-weight:bold;">${herb.chinese_name}</td>
                    <td data-label="åŸºåŸ" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${originPrev}">${originPrev}</td>
                    <td data-label="æ˜“æ··æ·†">${confusingPrev}</td>
                    <td data-label="æ“ä½œ">${actionButtons}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ... (Excel åŒ¯å‡º/åŒ¯å…¥é‚è¼¯ï¼Œä¿æŒæ‚¨åŸæœ¬çš„å¼·å¤§ç‰ˆæœ¬) ...
        function exportToExcel() {
            if (allHerbs.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
            const exportData = allHerbs.map(h => {
                const originStr = Array.isArray(h.origin) ? h.origin.map(o => (typeof o==='object' ? `${o.lat} [${o.ch}]` : o)).join('\n') : h.origin;
                const chemStr = Array.isArray(h.chemistry) ? h.chemistry.map(c => (typeof c==='object' ? `${c.name_en} [${c.name_ch}]` : c)).join('\n') : h.chemistry;
                const confStr = h.confusing_drugs ? h.confusing_drugs.map(c => `${c.name_ch} (${c.name_en}) [${c.note}]`).join('\n') : '';
                return {
                    "ID": h.id, "å¹´ç´š": h.grade, "ä¸­æ–‡å": h.chinese_name, "ç”Ÿè—¥å": h.latin_name,
                    "åŸºåŸ(åˆ—è¡¨)": originStr, "ç§‘å(ä¸­)": h.family_ch, "ç§‘å(è‹±)": h.family_en,
                    "éƒ¨ä½": h.part, "å¤§åˆ†é¡": h.chem_main, "å­åˆ†é¡": h.chem_sub,
                    "æˆåˆ†(åˆ—è¡¨)": chemStr, "åŠŸæ•ˆ": (h.effects || []).join(', '),
                    "æ˜“æ··æ·†(åˆ—è¡¨)": confStr, "å‚™è¨»(HTML)": h.indications, "ç‹€æ…‹": h.isTrash ? "åƒåœ¾æ¡¶" : "æ­£å¸¸"
                };
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ä¸­è—¥è³‡æ–™");
            XLSX.writeFile(wb, `ä¸­è—¥è³‡æ–™åº«_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // === åŒ¯å…¥ Excel (ä¸­è—¥å¾Œå°å°ˆç”¨ç‰ˆ) ===
        async function importFromExcel(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥å°‡è¦†è“‹è³‡æ–™ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
                input.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);

                    if (json.length === 0) return alert("æª”æ¡ˆæ˜¯ç©ºçš„");

                    let updateCount = 0, addCount = 0;
                    let newList = [...allHerbs];

                    json.forEach(row => {
                        // 1. è§£æåŸºåŸ
                        const originRaw = row["åŸºåŸ(åˆ—è¡¨)"] || row["åŸºåŸ"];
                        let originArr = [];
                        if (originRaw) {
                            originArr = originRaw.split(/[\n;]/).map(s => s.trim()).filter(s => s).map(s => {
                                const m = s.match(/^(.*?)(?:\s*\[(.*?)\])?$/);
                                return m ? { lat: m[1].trim(), ch: m[2] ? m[2].trim() : "" } : s;
                            });
                        }

                        // 2. è§£ææˆåˆ†
                        const chemRaw = row["æˆåˆ†(åˆ—è¡¨)"] || row["æˆåˆ†"];
                        let chemArr = [];
                        if (chemRaw) {
                            chemArr = chemRaw.split(/[\n;]/).map(s => s.trim()).filter(s => s).map(s => {
                                const m = s.match(/^(.*?)(?:\s*\[(.*?)\])?$/);
                                return m ? { name_en: m[1].trim(), name_ch: m[2] ? m[2].trim() : "", image: "" } : { name_en: s };
                            });
                        }

                        // 3. è§£ææ˜“æ··æ·†
                        const confRaw = row["æ˜“æ··æ·†(åˆ—è¡¨)"] || row["æ˜“æ··æ·†"];
                        let confArr = [];
                        if (confRaw) {
                            confArr = confRaw.split(/[\n;]/).map(s => s.trim()).filter(s => s).map(s => {
                                const m = s.match(/^(.*?)(?:\s*\((.*?)\))?(?:\s*\[(.*?)\])?$/);
                                return m ? { name_ch: m[1].trim(), name_en: m[2] ? m[2].trim() : "", note: m[3] ? m[3].trim() : "" } : { name_ch: s };
                            });
                        }

                        // 4. å»ºç«‹æ–°ç‰©ä»¶ (æ³¨æ„é€™è£¡çš„é€—è™Ÿå’Œæ‹¬è™Ÿ)
                        const newItem = {
                            id: row["ID"] ? parseInt(row["ID"]) : (Date.now() + Math.floor(Math.random() * 1000)),
                            grade: row["å¹´ç´š"] || "å¤§ä¸€",
                            chinese_name: row["ä¸­æ–‡å"] || "",
                            latin_name: row["ç”Ÿè—¥å"] || "",
                            origin: originArr,
                            family_ch: row["ç§‘å(ä¸­)"] || "",
                            family_en: row["ç§‘å(è‹±)"] || "",
                            part: row["éƒ¨ä½"] || "",
                            chem_main: row["å¤§åˆ†é¡"] || "",
                            chem_sub: row["å­åˆ†é¡"] || "",
                            chemistry: chemArr,
                            confusing_drugs: confArr,
                            effects: (row["åŠŸæ•ˆ"] || "").split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s),
                            indications: row["å‚™è¨»(HTML)"] || "",
                            isTrash: row["ç‹€æ…‹"] === "åƒåœ¾æ¡¶",
                            image: ""
                        }; // <--- é€™è£¡ä¸€å®šè¦æœ‰åˆ†è™Ÿï¼Œä¹‹å‰çš„éŒ¯èª¤å¯èƒ½å°±æ˜¯å› ç‚ºé€™è£¡æœ‰å•é¡Œ

                        // 5. â˜…â˜…â˜… åˆ¤æ–·é‡è¤‡é‚è¼¯ (ID æˆ– ä¸­æ–‡å) â˜…â˜…â˜…
                        const idx = newList.findIndex(h => 
                            (row["ID"] && h.id == row["ID"]) || // å¦‚æœ Excel æœ‰ IDï¼Œå„ªå…ˆæ¯”å° ID
                            (!row["ID"] && h.chinese_name === newItem.chinese_name) // å¦‚æœ Excel æ²’ IDï¼Œæ¯”å°ä¸­æ–‡å
                        );

                        if (idx !== -1) {
                            // æ›´æ–°èˆŠè³‡æ–™
                            const old = newList[idx];
                            
                            // å¼·åˆ¶æ²¿ç”¨èˆŠ ID
                            newItem.id = old.id;
                            
                            // ä¿ç•™èˆŠåœ–ç‰‡
                            newItem.image = old.image;
                            
                            // ä¿ç•™æˆåˆ†åœ–ç‰‡
                            if (old.chemistry) {
                                newItem.chemistry = newItem.chemistry.map(newC => {
                                    const oldC = old.chemistry.find(oc => oc.name_en === newC.name_en);
                                    if (oldC && oldC.image) newC.image = oldC.image;
                                    return newC;
                                });
                            }
                            
                            newList[idx] = { ...old, ...newItem };
                            updateCount++;
                        } else {
                            // æ–°å¢è³‡æ–™
                            newList.push(newItem);
                            addCount++;
                        }
                    });

                    // 6. å„²å­˜èˆ‡æ›´æ–°
                    await saveJSON('data/herbs.json', newList, sha, `Import Excel`);
                    const res = await fetchJSON('data/herbs.json');
                    allHerbs = res.data;
                    sha = res.sha;
                    updateDisplayCount();
                    renderTable();
                    alert(`åŒ¯å…¥å®Œæˆï¼\næ–°å¢ï¼š${addCount} ç­†\næ›´æ–°ï¼š${updateCount} ç­†`);

                } catch (e) {
                    console.error(e);
                    alert("åŒ¯å…¥å¤±æ•—: " + e.message);
                } finally {
                    input.value = "";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function syncToGitHub(message) {
            try {
                document.getElementById('status-text').innerText = "â³ åŒæ­¥ä¸­...";
                const res = await saveJSON('data/herbs.json', allHerbs, sha, message);
                sha = res.content.sha; updateDisplayCount(); renderTable();
                alert("ğŸ‰ æ“ä½œæˆåŠŸï¼"); document.getElementById('status-text').innerText = `âœ… å·²é€£ç·š (${allHerbs.length}ç­†)`;
                return true;
            } catch(e) { alert("åŒæ­¥å¤±æ•—: " + e.message); return false; }
        }

        // ... (å…¶ä»–è¼”åŠ©å‡½å¼ï¼šinitCategories, updateSubCats, logout ç­‰ç­‰) ...
        function initCategories() { const m=document.getElementById('chem_main'); for(let k in categories){let o=document.createElement('option');o.value=k;o.text=k;m.add(o);} }
        function updateSubCats() { const v=document.getElementById('chem_main').value; const s=document.getElementById('chem_sub'); s.innerHTML='<option value="">-- å­åˆ†é¡ --</option>'; if(v&&categories[v]) categories[v].forEach(sub=>{let o=document.createElement('option');o.value=sub;o.text=sub;s.add(o);}); }
        function updateDisplayCount() { const c=document.getElementById('herb-total-count'); if(c) c.innerText=`æ­£å¸¸: ${allHerbs.filter(h=>!h.isTrash).length} | æ¡¶: ${allHerbs.filter(h=>h.isTrash).length}`; }
        function logout() { if(confirm("ç¢ºå®šç™»å‡º?")) { localStorage.removeItem('tcm_admin_config'); window.location.href='admin_menu.html'; } }
        
        function toggleTrashView() { 
            const b=document.getElementById('toggle-trash-btn'); const t=document.getElementById('view-title');
            if(currentView==='active'){ currentView='trash'; b.innerText="ğŸ”™ å›åˆ°æ¸…å–®"; b.style.background="#455a64"; t.innerText="ğŸ—‘ï¸ åƒåœ¾æ¡¶"; }
            else{ currentView='active'; b.innerText="ğŸ—‘ï¸ åƒåœ¾æ¡¶"; b.style.background="#607d8b"; t.innerText="è—¥ææ¸…å–®"; }
            renderTable();
        }
        
        function handleSearchInput() {
            const v=document.getElementById('admin-search').value.trim().toLowerCase();
            const s=document.getElementById('suggestions');
            if(!v){ s.style.display='none'; renderTable(); return; }
            const m=allHerbs.filter(h=>(h.chinese_name&&h.chinese_name.includes(v))||(h.latin_name&&h.latin_name.toLowerCase().includes(v)));
            renderTable(m);
            if(m.length>0){ s.innerHTML=m.slice(0,5).map(h=>`<div class="suggestion-item" onclick="openEditModal(${h.id})"><span>${h.chinese_name}</span></div>`).join(''); s.style.display='block'; }
            else s.style.display='none';
        }

        // ... (ç·¨è¼¯è¦–çª—é‚è¼¯ï¼Œèˆ‡ä¹‹å‰ç›¸åŒ) ...
        function openEditModal(id=null) {
            const m=document.getElementById('edit-modal'); m.style.display='flex';
            document.getElementById('edit-id').value=id||""; document.getElementById('img-input').value="";
            document.getElementById('suggestions').style.display='none'; newImageBase64=null; hasUnsavedChanges=false;
            document.getElementById('origin-rows-wrapper').innerHTML=""; document.getElementById('confusing-rows-wrapper').innerHTML=""; document.getElementById('chem-rows-wrapper').innerHTML="";
            tinymce.get('indications').setContent("");
            
            if(id){
                const h=allHerbs.find(i=>i.id===id);
                document.getElementById('modal-title').innerText="ç·¨è¼¯è—¥æ";
                document.getElementById('edit-grade').value=h.grade; document.getElementById('chinese_name').value=h.chinese_name;
                if(Array.isArray(h.origin)) h.origin.forEach(o=>addOriginRow(o)); else addOriginRow(h.origin);
                if(h.confusing_drugs) h.confusing_drugs.forEach(c=>addConfusingRow(c));
                document.getElementById('latin_name').value=h.latin_name||""; document.getElementById('part').value=h.part||"";
                document.getElementById('family_ch').value=h.family_ch||""; document.getElementById('family_en').value=h.family_en||"";
                document.getElementById('effects').value=(h.effects||[]).join(', ');
                tinymce.get('indications').setContent(h.indications||"");
                document.getElementById('chem_main').value=h.chem_main||""; updateSubCats(); document.getElementById('chem_sub').value=h.chem_sub||"";
                document.getElementById('old-image-path').value=h.image||"";
                const p=document.getElementById('preview-img'); p.src=h.image||""; p.style.display=h.image?'block':'none';
                document.getElementById('img-status').innerText=h.image?"âœ… æ—¢æœ‰åœ–ç‰‡":"";
                if(h.chemistry){ let l=Array.isArray(h.chemistry)?h.chemistry:(typeof h.chemistry==='string'?h.chemistry.split(/[,ï¼Œ]/).map(s=>({name_en:s})):[]); l.forEach(c=>addChemRow(c)); } else addChemRow();
            } else {
                document.getElementById('modal-title').innerText="æ–°å¢è—¥æ";
                document.querySelectorAll('#edit-modal input[type=text], #edit-modal textarea').forEach(e=>e.value="");
                addOriginRow(); addChemRow(); document.getElementById('preview-img').style.display='none';
            }
            document.querySelectorAll('#edit-modal input, #edit-modal textarea, #edit-modal select').forEach(i=>i.oninput=()=>{hasUnsavedChanges=true;});
        }
        function closeEditModal() { if(hasUnsavedChanges&&!confirm("âš ï¸ æ¨æ£„è®Šæ›´ï¼Ÿ"))return; document.getElementById('edit-modal').style.display='none'; hasUnsavedChanges=false;tinymce.get('indications').fire('blur');}
        
        function addOriginRow(d) { const w=document.getElementById('origin-rows-wrapper'); const v=document.createElement('div'); v.className='dynamic-row origin-row'; v.innerHTML=`<input type="text" class="origin-lat" value="${d?.lat||(typeof d==='string'?d:'')}" placeholder="å­¸å"><input type="text" class="origin-ch" value="${d?.ch||''}" placeholder="ä¸­æ–‡"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v); }
        function addConfusingRow(d) { const w=document.getElementById('confusing-rows-wrapper'); const v=document.createElement('div'); v.className='dynamic-row confusing-row'; v.innerHTML=`<div style="flex:1"><div style="display:flex;gap:5px"><input class="conf-ch" value="${d?.name_ch||''}" placeholder="ä¸­æ–‡"><input class="conf-en" value="${d?.name_en||''}" placeholder="å­¸å"></div><input class="conf-note" value="${d?.note||''}" placeholder="å‚™è¨»"></div><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`; w.appendChild(v); }
        function addChemRow(d) { const w=document.getElementById('chem-rows-wrapper'); const idx=Math.floor(Date.now()+Math.random()*1000); const v=document.createElement('div'); v.className='chem-row'; let nEn="", nCh="", img=""; if(d){ if(typeof d==='string') nEn=d; else{ nEn=d.name_en||d.name||""; nCh=d.name_ch||""; img=d.image||""; } } v.innerHTML=`<div style="display:flex;gap:10px;margin-bottom:8px"><input class="chem-en" value="${nEn}" placeholder="è‹±æ–‡"><input class="chem-ch" value="${nCh}" placeholder="ä¸­æ–‡"><button class="btn btn-danger btn-sm" onclick="this.closest('.chem-row').remove()">X</button></div><label style="cursor:pointer;background:#eee;padding:5px;border-radius:5px;display:block;text-align:center">ğŸ“¸ ä¸Šå‚³çµæ§‹ <input type="file" style="display:none" onchange="handleChemImg(this,'c-${idx}')"></label><img id="c-${idx}" src="${img}" class="chem-img-preview" style="display:${img?'block':'none'}"><input type="hidden" class="chem-old-img" value="${img}"><input type="hidden" class="chem-new-base64">`; w.appendChild(v); }
        
        function handleImagePreview() { const f=document.getElementById('img-input').files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=800/i.width; c.width=800; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); newImageBase64=c.toDataURL('image/jpeg',0.7); const p=document.getElementById('preview-img'); p.src=newImageBase64; p.style.display='block'; document.getElementById('img-status').innerText="âœ… æº–å‚™ä¸Šå‚³"; }}; r.readAsDataURL(f); }
        function handleChemImg(ip,id) { const f=ip.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=500/i.width; c.width=500; c.height=i.height*s; c.getContext('2d').drawImage(i,0,0,c.width,c.height); const b=c.toDataURL('image/jpeg',0.7); document.getElementById(id).src=b; document.getElementById(id).style.display='block'; ip.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.value=b; }}; r.readAsDataURL(f); }

        // === âœ… ä¿®æ­£ç‰ˆï¼šå„²å­˜ä¸¦ä¸Šå‚³ (å«æˆåˆ†åœ–ç‰‡è‡ªå‹•ä¸Šå‚³) ===
        async function saveAndUpload() {
            const name = document.getElementById('chinese_name').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥ä¸­è—¥å");

            // 1. æª¢æŸ¥é‡è¤‡åç¨±
            const idVal = document.getElementById('edit-id').value;
            const sameNameItem = allHerbs.find(h => h.chinese_name === name && h.id != idVal);
            if (sameNameItem) {
                if (!confirm(`âš ï¸ è­¦å‘Šï¼šè³‡æ–™åº«ä¸­å·²ç¶“æœ‰ã€Œ${name}ã€(ID: ${sameNameItem.id}) äº†ï¼\n\næŒ‰ã€Œç¢ºå®šã€å°‡æœƒè¦†è“‹æ›´æ–°èˆŠè³‡æ–™ã€‚\næŒ‰ã€Œå–æ¶ˆã€å‰‡å»ºç«‹ä¸€ç­†æ–°çš„é‡è¤‡è³‡æ–™ã€‚`)) {
                    // å–æ¶ˆå‰‡å»ºç«‹æ–°è³‡æ–™
                } else {
                    // ç¢ºå®šå‰‡è¦†è“‹
                    document.getElementById('edit-id').value = sameNameItem.id;
                }
            }

            const btn = document.querySelector('#edit-modal .btn-primary');
            btn.innerText = "â³ è™•ç†ä¸­... (ä¸Šå‚³åœ–ç‰‡å¯èƒ½éœ€è¦æ™‚é–“)";
            btn.disabled = true;

            try {
                // 2. ä¸Šå‚³ä¸»åœ–ç‰‡
                let fImg = document.getElementById('old-image-path').value;
                if (newImageBase64) {
                    fImg = await uploadBase64(newImageBase64, 'herbs'); // ä¸Šå‚³ä¸»åœ–
                }

                // 3. â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šä¸Šå‚³æˆåˆ†åœ–ç‰‡ â˜…â˜…â˜…
                const cData = [];
                const chemRows = document.querySelectorAll('.chem-row');
                
                // ä½¿ç”¨ for...of è¿´åœˆä»¥æ”¯æ´ await
                for (const r of chemRows) {
                    const en = r.querySelector('.chem-en').value.trim();
                    const ch = r.querySelector('.chem-ch').value.trim();
                    let ci = r.querySelector('.chem-old-img').value; // èˆŠåœ–é€£çµ
                    const cn = r.querySelector('.chem-new-base64').value; // æ–°åœ– Base64

                    // å¦‚æœæœ‰æ–°é¸çš„åœ–ç‰‡ (Base64)ï¼Œå°±ä¸Šå‚³
                    if (cn) {
                        try {
                            // ä¸Šå‚³åˆ° GitHub images/chem/ è³‡æ–™å¤¾
                            ci = await uploadBase64(cn, 'chem'); 
                        } catch (err) {
                            console.error("æˆåˆ†åœ–ç‰‡ä¸Šå‚³å¤±æ•—:", err);
                            alert(`æˆåˆ† ${en || ch} çš„åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œå°‡ä¸æœƒé¡¯ç¤ºåœ–ç‰‡ã€‚`);
                        }
                    }

                    if (en || ch) {
                        cData.push({ name_en: en, name_ch: ch, image: ci });
                    }
                }

                // 4. æ”¶é›†å…¶ä»–è³‡æ–™
                const oData = [];
                document.querySelectorAll('.origin-row').forEach(r => {
                    const l = r.querySelector('.origin-lat').value;
                    const c = r.querySelector('.origin-ch').value;
                    if (l || c) oData.push({ lat: l, ch: c });
                });

                const confData = [];
                document.querySelectorAll('.confusing-row').forEach(r => {
                    const c = r.querySelector('.conf-ch').value;
                    const e = r.querySelector('.conf-en').value;
                    const n = r.querySelector('.conf-note').value;
                    if (c || e || n) confData.push({ name_ch: c, name_en: e, note: n });
                });

                const finalId = document.getElementById('edit-id').value ? parseInt(document.getElementById('edit-id').value) : (allHerbs.reduce((m, h) => Math.max(m, h.id || 0), 0) + 1);
                
                const newItem = {
                    id: finalId,
                    grade: document.getElementById('edit-grade').value,
                    chinese_name: name,
                    origin: oData,
                    confusing_drugs: confData,
                    latin_name: document.getElementById('latin_name').value,
                    part: document.getElementById('part').value,
                    family_ch: document.getElementById('family_ch').value,
                    family_en: document.getElementById('family_en').value,
                    chem_main: document.getElementById('chem_main').value,
                    chem_sub: document.getElementById('chem_sub').value,
                    chemistry: cData, // é€™è£¡å·²ç¶“åŒ…å«ä¸Šå‚³å¥½çš„åœ–ç‰‡é€£çµäº†
                    effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s),
                    indications: tinymce.get('indications').getContent(),
                    image: fImg,
                    isTrash: false
                };

                const eid = document.getElementById('edit-id').value;
                if (eid) allHerbs[allHerbs.findIndex(h => h.id == eid)] = newItem;
                else allHerbs.push(newItem);

                await syncToGitHub(`Update ${name}`);
                hasUnsavedChanges = false;
                document.getElementById('edit-modal').style.display = 'none';

            } catch (e) {
                alert("éŒ¯èª¤: " + e.message);
            } finally {
                btn.innerText = "ğŸ’¾ å„²å­˜ä¸¦ä¸Šå‚³";
                btn.disabled = false;
            }
        }
        
        async function uploadBase64(b,f) { const n=`images/${f}/${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`; const u=`https://api.github.com/repos/${JSON.parse(localStorage.getItem('tcm_admin_config')).user}/${JSON.parse(localStorage.getItem('tcm_admin_config')).repo}/contents/${n}`; const r=await fetch(u,{method:'PUT',headers:{'Authorization':`token ${JSON.parse(localStorage.getItem('tcm_admin_config')).token}`,'Content-Type':'application/json'},body:JSON.stringify({message:"Upload img",content:b.split(',')[1]})}); if(!r.ok)throw new Error("åœ–å‚³å¤±æ•—"); return (await r.json()).content.download_url; }
        async function softDelete(id) { if(confirm("ç§»è‡³åƒåœ¾æ¡¶ï¼Ÿ")){ allHerbs.find(h=>h.id==id).isTrash=true; syncToGitHub(`Trash ${id}`); } }
        async function restoreHerb(id) { allHerbs.find(h=>h.id==id).isTrash=false; syncToGitHub(`Restore ${id}`); }
        async function hardDelete(id) { if(confirm("æ°¸ä¹…åˆªé™¤ï¼Ÿ")){ allHerbs=allHerbs.filter(h=>h.id!=id); syncToGitHub(`Delete ${id}`); } }

        // === ğŸ–¼ï¸ åœ–ç‰‡å£“ç¸®å·¥å…· (å›å‚³ Base64) ===
        function compressFile(file, quality = 0.7, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // ç¸®æ”¾å°ºå¯¸ (ç¶­æŒæ¯”ä¾‹)
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // è¼¸å‡ºå£“ç¸®å¾Œçš„ Base64 (JPEG æ ¼å¼)
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }
    </script>
</body>
</html>
