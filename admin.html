<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›´æ–°è³‡æ–™åº« | æœ¬è‰å­¸åœ’</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* admin å°ˆç”¨æ¨£å¼å„ªåŒ– */
        body { background-color: #f4f7f6; }
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* ç‹€æ…‹åˆ— */
        .status-bar { background: #e8f5e9; color: #2e7d32; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .status-bar.error { background: #ffebee; color: #c62828; }
        
        /* æœå°‹å€ */
        .search-section { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px dashed #eee; }
        .search-box-wrapper { display: flex; gap: 10px; max-width: 500px; margin: 0 auto; }
        .search-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 50px; font-size: 1.1rem; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); }
        .action-btn { padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; background: var(--primary); transition: 0.2s; white-space: nowrap;}
        .action-btn:hover { opacity: 0.9; }
        .btn-new { background: #ff9800; } /* æ©˜è‰²æ–°å¢æŒ‰éˆ• */

        /* æœå°‹çµæœå¡ç‰‡ */
        .result-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; }
        .mini-card { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; text-align: left; }
        .mini-card:hover { border-color: var(--primary); background: #f1f8e9; transform: translateY(-2px); }
        .mini-card h4 { margin: 0 0 5px 0; color: #333; }
        .mini-card p { margin: 0; font-size: 0.85rem; color: #666; }

        /* è¡¨å–®å€ (é è¨­éš±è—ï¼Œé¸å–å¾Œé¡¯ç¤º) */
        #edit-form-area { display: none; animation: fadeIn 0.5s; }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-title { font-size: 1.5rem; font-weight: bold; color: var(--secondary); margin: 0; }
        .mode-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .mode-update { background: #e3f2fd; color: #1565c0; } /* è—è‰²æ›´æ–°æ¨¡å¼ */
        .mode-create { background: #fff3e0; color: #ef6c00; } /* æ©˜è‰²æ–°å¢æ¨¡å¼ */

        /* æ¬„ä½æ¨£å¼ */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 80px; resize: vertical; }
        
        /* åœ–ç‰‡é è¦½ */
        .img-preview-box { text-align: center; margin-top: 10px; }
        #preview-img { max-height: 150px; border-radius: 8px; display: none; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <nav>
        <div class="logo">ğŸ› ï¸ æ›´æ–°è³‡æ–™åº«</div>
        <ul class="menu">
            <li><a href="index.html">å›å‰å°</a></li>
        </ul>
    </nav>

    <div class="admin-container">
        <div id="status-bar" class="status-bar">
            <span id="status-text">â³ æ­£åœ¨é€£ç·š GitHub è³‡æ–™åº«...</span>
            <button onclick="toggleSettings()" style="background:none; border:none; text-decoration:underline; cursor:pointer; color:inherit;">âš™ï¸ è¨­å®š</button>
        </div>

        <div id="settings-panel" style="display:none; background:#333; color:white; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h4>GitHub é€£ç·šè¨­å®š</h4>
            <input type="text" id="gh_owner" placeholder="Owner (e.g. yourname)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <input type="text" id="gh_repo" placeholder="Repo (e.g. tcm-learning)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <input type="password" id="gh_token" placeholder="Token (ghp_...)" style="margin-bottom:10px; background:#555; color:white; border:none;">
            <button onclick="saveSettings()" class="action-btn" style="width:100%;">å„²å­˜ä¸¦é€£ç·š</button>
        </div>

        <div class="search-section">
            <h3 style="margin-bottom:15px; color:#555;">ä½ è¦ç·¨è¼¯å“ªä¸€å‘³è—¥ï¼Ÿ</h3>
            <div class="search-box-wrapper">
                <input type="text" id="admin-search" class="search-input" placeholder="è¼¸å…¥ä¸­è—¥å..." onkeypress="if(event.key==='Enter') doSearch()">
                <button onclick="doSearch()" class="action-btn">ğŸ” æœå°‹</button>
            </div>
            
            <div id="search-results" class="result-list"></div>
            
            <div id="no-result-msg" style="display:none; margin-top:20px;">
                <p>è³‡æ–™åº«è£¡æ²’æœ‰é€™å‘³è—¥ã€‚</p>
                <button onclick="startCreateNew()" class="action-btn btn-new">â• æ–°å¢æ­¤ä¸­è—¥</button>
            </div>
        </div>

        <div id="edit-form-area">
            <div class="form-header">
                <h3 class="form-title">ğŸ“ ç·¨è¼¯è³‡æ–™</h3>
                <span id="edit-mode-badge" class="mode-badge mode-update">æ›´æ–°æ¨¡å¼</span>
            </div>

            <div class="form-group">
                <label>ä¸­è—¥åç¨± (Chinese Name) *</label>
                <input type="text" id="chinese_name">
            </div>

            <div class="form-group">
                <label>åŸºåŸ/å­¸å (Origin) * <small style="color:var(--primary)">å¦‚æœæ˜¯å¤šåŸºåŸï¼Œè«‹å…¨éƒ¨åˆ—å‡º</small></label>
                <textarea id="origin" placeholder="ä¾‹å¦‚ï¼šEphedra sinica (è‰éº»é»ƒ), Ephedra equisetina (æœ¨è³Šéº»é»ƒ)"></textarea>
            </div>

            <div class="form-group">
                <label>ç”Ÿè—¥å (Latin Name)</label>
                <input type="text" id="latin_name" placeholder="ä¾‹å¦‚ï¼šEphedrae Herba">
            </div>

            <div class="form-group">
                <label>ç§‘å (Family)</label>
                <input type="text" id="family" placeholder="ä¾‹å¦‚ï¼šéº»é»ƒç§‘ (Ephedraceae)">
            </div>

            <div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:10px;">
                <label style="color:var(--primary);">ğŸ§ª ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="chem_main" onchange="updateSubCats()"><option value="">-- å¤§åˆ†é¡ --</option></select>
                    <select id="chem_sub"><option value="">-- å­åˆ†é¡ --</option></select>
                </div>
            </div>

            <div class="form-group">
                <label>ä¸»è¦æˆåˆ† (Chemistry)</label>
                <input type="text" id="chemistry" placeholder="ä¾‹å¦‚ï¼šEphedrine">
            </div>

            <div class="form-group">
                <label>åŠŸæ•ˆ (Effects) <small>ç”¨é€—è™Ÿåˆ†éš”</small></label>
                <input type="text" id="effects" placeholder="ç™¼æ±—è§£è¡¨, å®£è‚ºå¹³å–˜">
            </div>

            <div class="form-group">
                <label>å‚™è¨» / ç­†è¨˜ (Indications)</label>
                <textarea id="indications"></textarea>
            </div>

            <div class="form-group">
                <label>å¹´ç´š</label>
                <select id="grade">
                    <option value="å¤§ä¸€">å¤§ä¸€</option>
                    <option value="å¤§äºŒ">å¤§äºŒ</option>
                    <option value="å¤§äºŒä¸Š">å¤§äºŒä¸Š</option>
                    <option value="å¤§äºŒä¸‹">å¤§äºŒä¸‹</option>
                    <option value="å¤§ä¸‰">å¤§ä¸‰</option>
                </select>
            </div>

            <div class="form-group" style="border:2px dashed #ddd; padding:15px; border-radius:10px; text-align:center;">
                <label>ğŸ“¸ ä¸­è—¥åœ–ç‰‡ (é¸å¡«)</label>
                <input type="file" id="img-input" accept="image/*" onchange="handleImagePreview()">
                <div class="img-preview-box">
                    <img id="preview-img" src="" alt="é è¦½">
                    <p id="img-status" style="font-size:0.8rem; color:#666;"></p>
                </div>
                <input type="hidden" id="old-image-path">
            </div>

            <div style="display:flex; gap:10px; margin-top:30px;">
                <button onclick="cancelEdit()" class="action-btn" style="background:#666; flex:1;">å–æ¶ˆ</button>
                <button onclick="saveAndUpload()" class="action-btn" style="flex:2;">ğŸš€ å„²å­˜ä¸¦ä¸Šå‚³</button>
            </div>
        </div>
    </div>

   <script>
    // --- 1. å…¨åŸŸè®Šæ•¸ ---
    let allHerbs = [];
    let currentHerbId = null; 
    let newImageBase64 = null; 

    const categories = {
        "é…ç³–é«”": ["å¼·å¿ƒé…é†£é«”", "è”¥é†Œé¡é…é†£é«”", "çš‚ç´ é…é†£é«”", "æ°°è‹·é…é†£é«”", "ç•°ç¡«æ°°é…é†£é«”", "é†‡é¡é…é†£é«”", "é†›é¡é…é†£é«”", "é…šé¡é…é†£é«”", "å…¶ä»–é…é†£é«”"],
        "ç”Ÿç‰©é¹¼": ["å¡å•¶-å“Œå•¶é¡", "æ‰˜çƒ·é¡", "å–¹å•‰é¡", "ç•°å–¹å•‰é¡", "å²å“šé¡", "å’ªå”‘é¡", "å˜Œå‘¤é¡", "ç”¾é«”é¡", "å…¶ä»–ç”Ÿç‰©é¹¼"],
        "å¤šé†£é¡": ["æ¾±ç²‰", "æ¨¹è† ", "é»æ¶²è³ª", "æœè† "],
        "è‹¯ä¸™çƒ·é¡": ["ç°¡å–®è‹¯ä¸™çƒ·é¡", "é¦™è±†ç´ ", "æœ¨è³ªç´ "],
        "æœ¨é…šç´ ": ["æœ¨é…šç´ ", "æ–°æœ¨é…šç´ "],
        "é¡é»ƒé…®": ["é»ƒé…®é¡", "é»ƒé…®é†‡é¡", "ç•°é»ƒé…®é¡", "èŠ±é’ç´ "],
        "é£è³ª": ["æ°´è§£å‹é£è³ª", "ç¸®åˆå‹é£è³ª"],
        "èœé¡": ["å–®èœ", "å€åŠèœ", "äºŒèœ", "ä¸‰èœ"],
        "æ®ç™¼æ²¹": ["å«æ°§å–®èœ", "å€åŠèœé¡", "èŠ³é¦™æ—"],
        "æ¨¹è„‚": ["æ²¹æ¨¹è„‚", "è† æ¨¹è„‚", "æ²¹è† æ¨¹è„‚", "é¦™æ¨¹è„‚"],
        "è„‚è³ª": ["è„‚è‚ªæ²¹", "è Ÿ"]
    };

    // --- 2. åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        initCategories();
        loadDatabase(); // è‡ªå‹•å•Ÿå‹•é€£ç·š
    });

    function initCategories() {
        const mainSel = document.getElementById('chem_main');
        for(let key in categories) {
            let opt = document.createElement('option');
            opt.value = key; opt.text = key;
            mainSel.add(opt);
        }
    }

    function updateSubCats() {
        const mainVal = document.getElementById('chem_main').value;
        const subSel = document.getElementById('chem_sub');
        subSel.innerHTML = '<option value="">-- å­åˆ†é¡ --</option>';
        if(mainVal && categories[mainVal]) {
            categories[mainVal].forEach(sub => {
                let opt = document.createElement('option');
                opt.value = sub; opt.text = sub;
                subSel.add(opt);
            });
        }
    }

    // --- 3. æ ¸å¿ƒé€£å‹•ï¼šè®€å– GitHub è³‡æ–™åº« ---
    async function loadDatabase() {
        const owner = localStorage.getItem('tcm_owner');
        const repo = localStorage.getItem('tcm_repo');
        const token = localStorage.getItem('tcm_token');
        const statusText = document.getElementById('status-text');
        const statusBar = document.getElementById('status-bar');

        if (!owner || !repo || !token) {
            statusText.innerText = "âŒ æœªè¨­å®š GitHubï¼Œè«‹é»æ“Šè¨­å®š";
            statusBar.className = "status-bar error";
            return;
        }

        try {
            // æ³¨æ„ï¼šé€™è£¡çš„è·¯å¾‘å¿…é ˆè·Ÿä½ çš„ GitHub çµæ§‹å®Œå…¨ä¸€æ¨£
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/data/herbs.json`;
            console.log("æ­£åœ¨å˜—è©¦é€£ç·šè‡³:", url); 

            const res = await fetch(url, { 
                headers: { 
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                } 
            });

            if (res.status === 401) throw new Error("Token éŒ¯èª¤æˆ–æ¬Šé™ä¸è¶³(è«‹å‹¾é¸repo)");
            if (res.status === 404) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆï¼è«‹æª¢æŸ¥ Repo åç¨±èˆ‡è·¯å¾‘(data/herbs.json)");
            if (!res.ok) throw new Error(`é€£ç·šå¤±æ•— (ä»£ç¢¼: ${res.status})`);
            
            const data = await res.json();
            const content = decodeURIComponent(escape(window.atob(data.content)));
            allHerbs = JSON.parse(content);
            
            localStorage.setItem('herbs_sha', data.sha);
            statusText.innerText = `âœ… è³‡æ–™åº«å·²åŒæ­¥ (å…± ${allHerbs.length} ç­†)`;
            statusBar.className = "status-bar";

        } catch (err) {
            console.error("è©³ç´°éŒ¯èª¤è³‡è¨Š:", err);
            statusText.innerText = "âŒ éŒ¯èª¤ï¼š" + err.message;
            statusBar.className = "status-bar error";
        }
    }

    // --- 4. æœå°‹èˆ‡ç·¨è¼¯é‚è¼¯ ---
    function doSearch() {
        const term = document.getElementById('admin-search').value.trim().toLowerCase();
        const resultDiv = document.getElementById('search-results');
        const noResultMsg = document.getElementById('no-result-msg');
        const formArea = document.getElementById('edit-form-area');

        resultDiv.innerHTML = "";
        formArea.style.display = "none";
        noResultMsg.style.display = "none";

        if(!term) return;

        const matches = allHerbs.filter(h => 
            h.chinese_name.includes(term) || 
            (h.latin_name && h.latin_name.toLowerCase().includes(term))
        );

        if(matches.length === 0) {
            noResultMsg.style.display = "block";
        } else {
            matches.forEach(h => {
                const div = document.createElement('div');
                div.className = 'mini-card';
                div.innerHTML = `<h4>${h.chinese_name}</h4><p>${h.latin_name || ''}</p>`;
                div.onclick = () => loadHerbToForm(h);
                resultDiv.appendChild(div);
            });
        }
    }

    function loadHerbToForm(herb) {
        document.getElementById('search-results').innerHTML = "";
        document.getElementById('edit-form-area').style.display = "block";
        document.getElementById('edit-mode-badge').innerText = "æ›´æ–°ç¾æœ‰è³‡æ–™";
        document.getElementById('edit-mode-badge').className = "mode-badge mode-update";

        currentHerbId = herb.id;
        document.getElementById('chinese_name').value = herb.chinese_name;
        document.getElementById('origin').value = herb.origin || "";
        document.getElementById('latin_name').value = herb.latin_name || "";
        document.getElementById('family').value = herb.family || "";
        document.getElementById('chemistry').value = herb.chemistry || "";
        document.getElementById('effects').value = (herb.effects || []).join(', ');
        document.getElementById('indications').value = herb.indications || "";
        document.getElementById('grade').value = herb.grade || "å¤§äºŒ";
        document.getElementById('old-image-path').value = herb.image || "";

        document.getElementById('chem_main').value = herb.chem_main || "";
        updateSubCats();
        document.getElementById('chem_sub').value = herb.chem_sub || "";

        const img = document.getElementById('preview-img');
        img.style.display = herb.image ? "block" : "none";
        document.getElementById('img-status').innerText = herb.image ? `ç›®å‰åœ–ç‰‡è·¯å¾‘ï¼š${herb.image}` : "";
        newImageBase64 = null;
    }

    function startCreateNew() {
        const searchTerm = document.getElementById('admin-search').value;
        document.getElementById('no-result-msg').style.display = "none";
        document.getElementById('edit-form-area').style.display = "block";
        document.getElementById('edit-mode-badge').innerText = "æ–°å¢æ¨¡å¼";
        document.getElementById('edit-mode-badge').className = "mode-badge mode-create";
        currentHerbId = null;
        document.querySelectorAll('#edit-form-area input, #edit-form-area textarea').forEach(el => el.value = "");
        document.getElementById('chinese_name').value = searchTerm;
        document.getElementById('preview-img').style.display = "none";
    }

    function cancelEdit() {
        document.getElementById('edit-form-area').style.display = "none";
    }

    async function saveAndUpload() {
        const owner = localStorage.getItem('tcm_owner');
        const repo = localStorage.getItem('tcm_repo');
        const token = localStorage.getItem('tcm_token');
        const sha = localStorage.getItem('herbs_sha');
        
        const cname = document.getElementById('chinese_name').value.trim();
        if(!cname) { alert("è«‹å¡«å¯«ä¸­è—¥åç¨±"); return; }

        const statusText = document.getElementById('status-text');
        statusText.innerText = "ğŸš€ ä¸Šå‚³ä¸­...";

        try {
            let finalImagePath = document.getElementById('old-image-path').value || "images/placeholder.jpg";

            // 1. åœ–ç‰‡è™•ç† (ç•¥éï¼Œç¶­æŒåŸé‚è¼¯)
            // 2. æº–å‚™ç‰©ä»¶
            const newHerb = {
                id: currentHerbId || Date.now(),
                chinese_name: cname,
                origin: document.getElementById('origin').value.trim(),
                latin_name: document.getElementById('latin_name').value.trim(),
                family: document.getElementById('family').value.trim(),
                chem_main: document.getElementById('chem_main').value,
                chem_sub: document.getElementById('chem_sub').value,
                chemistry: document.getElementById('chemistry').value.trim(),
                effects: document.getElementById('effects').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s),
                indications: document.getElementById('indications').value.trim(),
                grade: document.getElementById('grade').value,
                image: finalImagePath,
                wrong_effects: []
            };

            if (currentHerbId) {
                const idx = allHerbs.findIndex(h => h.id === currentHerbId);
                if(idx !== -1) allHerbs[idx] = newHerb;
            } else {
                allHerbs.push(newHerb);
            }

            const jsonString = JSON.stringify(allHerbs, null, 2);
            const encodedContent = window.btoa(unescape(encodeURIComponent(jsonString)));

            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data/herbs.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Update ${cname} via Admin`,
                    content: encodedContent,
                    sha: sha 
                })
            });

            if(!res.ok) throw new Error("JSON æ›´æ–°å¤±æ•—");
            alert("âœ… æ›´æ–°æˆåŠŸï¼");
            location.reload(); // é‡æ–°è¼‰å…¥ä»¥åŒæ­¥æœ€æ–°ç‹€æ…‹

        } catch (err) {
            alert("å¤±æ•—ï¼š" + err.message);
            statusText.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
        }
    }

    // --- 5. è¨­å®šé¢æ¿æ§åˆ¶ ---
    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        if(panel.style.display === 'block') {
            document.getElementById('gh_owner').value = localStorage.getItem('tcm_owner') || '';
            document.getElementById('gh_repo').value = localStorage.getItem('tcm_repo') || '';
            document.getElementById('gh_token').value = localStorage.getItem('tcm_token') || '';
        }
    }

    function saveSettings() {
        localStorage.setItem('tcm_owner', document.getElementById('gh_owner').value.trim());
        localStorage.setItem('tcm_repo', document.getElementById('gh_repo').value.trim());
        localStorage.setItem('tcm_token', document.getElementById('gh_token').value.trim());
        alert('è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é€£ç·š...');
        toggleSettings();
        loadDatabase();
    }
</script>
</body>
</html>
