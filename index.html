<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­è—¥æ™ºæ…§æŸ¥è©¢ | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* === å…¨å±€è®Šæ•¸ (èˆ‡ç”Ÿè—¥å‰å°çµ±ä¸€) === */
        :root {
            --primary: #4A7C59;
            --primary-dark: #2C5E4F;
            --accent: #E8F5E9;
            --text-dark: #333;
            --text-light: #666;
            --bg-color: #f4f7f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            color: var(--text-dark);
        }

        /* === å°è¦½åˆ— === */
        nav {
            background: white; padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-links a { text-decoration: none; color: var(--text-light); margin-left: 20px; font-weight: 500; transition: 0.2s; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); }

        /* === æœå°‹å€ (Hero Section) === */
        .hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 3rem 1rem 4rem 1rem;
            text-align: center;
            color: white;
            margin-bottom: -30px; /* è®“å¡ç‰‡å¾€ä¸Šæµ®ä¸€é» */
        }
        .hero-title { font-size: 2rem; margin-bottom: 1.5rem; font-weight: 300; }

        /* æ™ºæ…§æœå°‹æ¡† */
        .search-container {
            max-width: 800px; margin: 0 auto; position: relative;
            background: white; border-radius: 50px; padding: 5px;
            display: flex; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .search-select {
            border: none; background: transparent; padding: 0 20px;
            font-size: 1rem; color: #555; font-weight: bold; cursor: pointer;
            border-right: 1px solid #eee; outline: none; border-radius: 50px 0 0 50px;
        }
        .search-box {
            flex: 1; border: none; padding: 15px; font-size: 1.1rem; outline: none;
        }
        .search-btn {
            background: var(--primary); color: white; border: none;
            padding: 10px 30px; border-radius: 50px; cursor: pointer;
            font-weight: bold; transition: 0.2s; font-size: 1rem; margin: 3px;
        }
        .search-btn:hover { background: var(--primary-dark); }

        /* å»ºè­°æ¸…å–® */
        .suggestions-list {
            position: absolute; top: 115%; left: 20px; right: 20px;
            background: white; border-radius: 15px; z-index: 999;
            max-height: 300px; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; text-align: left;
        }
        .suggestion-item {
            padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; color: #333;
        }
        .suggestion-item:hover { background-color: var(--accent); }

        /* === å¡ç‰‡ç¶²æ ¼å€ === */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 50px 20px; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px;
        }

        /* === è—¥æå¡ç‰‡ === */
        .card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: var(--card-shadow); transition: all 0.3s ease;
            position: relative; cursor: pointer; border: 1px solid #eee;
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--card-hover); border-color: var(--primary); }
        .card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: var(--primary);
        }

        .card-img-top {
            height: 180px; width: 100%; object-fit: cover; background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        .card-body { padding: 20px; flex: 1; }
        .card-title { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        .card-subtitle { font-size: 0.95rem; color: #888; font-family: 'Roboto Mono', monospace; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 8px; color: var(--text-light); border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .card-footer { padding: 15px 20px; background: #fafafa; border-top: 1px solid #eee; text-align: right; font-size: 0.9rem; color: var(--primary); font-weight: bold; }

        /* === è©³æƒ… Modal (èˆ‡ç”Ÿè—¥å‰å°å…±ç”¨æ¨£å¼) === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: white; width: 100%; max-width: 900px; max-height: 90vh;
            border-radius: 20px; overflow-y: auto; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { background: var(--primary); color: white; padding: 20px 30px; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; }
        .section-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-dark); border-bottom: 2px solid var(--accent); padding-bottom: 8px; margin-bottom: 15px; }
        
        /* æ··æ·†è—¥æ */
        .confusing-box { background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 5px solid #ff9800; margin-top: 10px; }
        .confusing-item { margin-bottom: 10px; border-bottom: 1px dashed #ffe0b2; padding-bottom: 5px; }
        .confusing-item:last-child { border: none; margin: 0; padding: 0; }

        /* æˆåˆ†ç¶²æ ¼ */
        .chem-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .chem-item { text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 10px; }
        .chem-item img { max-width: 100%; max-height: 80px; margin-top: 5px; }

        @media (max-width: 768px) {
            .search-container { flex-direction: column; border-radius: 20px; padding: 10px; }
            .search-select { border-right: none; border-bottom: 1px solid #eee; width: 100%; border-radius: 0; padding: 10px; }
            .search-btn { width: 100%; margin-top: 10px; }
        }
        /* è®“å‚™è¨»å€å¡Šçš„ HTML å…§å®¹æ­£å¸¸æ’ç‰ˆ */
#modal-indications {
    line-height: 1.6;
    color: #333;
}
#modal-indications ul, #modal-indications ol {
    margin-left: 20px;
    padding-left: 0;
}
#modal-indications table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}
#modal-indications th, #modal-indications td {
    border: 1px solid #ddd;
    padding: 8px;
}
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ğŸŒ¿ æœ¬è‰å­¸åœ’</a>
        <div class="nav-links">
            <a href="index.html">ä¸­è—¥åº«</a>
            <a href="pharmacognosy.html">ç”Ÿè—¥åº«</a>
            <a href="quiz.html">è‡ªæˆ‘æ¸¬é©—</a>
            <a href="admin_menu.html">å¾Œå°ç®¡ç†</a>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="hero-title">ä¸­è—¥æ™ºæ…§æŸ¥è©¢ç³»çµ±</h1>
        <div class="search-container">
            <select id="searchType" class="search-select">
                <option value="all">å…¨éƒ¨</option>
                <option value="name">ä¸­è—¥å</option>
                <option value="latin">ç”Ÿè—¥å</option>
                <option value="part">è—¥ç”¨éƒ¨ä½</option>
                <option value="family">ç§‘å</option>
                <option value="origin">åŸºåŸ</option>
                <option value="chemistry">æˆåˆ†</option>
                <option value="effects">åŠŸæ•ˆ</option>
            </select>
            <input type="text" id="searchInput" class="search-box" placeholder="è¼¸å…¥é—œéµå­—..." autocomplete="off">
            <button class="search-btn" onclick="performSearch()">æœå°‹</button>
            <div id="suggestions" class="suggestions-list"></div>
        </div>
    </div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px; color:#888;">
            <h2>â³ è³‡æ–™åº«è¼‰å…¥ä¸­...</h2>
        </div>
        <div id="results-grid" class="grid"></div>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modal-title" style="margin:0; font-size:1.8rem;"></h2>
                    <span id="modal-subtitle" style="font-family:'Roboto Mono'; opacity:0.9;"></span>
                </div>
                <button onclick="document.getElementById('detail-modal').style.display='none'" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer;">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="modal-img-container" style="text-align:center; margin-bottom:20px;">
                    <img id="modal-img" src="" style="max-height:250px; border-radius:10px; max-width:100%;">
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ“Œ åŸºæœ¬è³‡è¨Š</div>
                    <p><strong>åŸºåŸ (Origin)ï¼š</strong> <span id="modal-origin"></span></p>
                    <p><strong>ç§‘åˆ¥ (Family)ï¼š</strong> <span id="modal-family"></span></p>
                    <p><strong>éƒ¨ä½ (Part)ï¼š</strong> <span id="modal-part"></span></p>
                </div>

                <div class="detail-section">
                    <div class="section-title">âš—ï¸ ä¸»è¦æˆåˆ†</div>
                    <div id="modal-chem-grid" class="chem-grid"></div>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ’¡ åŠŸæ•ˆèˆ‡å‚™è¨»</div>
                    <p><strong>åŠŸæ•ˆï¼š</strong> <span id="modal-effects"></span></p>
                    <p><strong>å‚™è¨»ï¼š</strong> <span id="modal-indications"></span></p>
                </div>

                <div class="detail-section" id="confusing-section">
                    <div class="section-title" style="color:#d32f2f; border-color:#ffccbc;">âš ï¸ æ˜“æ··æ·†è—¥æ</div>
                    <div id="modal-confusing" class="confusing-box"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = [];
        const input = document.getElementById('searchInput');
        const typeSelect = document.getElementById('searchType');
        const suggestionsBox = document.getElementById('suggestions');
        const resultsGrid = document.getElementById('results-grid');

        // 1. è¼‰å…¥è³‡æ–™
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('data/herbs.json');
                if (!response.ok) throw new Error("è³‡æ–™è®€å–å¤±æ•—");
                db = await response.json();
                document.getElementById('loading').style.display = 'none';
                renderCards(db); // é è¨­é¡¯ç¤ºå…¨éƒ¨ (æˆ–å‰20ç­†)
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = `<p style="color:red;">âŒ è³‡æ–™åº«è®€å–å¤±æ•—</p>`;
            }
        });

        // 2. æœå°‹æ ¸å¿ƒé‚è¼¯
        function getFilteredMatches(val) {
            if (!val) return db; // æ²’è¼¸å…¥é¡¯ç¤ºå…¨éƒ¨
            const type = typeSelect.value;
            const term = val.toLowerCase();

            return db.filter(item => {
                const cName = (item.chinese_name || "").toLowerCase();
                const lName = (item.latin_name || "").toLowerCase();
                const part = (item.part || "").toLowerCase();
                const fMix = ((item.family_ch||"") + (item.family_en||"") + (item.family||"")).toLowerCase();
                
                let originText = Array.isArray(item.origin) ? 
                    item.origin.map(o => (typeof o==='object') ? (o.lat+o.ch) : o).join(" ").toLowerCase() : (item.origin||"").toLowerCase();

                let chemText = Array.isArray(item.chemistry) ? 
                    item.chemistry.map(c => (typeof c==='object') ? (c.name_en+c.name_ch) : c).join(" ").toLowerCase() : (item.chemistry||"").toLowerCase();

                const effects = Array.isArray(item.effects) ? item.effects.join(' ').toLowerCase() : (item.effects||"").toLowerCase();

                switch (type) {
                    case 'name': return cName.includes(term);
                    case 'latin': return lName.includes(term);
                    case 'family': return fMix.includes(term);
                    case 'origin': return originText.includes(term);
                    case 'chemistry': return chemText.includes(term);
                    case 'effects': return effects.includes(term);
                    case 'part': return part.includes(term);
                    case 'all': default:
                        return cName.includes(term) || lName.includes(term) || fMix.includes(term) || 
                               originText.includes(term) || chemText.includes(term) || 
                               effects.includes(term) || part.includes(term);
                }
            });
        }

        // 3. åŸ·è¡Œæœå°‹
        window.performSearch = function() {
            const val = input.value.trim();
            suggestionsBox.style.display = 'none';
            const matches = getFilteredMatches(val);
            renderCards(matches);
        }

        // 4. å³æ™‚å»ºè­°
        input.addEventListener('input', function() {
            const val = this.value.trim();
            if (!val) { suggestionsBox.style.display = 'none'; return; }
            
            const matches = getFilteredMatches(val).slice(0, 8);
            if (matches.length > 0) {
                suggestionsBox.innerHTML = matches.map(item => `
                    <div class="suggestion-item" onclick="selectSuggestion('${item.chinese_name}')">
                        <span style="font-weight:bold;">${item.chinese_name}</span>
                        <span style="color:#888; font-size:0.9rem;">${item.latin_name || ''}</span>
                    </div>
                `).join('');
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        });

        window.selectSuggestion = function(name) {
            input.value = name;
            suggestionsBox.style.display = 'none';
            performSearch();
        }

        // 5. æ¸²æŸ“å¡ç‰‡ (ç¾è§€ç‰ˆ)
        function renderCards(data) {
            resultsGrid.innerHTML = "";
            if (data.length === 0) {
                resultsGrid.innerHTML = "<p style='text-align:center; width:100%; grid-column:1/-1; color:#666;'>æ‰¾ä¸åˆ°ç¬¦åˆçš„è³‡æ–™...</p>";
                return;
            }

            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openModal(item);

                // è™•ç†åœ–ç‰‡
                const imgSrc = (item.image && item.image.startsWith('http')) ? item.image : "https://via.placeholder.com/300x200?text=No+Image";
                
                // è™•ç†ç§‘å
                const family = item.family_ch || item.family || "æœªåˆ†é¡";

                card.innerHTML = `
                    <img src="${imgSrc}" class="card-img-top" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="card-body">
                        <h3 class="card-title">${item.chinese_name}</h3>
                        <div class="card-subtitle">${item.latin_name || ''}</div>
                        
                        <div class="info-row">
                            <span>ç§‘åˆ¥</span> <span>${family}</span>
                        </div>
                        <div class="info-row">
                            <span>éƒ¨ä½</span> <span>${item.part || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span>å¹´ç´š</span> <span style="background:#e8f5e9; padding:2px 6px; border-radius:4px; color:#2C5E4F; font-size:0.8rem;">${item.grade || 'æœªåˆ†é¡'}</span>
                        </div>
                    </div>
                    <div class="card-footer">æŸ¥çœ‹è©³æƒ… â”</div>
                `;
                resultsGrid.appendChild(card);
            });
        }

        // 6. é–‹å•Ÿè©³æƒ…è¦–çª—
        function openModal(item) {
            const modal = document.getElementById('detail-modal');
            
            document.getElementById('modal-title').innerText = item.chinese_name;
            document.getElementById('modal-subtitle').innerText = item.latin_name || '';
            
            // åœ–ç‰‡
            const img = document.getElementById('modal-img');
            if (item.image) {
                img.src = item.image;
                img.style.display = 'inline-block';
            } else {
                img.style.display = 'none';
            }

            // åŸºæœ¬è³‡æ–™
            let originText = "";
            if (Array.isArray(item.origin)) {
                originText = item.origin.map(o => (typeof o==='object') ? `${o.lat} ${o.ch}` : o).join('<br>');
            } else {
                originText = item.origin || '-';
            }
            document.getElementById('modal-origin').innerHTML = originText;
            document.getElementById('modal-family').innerText = `${item.family_ch||''} ${item.family_en||''} ${item.family||''}`;
            document.getElementById('modal-part').innerText = item.part || '-';

            // æˆåˆ†
          // ... (åœ¨ openModal å‡½å¼å…§) ...
            
            // æˆåˆ† (ä¿®æ”¹ç‰ˆï¼šé»æ“Šè·³è½‰)
            const chemGrid = document.getElementById('modal-chem-grid');
            chemGrid.innerHTML = "";
            if (item.chemistry && (Array.isArray(item.chemistry) || typeof item.chemistry === 'string')) {
                const list = Array.isArray(item.chemistry) ? item.chemistry : item.chemistry.split(/[,ï¼Œ]/);
                list.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'chem-item';
                    div.style.cursor = 'pointer'; // è®“æ»‘é¼ è®Šæ‰‹æŒ‡
                    div.title = "é»æ“Šå‰å¾€ç”Ÿè—¥åº«æŸ¥çœ‹è©³æƒ…"; // æç¤ºæ–‡å­—

                    let cName = "", cImg = "";
                    if (typeof c === 'object') {
                        cName = `${c.name_en||''} ${c.name_ch||''}`;
                        cImg = c.image;
                    } else {
                        cName = c;
                    }
                    
                    // â˜… é—œéµï¼šé»æ“Šå¾Œè·³è½‰ï¼Œä¸¦å¸¶è‘—æœå°‹é—œéµå­— (?q=...)
                    // æˆ‘å€‘å„ªå…ˆç”¨è‹±æ–‡åæœå°‹ï¼Œå› ç‚ºç”Ÿè—¥åº«è‹±æ–‡è³‡æ–™è¼ƒå…¨ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨ä¸­æ–‡
                    const searchKey = (typeof c === 'object' && c.name_en) ? c.name_en : cName;
                    
                    div.onclick = (e) => {
                        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å…¶ä»–é»æ“Š
                        window.location.href = `pharmacognosy.html?q=${encodeURIComponent(searchKey)}`;
                    };

                    div.innerHTML = `
                        <div style="font-weight:bold; font-size:0.9rem;">${cName}</div>
                        ${cImg ? `<img src="${cImg}" style="max-height:80px; margin-top:5px;">` : ''}
                    `;
                    chemGrid.appendChild(div);
                });
            } else {
                chemGrid.innerHTML = "<span style='color:#ccc'>æš«ç„¡è³‡æ–™</span>";
            }
            // åŠŸæ•ˆå‚™è¨»
            document.getElementById('modal-effects').innerText = Array.isArray(item.effects) ? item.effects.join('ã€') : (item.effects||'-');
          // æ”¹æˆ innerHTML æ‰èƒ½é¡¯ç¤ºåŠ ç²—ã€è®Šè‰²ç­‰æ•ˆæœ
document.getElementById('modal-indications').innerHTML = item.indications || '-';
            // æ˜“æ··æ·†
            const confBox = document.getElementById('modal-confusing');
            const confSec = document.getElementById('confusing-section');
            if (item.confusing_drugs && item.confusing_drugs.length > 0) {
                confBox.innerHTML = item.confusing_drugs.map(c => `
                    <div class="confusing-item">
                        <strong>${c.name_ch||''}</strong> <i>${c.name_en||''}</i>
                        <div style="color:#666; font-size:0.9rem;">${c.note||''}</div>
                    </div>
                `).join('');
                confSec.style.display = 'block';
            } else {
                confSec.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closeModal(e) {
            if (e.target.id === 'detail-modal') {
                document.getElementById('detail-modal').style.display = 'none';
            }
        }
    </script>
</body>
</html>
