<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªæˆ‘æ¸¬é©— | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === é¢¨æ ¼è¨­å®š (èˆ‡å…¶ä»–é é¢çµ±ä¸€) === */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7f6; margin: 0; color: #333; }
        
        nav { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: #2C5E4F; text-decoration: none; }
        .nav-links a { text-decoration: none; color: #666; margin-left: 20px; font-weight: 500; }
        
        /* === 1. æ¸¬é©—å¤§å»³ (Menu) === */
        .quiz-menu { max-width: 800px; margin: 50px auto; text-align: center; padding: 20px; }
        .menu-title { font-size: 2rem; color: #2C5E4F; margin-bottom: 40px; }
        
        .mode-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        
        .mode-card {
            background: white; border-radius: 20px; padding: 40px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); cursor: pointer;
            transition: 0.3s; border: 3px solid transparent;
        }
        .mode-card:hover { transform: translateY(-10px); border-color: #4A7C59; box-shadow: 0 20px 40px rgba(74, 124, 89, 0.2); }
        
        .mode-icon { font-size: 4rem; margin-bottom: 20px; display: block; }
        .mode-name { font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 10px; display: block; }
        .mode-desc { color: #666; line-height: 1.6; }

        /* === 2. æ¸¬é©—é€²è¡Œä¸­ (Game) === */
        .quiz-container { max-width: 700px; margin: 30px auto; display: none; padding: 20px; }
        
        /* é€²åº¦æ¢ */
        .progress-bar-bg { background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar-fill { background: #4A7C59; height: 100%; width: 0%; transition: 0.3s; }
        
        /* å•é¡Œå¡ç‰‡ */
        .question-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; }
        
        .question-img { 
            max-width: 100%; max-height: 250px; margin-bottom: 20px; 
            border-radius: 10px; object-fit: contain; cursor: zoom-in;
        }
        .question-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; color: #2C5E4F; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn {
            background: white; border: 2px solid #ddd; padding: 15px;
            border-radius: 12px; font-size: 1.1rem; cursor: pointer; transition: 0.2s;
            color: #555; font-weight: 500;
        }
        .option-btn:hover { background: #f9f9f9; border-color: #aaa; }
        
        /* å°éŒ¯ç‹€æ…‹ */
        .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

        /* === 3. çµç®—ç•«é¢ (Result) === */
        .result-container { display: none; text-align: center; padding: 50px 20px; }
        .score-circle {
            width: 150px; height: 150px; background: #4A7C59; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; margin: 0 auto 30px auto;
            box-shadow: 0 10px 30px rgba(74, 124, 89, 0.3);
        }
        
        .mistake-list { max-width: 600px; margin: 30px auto; text-align: left; }
        .mistake-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid #dc3545; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
            .mode-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ğŸŒ¿ æœ¬è‰å­¸åœ’</a>
        <div class="nav-links">
            <a href="index.html">å›é¦–é </a>
        </div>
    </nav>

    <div id="menu-view" class="quiz-menu">
        <h1 class="menu-title">è«‹é¸æ“‡æ¸¬é©—æ¨¡å¼</h1>
        <div class="mode-cards">
            <div class="mode-card" onclick="startQuiz('tcm')">
                <span class="mode-icon">ğŸ’Š</span>
                <span class="mode-name">ä¸­è—¥è·‘å°æ¸¬é©—</span>
                <span class="mode-desc">é‡å°ä¸­è—¥æçš„åœ–ç‰‡è¾¨è­˜ã€ç§‘åˆ¥ã€åŸºåŸèˆ‡è—¥ç”¨éƒ¨ä½é€²è¡Œç¶œåˆæ¸¬é©—ã€‚</span>
            </div>

            <div class="mode-card" onclick="startQuiz('pharma')">
                <span class="mode-icon">âš—ï¸</span>
                <span class="mode-name">ç”Ÿè—¥å­¸æ¸¬é©—</span>
                <span class="mode-desc">é‡å°åŒ–å­¸çµæ§‹ã€ç”Ÿåˆæˆè·¯å¾‘åˆ†é¡ã€æˆåˆ†åç¨±èˆ‡åŸºåŸé€²è¡Œæ¸¬é©—ã€‚</span>
            </div>
        </div>
    </div>

    <div id="game-view" class="quiz-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="q-counter" style="font-weight:bold; color:#4A7C59;">Q1 / 10</span>
            <span id="q-score">å¾—åˆ†: 0</span>
        </div>
        <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>

        <div class="question-card">
            <img id="q-img" class="question-img" src="" style="display:none;" onclick="window.open(this.src)">
            <div id="q-text" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div id="options-area" class="options-grid"></div>
        </div>
        
        <div id="feedback-msg" style="margin-top:20px; text-align:center; font-weight:bold; height:20px;"></div>
    </div>

    <div id="result-view" class="result-container">
        <div class="score-circle" id="final-score">80</div>
        <h2>æ¸¬é©—çµæŸï¼</h2>
        <p id="final-comment">åšå¾—ä¸éŒ¯å–”ï¼</p>
        
        <div id="mistake-area" class="mistake-list"></div>
        
        <button onclick="location.reload()" style="background:#4A7C59; color:white; border:none; padding:12px 30px; border-radius:50px; font-size:1.1rem; cursor:pointer; margin-top:20px;">
            ğŸ”„ å†æ¸¬ä¸€æ¬¡
        </button>
        <button onclick="location.href='index.html'" style="background:transparent; border:2px solid #999; color:#666; padding:10px 30px; border-radius:50px; font-size:1rem; cursor:pointer; margin-top:10px; margin-left:10px;">
            å›é¦–é 
        </button>
    </div>

    <script>
        // === å…¨å±€è®Šæ•¸ ===
        let currentMode = ''; // 'tcm' or 'pharma'
        let questions = [];
        let currentQIndex = 0;
        let score = 0;
        let mistakes = [];
        let isAnswering = false;

        const TOTAL_QUESTIONS = 10; // æ¯æ¬¡æ¸¬é©— 10 é¡Œ

        // === 1. é–‹å§‹æ¸¬é©— (è®€å–è³‡æ–™) ===
        async function startQuiz(mode) {
            currentMode = mode;
            document.getElementById('menu-view').style.display = 'none';
            document.getElementById('game-view').style.display = 'block';
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('q-text').innerText = "æ­£åœ¨æº–å‚™è€ƒå·...";
            
            try {
                let data = [];
                // æ ¹æ“šæ¨¡å¼è®€å–ä¸åŒæª”æ¡ˆ
                if (mode === 'tcm') {
                    const res = await fetch('data/herbs.json');
                    data = await res.json();
                } else {
                    const res = await fetch('data/pharma.json');
                    // è™•ç† GitHub API å¯èƒ½çš„ Base64
                    const json = await res.json();
                    if (json.content && json.encoding === 'base64') {
                        data = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                    } else {
                        data = json;
                    }
                }

                if(!data || data.length < 4) {
                    alert("è³‡æ–™åº«é¡Œç›®å¤ªå°‘ï¼Œç„¡æ³•é€²è¡Œæ¸¬é©—ï¼");
                    location.reload();
                    return;
                }

                generateQuestions(data);
                showQuestion();

            } catch (e) {
                console.error(e);
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æª”æ¡ˆè·¯å¾‘ã€‚");
                location.reload();
            }
        }

        // === 2. ç”¢ç”Ÿé¡Œç›® (æ ¸å¿ƒé‚è¼¯) ===
        function generateQuestions(data) {
            // æ´—ç‰Œæ•´å€‹è³‡æ–™åº«
            const shuffled = data.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, TOTAL_QUESTIONS);
            
            questions = selected.map(item => {
                // æ±ºå®šé¡Œå‹ (æœ‰åœ–è€ƒåœ–ï¼Œæ²’åœ–è€ƒæ–‡å­—)
                let type = 'text';
                let qContent = "";
                let imgUrl = "";
                let correctAnswer = "";
                
                if (currentMode === 'tcm') {
                    // --- ä¸­è—¥æ¨¡å¼ ---
                    // å„ªå…ˆè€ƒåœ–ç‰‡ -> çŒœåå­—
                    if (item.image && Math.random() > 0.3) {
                        type = 'image';
                        imgUrl = item.image;
                        qContent = "é€™æ˜¯ä»€éº¼ä¸­è—¥æï¼Ÿ";
                        correctAnswer = item.chinese_name;
                    } else {
                        // è€ƒåŸºåŸ -> çŒœåå­—
                        type = 'text';
                        let origin = Array.isArray(item.origin) ? item.origin[0] : item.origin;
                        if(typeof origin === 'object') origin = origin.lat + " " + origin.ch;
                        qContent = `åŸºåŸç‚ºã€Œ${origin || '...'}ã€çš„ä¸­è—¥æ˜¯ï¼Ÿ`;
                        correctAnswer = item.chinese_name;
                    }
                } else {
                    // --- ç”Ÿè—¥æ¨¡å¼ ---
                    // å„ªå…ˆè€ƒçµæ§‹åœ– -> çŒœæˆåˆ†å (å¦‚æœæœ‰æˆåˆ†è³‡æ–™)
                    let comp = (item.components && item.components.length > 0) ? item.components[0] : null;
                    
                    if (comp && comp.image && Math.random() > 0.4) {
                        type = 'image';
                        imgUrl = comp.image;
                        qContent = "æ­¤åŒ–å­¸çµæ§‹å±¬æ–¼å“ªå€‹æˆåˆ†ï¼Ÿ";
                        correctAnswer = comp.name; // ç­”æ¡ˆæ˜¯æˆåˆ†å
                    } else {
                        // è€ƒè—¥å -> çŒœç§‘åˆ¥
                        type = 'text';
                        qContent = `ç”Ÿè—¥ã€Œ${item.name_ch} (${item.name_en})ã€å±¬æ–¼å“ªä¸€ç§‘ï¼Ÿ`;
                        correctAnswer = item.family_ch || item.family_en;
                    }
                }

                // ç”¢ç”Ÿ 3 å€‹éŒ¯èª¤é¸é …
                let distractors = [];
                while(distractors.length < 3) {
                    let randomItem = data[Math.floor(Math.random() * data.length)];
                    let wrongAns = "";
                    
                    if (currentMode === 'tcm') {
                        wrongAns = randomItem.chinese_name;
                    } else {
                        // ç”Ÿè—¥æ¨¡å¼çš„éŒ¯èª¤é¸é …è¦è·Ÿé¡Œç›®å°æ‡‰
                        if (qContent.includes("çµæ§‹")) {
                            // å¦‚æœè€ƒçµæ§‹ï¼ŒéŒ¯èª¤é¸é …è¦æ˜¯æˆåˆ†å
                            let c = (randomItem.components && randomItem.components.length > 0) ? randomItem.components[0].name : randomItem.name_en;
                            wrongAns = c;
                        } else {
                            // å¦‚æœè€ƒç§‘åˆ¥
                            wrongAns = randomItem.family_ch || randomItem.family_en;
                        }
                    }

                    if (wrongAns && wrongAns !== correctAnswer && !distractors.includes(wrongAns)) {
                        distractors.push(wrongAns);
                    }
                }

                return {
                    type: type,
                    question: qContent,
                    image: imgUrl,
                    correct: correctAnswer,
                    options: [...distractors, correctAnswer].sort(() => 0.5 - Math.random())
                };
            });
        }

        // === 3. é¡¯ç¤ºé¡Œç›® ===
        function showQuestion() {
            isAnswering = false;
            const q = questions[currentQIndex];
            
            // æ›´æ–°é€²åº¦ UI
            document.getElementById('q-counter').innerText = `Q${currentQIndex + 1} / ${TOTAL_QUESTIONS}`;
            document.getElementById('progress-fill').style.width = `${((currentQIndex) / TOTAL_QUESTIONS) * 100}%`;
            document.getElementById('q-score').innerText = `å¾—åˆ†: ${score}`;
            document.getElementById('feedback-msg').innerText = "";

            // é¡¯ç¤ºåœ–ç‰‡æˆ–æ–‡å­—
            const imgEl = document.getElementById('q-img');
            if (q.type === 'image' && q.image) {
                imgEl.src = q.image;
                imgEl.style.display = 'inline-block';
            } else {
                imgEl.style.display = 'none';
            }
            document.getElementById('q-text').innerText = q.question;

            // ç”¢ç”Ÿé¸é …æŒ‰éˆ•
            const optsDiv = document.getElementById('options-area');
            optsDiv.innerHTML = "";
            
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt || "æœªçŸ¥é¸é …";
                btn.onclick = () => checkAnswer(opt, btn);
                optsDiv.appendChild(btn);
            });
        }

        // === 4. æª¢æŸ¥ç­”æ¡ˆ ===
        function checkAnswer(selected, btnElement) {
            if (isAnswering) return; // é˜²æ­¢é€£é»
            isAnswering = true;

            const q = questions[currentQIndex];
            const isCorrect = (selected === q.correct);

            // è¦–è¦ºå›é¥‹
            if (isCorrect) {
                btnElement.classList.add('correct');
                document.getElementById('feedback-msg').style.color = "#28a745";
                document.getElementById('feedback-msg').innerText = "âœ… ç­”å°äº†ï¼";
                score += 10;
            } else {
                btnElement.classList.add('wrong');
                document.getElementById('feedback-msg').style.color = "#dc3545";
                document.getElementById('feedback-msg').innerText = `âŒ ç­”éŒ¯äº†ï¼Œç­”æ¡ˆæ˜¯ï¼š${q.correct}`;
                
                // è¨˜éŒ„éŒ¯é¡Œ
                mistakes.push({
                    q: q.question,
                    ans: q.correct,
                    yours: selected,
                    img: q.image
                });

                // æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => {
                    if (b.innerText === q.correct) b.classList.add('correct');
                });
            }

            // å»¶é²è·³è½‰ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                currentQIndex++;
                if (currentQIndex < TOTAL_QUESTIONS) {
                    showQuestion();
                } else {
                    showResult();
                }
            }, 1500);
        }

        // === 5. çµç®— ===
        function showResult() {
            document.getElementById('game-view').style.display = 'none';
            document.getElementById('result-view').style.display = 'block';
            
            document.getElementById('final-score').innerText = score;
            const comment = score === 100 ? "å¤ªç¥å•¦ï¼å…¨å°ï¼ğŸ†" : 
                            score >= 80 ? "å¾ˆæ£’å–”ï¼ç¹¼çºŒä¿æŒï¼âœ¨" : 
                            score >= 60 ? "åŠæ ¼äº†ï¼Œå†åŠ æ²¹ï¼ğŸ“š" : "è¦å†å¤šè¤‡ç¿’ä¸€ä¸‹å–”ï¼ğŸ’ª";
            document.getElementById('final-comment').innerText = comment;

            // é¡¯ç¤ºéŒ¯é¡Œ
            const mistakeArea = document.getElementById('mistake-area');
            if (mistakes.length > 0) {
                mistakeArea.innerHTML = "<h3>âš ï¸ éŒ¯é¡Œæª¢è¨</h3>" + mistakes.map(m => `
                    <div class="mistake-item">
                        ${m.img ? `<img src="${m.img}" style="max-height:80px; display:block; margin-bottom:5px;">` : ''}
                        <div style="font-weight:bold; color:#2C5E4F;">${m.q}</div>
                        <div style="font-size:0.9rem;">ä½ çš„ç­”æ¡ˆï¼š<span style="color:#dc3545">${m.yours}</span></div>
                        <div style="font-size:0.9rem;">æ­£ç¢ºç­”æ¡ˆï¼š<span style="color:#28a745; font-weight:bold;">${m.ans}</span></div>
                    </div>
                `).join('');
            } else {
                mistakeArea.innerHTML = "<p>å¤ªå¼·äº†ï¼æ²’æœ‰ä»»ä½•éŒ¯é¡Œï¼</p>";
            }
        }
    </script>
</body>
</html>
