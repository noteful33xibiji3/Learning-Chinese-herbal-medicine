<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­è—¥è·‘å°æ¸¬é©— | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === æ ¸å¿ƒè®Šæ•¸èˆ‡é‡ç½® === */
        :root {
            --primary: #4A7C59;
            --primary-dark: #2C5E4F;
            --accent: #E8F5E9;
            --text: #333;
            --bg: #f4f7f6;
        }
        body { background: var(--bg); font-family: 'Noto Sans TC', sans-serif; margin: 0; color: var(--text); }
        * { box-sizing: border-box; }

        /* === å°è¦½åˆ— === */
        nav { 
            background: white; padding: 1rem 2rem; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 100;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .back-btn { 
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #666; 
            padding: 5px; border-radius: 50%; transition: 0.2s;
        }
        .back-btn:hover { background: #eee; color: var(--primary); }
        .logo { font-size: 1.3rem; font-weight: 700; color: var(--primary-dark); text-decoration: none; }

        /* === ä¸»å®¹å™¨ === */
        main { max-width: 800px; margin: 30px auto; padding: 0 20px; }

        /* === é¢æ¿æ¨£å¼ === */
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .panel-title { 
            text-align: center; color: var(--primary-dark); margin: 0 0 25px 0; font-size: 1.5rem; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .section-header { 
            font-size: 1rem; color: var(--primary); font-weight: bold; 
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
            background: var(--accent); padding: 8px 15px; border-radius: 10px; width: fit-content;
        }

        /* === 1. å¹´ç´šç¯©é¸ === */
        .grade-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .grade-label { cursor: pointer; flex: 1; min-width: 80px; }
        .grade-label input { display: none; }
        .grade-box { 
            display: block; text-align: center; padding: 10px; 
            border: 1px solid #ddd; border-radius: 12px; color: #666; 
            background: white; transition: 0.2s; font-weight: 500;
        }
        .grade-label input:checked + .grade-box { 
            background: var(--primary); color: white; border-color: var(--primary); 
            box-shadow: 0 4px 10px rgba(74, 124, 89, 0.3); transform: translateY(-2px);
        }

        /* === 2. è—¥æé¸æ“‡ === */
        .search-bar { 
            display: flex; gap: 10px; margin-bottom: 15px; 
            background: white; padding: 5px; border-radius: 50px; border: 1px solid #ddd;
        }
        .search-input { 
            flex: 1; border: none; padding: 10px 20px; font-size: 1rem; outline: none; background: transparent; 
        }
        .action-btn { 
            padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 0.9rem; 
            background: #eee; color: #555; transition: 0.2s; font-weight: bold;
        }
        .action-btn:hover { background: #ddd; }

        .herb-container { 
            height: 250px; overflow-y: auto; padding: 15px; 
            background: #fafafa; border-radius: 15px; border: 1px solid #eee;
            display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;
        }
        .herb-chip { cursor: pointer; }
        .herb-chip input { display: none; }
        .chip-text { 
            display: inline-block; padding: 6px 14px; border-radius: 20px; 
            background: white; border: 1px solid #ddd; color: #555; font-size: 0.9rem; transition: 0.2s; 
        }
        .herb-chip:hover .chip-text { background: #f0f0f0; }
        .herb-chip input:checked + .chip-text { 
            background: var(--primary-dark); color: white; border-color: var(--primary-dark); 
        }

        /* === 3. é…å°æ¨¡å¼ === */
        .match-card { 
            background: #fff8e1; border-radius: 15px; padding: 20px; 
            display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;
            border: 1px solid #ffe0b2;
        }
        .select-group { text-align: center; flex: 1; }
        .select-styled { 
            width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; 
            background: white; font-size: 1rem; cursor: pointer; outline: none;
        }
        .arrow { font-size: 1.5rem; color: #f57c00; }

        /* === 4. æ¸¬é©—æ©Ÿåˆ¶ === */
        .logic-grid { display: flex; gap: 15px; }
        .logic-label { flex: 1; cursor: pointer; }
        .logic-label input { display: none; }
        .logic-box { 
            display: block; padding: 15px; border: 2px solid #eee; border-radius: 12px; 
            text-align: center; transition: 0.2s; background: white;
        }
        .logic-label input:checked + .logic-box { 
            border-color: var(--primary); background: var(--accent); color: var(--primary-dark);
        }

        /* === æŒ‰éˆ• === */
        .btn-start { 
            background: linear-gradient(135deg, #4A7C59, #2C5E4F); color: white; border: none; 
            padding: 15px; width: 100%; border-radius: 50px; font-size: 1.2rem; font-weight: bold; 
            cursor: pointer; box-shadow: 0 5px 15px rgba(44, 94, 79, 0.3); transition: 0.3s;
        }
        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(44, 94, 79, 0.4); }

        /* === æ¸¬é©—ä¸­ç•«é¢ === */
        .progress-track { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin: 15px 0; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: 0.3s; }
        
        .q-card { text-align: center; margin: 20px 0; }
        .q-img { max-height: 200px; max-width: 100%; border-radius: 10px; margin-bottom: 15px; cursor: zoom-in; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .q-text { font-size: 1.6rem; font-weight: bold; color: var(--text); margin: 10px 0; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { 
            background: white; border: 2px solid #eee; border-radius: 15px; padding: 15px; 
            font-size: 1.1rem; cursor: pointer; transition: 0.2s; min-height: 70px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .option-btn:hover { border-color: #ccc; background: #f9f9f9; }
        
        /* ç­”é¡Œç‹€æ…‹æ¨£å¼ */
        .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; font-weight: bold; }
        .option-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } }

        /* === çµæœç•«é¢ === */
        .score-circle { 
            width: 150px; height: 150px; background: var(--primary); color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 3.5rem; font-weight: bold; 
            margin: 20px auto; box-shadow: 0 10px 30px rgba(74, 124, 89, 0.3);
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <button class="back-btn" onclick="location.href='quiz.html'">â®</button>
            <a href="index.html" class="logo">ğŸ’Š ä¸­è—¥è·‘å°æ¸¬é©—</a>
        </div>
    </nav>

    <main>
        <div id="setup-panel" class="panel">
            <h2 class="panel-title">ğŸ› ï¸ æ¸¬é©—è¨­å®š</h2>
            
            <div class="section-header">1. é¸æ“‡å¹´ç´šç¯„åœ</div>
            <div class="grade-grid">
                <label class="grade-label"><input type="checkbox" name="grade" value="å¤§ä¸€" onchange="window.batchSelectByGrade()"><span class="grade-box">å¤§ä¸€</span></label>
                <label class="grade-label"><input type="checkbox" name="grade" value="å¤§äºŒä¸Š" onchange="window.batchSelectByGrade()"><span class="grade-box">å¤§äºŒä¸Š</span></label>
                <label class="grade-label"><input type="checkbox" name="grade" value="å¤§äºŒä¸‹" onchange="window.batchSelectByGrade()"><span class="grade-box">å¤§äºŒä¸‹</span></label>
                <label class="grade-label"><input type="checkbox" name="grade" value="å¤§ä¸‰" onchange="window.batchSelectByGrade()"><span class="grade-box">å¤§ä¸‰</span></label>
            </div>

            <div class="section-header">2. å¾®èª¿è—¥ææ¸…å–®</div>
            <div class="search-bar">
                <input type="text" id="filter-search" class="search-input" placeholder="æœå°‹è—¥æ..." onkeyup="window.renderHerbList()">
                <button class="action-btn" onclick="window.toggleSelectAll(true)">å…¨é¸</button>
                <button class="action-btn" onclick="window.toggleSelectAll(false)">æ¸…ç©º</button>
            </div>
            <div id="herb-chip-container" class="herb-container">
                <p style="text-align:center; width:100%; color:#999; margin-top:50px;">è¼‰å…¥ä¸­...</p>
            </div>
            <div style="text-align:right; margin-top:10px; color:var(--primary); font-weight:bold;" id="selected-count">å·²é¸: 0</div>

            <div class="section-header" style="margin-top:20px;">3. è‡ªç”±é…å°</div>
            <div class="match-card">
                <div class="select-group">
                    <label style="display:block; margin-bottom:5px; color:#666; font-size:0.9rem;">é¡Œç›®é¡¯ç¤º (Q)</label>
                    <select id="mode-question" class="select-styled">
                        <option value="chinese_name">ä¸­è—¥å</option>
                        <option value="family_ch">ç§‘å (ä¸­æ–‡)</option>
                        <option value="family_en">ç§‘å (è‹±æ–‡)</option>
                        <option value="origin">åŸºåŸ(å­¸å)</option>
                        <option value="chemistry" selected>æˆåˆ†/åœ–ç‰‡</option>
                        <option value="image">ä¸­è—¥å¤–è§€åœ–</option>
                        <option value="effects">åŠŸæ•ˆ</option>
                        <option value="latin_name">ç”Ÿè—¥å</option>
                    </select>
                </div>
                <div class="arrow">â¡</div>
                <div class="select-group">
                    <label style="display:block; margin-bottom:5px; color:#666; font-size:0.9rem;">é¸é …ç­”æ¡ˆ (A)</label>
                    <select id="mode-answer" class="select-styled">
                        <option value="chinese_name" selected>ä¸­è—¥å</option>
                        <option value="latin_name">ç”Ÿè—¥å</option>
                        <option value="family_ch">ç§‘å (ä¸­æ–‡)</option>
                        <option value="family_en">ç§‘å (è‹±æ–‡)</option>
                        <option value="origin">åŸºåŸ</option>
                        <option value="effects">åŠŸæ•ˆ</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:10px; padding:10px; background:#fff; border-radius:10px; display:flex; gap:15px; justify-content:center; font-size:0.9rem; color:#666;">
                <span>ğŸ§ª æˆåˆ†é¡Œé¡¯ç¤ºï¼š</span>
                <label><input type="radio" name="chemDisplay" value="full" checked> ä¸­+è‹±+åœ–</label>
                <label><input type="radio" name="chemDisplay" value="en_img"> è‹±+åœ–</label>
            </div>

            <div class="section-header" style="margin-top:20px;">4. æ¸¬é©—æ©Ÿåˆ¶</div>
            <div class="logic-grid">
                <label class="logic-label">
                    <input type="radio" name="quizLogic" value="standard" checked>
                    <span class="logic-box">
                        <strong>ğŸ æ¨™æº–æ¨¡å¼</strong><br><small style="color:#888">è€ƒå®Œå³çµæŸ</small>
                    </span>
                </label>
                <label class="logic-label">
                    <input type="radio" name="quizLogic" value="reinforce">
                    <span class="logic-box">
                        <strong>ğŸ’ª éå›ºå­¸ç¿’</strong><br><small style="color:#888">éŒ¯é¡Œæœƒé‡å‡º</small>
                    </span>
                </label>
            </div>

            <div style="margin-top:30px;">
                <button class="btn-start" onclick="window.startQuiz()">ğŸš€ é–‹å§‹æ¸¬é©—</button>
            </div>
        </div>

        <div id="quiz-panel" class="panel" style="display: none;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:#666;">
                <span>é€²åº¦ <span id="q-current">1</span> / <span id="q-total">10</span></span>
                <span style="color:var(--primary);">å¾—åˆ†: <span id="q-score">0</span></span>
            </div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            
            <div id="quiz-content" class="q-card"></div>

            <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                <button id="btn-next" class="btn-start" onclick="window.nextQuestion(true)" style="display:none; width:auto; padding:10px 40px;">ä¸‹ä¸€é¡Œ â¡</button>
                <button id="btn-finish" class="btn-start" onclick="window.endQuiz()" style="display:none; width:auto; padding:10px 40px; background:#333;">ğŸ çµæŸ</button>
            </div>
        </div>

        <div id="result-panel" class="panel" style="display: none; text-align:center;">
            <h2>ğŸ“Š æ¸¬é©—çµæœ</h2>
            <div class="score-circle" id="final-score">100</div>
            <p id="result-msg" style="font-size:1.2rem; color:#666; margin-bottom:30px;">æ­å–œå®Œæˆï¼</p>
            
            <button id="btn-retry-mistakes" class="btn-start" onclick="window.retryMistakes()" style="display:none; background:#dc3545; margin-bottom:15px;">ğŸ”¥ éŒ¯èª¤é¡Œé‡æ¸¬</button>
            
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-start" onclick="window.restartQuiz()" style="font-size:1rem; padding:12px 20px;">ğŸ”„ å†æ¸¬ä¸€æ¬¡</button>
                <button class="btn-start" onclick="window.backToSetup()" style="font-size:1rem; padding:12px 20px; background:white; border:2px solid #ccc; color:#666;">âš™ï¸ å›è¨­å®š</button>
            </div>
            
            <button onclick="location.href='quiz.html'" style="background:transparent; border:none; color:#666; text-decoration:underline; margin-top:20px; cursor:pointer;">å›æ¸¬é©—å¤§å»³</button>
        </div>
    </main>

    <script>
        // === é‚è¼¯å€ ===
        window.allHerbs = []; window.quizList = []; window.currentIdx = 0;
        window.score = 0; window.selectedHerbIds = new Set(); 
        window.quizLogic = "standard"; window.sessionWrongHerbs = []; 

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('data/herbs.json');
                if (!res.ok) throw new Error("HTTP error " + res.status);
                window.allHerbs = await res.json();
                window.renderHerbList();
                
                const qSelect = document.getElementById('mode-question');
                const aSelect = document.getElementById('mode-answer');
                function updateAnswerOptions() {
                    const qVal = qSelect.value;
                    Array.from(aSelect.options).forEach(opt => { opt.disabled = (opt.value === qVal); });
                }
                qSelect.addEventListener('change', updateAnswerOptions);
                updateAnswerOptions();
            } catch (err) {
                console.error(err);
                document.getElementById('herb-chip-container').innerHTML = `<p style="color:red; text-align:center;">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</p>`;
            }
        });

        window.renderHerbList = function() {
            const container = document.getElementById('herb-chip-container');
            const term = document.getElementById('filter-search').value.trim().toLowerCase();
            container.innerHTML = "";
            const filtered = window.allHerbs.filter(h => !term || h.chinese_name.includes(term));
            
            if (filtered.length === 0) {
                container.innerHTML = `<div style="width:100%; text-align:center; color:#999; padding:10px;">æ‰¾ä¸åˆ°ç¬¦åˆçš„è—¥æ</div>`;
                return;
            }
            filtered.forEach(herb => {
                const label = document.createElement('label');
                label.className = 'herb-chip';
                const isChecked = window.selectedHerbIds.has(herb.id) ? 'checked' : '';
                label.innerHTML = `<input type="checkbox" value="${herb.id}" onchange="window.handleChipChange(this)" ${isChecked}><span class="chip-text">${herb.chinese_name}</span>`;
                container.appendChild(label);
            });
            window.updateCount();
        };

        window.handleChipChange = function(cb) {
            const id = parseInt(cb.value);
            if (cb.checked) window.selectedHerbIds.add(id); else window.selectedHerbIds.delete(id);
            window.updateCount();
        };
        window.updateCount = function() { document.getElementById('selected-count').innerText = `å·²é¸: ${window.selectedHerbIds.size}`; };

        window.batchSelectByGrade = function() {
            const checked = Array.from(document.querySelectorAll('input[name="grade"]:checked')).map(c => c.value);
            const unchecked = Array.from(document.querySelectorAll('input[name="grade"]:not(:checked)')).map(c => c.value);
            window.allHerbs.forEach(h => {
                if (checked.includes(h.grade)) window.selectedHerbIds.add(h.id);
                else if (unchecked.includes(h.grade)) window.selectedHerbIds.delete(h.id);
            });
            window.renderHerbList();
        };

        window.toggleSelectAll = function(select) {
            document.querySelectorAll('#herb-chip-container input').forEach(i => {
                i.checked = select;
                const id = parseInt(i.value);
                if (select) window.selectedHerbIds.add(id); else window.selectedHerbIds.delete(id);
            });
            window.updateCount();
        };

        // --- æ¸¬é©—æ ¸å¿ƒ (ä¿®æ­£ç‰ˆï¼šæ‰‹å‹•è·³é¡Œ + é¡¯ç¤ºæ­£è§£) ---
        window.startQuiz = function() {
            window.quizList = window.allHerbs.filter(h => window.selectedHerbIds.has(h.id));
            if (window.quizList.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å‘³è—¥æï¼");
            const qMode = document.getElementById('mode-question').value;
            const aMode = document.getElementById('mode-answer').value;
            if (qMode === aMode) return alert("é¡Œç›®å’Œç­”æ¡ˆä¸èƒ½ä¸€æ¨£ï¼");

            window.quizLogic = document.querySelector('input[name="quizLogic"]:checked').value;
            window.currentIdx = 0; window.score = 0; window.sessionWrongHerbs = [];
            window.quizList.sort(() => Math.random() - 0.5);

            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('quiz-panel').style.display = 'block';
            document.getElementById('result-panel').style.display = 'none';
            document.getElementById('q-total').innerText = window.quizList.length;
            window.nextQuestion();
        };

        function parseOptionData(data, mode) {
            let label = "", image = null, html = "";
            let target = Array.isArray(data) ? data[Math.floor(Math.random() * data.length)] : data;

            if (typeof target === 'object' && target !== null && (target.name_en || target.family_ch)) {
                if (mode === 'chemistry') {
                    const setting = document.querySelector('input[name="chemDisplay"]:checked').value;
                    let parts = [];
                    if (target.name_en) parts.push(target.name_en);
                    if (setting === 'full' && target.name_ch) parts.push(target.name_ch);
                    label = parts.join('<br>');
                    image = target.image;
                } else {
                    label = target.name || target.name_en || JSON.stringify(target);
                    image = target.image;
                }
            } else { label = target; }

            if (mode === 'image') { image = (typeof target === 'string') ? target : target.image; label = ""; }

            if (image) html += `<img src="${image}" class="q-img">`;
            if (label) html += `<div style="${image?'font-size:0.9rem':''}">${label}</div>`;
            return { label, image, html };
        }

        window.getFieldData = function(herb, mode) {
            if (mode === 'image') return herb.image;
            if (mode === 'family_ch') return herb.family_ch || "ç„¡ä¸­æ–‡ç§‘å";
            if (mode === 'family_en') return herb.family_en || "ç„¡è‹±æ–‡ç§‘å";
            return herb[mode] || "ç„¡è³‡æ–™";
        };

        window.nextQuestion = function(manual) {
            if (manual) window.currentIdx++;
            if (window.currentIdx >= window.quizList.length) return window.endQuiz();

            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-finish').style.display = 'none';
            document.getElementById('q-current').innerText = window.currentIdx + 1;
            document.getElementById('q-score').innerText = window.score;
            document.getElementById('progress-bar').style.width = `${((window.currentIdx)/window.quizList.length)*100}%`;

            const herb = window.quizList[window.currentIdx];
            const qMode = document.getElementById('mode-question').value;
            const aMode = document.getElementById('mode-answer').value;

            const qRaw = window.getFieldData(herb, qMode);
            const qObj = parseOptionData(qRaw, qMode);
            const modeName = { 'chinese_name':'ä¸­è—¥å', 'chemistry':'æˆåˆ†', 'image':'å¤–è§€', 'effects':'åŠŸæ•ˆ' };

            const content = `
                <div style="text-align:center;">
                    <span style="background:#2C5E4F; color:white; padding:4px 12px; border-radius:20px; font-size:0.85rem;">é¡Œç›®ï¼š${modeName[qMode] || qMode}</span>
                    <div style="margin:20px 0;">${qObj.html}</div>
                    <p style="color:#666;">è«‹é¸æ“‡æ­£ç¢ºçš„ <b>${modeName[aMode] || aMode}</b></p>
                </div>
            `;

            let correctRaw = window.getFieldData(herb, aMode);
            let correctObj = parseOptionData(correctRaw, aMode);
            let options = [{ ...correctObj, isCorrect: true }];

            let attempts = 0;
            while(options.length < 4 && attempts < 200) {
                attempts++;
                const rnd = window.allHerbs[Math.floor(Math.random() * window.allHerbs.length)];
                if (rnd.id === herb.id) continue;
                let wrongRaw = window.getFieldData(rnd, aMode);
                let wrongObj = parseOptionData(wrongRaw, aMode);
                if (!wrongObj.label && !wrongObj.image) continue;
                if (!options.some(o => o.label === wrongObj.label)) options.push({ ...wrongObj, isCorrect: false });
            }
            options.sort(() => Math.random() - 0.5);

            let btnsHtml = options.map(opt => 
                // â˜… é€™è£¡å¾ˆé‡è¦ï¼šæŠŠ data-is-correct å±¬æ€§åŠ é€²å»ï¼Œæ–¹ä¾¿ç¨å¾Œæª¢æŸ¥æ™‚æ‰¾åˆ°æ­£ç¢ºæŒ‰éˆ•
                `<button class="option-btn" data-is-correct="${opt.isCorrect}" onclick="window.checkAnswer(this, ${opt.isCorrect})">${opt.html}</button>`
            ).join('');

            document.getElementById('quiz-content').innerHTML = content + `<div class="options-grid">${btnsHtml}</div>`;
        };

        // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–·ç­”æ¡ˆä¸¦é¡¯ç¤ºçµæœ
        window.checkAnswer = function(btn, isCorrect) {
            // 1. é–å®šæ‰€æœ‰æŒ‰éˆ•ï¼Œä¸èƒ½å†é»
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            const herb = window.quizList[window.currentIdx];

            if (isCorrect) {
                btn.classList.add('correct');
                window.score += 10;
            } else {
                btn.classList.add('wrong');
                // â˜… é€™è£¡ï¼šç­”éŒ¯æ™‚ï¼Œè‡ªå‹•å¹«ä½ æŠŠã€Œæ­£ç¢ºçš„é‚£å€‹æŒ‰éˆ•ã€æ¨™ç¤ºæˆç¶ è‰²
                const correctBtn = document.querySelector('.option-btn[data-is-correct="true"]');
                if (correctBtn) correctBtn.classList.add('correct');

                if(!window.sessionWrongHerbs.find(h => h.id === herb.id)) window.sessionWrongHerbs.push(herb);
                if (window.quizLogic === "reinforce") {
                    window.quizList.splice(window.currentIdx + 3, 0, herb);
                    document.getElementById('q-total').innerText = window.quizList.length;
                }
            }
            document.getElementById('q-score').innerText = window.score;
            
            // â˜… ç§»é™¤ setTimeoutï¼Œæ”¹ç‚ºé¡¯ç¤ºã€Œä¸‹ä¸€é¡Œã€æˆ–ã€ŒçµæŸã€æŒ‰éˆ•
            if (window.currentIdx === window.quizList.length - 1) {
                document.getElementById('btn-finish').style.display = 'block';
            } else {
                document.getElementById('btn-next').style.display = 'block';
            }
        };

        window.endQuiz = function() {
            document.getElementById('quiz-panel').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('final-score').innerText = window.score;
            
            const btnRetry = document.getElementById('btn-retry-mistakes');
            if (window.sessionWrongHerbs.length > 0) {
                btnRetry.style.display = 'block';
                btnRetry.innerText = `ğŸ”¥ éŒ¯èª¤é¡Œé‡æ¸¬ (${window.sessionWrongHerbs.length}é¡Œ)`;
            } else {
                btnRetry.style.display = 'none';
            }
        };

        window.retryMistakes = function() {
            window.quizList = [...window.sessionWrongHerbs];
            window.sessionWrongHerbs = [];
            window.restartQuiz();
        };

        window.restartQuiz = function() {
            window.currentIdx = 0; window.score = 0;
            window.quizList.sort(() => Math.random() - 0.5);
            document.getElementById('result-panel').style.display = 'none';
            document.getElementById('quiz-panel').style.display = 'block';
            document.getElementById('q-total').innerText = window.quizList.length;
            window.nextQuestion();
        };

        window.backToSetup = function() {
            document.getElementById('result-panel').style.display = 'none';
            document.getElementById('quiz-panel').style.display = 'none';
            document.getElementById('setup-panel').style.display = 'block';
        };
    </script>
</body>
</html>
