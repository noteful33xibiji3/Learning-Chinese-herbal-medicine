<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é¡ä»‹ç´¹ç®¡ç† | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { background: #f4f7f6; font-family: 'Noto Sans TC', sans-serif; margin: 0; }
        .container { max-width: 900px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; background: #4A7C59; }
        .btn:hover { background: #2C5E4F; }
        .btn-back { background: #666; margin-right: 10px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #333; }
        select { width: 100%; padding: 10px; font-size: 1.1rem; border-radius: 8px; border: 1px solid #ccc; }
        .editor-container { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ğŸ“– ç”Ÿè—¥åˆ†é¡ä»‹ç´¹ç·¨è¼¯å™¨</h2>
            <button class="btn btn-back" onclick="location.href='admin_menu.html'">å›é¸å–®</button>
        </div>

        <label>é¸æ“‡åˆ†é¡ (Category)</label>
        <select id="cat-select" onchange="loadCategoryData()">
            <option value="">-- è«‹é¸æ“‡åˆ†é¡ --</option>
        </select>

        <div id="editor-area" style="display:none; margin-top:20px;">
            <label>ğŸ“ è©³ç´°ä»‹ç´¹ (å«ç°¡ä»‹ã€åŠŸç”¨ã€åˆæˆã€æª¢é©—ã€æ¯”è¼ƒè¡¨)</label>
            <div style="background:#fff3e0; padding:10px; font-size:0.9rem; color:#666; margin-bottom:10px; border-radius:5px;">
                ğŸ’¡ æç¤ºï¼šä½¿ç”¨ä¸Šæ–¹å·¥å…·åˆ—çš„ <strong>è¡¨æ ¼åœ–ç¤º</strong> ä¾†æ–°å¢æ¯”è¼ƒè¡¨ã€‚å¯ä»¥è‡ªç”±è¼¸å…¥æ¨™é¡Œ (å¦‚ï¼šä¸€ã€ç°¡ä»‹)ã€‚
            </div>
            <textarea id="rich-editor"></textarea>
            
            <button class="btn" onclick="saveCategory()" style="width:100%; margin-top:20px; padding:15px; font-size:1.1rem;">ğŸ’¾ å„²å­˜ä»‹ç´¹</button>
        </div>
    </div>

    <script src="pharma_config.js"></script>
    <script src="utils.js"></script>
    <script>
        let categoriesData = {};
        let fileSha = "";
        const FILE_PATH = "data/categories.json";

        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ– TinyMCE (Gmail é¢¨æ ¼ç·¨è¼¯å™¨)
            tinymce.init({
                selector: '#rich-editor',
                height: 500,
                plugins: 'table lists link image code',
                toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter | bullist numlist | table | code',
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; }'
            });

            // æª¢æŸ¥ç™»å…¥
            const configStr = localStorage.getItem('tcm_admin_config');
            if (!configStr) return location.href = "admin_menu.html";
            const config = JSON.parse(configStr);
            await initGitHubConfig(config.token, config.user, config.repo);

            // è¼‰å…¥ä¸‹æ‹‰é¸å–® (å¾ config)
            const sel = document.getElementById('cat-select');
            PHARMA_CATEGORIES.forEach(c => {
                sel.add(new Option(c.name_ch + " (" + c.name_en + ")", c.name_ch));
            });

            // è¼‰å…¥ç¾æœ‰è³‡æ–™
            try {
                const res = await fetchJSON(FILE_PATH);
                categoriesData = res.data;
                fileSha = res.sha;
            } catch(e) {
                console.log("å°šç„¡ categories.jsonï¼Œå°‡å»ºç«‹æ–°æª”");
                categoriesData = {}; // åˆå§‹åŒ–
            }
        });

        function loadCategoryData() {
            const cat = document.getElementById('cat-select').value;
            if (!cat) {
                document.getElementById('editor-area').style.display = 'none';
                return;
            }
            document.getElementById('editor-area').style.display = 'block';
            
            // è®€å–è©²åˆ†é¡çš„å…§å®¹ (å¦‚æœæœ‰çš„è©±)
            const content = categoriesData[cat] || "";
            tinymce.get('rich-editor').setContent(content);
        }

        async function saveCategory() {
            const cat = document.getElementById('cat-select').value;
            if (!cat) return alert("è«‹å…ˆé¸æ“‡åˆ†é¡");

            const content = tinymce.get('rich-editor').getContent();
            categoriesData[cat] = content; // å„²å­˜ HTML

            try {
                const res = await saveJSON(FILE_PATH, categoriesData, fileSha, `Update Category: ${cat}`);
                fileSha = res.content.sha;
                alert("ğŸ‰ å„²å­˜æˆåŠŸï¼");
            } catch(e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            }
        }
    </script>
</body>
</html>
