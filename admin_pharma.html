<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥è³‡æ–™åº«ç®¡ç† | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    
    <style>
        /* === æ¨£å¼å€ === */
        body { background: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; }
        nav { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .nav-title { font-size: 1.2rem; font-weight: bold; color: #2C5E4F; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: #e0e0e0; color: #333; padding: 5px 12px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; transition: 0.2s; }
        .back-btn:hover { background: #d0d0d0; }
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .pharma-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border-left: 5px solid #4A7C59; position: relative; }
        .pharma-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-size: 1.3rem; font-weight: bold; color: #333; margin: 0; }
        .card-cat { background: #e8f5e9; color: #2C5E4F; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .card-en { color: #666; font-size: 0.9rem; font-style: italic; }
        .card-delete-btn { position: absolute; bottom: 15px; right: 15px; background: #ffebee; color: #c62828; border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: 0.2s; z-index: 2; }
        .card-delete-btn:hover { background: #ffcdd2; transform: scale(1.1); }
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: white; width: 95%; max-width: 900px; margin: 0 auto 50px auto; padding: 30px; border-radius: 15px; position: relative; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .section-title { font-size: 1.1rem; color: #2C5E4F; border-bottom: 2px solid #eee; padding-bottom: 5px; margin: 30px 0 15px 0; font-weight: bold; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: #4A7C59; }
        .btn-add { background: #607d8b; width: 100%; margin-top: 5px; }
        .btn-danger { background: #e57373; padding: 5px 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size:2rem;">â³</div>
        <p id="loading-text">æ­£åœ¨é€£æ¥ GitHub è³‡æ–™åº«...</p>
        <button onclick="document.getElementById('loading-overlay').style.display='none'" style="margin-top:20px; padding:5px 10px; border:1px solid #ccc; background:white; cursor:pointer;">å¼·åˆ¶é—œé–‰ (é™¤éŒ¯ç”¨)</button>
    </div>

    <nav>
        <div class="nav-title">
            <a href="admin_menu.html" class="back-btn">â¬… å›é¸å–®</a>
            <a href="pharmacognosy.html" class="back-btn" style="background:#e8f5e9; color:#2C5E4F; margin-left:5px;" target="_blank">ğŸ  å»å‰å°çœ‹</a>
            <span style="margin-left:10px;">ğŸ”¬ ç”Ÿè—¥è³‡æ–™åº«ç®¡ç†</span>
        </div>
        <button onclick="openModal()" class="btn btn-primary">ï¼‹ æ–°å¢ç”Ÿè—¥</button>
    </nav>

    <main>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ç”Ÿè—¥åç¨±ã€å­¸åã€æˆåˆ†..." oninput="renderList()">
            <select id="filter-cat" onchange="renderList()" style="width:150px;">
                <option value="">æ‰€æœ‰åˆ†é¡</option>
            </select>
        </div>

        <div id="pharma-list" class="card-container"></div>
    </main>

    <div id="edit-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:#2C5E4F;">ç·¨è¼¯ç”Ÿè—¥è³‡æ–™</h2>
                <button onclick="closeModalDirect()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <input type="hidden" id="edit-id">

            <div class="form-group" style="background:#e8f5e9; padding:15px; border-radius:10px;">
                <label>ğŸ“Œ ç”Ÿè—¥åˆ†é¡ (ä¾æ“š Word è¨­å®š)</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="cat-main" onchange="updateSubCats()"><option value="">- å¤§åˆ†é¡ -</option></select>
                    <select id="cat-sub"><option value="">- ä¸­åˆ†é¡ -</option></select>
                </div>
            </div>

            <div class="section-title">åŸºæœ¬è³‡æ–™</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>ç”Ÿè—¥åç¨± (ä¸­æ–‡)</label><input type="text" id="name-ch" placeholder="ä¾‹å¦‚ï¼šéº»é»ƒ"></div>
                <div><label>ç”Ÿè—¥åç¨± (è‹±æ–‡)</label><input type="text" id="name-en" placeholder="ä¾‹å¦‚ï¼šEphedra"></div>
            </div>
            
            <label style="margin-top:10px;">åˆ¥å (Alias)</label>
            <div id="alias-list"></div>
            <button class="btn btn-add" onclick="addAliasRow()">+ æ–°å¢åˆ¥å</button>

            <div class="section-title">åŸºåŸèˆ‡ç§‘åˆ¥</div>
            <div class="form-group"><label>åŸºåŸ (Origin)</label><input type="text" id="origin" placeholder="ä¾‹å¦‚ï¼šEphedra sinica Stapf"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>ç§‘å (ä¸­æ–‡)</label><input type="text" id="family-ch" placeholder="éº»é»ƒç§‘"></div>
                <div><label>ç§‘å (è‹±æ–‡)</label><input type="text" id="family-en" placeholder="Ephedraceae"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">
                <div><label>ä½¿ç”¨éƒ¨ä½ (ä¸­æ–‡)</label><input type="text" id="part-ch" placeholder="ä¹¾ç‡¥è‰è³ªè–"></div>
                <div><label>ä½¿ç”¨éƒ¨ä½ (è‹±æ–‡)</label><input type="text" id="part-en" placeholder="Stem"></div>
            </div>

            <div class="section-title">âš—ï¸ åŒ–å­¸æˆåˆ† (Components)</div>
            <div id="chem-list"></div>
            <button class="btn btn-add" style="background:#4A7C59;" onclick="addChemRow()">+ æ–°å¢æˆåˆ†èˆ‡çµæ§‹åœ–</button>

            <div class="section-title">âš–ï¸ æ¯”è¼ƒ (Comparison)</div>
            <div id="compare-list"></div>
            <button class="btn btn-add" onclick="addCompareRow()">+ æ–°å¢æ¯”è¼ƒé …ç›®</button>

            <div class="section-title">ç‰¹æ€§èˆ‡åŠŸæ•ˆ</div>
            <div class="form-group"><label>æ€§ç‹€/ç‰¹æ€§</label><textarea id="characteristics" rows="3"></textarea></div>
            <div class="form-group"><label>åŠŸæ•ˆ (Efficacy)</label><textarea id="efficacy" rows="3"></textarea></div>
            <div class="form-group"><label>é©æ‡‰ç—‡/æ²»ç™‚</label><textarea id="treatment" rows="2"></textarea></div>
            <div class="form-group"><label>è¨˜æ³• (Mnemonic)</label><input type="text" id="mnemonic" placeholder="å£è¨£..."></div>

            <div class="section-title">ğŸ“ è©³ç´°å‚™è¨»</div>
            <textarea id="rich-note"></textarea>

            <div class="modal-footer" style="margin-top:30px; display:flex; gap:10px;">
                <button onclick="closeModalDirect()" style="flex:1; background:#eee; color:#333; border:none; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="saveData()" id="btn-save" class="btn btn-primary" style="flex:2; padding:15px; font-size:1.1rem;">ğŸ’¾ å„²å­˜è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script src="pharma_config.js"></script>
    <script src="utils.js"></script>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let pharmaList = [];
        let fileSha = "";
        const FILE_PATH = "data/pharma.json";
        
        // â˜… é—œéµä¿®æ­£ï¼šè®Šæ•¸æ”¹åï¼Œé¿å…èˆ‡å…¶ä»–æª”æ¡ˆè¡çª
        let pharmaConfig = null; 

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ– TinyMCE
            tinymce.init({
                selector: '#rich-note', // â˜… ç¢ºä¿é€™è£¡å°æ‡‰ textarea çš„ ID
                height: 400,
                plugins: 'table lists link image code preview searchreplace autolink fullscreen charmap',
                toolbar: 'undo redo | cut copy paste | blocks fontfamily fontsize | ' +
                         'bold italic underline strikethrough forecolor backcolor | ' +
                         'alignleft aligncenter alignright alignjustify | ' +
                         'bullist numlist outdent indent | table image link | removeformat code fullscreen',
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; color: #333; }',
                branding: false,
                menubar: true
            });

            // 2. ç™»å…¥æª¢æŸ¥
            const configStr = localStorage.getItem('tcm_admin_config');
            if (!configStr) {
                alert("è«‹å…ˆç™»å…¥ï¼");
                document.getElementById('loading-overlay').style.display = 'none';
                return location.href = 'admin_menu.html';
            }
            
            // â˜… è®€å–è¨­å®šåˆ°æ–°è®Šæ•¸ pharmaConfig
            pharmaConfig = JSON.parse(configStr);
            
            // 3. æ ¸å¿ƒè¼‰å…¥é‚è¼¯ (é˜²å¡æ­»)
            try {
                // æª¢æŸ¥ utils.js
                if (typeof initGitHubConfig === 'undefined') throw new Error("æ‰¾ä¸åˆ° utils.jsï¼Œè«‹æª¢æŸ¥æª”æ¡ˆ");

                await initGitHubConfig(pharmaConfig.token, pharmaConfig.user, pharmaConfig.repo);
                await loadData();
                initCatSelects();
                
            } catch (e) {
                alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
                console.error(e);
            } finally {
                // â˜… é—œéµï¼šç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½è¦æŠŠè¼‰å…¥ç•«é¢é—œæ‰
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        // 1. è®€å–è³‡æ–™ (å®¹éŒ¯è™•ç†)
        async function loadData() {
            try {
                const url = `https://api.github.com/repos/${pharmaConfig.user}/${pharmaConfig.repo}/contents/${FILE_PATH}?t=${Date.now()}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${pharmaConfig.token}` } });
                
                if (res.ok) {
                    const json = await res.json();
                    fileSha = json.sha;
                    if (json.content) {
                        pharmaList = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                    } else {
                        pharmaList = [];
                    }
                } else if (res.status === 404) {
                    console.log("å°šæœªå»ºç«‹ pharma.jsonï¼Œå°‡åˆå§‹åŒ–ç‚ºæ–°æª”");
                    pharmaList = [];
                } else {
                    throw new Error("GitHub å›å‚³éŒ¯èª¤: " + res.status);
                }
                
                renderList();
            } catch (e) {
                console.error("è®€å–å¤±æ•—:", e);
                pharmaList = [];
                renderList();
            }
        }

        // 2. æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            const container = document.getElementById('pharma-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('filter-cat').value;
            
            container.innerHTML = "";

            const filtered = pharmaList.filter(item => {
                const matchSearch = (item.name_ch || "").includes(search) || (item.name_en || "").toLowerCase().includes(search);
                const matchCat = filter ? item.category_main === filter : true;
                return matchSearch && matchCat;
            });
            
            const sortedList = [...filtered].sort((a,b) => b.id - a.id);

            sortedList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pharma-card';
                div.onclick = () => openModal(item.id);
                
                div.innerHTML = `
                    <div class="card-header">
                        <span class="card-name">${item.name_ch}</span>
                        <span class="card-cat">${item.category_sub || item.category_main}</span>
                    </div>
                    <div class="card-en">${item.name_en}</div>
                    <div style="font-size:0.85rem; color:#888; margin-top:5px;">
                        ${item.family_ch || ""} / ${item.part_ch || ""}
                    </div>
                    <button class="card-delete-btn" onclick="event.stopPropagation(); deleteItem(${item.id})" title="åˆªé™¤æ­¤è³‡æ–™">
                        ğŸ—‘ï¸
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // 3. åˆªé™¤åŠŸèƒ½
        async function deleteItem(id) {
            if (!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼")) return;
            
            const newArr = pharmaList.filter(item => item.id !== id);
            const oldArr = [...pharmaList];
            pharmaList = newArr;
            renderList();

            try {
                await uploadToGitHub(newArr, `Delete ID: ${id}`);
                alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸï¼");
            } catch (e) {
                alert("åˆªé™¤å¤±æ•—: " + e.message);
                pharmaList = oldArr; // é‚„åŸ
                renderList();
            }
        }

        // 4. ç·¨è¼¯è¦–çª—
        function openModal(id = null) {
            const modal = document.getElementById('edit-modal');
            document.querySelectorAll('input, select, textarea').forEach(i => i.value = '');
            document.getElementById('alias-list').innerHTML = "";
            document.getElementById('chem-list').innerHTML = "";
            document.getElementById('compare-list').innerHTML = "";
            tinymce.get('rich-note').setContent('');

            if (id) {
                const item = pharmaList.find(i => i.id === id);
                if (item) {
                    document.getElementById('edit-id').value = item.id;
                    document.getElementById('name-ch').value = item.name_ch || '';
                    document.getElementById('name-en').value = item.name_en || '';
                    document.getElementById('cat-main').value = item.category_main || '';
                    updateSubCats();
                    document.getElementById('cat-sub').value = item.category_sub || '';
                    document.getElementById('origin').value = item.origin || '';
                    document.getElementById('family-ch').value = item.family_ch || '';
                    document.getElementById('family-en').value = item.family_en || '';
                    document.getElementById('part-ch').value = item.part_ch || '';
                    document.getElementById('part-en').value = item.part_en || '';
                    document.getElementById('characteristics').value = item.characteristics || '';
                    document.getElementById('efficacy').value = item.efficacy || '';
                    document.getElementById('treatment').value = item.treatment || '';
                    document.getElementById('mnemonic').value = item.mnemonic || '';
                    tinymce.get('rich-note').setContent(item.note || '');

                    (item.aliases || []).forEach(v => addAliasRow(v));
                    (item.components || []).forEach(v => addChemRow(v));
                    (item.comparisons || []).forEach(v => addCompareRow(v));
                }
            } else {
                document.getElementById('edit-id').value = "";
                addChemRow(); // é è¨­çµ¦ä¸€è¡Œæˆåˆ†
            }
            modal.style.display = 'block';
        }

        function closeModalDirect() { document.getElementById('edit-modal').style.display = 'none'; }
        function closeModal() { if(confirm("ç¢ºå®šé—œé–‰ï¼Ÿæœªå„²å­˜è®Šæ›´å°‡éºå¤±")) closeModalDirect(); }

        // 5. å‹•æ…‹æ¬„ä½
        function addAliasRow(val = "") {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="alias-input" value="${val}" placeholder="åˆ¥å"><button class="btn btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('alias-list').appendChild(div);
        }
        function addCompareRow(data = {}) {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="comp-target" value="${data.target||''}" placeholder="å°è±¡"><input type="text" class="comp-diff" value="${data.diff||''}" placeholder="å·®ç•°"><button class="btn btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('compare-list').appendChild(div);
        }
        function addChemRow(data = {}) {
            const div = document.createElement('div'); div.className = 'dynamic-row'; div.style.flexDirection = 'column';
            const imgId = `chem-img-${Date.now()}-${Math.random()}`;
            const imgVal = data.image || "";
            const noteVal = data.note || ""; 
            
            div.innerHTML = `
                <div style="display:flex; gap:5px; width:100%;">
                    <input type="text" class="chem-name" value="${data.name||''}" placeholder="æˆåˆ†å (å¦‚: Ephedrine)">
                    <input type="text" class="chem-note" value="${noteVal}" placeholder="å‚™è¨» (å¦‚: æ¯’æ€§)">
                    <button class="btn btn-danger" onclick="this.closest('.dynamic-row').remove()">âœ•</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="background:#eee; padding:5px; border-radius:5px; cursor:pointer;">ğŸ“¸ ä¸Šå‚³çµæ§‹ <input type="file" style="display:none" onchange="handleChemUpload(this, '${imgId}')"></label>
                    <img id="${imgId}" src="${imgVal}" style="max-height:60px; display:${imgVal?'block':'none'}; border:1px solid #ccc;">
                    <input type="hidden" class="chem-img-url" value="${imgVal}">
                </div>`;
            document.getElementById('chem-list').appendChild(div);
        }
        function handleChemUpload(input, viewId) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(viewId).src = e.target.result;
                document.getElementById(viewId).style.display = 'block';
                input.fileObj = file; 
            };
            reader.readAsDataURL(file);
        }

        // 6. å„²å­˜é‚è¼¯ (é˜²å‘† + è‡ªå‹•é—œé–‰ + SHAè™•ç†)
        async function saveData() {
            const btn = document.getElementById('btn-save');
            const idVal = document.getElementById('edit-id').value;
            const name_ch = document.getElementById('name-ch').value.trim();
            if (!name_ch) return alert("ä¸­æ–‡è—¥åå¿…å¡«ï¼");

            btn.disabled = true; // é–å®šæŒ‰éˆ•
            btn.innerText = "â³ å„²å­˜ä¸­...";

            try {
                // A. è™•ç†åœ–ç‰‡
                const chemRows = document.querySelectorAll('#chem-list .dynamic-row');
                const components = [];
                for (let row of chemRows) {
                    const name = row.querySelector('.chem-name').value.trim();
                    const note = row.querySelector('.chem-note').value.trim();
                    if (!name) continue;
                    
                    let imgUrl = row.querySelector('.chem-img-url').value;
                    const fileInput = row.querySelector('input[type="file"]');
                    if (fileInput.fileObj) {
                        imgUrl = await compressAndUploadImage(fileInput.fileObj, 'images/pharma');
                    }
                    components.push({ name, note, image: imgUrl });
                }

                // B. å»ºç«‹ç‰©ä»¶
                const newItem = {
                    id: idVal ? parseInt(idVal) : Date.now(),
                    name_ch, name_en: document.getElementById('name-en').value.trim(),
                    category_main: document.getElementById('cat-main').value,
                    category_sub: document.getElementById('cat-sub').value,
                    origin: document.getElementById('origin').value,
                    family_ch: document.getElementById('family-ch').value,
                    family_en: document.getElementById('family-en').value,
                    part_ch: document.getElementById('part-ch').value,
                    part_en: document.getElementById('part-en').value,
                    aliases: Array.from(document.querySelectorAll('.alias-input')).map(i => i.value.trim()).filter(v=>v),
                    comparisons: Array.from(document.querySelectorAll('#compare-list .dynamic-row')).map(r => ({target: r.querySelector('.comp-target').value, diff: r.querySelector('.comp-diff').value})).filter(c=>c.target),
                    components: components,
                    characteristics: document.getElementById('characteristics').value,
                    efficacy: document.getElementById('efficacy').value,
                    treatment: document.getElementById('treatment').value,
                    mnemonic: document.getElementById('mnemonic').value,
                    note: tinymce.get('rich-note').getContent(),
                    updated_at: new Date().toISOString()
                };

                let newList = [...pharmaList];
                if (idVal) {
                    const idx = newList.findIndex(i => i.id == idVal);
                    if(idx !== -1) newList[idx] = newItem;
                } else {
                    newList.unshift(newItem);
                }

                // C. ä¸Šå‚³ (ä½¿ç”¨ pharmaConfig)
                await uploadToGitHub(newList, `Update: ${name_ch}`);
                
                // D. æˆåŠŸè™•ç†
                pharmaList = newList;
                renderList();
                closeModalDirect(); 
                alert("ğŸ‰ å„²å­˜æˆåŠŸï¼");

            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸ’¾ å„²å­˜è³‡æ–™";
            }
        }

        async function uploadToGitHub(data, msg) {
            const url = `https://api.github.com/repos/${pharmaConfig.user}/${pharmaConfig.repo}/contents/${FILE_PATH}`;
            const body = {
                message: msg,
                content: window.btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: fileSha
            };
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${pharmaConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error("GitHub API Error");
            const json = await res.json();
            fileSha = json.content.sha;
        }

        // åˆ†é¡é¸å–®
        function initCatSelects() {
            const mainSel = document.getElementById('cat-main');
            const filterSel = document.getElementById('filter-cat');
            if (typeof PHARMA_CATEGORIES !== 'undefined') {
                PHARMA_CATEGORIES.forEach(cat => {
                    const opt = new Option(cat.name_ch, cat.name_ch);
                    mainSel.add(opt);
                    filterSel.add(opt.cloneNode(true));
                });
            }
        }
        function updateSubCats() {
            const val = document.getElementById('cat-main').value;
            const sub = document.getElementById('cat-sub');
            sub.innerHTML = '<option value="">- ä¸­åˆ†é¡ -</option>';
            const found = PHARMA_CATEGORIES.find(c => c.name_ch === val);
            if(found && found.subcategories) found.subcategories.forEach(s => sub.add(new Option(s.ch, s.ch)));
        }
    </script>
</body>
</html>
