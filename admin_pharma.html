<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥è³‡æ–™åº«ç®¡ç† | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; margin: 0; padding-top: 70px; }
        
        /* å°è¦½åˆ— */
        nav { 
            background: white; padding: 15px 30px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            display:flex; justify-content:space-between; align-items:center; 
            position:fixed; top:0; width:100%; box-sizing:border-box; z-index:100; 
        }
        .nav-title { font-size:1.2rem; font-weight:bold; color:#2C5E4F; display:flex; align-items:center; gap:10px; }
        .back-btn { text-decoration:none; background:#eee; color:#555; padding:5px 12px; border-radius:20px; font-size:0.9rem; transition:0.2s; }
        .back-btn:hover { background:#ddd; color:#000; }
        .btn-primary { background:#4A7C59; color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; }
        .btn-primary:hover { background:#38614A; }

        /* åˆ—è¡¨å€ */
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .pharma-item { 
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; border: 1px solid transparent;
        }
        .pharma-item:hover { transform: translateY(-3px); border-color: #4A7C59; }
        
        .item-info h3 { margin: 0 0 5px 0; color: #2C5E4F; }
        .item-meta { font-size: 0.9rem; color: #666; }
        .item-tag { background: #e8f5e9; color: #4A7C59; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-right: 5px; }

        /* æŒ‰éˆ•ç¾¤ */
        .btn-group { display: flex; gap: 10px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s; }
        .btn-edit { background: #e3f2fd; color: #1976d2; }
        .btn-edit:hover { background: #bbdefb; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-delete:hover { background: #ffcdd2; }

        /* ç·¨è¼¯å½ˆçª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-start; padding-top: 50px; z-index: 200; overflow-y: auto; }
        .modal { background: white; width: 90%; max-width: 900px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; margin-bottom: 50px; }
        .modal h2 { margin-top: 0; color: #2C5E4F; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .form-group textarea { height: 100px; resize: vertical; }
        
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        .modal-footer { margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-save:disabled { background-color: #ccc; cursor: not-allowed; }

        /* å‹•æ…‹åˆ—è¡¨ */
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .btn-add { background: #607d8b; width: 100%; margin-top: 5px; padding: 10px; border:none; color:white; border-radius:8px; cursor:pointer; }
        .btn-danger { background: #e57373; padding: 5px 10px; border:none; color:white; border-radius:5px; cursor:pointer;}
    </style>
</head>
<body>

    <nav>
        <div class="nav-title">
            <a href="admin_menu.html" class="back-btn">â¬… å›é¸å–®</a>
            <a href="pharmacognosy.html" class="back-btn" style="background:#e8f5e9; color:#2C5E4F; margin-left:5px;" target="_blank">ğŸ  å»å‰å°çœ‹</a>
            <span style="margin-left:10px;">ğŸ”¬ ç”Ÿè—¥è³‡æ–™åº«ç®¡ç†</span>
        </div>
        <button onclick="openModal()" class="btn-primary">ï¼‹ æ–°å¢ç”Ÿè—¥</button>
    </nav>

    <div class="container" id="list-container">
        <p style="text-align:center; color:#999;">è³‡æ–™è¼‰å…¥ä¸­...</p>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="modal-title" style="margin:0; border:none;">æ–°å¢ç”Ÿè—¥</h2>
                <button onclick="closeModalDirect()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <input type="hidden" id="edit-id">

            <div class="form-group" style="background:#e8f5e9; padding:15px; border-radius:10px;">
                <label>ğŸ“Œ ç”Ÿè—¥åˆ†é¡ (ä¾æ“š Word è¨­å®š)</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="cat-main" onchange="updateSubCats()"><option value="">- å¤§åˆ†é¡ -</option></select>
                    <select id="cat-sub"><option value="">- ä¸­åˆ†é¡ -</option></select>
                </div>
            </div>

            <div class="row">
                <div class="form-group col"><label>ä¸­æ–‡è—¥å</label><input type="text" id="name-ch" placeholder="ä¾‹å¦‚ï¼šéº»é»ƒ"></div>
                <div class="form-group col"><label>è‹±æ–‡è—¥å</label><input type="text" id="name-en" placeholder="ä¾‹å¦‚ï¼šEphedra"></div>
            </div>
            
            <label>åˆ¥å (Alias)</label>
            <div id="alias-list"></div>
            <button class="btn-add" onclick="addAliasRow()">+ æ–°å¢åˆ¥å</button>

            <div class="form-group" style="margin-top:20px;">
                <label>åŸºåŸ (Origin)</label>
                <input type="text" id="origin" placeholder="å­¸å">
            </div>

            <div class="row">
                <div class="form-group col"><label>ç§‘åˆ¥ (ä¸­æ–‡)</label><input type="text" id="family-ch"></div>
                <div class="form-group col"><label>ç§‘åˆ¥ (è‹±æ–‡)</label><input type="text" id="family-en"></div>
            </div>
            <div class="row">
                <div class="form-group col"><label>ä½¿ç”¨éƒ¨ä½ (ä¸­æ–‡)</label><input type="text" id="part-ch"></div>
                <div class="form-group col"><label>ä½¿ç”¨éƒ¨ä½ (è‹±æ–‡)</label><input type="text" id="part-en"></div>
            </div>

            <h3 style="color:#2C5E4F; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:30px;">âš—ï¸ åŒ–å­¸æˆåˆ† (Components)</h3>
            <div id="chem-list"></div>
            <button class="btn-add" style="background:#4A7C59;" onclick="addChemRow()">+ æ–°å¢æˆåˆ†èˆ‡çµæ§‹åœ–</button>

            <h3 style="color:#2C5E4F; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:30px;">âš–ï¸ æ¯”è¼ƒ (Comparison)</h3>
            <div id="compare-list"></div>
            <button class="btn-add" onclick="addCompareRow()">+ æ–°å¢æ¯”è¼ƒé …ç›®</button>

            <div class="form-group" style="margin-top:20px;"><label>æ€§ç‹€/ç‰¹æ€§</label><textarea id="characteristics" rows="2"></textarea></div>
            <div class="form-group"><label>åŠŸæ•ˆ</label><textarea id="efficacy" rows="2"></textarea></div>
            <div class="form-group"><label>é©æ‡‰ç—‡</label><textarea id="treatment" rows="2"></textarea></div>
            <div class="form-group"><label>è¨˜æ³•</label><input type="text" id="mnemonic"></div>

            <h3 style="color:#2C5E4F; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:30px;">ğŸ“ è©³ç´°å‚™è¨»</h3>
            <textarea id="rich-note"></textarea>

            <div class="modal-footer">
                <button onclick="closeModalDirect()" style="background:transparent; border:none; color:#666; cursor:pointer; margin-right:10px; font-size:1rem;">å–æ¶ˆ</button>
                <button onclick="saveData()" id="btn-save" class="btn-primary btn-save" style="font-size:1rem; padding:10px 30px;">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>

    <script src="pharma_config.js"></script>
    <script src="utils.js"></script>
    
    <script>
        let pharmaList = [];
        let fileSha = "";
        const FILE_PATH = "data/pharma.json";
        let ghConfig = null;

        document.addEventListener('DOMContentLoaded', async () => {
            tinymce.init({
                selector: '#rich-note', height: 400,
                plugins: 'table lists link image code preview',
                toolbar: 'undo redo | blocks | bold italic forecolor | bullist numlist | table | image code'
            });

            const configStr = localStorage.getItem('tcm_admin_config');
            if (!configStr) return location.href = 'admin_menu.html';
            ghConfig = JSON.parse(configStr);
            
            await initGitHubConfig(ghConfig.token, ghConfig.user, ghConfig.repo);
            await loadData();
            initCatSelects();
        });

        // 1. è®€å–è³‡æ–™
        async function loadData() {
            try {
                const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${FILE_PATH}?t=${Date.now()}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });
                
                if (res.ok) {
                    const json = await res.json();
                    fileSha = json.sha;
                    if (json.content) pharmaList = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                    else pharmaList = [];
                } else {
                    pharmaList = [];
                }
                renderList();
            } catch (e) { alert("è®€å–å¤±æ•—: " + e.message); }
        }

        // 2. æ¸²æŸ“åˆ—è¡¨ (å«åˆªé™¤æŒ‰éˆ•)
        function renderList() {
            const container = document.getElementById('list-container');
            const search = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : "";
            container.innerHTML = "";
            
            const filtered = pharmaList.filter(item => (item.name_ch||"").includes(search) || (item.name_en||"").toLowerCase().includes(search));
            const sortedList = [...filtered].sort((a,b) => b.id - a.id);

            sortedList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pharma-item';
                div.innerHTML = `
                    <div class="item-info">
                        <h3>${item.name_ch} <small style="color:#999; font-size:0.9rem;">${item.name_en || ''}</small></h3>
                        <div class="item-meta">
                            <span class="item-tag">${item.category_main || 'æœªåˆ†é¡'}</span>
                            <span>${item.origin || ''}</span>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-icon btn-edit" onclick="openModal(${item.id})" title="ç·¨è¼¯">âœï¸</button>
                        <button class="btn-icon btn-delete" onclick="deleteItem(${item.id})" title="åˆªé™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 3. åˆªé™¤åŠŸèƒ½
        async function deleteItem(id) {
            if (!confirm("âš ï¸ ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            const newArr = pharmaList.filter(item => item.id !== id);
            try {
                await uploadToGitHub(newArr, `Delete ID: ${id}`);
                pharmaList = newArr;
                renderList();
                alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸï¼");
            } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
        }

        // 4. ç·¨è¼¯è¦–çª—é‚è¼¯
        function openModal(id = null) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            document.querySelectorAll('input, select, textarea').forEach(i => i.value = '');
            document.getElementById('alias-list').innerHTML = "";
            document.getElementById('chem-list').innerHTML = "";
            document.getElementById('compare-list').innerHTML = "";
            tinymce.get('rich-note').setContent('');

            if (id) {
                const item = pharmaList.find(i => i.id === id);
                if (item) {
                    title.innerText = "ç·¨è¼¯ç”Ÿè—¥";
                    document.getElementById('edit-id').value = item.id;
                    document.getElementById('name-ch').value = item.name_ch || '';
                    document.getElementById('name-en').value = item.name_en || '';
                    document.getElementById('cat-main').value = item.category_main || '';
                    updateSubCats();
                    document.getElementById('cat-sub').value = item.category_sub || '';
                    document.getElementById('origin').value = item.origin || '';
                    document.getElementById('family-ch').value = item.family_ch || '';
                    document.getElementById('family-en').value = item.family_en || '';
                    document.getElementById('part-ch').value = item.part_ch || '';
                    document.getElementById('part-en').value = item.part_en || '';
                    document.getElementById('characteristics').value = item.characteristics || '';
                    document.getElementById('efficacy').value = item.efficacy || '';
                    document.getElementById('treatment').value = item.treatment || '';
                    document.getElementById('mnemonic').value = item.mnemonic || '';
                    tinymce.get('rich-note').setContent(item.note || '');

                    (item.aliases || []).forEach(v => addAliasRow(v));
                    (item.components || []).forEach(v => addChemRow(v));
                    (item.comparisons || []).forEach(v => addCompareRow(v));
                }
            } else {
                title.innerText = "æ–°å¢ç”Ÿè—¥";
                document.getElementById('edit-id').value = "";
                addChemRow(); // é è¨­çµ¦ä¸€è¡Œ
            }
            modal.style.display = 'flex';
        }

        function closeModalDirect() { document.getElementById('modal').style.display = 'none'; }

        // 5. å‹•æ…‹æ¬„ä½
        function addAliasRow(val = "") {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="alias-input" value="${val}" placeholder="åˆ¥å"><button class="btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('alias-list').appendChild(div);
        }
        function addCompareRow(data = {}) {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="comp-target" value="${data.target||''}" placeholder="å°è±¡"><input type="text" class="comp-diff" value="${data.diff||''}" placeholder="å·®ç•°"><button class="btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('compare-list').appendChild(div);
        }
        function addChemRow(data = {}) {
            const div = document.createElement('div'); div.className = 'dynamic-row'; div.style.flexDirection = 'column';
            const imgId = `chem-img-${Date.now()}-${Math.random()}`;
            const imgVal = data.image || "";
            div.innerHTML = `
                <div style="display:flex; gap:5px; width:100%;">
                    <input type="text" class="chem-name" value="${data.name||''}" placeholder="æˆåˆ†å">
                    <input type="text" class="chem-note" value="${data.note||''}" placeholder="å‚™è¨»">
                    <button class="btn-danger" onclick="this.closest('.dynamic-row').remove()">âœ•</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="background:#eee; padding:5px; border-radius:5px; cursor:pointer;">ğŸ“¸ ä¸Šå‚³ <input type="file" style="display:none" onchange="handleChemUpload(this, '${imgId}')"></label>
                    <img id="${imgId}" src="${imgVal}" style="max-height:60px; display:${imgVal?'block':'none'};">
                    <input type="hidden" class="chem-img-url" value="${imgVal}">
                </div>`;
            document.getElementById('chem-list').appendChild(div);
        }
        function handleChemUpload(input, viewId) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(viewId).src = e.target.result;
                document.getElementById(viewId).style.display = 'block';
                input.fileObj = file; 
            };
            reader.readAsDataURL(file);
        }

        // 6. å„²å­˜é‚è¼¯ (é˜²é€£é» + è‡ªå‹•é—œé–‰)
        async function saveData() {
            const btn = document.getElementById('btn-save');
            const idVal = document.getElementById('edit-id').value;
            const name_ch = document.getElementById('name-ch').value.trim();
            if (!name_ch) return alert("ä¸­æ–‡è—¥åå¿…å¡«ï¼");

            btn.disabled = true;
            btn.innerText = "â³ å„²å­˜ä¸­...";

            try {
                // è™•ç†æˆåˆ†åœ–ç‰‡
                const chemRows = document.querySelectorAll('#chem-list .dynamic-row');
                const components = [];
                for (let row of chemRows) {
                    const name = row.querySelector('.chem-name').value.trim();
                    if (!name) continue;
                    let imgUrl = row.querySelector('.chem-img-url').value;
                    const fileInput = row.querySelector('input[type="file"]');
                    if (fileInput.fileObj) {
                        imgUrl = await compressAndUploadImage(fileInput.fileObj, 'images/pharma');
                    }
                    components.push({ name: name, note: row.querySelector('.chem-note').value.trim(), image: imgUrl });
                }

                // å»ºç«‹ç‰©ä»¶
                const newItem = {
                    id: idVal ? parseInt(idVal) : Date.now(),
                    name_ch, name_en: document.getElementById('name-en').value.trim(),
                    category_main: document.getElementById('cat-main').value,
                    category_sub: document.getElementById('cat-sub').value,
                    origin: document.getElementById('origin').value,
                    family_ch: document.getElementById('family-ch').value,
                    family_en: document.getElementById('family-en').value,
                    part_ch: document.getElementById('part-ch').value,
                    part_en: document.getElementById('part-en').value,
                    aliases: Array.from(document.querySelectorAll('.alias-input')).map(i => i.value.trim()).filter(v=>v),
                    comparisons: Array.from(document.querySelectorAll('#compare-list .dynamic-row')).map(r => ({target: r.querySelector('.comp-target').value, diff: r.querySelector('.comp-diff').value})).filter(c=>c.target),
                    components: components,
                    characteristics: document.getElementById('characteristics').value,
                    efficacy: document.getElementById('efficacy').value,
                    treatment: document.getElementById('treatment').value,
                    mnemonic: document.getElementById('mnemonic').value,
                    note: tinymce.get('rich-note').getContent()
                };

                let newList = [...pharmaList];
                if (idVal) {
                    const idx = newList.findIndex(i => i.id == idVal);
                    if(idx !== -1) newList[idx] = newItem;
                } else {
                    newList.unshift(newItem);
                }

                await uploadToGitHub(newList, `Update: ${name_ch}`);
                pharmaList = newList;
                renderList();
                closeModalDirect(); // æˆåŠŸå¾Œé—œé–‰
                alert("ğŸ‰ å„²å­˜æˆåŠŸï¼");

            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸ’¾ å„²å­˜";
            }
        }

        async function uploadToGitHub(data, msg) {
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${FILE_PATH}`;
            const body = {
                message: msg,
                content: window.btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: fileSha
            };
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error("GitHub Error");
            const json = await res.json();
            fileSha = json.content.sha;
        }

        // åˆ†é¡é¸å–®
        function initCatSelects() {
            const mainSel = document.getElementById('cat-main');
            if (typeof PHARMA_CATEGORIES !== 'undefined') {
                PHARMA_CATEGORIES.forEach(cat => mainSel.add(new Option(cat.name_ch, cat.name_ch)));
            }
        }
        function updateSubCats() {
            const val = document.getElementById('cat-main').value;
            const sub = document.getElementById('cat-sub');
            sub.innerHTML = '<option value="">- ä¸­åˆ†é¡ -</option>';
            const found = PHARMA_CATEGORIES.find(c => c.name_ch === val);
            if(found && found.subcategories) found.subcategories.forEach(s => sub.add(new Option(s.ch, s.ch)));
        }
    </script>
</body>
</html>
