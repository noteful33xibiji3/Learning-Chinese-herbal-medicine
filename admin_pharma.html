<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥è³‡æ–™åº«ç®¡ç† | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* === æ¨£å¼å€ === */
        body { background: #f0f2f5; font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; }
        nav { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .nav-title { font-size: 1.2rem; font-weight: bold; color: #2C5E4F; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: #e0e0e0; color: #333; padding: 5px 12px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; transition: 0.2s; }
        .back-btn:hover { background: #d0d0d0; }
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .pharma-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border-left: 5px solid #4A7C59; position: relative; }
        .pharma-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-size: 1.3rem; font-weight: bold; color: #333; margin: 0; }
        .card-cat { background: #e8f5e9; color: #2C5E4F; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .card-en { color: #666; font-size: 0.9rem; font-style: italic; }
        .card-delete-btn { position: absolute; bottom: 15px; right: 15px; background: #ffebee; color: #c62828; border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: 0.2s; z-index: 2; }
        .card-delete-btn:hover { background: #ffcdd2; transform: scale(1.1); }
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: white; width: 95%; max-width: 900px; margin: 0 auto 50px auto; padding: 30px; border-radius: 15px; position: relative; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; }
        input[type="text"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .section-title { font-size: 1.1rem; color: #2C5E4F; border-bottom: 2px solid #eee; padding-bottom: 5px; margin: 30px 0 15px 0; font-weight: bold; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: #4A7C59; }
        .btn-add { background: #607d8b; width: 100%; margin-top: 5px; }
        .btn-danger { background: #e57373; padding: 5px 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        
        /* â˜… æ–°å¢ï¼šæˆåˆ†å¡ç‰‡æ¨£å¼ (ç‚ºäº†æ”¾ç·¨è¼¯å™¨) */
        .chem-card { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
        /* === åˆ—å°æ™‚çš„æ¨£å¼è¨­å®š (éš±è—ä¸å¿…è¦çš„æ±è¥¿) === */
    @media print {
        nav, .btn-group, #loading-overlay, .card-delete-btn {
            display: none !important; /* éš±è—å°è¦½åˆ—ã€æŒ‰éˆ• */
        }
        body {
            background: white;
            padding-top: 0;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        .pharma-card {
            border: 1px solid #000; /* åˆ—å°æ™‚åŠ å€‹é»‘æ¡†æ¯”è¼ƒæ¸…æ¥š */
            box-shadow: none;
            break-inside: avoid; /* é¿å…å¡ç‰‡è¢«åˆ‡æˆå…©åŠ */
            margin-bottom: 20px;
        }
        /* å¼·åˆ¶é¡¯ç¤ºèƒŒæ™¯è‰² (æœ‰äº›ç€è¦½å™¨é è¨­ä¸å°èƒŒæ™¯è‰²) */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size:2rem;">â³</div>
        <p id="loading-text">æ­£åœ¨é€£æ¥ GitHub è³‡æ–™åº«...</p>
        <button onclick="document.getElementById('loading-overlay').style.display='none'" style="margin-top:20px; padding:5px 10px; border:1px solid #ccc; background:white; cursor:pointer;">å¼·åˆ¶é—œé–‰ (é™¤éŒ¯ç”¨)</button>
    </div>

    <nav>
        <div class="nav-title">
            <a href="admin_menu.html" class="back-btn">â¬… å›é¸å–®</a>
            <a href="pharmacognosy.html" class="back-btn" style="background:#e8f5e9; color:#2C5E4F; margin-left:5px;" target="_blank">ğŸ  å»å‰å°çœ‹</a>
            <span style="margin-left:10px;">ğŸ”¬ ç”Ÿè—¥è³‡æ–™åº«ç®¡ç†</span>
        </div>
         <div style="display:flex; gap:10px;">
               <input type="file" id="import-file" accept=".xlsx, .xls" style="display:none;" onchange="importFromExcel(this)">
        
        <button onclick="document.getElementById('import-file').click()" class="btn" style="background:#ff9800; color:white;">ğŸ“¥ åŒ¯å…¥ Excel</button>
        <button onclick="exportToExcel()" class="btn" style="background:#217346; color:white;">ğŸ“Š åŒ¯å‡º Excel</button>
        <button onclick="window.print()" class="btn" style="background:#555; color:white;">ğŸ–¨ï¸ åˆ—å°/å­˜ PDF</button>
        <button onclick="openModal()" class="btn btn-primary">ï¼‹ æ–°å¢ç”Ÿè—¥</button>
         </div>
    </nav>
</div>
    <main>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ç”Ÿè—¥åç¨±ã€å­¸åã€æˆåˆ†..." oninput="renderList()">
            <select id="filter-cat" onchange="renderList()" style="width:150px;">
                <option value="">æ‰€æœ‰åˆ†é¡</option>
            </select>
        </div>

        <div id="pharma-list" class="card-container"></div>
    </main>

    <div id="edit-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:#2C5E4F;">ç·¨è¼¯ç”Ÿè—¥è³‡æ–™</h2>
                <button onclick="closeModalDirect()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            
            <input type="hidden" id="edit-id">

            <div class="form-group" style="background:#e8f5e9; padding:15px; border-radius:10px;">
                <label>ğŸ“Œ ç”Ÿè—¥åˆ†é¡</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="cat-main" onchange="updateSubCats()"><option value="">- å¤§åˆ†é¡ -</option></select>
                    <select id="cat-sub"><option value="">- ä¸­åˆ†é¡ -</option></select>
                </div>
            </div>

            <div class="section-title">åŸºæœ¬è³‡æ–™</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>ç”Ÿè—¥åç¨± (ä¸­æ–‡)</label><input type="text" id="name-ch" placeholder="ä¾‹å¦‚ï¼šéº»é»ƒ"></div>
                <div><label>ç”Ÿè—¥åç¨± (è‹±æ–‡)</label><input type="text" id="name-en" placeholder="ä¾‹å¦‚ï¼šEphedra"></div>
            </div>
            
            <label style="margin-top:10px;">åˆ¥å</label>
            <div id="alias-list"></div>
            <button class="btn btn-add" onclick="addAliasRow()">+ æ–°å¢åˆ¥å</button>

            <div class="section-title">åŸºåŸèˆ‡ç§‘åˆ¥</div>
            <div class="form-group"><label>åŸºåŸ (Origin)</label><input type="text" id="origin" placeholder="ä¾‹å¦‚ï¼šEphedra sinica Stapf"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>ç§‘å (ä¸­æ–‡)</label><input type="text" id="family-ch" placeholder="éº»é»ƒç§‘"></div>
                <div><label>ç§‘å (è‹±æ–‡)</label><input type="text" id="family-en" placeholder="Ephedraceae"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">
                <div><label>ä½¿ç”¨éƒ¨ä½ (ä¸­æ–‡)</label><input type="text" id="part-ch" placeholder="ä¹¾ç‡¥è‰è³ªè–"></div>
                <div><label>ä½¿ç”¨éƒ¨ä½ (è‹±æ–‡)</label><input type="text" id="part-en" placeholder="Stem"></div>
            </div>

            <div class="section-title">âš—ï¸ åŒ–å­¸æˆåˆ† (Components) - æ”¯æ´è©³ç´°æ ¼å¼</div>
            <div id="chem-list"></div>
            <button class="btn btn-add" style="background:#4A7C59;" onclick="addChemRow()">+ æ–°å¢æˆåˆ†</button>

            <div class="section-title">âš–ï¸ æ¯”è¼ƒ (Comparison)</div>
            <div id="compare-list"></div>
            <button class="btn btn-add" onclick="addCompareRow()">+ æ–°å¢æ¯”è¼ƒé …ç›®</button>

            <div class="section-title">ç‰¹æ€§èˆ‡åŠŸæ•ˆ</div>
            <div class="form-group"><label>æ€§ç‹€/ç‰¹æ€§</label><textarea id="characteristics" rows="3"></textarea></div>
            <div class="form-group"><label>åŠŸæ•ˆ</label><textarea id="efficacy" rows="3"></textarea></div>
            <div class="form-group"><label>é©æ‡‰ç—‡</label><textarea id="treatment" rows="2"></textarea></div>
            <div class="form-group"><label>è¨˜æ³•</label><input type="text" id="mnemonic" placeholder="å£è¨£..."></div>

            <div class="section-title">ğŸ“ è©³ç´°å‚™è¨»</div>
            <textarea id="rich-note"></textarea>

            <div class="modal-footer" style="margin-top:30px; display:flex; gap:10px;">
                <button onclick="closeModalDirect()" style="flex:1; background:#eee; color:#333; border:none; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="saveData()" id="btn-save" class="btn btn-primary" style="flex:2; padding:15px; font-size:1.1rem;">ğŸ’¾ å„²å­˜è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script src="pharma_config.js"></script>
    <script src="utils.js"></script>

    <script>
        let pharmaList = [];
        let fileSha = "";
        const FILE_PATH = "data/pharma.json";
        let currentConfig = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ–ä¸‹æ–¹çš„å¤§ç·¨è¼¯å™¨
            tinymce.init({
                selector: '#rich-note', 
                height: 400,
                plugins: 'table lists link image code preview searchreplace autolink fullscreen charmap',
                toolbar: 'undo redo | cut copy paste | blocks | bold italic underline forecolor backcolor | alignleft aligncenter | bullist numlist | table image | code',
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 16px; color: #333; }',
                branding: false, menubar: true
            });

            const configStr = localStorage.getItem('tcm_admin_config');
            if (!configStr) {
                alert("è«‹å…ˆç™»å…¥ï¼");
                document.getElementById('loading-overlay').style.display = 'none';
                return location.href = 'admin_menu.html';
            }
            currentConfig = JSON.parse(configStr);
            
            try {
                if (typeof initGitHubConfig === 'undefined') throw new Error("æ‰¾ä¸åˆ° utils.js");
                await initGitHubConfig(currentConfig.token, currentConfig.user, currentConfig.repo);
                await loadData();
                initCatSelects();
            } catch (e) {
                alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
                console.error(e);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        async function loadData() {
            try {
                const url = `https://api.github.com/repos/${currentConfig.user}/${currentConfig.repo}/contents/${FILE_PATH}?t=${Date.now()}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${currentConfig.token}` } });
                
                if (res.ok) {
                    const json = await res.json();
                    fileSha = json.sha;
                    if (json.content) pharmaList = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                    else pharmaList = [];
                } else if (res.status === 404) {
                    pharmaList = [];
                } else {
                    throw new Error("GitHub å›å‚³éŒ¯èª¤: " + res.status);
                }
                renderList();
            } catch (e) {
                console.error("è®€å–å¤±æ•—:", e);
                pharmaList = [];
                renderList();
            }
        }

        function renderList() {
            const container = document.getElementById('pharma-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('filter-cat').value;
            container.innerHTML = "";

            const filtered = pharmaList.filter(item => {
                const matchSearch = (item.name_ch || "").includes(search) || (item.name_en || "").toLowerCase().includes(search);
                const matchCat = filter ? item.category_main === filter : true;
                return matchSearch && matchCat;
            });
            const sortedList = [...filtered].sort((a,b) => b.id - a.id);

            sortedList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'pharma-card';
                div.onclick = () => openModal(item.id);
                div.innerHTML = `
                    <div class="card-header"><span class="card-name">${item.name_ch}</span><span class="card-cat">${item.category_sub || item.category_main}</span></div>
                    <div class="card-en">${item.name_en}</div>
                    <div style="font-size:0.85rem; color:#888; margin-top:5px;">${item.family_ch || ""} / ${item.part_ch || ""}</div>
                    <button class="card-delete-btn" onclick="event.stopPropagation(); deleteItem(${item.id})" title="åˆªé™¤">ğŸ—‘ï¸</button>
                `;
                container.appendChild(div);
            });
        }

        async function deleteItem(id) {
            if (!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
            const newArr = pharmaList.filter(item => item.id !== id);
            const oldArr = [...pharmaList];
            pharmaList = newArr; renderList();
            try {
                await uploadToGitHub(newArr, `Delete ID: ${id}`);
                alert("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸï¼");
            } catch (e) { alert("åˆªé™¤å¤±æ•—"); pharmaList = oldArr; renderList(); }
        }

        // === ç·¨è¼¯è¦–çª—ç›¸é—œ ===
        function openModal(id = null) {
            // 1. å…ˆæŠŠèˆŠçš„æˆåˆ†ç·¨è¼¯å™¨å…¨éƒ¨éŠ·æ¯€ï¼Œé¿å… ID è¡çª
            removeChemEditors();
            
            document.querySelectorAll('input, select, textarea').forEach(i => i.value = '');
            document.getElementById('alias-list').innerHTML = "";
            document.getElementById('chem-list').innerHTML = "";
            document.getElementById('compare-list').innerHTML = "";
            tinymce.get('rich-note').setContent('');

            if (id) {
                const item = pharmaList.find(i => i.id === id);
                if (item) {
                    document.getElementById('edit-id').value = item.id;
                    document.getElementById('name-ch').value = item.name_ch || '';
                    document.getElementById('name-en').value = item.name_en || '';
                    document.getElementById('cat-main').value = item.category_main || '';
                    updateSubCats();
                    document.getElementById('cat-sub').value = item.category_sub || '';
                    document.getElementById('origin').value = item.origin || '';
                    document.getElementById('family-ch').value = item.family_ch || '';
                    document.getElementById('family-en').value = item.family_en || '';
                    document.getElementById('part-ch').value = item.part_ch || '';
                    document.getElementById('part-en').value = item.part_en || '';
                    document.getElementById('characteristics').value = item.characteristics || '';
                    document.getElementById('efficacy').value = item.efficacy || '';
                    document.getElementById('treatment').value = item.treatment || '';
                    document.getElementById('mnemonic').value = item.mnemonic || '';
                    tinymce.get('rich-note').setContent(item.note || '');

                    (item.aliases || []).forEach(v => addAliasRow(v));
                    // å¡«å…¥æˆåˆ† (å¸¶æœ‰ HTML å‚™è¨»)
                    (item.components || []).forEach(v => addChemRow(v));
                    (item.comparisons || []).forEach(v => addCompareRow(v));
                }
            } else {
                document.getElementById('edit-id').value = "";
                addChemRow(); 
            }
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeModalDirect() { 
            document.getElementById('edit-modal').style.display = 'none'; 
            removeChemEditors(); // é—œé–‰æ™‚ä¹Ÿæ¸…ç†ç·¨è¼¯å™¨
        }
        function closeModal() { if(confirm("ç¢ºå®šé—œé–‰ï¼Ÿ")) closeModalDirect(); }

        // === å‹•æ…‹æ¬„ä½ ===
        function addAliasRow(val = "") {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="alias-input" value="${val}" placeholder="åˆ¥å"><button class="btn btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('alias-list').appendChild(div);
        }
        function addCompareRow(data = {}) {
            const div = document.createElement('div'); div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="comp-target" value="${data.target||''}" placeholder="å°è±¡"><input type="text" class="comp-diff" value="${data.diff||''}" placeholder="å·®ç•°"><button class="btn btn-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            document.getElementById('compare-list').appendChild(div);
        }

        // === â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæˆåˆ†åˆ— + è¿·ä½ ç·¨è¼¯å™¨ ===
        function addChemRow(data = {}) {
            const div = document.createElement('div'); 
            div.className = 'chem-card'; // æ”¹ç”¨å¡ç‰‡å¼ä½ˆå±€
            
            const imgId = `chem-img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            // ç‚ºç·¨è¼¯å™¨ç”¢ç”Ÿå”¯ä¸€ ID
            const noteId = `chem-note-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const imgVal = data.image || "";
            const noteVal = data.note || ""; // é€™è£¡æ˜¯ HTML

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <input type="text" class="chem-name" value="${data.name||''}" placeholder="æˆåˆ†åç¨± (å¦‚: Ephedrine)" style="font-weight:bold; width:70%;">
                    <button class="btn btn-danger" onclick="removeChemRow(this, '${noteId}')">åˆªé™¤æ­¤æˆåˆ†</button>
                </div>
                
                <div style="display:flex; gap:15px; margin-bottom:10px; align-items:center; background:#eee; padding:5px; border-radius:5px;">
                    <label style="cursor:pointer; font-weight:bold;">ğŸ“¸ çµæ§‹åœ– <input type="file" style="display:none" onchange="handleChemUpload(this, '${imgId}')"></label>
                    <img id="${imgId}" src="${imgVal}" style="max-height:50px; display:${imgVal?'block':'none'}; border:1px solid #ccc;">
                    <input type="hidden" class="chem-img-url" value="${imgVal}">
                </div>

                <label>æˆåˆ†å‚™è¨» (å¯æ’ç‰ˆ)ï¼š</label>
                <textarea id="${noteId}" class="chem-note-editor">${noteVal}</textarea>
            `;
            document.getElementById('chem-list').appendChild(div);

            // â˜… ç«‹å³åˆå§‹åŒ–é€™å€‹å°ç·¨è¼¯å™¨
            initMiniEditor(noteId);
        }

        // åˆå§‹åŒ–è¿·ä½ ç·¨è¼¯å™¨
        function initMiniEditor(id) {
            tinymce.init({
                selector: `#${id}`,
                height: 200,
                menubar: false, // éš±è—é¸å–®
                plugins: 'lists link code charmap',
                toolbar: 'bold italic forecolor | bullist numlist | removeformat', // ç²¾ç°¡å·¥å…·åˆ—
                content_style: 'body { font-family: "Noto Sans TC", sans-serif; font-size: 14px; margin: 10px; }',
                branding: false
            });
        }

        // åˆªé™¤æˆåˆ†åˆ—æ™‚ï¼Œè¦å…ˆéŠ·æ¯€ç·¨è¼¯å™¨
        function removeChemRow(btn, editorId) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æˆåˆ†ï¼Ÿ")) {
                tinymce.remove(`#${editorId}`); // é‡‹æ”¾è¨˜æ†¶é«”
                btn.closest('.chem-card').remove();
            }
        }

        // æ¸…ç†æ‰€æœ‰æˆåˆ†ç·¨è¼¯å™¨ (åœ¨é—œé–‰è¦–çª—æ™‚å‘¼å«)
        function removeChemEditors() {
            // æ‰¾å‡ºæ‰€æœ‰ class ç‚º chem-note-editor çš„ ID
            const editors = document.querySelectorAll('.chem-note-editor');
            editors.forEach(el => {
                tinymce.remove(`#${el.id}`);
            });
        }

        function handleChemUpload(input, viewId) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(viewId).src = e.target.result;
                document.getElementById(viewId).style.display = 'block';
                input.fileObj = file; 
            };
            reader.readAsDataURL(file);
        }

        // === å„²å­˜é‚è¼¯ ===
        async function saveData() {
            const btn = document.getElementById('btn-save');
            const idVal = document.getElementById('edit-id').value;
            const name_ch = document.getElementById('name-ch').value.trim();
            if (!name_ch) return alert("ä¸­æ–‡è—¥åå¿…å¡«ï¼");

            btn.disabled = true; 
            btn.innerText = "â³ å„²å­˜ä¸­...";

            try {
                // A. æ”¶é›†æˆåˆ†è³‡æ–™ (éœ€å¾ç·¨è¼¯å™¨å–å€¼)
                const chemRows = document.querySelectorAll('.chem-card');
                const components = [];
                
                for (let row of chemRows) {
                    const name = row.querySelector('.chem-name').value.trim();
                    if (!name) continue;

                    // â˜… å¾ TinyMCE ç²å– HTML å…§å®¹
                    const textarea = row.querySelector('.chem-note-editor');
                    // ä½¿ç”¨ tinymce.get(id).getContent()
                    const editor = tinymce.get(textarea.id);
                    const note = editor ? editor.getContent() : textarea.value;

                    let imgUrl = row.querySelector('.chem-img-url').value;
                    const fileInput = row.querySelector('input[type="file"]');
                    if (fileInput.fileObj) {
                        imgUrl = await compressAndUploadImage(fileInput.fileObj, 'images/pharma');
                    }
                    components.push({ name, note, image: imgUrl });
                }

                const newItem = {
                    id: idVal ? parseInt(idVal) : Date.now(),
                    name_ch, name_en: document.getElementById('name-en').value.trim(),
                    category_main: document.getElementById('cat-main').value,
                    category_sub: document.getElementById('cat-sub').value,
                    origin: document.getElementById('origin').value,
                    family_ch: document.getElementById('family-ch').value,
                    family_en: document.getElementById('family-en').value,
                    part_ch: document.getElementById('part-ch').value,
                    part_en: document.getElementById('part-en').value,
                    aliases: Array.from(document.querySelectorAll('.alias-input')).map(i => i.value.trim()).filter(v=>v),
                    comparisons: Array.from(document.querySelectorAll('#compare-list .dynamic-row')).map(r => ({target: r.querySelector('.comp-target').value, diff: r.querySelector('.comp-diff').value})).filter(c=>c.target),
                    components: components,
                    characteristics: document.getElementById('characteristics').value,
                    efficacy: document.getElementById('efficacy').value,
                    treatment: document.getElementById('treatment').value,
                    mnemonic: document.getElementById('mnemonic').value,
                    note: tinymce.get('rich-note').getContent(),
                    updated_at: new Date().toISOString()
                };

                let newList = [...pharmaList];
                if (idVal) {
                    const idx = newList.findIndex(i => i.id == idVal);
                    if(idx !== -1) newList[idx] = newItem;
                } else {
                    newList.unshift(newItem);
                }

                await uploadToGitHub(newList, `Update: ${name_ch}`);
                pharmaList = newList;
                renderList();
                closeModalDirect(); 
                alert("ğŸ‰ å„²å­˜æˆåŠŸï¼");

            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸ’¾ å„²å­˜è³‡æ–™";
            }
        }

        async function uploadToGitHub(data, msg) {
            const url = `https://api.github.com/repos/${currentConfig.user}/${currentConfig.repo}/contents/${FILE_PATH}`;
            const body = {
                message: msg,
                content: window.btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                sha: fileSha
            };
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${currentConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error("GitHub API Error");
            const json = await res.json();
            fileSha = json.content.sha;
        }

        function initCatSelects() {
            const mainSel = document.getElementById('cat-main');
            const filterSel = document.getElementById('filter-cat');
            if (typeof PHARMA_CATEGORIES !== 'undefined') {
                PHARMA_CATEGORIES.forEach(cat => {
                    const displayName = `${cat.name_ch} (${cat.name_en})`;
                    const opt = new Option(displayName, cat.name_ch);
                    mainSel.add(opt);
                    filterSel.add(opt.cloneNode(true));
                });
            }
        }
        function updateSubCats() {
            const val = document.getElementById('cat-main').value;
            const sub = document.getElementById('cat-sub');
            sub.innerHTML = '<option value="">- ä¸­åˆ†é¡ -</option>';
            const found = PHARMA_CATEGORIES.find(c => c.name_ch === val);
            if(found && found.subcategories) {
                found.subcategories.forEach(s => {
                    const displayName = `${s.ch} (${s.en})`;
                    sub.add(new Option(displayName, s.ch));
                });
            }
        }
       // === 7. åŒ¯å‡º Excel åŠŸèƒ½ (å«æˆåˆ†å‚™è¨»ç‰ˆ) ===
        function exportToExcel() {
            if (pharmaList.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
                return;
            }

            // 1. æ•´ç†è³‡æ–™
            const exportData = pharmaList.map(item => {
                
                // â˜… ä¿®æ”¹é‡é»ï¼šè™•ç†æˆåˆ†èˆ‡å‚™è¨»
                let compStr = '';
                if (item.components && item.components.length > 0) {
                    compStr = item.components.map(c => {
                        // A. æŠŠ HTML æ¨™ç±¤æ‹¿æ‰ (åªç•™ç´”æ–‡å­—)
                        let cleanNote = c.note ? c.note.replace(/<[^>]+>/g, '').trim() : '';
                        // B. çµ„åˆæ ¼å¼ï¼š "éº»é»ƒé¹¼ [å…·æ¯’æ€§...]"
                        return c.name + (cleanNote ? ` [${cleanNote}]` : '');
                    }).join('\n'); // C. ç”¨æ›è¡Œç¬¦è™Ÿåˆ†éš”æ¯å€‹æˆåˆ†
                }

                // è™•ç†åˆ¥å
                const aliasStr = item.aliases ? item.aliases.join(', ') : '';

                return {
                    "ID": item.id,
                    "ä¸­æ–‡å": item.name_ch,
                    "è‹±æ–‡å": item.name_en,
                    "å¤§åˆ†é¡": item.category_main,
                    "ä¸­åˆ†é¡": item.category_sub,
                    "åŸºåŸ": item.origin,
                    "ç§‘åˆ¥(ä¸­)": item.family_ch,
                    "ç§‘åˆ¥(è‹±)": item.family_en,
                    "éƒ¨ä½(ä¸­)": item.part_ch,
                    "éƒ¨ä½(è‹±)": item.part_en,
                    "æˆåˆ†(å«å‚™è¨»)": compStr, // é€™è£¡ç¾åœ¨æœƒæœ‰è©³ç´°è³‡æ–™äº†
                    "åˆ¥å": aliasStr,
                    "åŠŸæ•ˆ": item.efficacy,
                    "é©æ‡‰ç—‡": item.treatment,
                    "å‚™è¨»(HTML)": item.note 
                };
            });

            // 2. å»ºç«‹å·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ç”Ÿè—¥è³‡æ–™åº«");

            // 3. ä¸‹è¼‰æª”æ¡ˆ
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `ç”Ÿè—¥è³‡æ–™åº«å‚™ä»½_${date}.xlsx`);
        }
   // === 8. åŒ¯å…¥ Excel åŠŸèƒ½ (æ™ºæ…§è§£æç‰ˆ) ===
        async function importFromExcel(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥å°‡æœƒè¦†è“‹ç¾æœ‰ç›¸åŒ ID çš„è³‡æ–™ï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
                input.value = "";
                return;
            }

            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const excelData = XLSX.utils.sheet_to_json(worksheet);

                    if (excelData.length === 0) {
                        alert("Excel æª”æ¡ˆæ˜¯ç©ºçš„ï¼");
                        return;
                    }

                    let updateCount = 0;
                    let addCount = 0;
                    let newList = [...pharmaList];

                    excelData.forEach(row => {
                        // === â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºæ…§è§£ææˆåˆ†æ¬„ä½ ===
                        let compArr = [];
                        // æª¢æŸ¥ Excel æ¬„ä½æ˜¯ "æˆåˆ†(å«å‚™è¨»)" é‚„æ˜¯èˆŠçš„ "æˆåˆ†"
                        const rawCompStr = row["æˆåˆ†(å«å‚™è¨»)"] || row["æˆåˆ†"];

                        if (rawCompStr) {
                            // 1. å…ˆç”¨ã€Œæ›è¡Œç¬¦è™Ÿã€åˆ‡é–‹æ¯å€‹æˆåˆ† (å› ç‚ºåŒ¯å‡ºæ™‚æ˜¯ç”¨ \n åˆ†éš”)
                            // ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘åŒæ™‚æ”¯æ´ æ›è¡Œ(\n) å’Œ é€—è™Ÿ(,)
                            const splitComps = rawCompStr.split(/[\n,ï¼Œ]/g).map(s => s.trim()).filter(s => s);

                            compArr = splitComps.map(str => {
                                // 2. ä½¿ç”¨æ­£è¦è¡¨é”å¼ (Regex) ä¾†æ‹†è§£ "åç¨± [å‚™è¨»]"
                                // è¦å‰‡ï¼šæŠ“å– "åç¨±" + å¯èƒ½å­˜åœ¨çš„ "[å‚™è¨»]"
                                const match = str.match(/^(.*?)(?:\s*\[(.*?)\])?$/);
                                
                                if (match) {
                                    return {
                                        name: match[1].trim(), // æŠ“åˆ°çš„åå­—
                                        note: match[2] ? match[2].trim() : "", // æŠ“åˆ°çš„å‚™è¨» (å¦‚æœæœ‰çš„è©±)
                                        image: "" // âš ï¸ åœ–ç‰‡ç„¡æ³•å¾ Excel æ–‡å­—é‚„åŸï¼Œæœƒè®Šç©ºç™½
                                    };
                                } else {
                                    return { name: str, note: "", image: "" };
                                }
                            });
                        }

                        // è™•ç†åˆ¥å
                        const aliasArr = row["åˆ¥å"] ? row["åˆ¥å"].split(/[,ï¼Œã€]/).map(s => s.trim()) : [];

                        const newItem = {
                            id: row["ID"] ? parseInt(row["ID"]) : Date.now() + Math.floor(Math.random()*1000),
                            name_ch: row["ä¸­æ–‡å"] || "",
                            name_en: row["è‹±æ–‡å"] || "",
                            category_main: row["å¤§åˆ†é¡"] || "",
                            category_sub: row["ä¸­åˆ†é¡"] || "",
                            origin: row["åŸºåŸ"] || "",
                            family_ch: row["ç§‘åˆ¥(ä¸­)"] || "",
                            family_en: row["ç§‘åˆ¥(è‹±)"] || "",
                            part_ch: row["éƒ¨ä½(ä¸­)"] || "",
                            part_en: row["éƒ¨ä½(è‹±)"] || "",
                            efficacy: row["åŠŸæ•ˆ"] || "",
                            treatment: row["é©æ‡‰ç—‡"] || "",
                            note: row["å‚™è¨»(HTML)"] || "",
                            
                            components: compArr, // ä½¿ç”¨è§£æå¾Œçš„æˆåˆ†é™£åˆ—
                            aliases: aliasArr,
                            
                            // ä¿ç•™æ¬„ä½
                            characteristics: "", 
                            mnemonic: "",
                            comparisons: [],
                            updated_at: new Date().toISOString()
                        };

                        const existingIdx = newList.findIndex(item => item.id == newItem.id);
                        
                        if (existingIdx !== -1) {
                            // æ›´æ–°é‚è¼¯ï¼šä¿ç•™èˆŠåœ–ç‰‡
                            const oldItem = newList[existingIdx];
                            
                            // â˜… é€²éšï¼šå˜—è©¦ä¿ç•™èˆŠæˆåˆ†çš„åœ–ç‰‡
                            // å¦‚æœæ–°åŒ¯å…¥çš„æˆåˆ†åå­—è·ŸèˆŠçš„ä¸€æ¨£ï¼Œå°±æŠŠèˆŠåœ–ç‰‡æŠ“å›ä¾†
                            if (oldItem.components) {
                                newItem.components = newItem.components.map(newC => {
                                    const oldC = oldItem.components.find(oc => oc.name === newC.name);
                                    if (oldC && oldC.image) {
                                        newC.image = oldC.image; // æ•‘å›åœ–ç‰‡ï¼
                                    }
                                    return newC;
                                });
                            }

                            newList[existingIdx] = {
                                ...oldItem,
                                ...newItem
                            };
                            updateCount++;
                        } else {
                            newList.push(newItem);
                            addCount++;
                        }
                    });

                    await uploadToGitHub(newList, `Import Excel: ${addCount} added, ${updateCount} updated`);
                    pharmaList = newList;
                    renderList();
                    alert(`ğŸ‰ åŒ¯å…¥æˆåŠŸï¼\næ–°å¢ï¼š${addCount} ç­†\næ›´æ–°ï¼š${updateCount} ç­†`);

                } catch (e) {
                    console.error(e);
                    alert("åŒ¯å…¥å¤±æ•—ï¼š" + e.message);
                } finally {
                    input.value = "";
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
