<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸ | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* === å…¨å±€è®Šæ•¸ === */
        :root {
            --primary: #4A7C59;
            --primary-dark: #2C5E4F;
            --accent: #E8F5E9;
            --text-dark: #333;
            --text-light: #666;
            --bg-color: #f4f7f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            color: var(--text-dark);
        }

        /* === å°è¦½åˆ— === */
        nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-links a { text-decoration: none; color: var(--text-light); margin-left: 20px; font-weight: 500; transition: 0.2s; }
        .nav-links a:hover { color: var(--primary); }

        /* === æœå°‹èˆ‡ç¯©é¸å€ === */
        .hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 3rem 1rem;
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        .hero-title { font-size: 2rem; margin-bottom: 1rem; font-weight: 300; }
        
        .search-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        .search-box {
            width: 100%;
            padding: 15px 25px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            outline: none;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        .filter-tag {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9rem;
        }
        .filter-tag:hover, .filter-tag.active {
            background: white;
            color: var(--primary-dark);
            font-weight: bold;
        }

        /* === å¡ç‰‡ç¶²æ ¼å€ === */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 50px 20px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        /* === è—¥å­¸å¡ç‰‡è¨­è¨ˆ === */
        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover);
            border-color: var(--primary);
        }
        /* å·¦å´è£é£¾æ¢ (ä¾åˆ†é¡è®Šè‰²ï¼Œç›®å‰çµ±ä¸€ç¶ è‰²) */
        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--primary);
        }

        .card-body { padding: 20px; flex: 1; }
        
        .card-category {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            line-height: 1.2;
        }
        
        .card-subtitle {
            font-size: 0.95rem;
            color: #888;
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-top: 8px;
            color: var(--text-light);
            border-bottom: 1px dashed #eee;
            padding-bottom: 4px;
        }
        .info-label { font-weight: 500; color: #555; }

        .card-footer {
            padding: 15px 20px;
            background: #fafafa;
            border-top: 1px solid #eee;
            text-align: right;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* === è©³æƒ… Modal === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        
        .modal-content {
            background: white;
            width: 100%; max-width: 900px;
            max-height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            position: sticky; top: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title-group h2 { margin: 0; font-size: 1.8rem; }
        .modal-title-group span { font-family: 'Roboto Mono', monospace; opacity: 0.9; }
        .close-btn { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; }

        .modal-body { padding: 30px; }

        /* è©³æƒ…å€å¡Šæ¨£å¼ */
        .detail-section { margin-bottom: 30px; }
        .section-title {
            font-size: 1.2rem; font-weight: bold; color: var(--primary-dark);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }

        /* æ¨™ç±¤é›² */
        .tag-cloud { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .tag { background: var(--accent); color: var(--primary-dark); padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }

        /* æˆåˆ†åœ–ç‰‡ç¶²æ ¼ (å„ªåŒ–ç‰ˆ) */
        .chem-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* æ ¼å­ç¨å¾®å¯¬ä¸€é» */
            gap: 15px; 
        }
        .chem-item { 
            text-align: center; 
            border: 1px solid #eee; 
            padding: 15px 10px; 
            border-radius: 12px; 
            transition: 0.2s; 
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .chem-item:hover { 
            border-color: var(--primary); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .chem-item img { 
            max-width: 100%; 
            max-height: 120px; 
            object-fit: contain; 
            margin-bottom: 10px; 
            cursor: zoom-in; /* åªæœ‰åœ–ç‰‡å¯ä»¥é»æ“Šæ”¾å¤§ */
        }
        .chem-name { 
            font-size: 1rem; 
            font-weight: bold; 
            color: #444; 
            margin-bottom: 5px;
        }
        /* æ–°å¢ï¼šç›´æ¥é¡¯ç¤ºçš„å‚™è¨»æ¨£å¼ */
        .chem-inline-note {
            font-size: 0.85rem;
            color: #d32f2f; /* è­¦ç¤ºç´… */
            background: #fff3e0; /* æ·¡æ©˜åº• */
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 5px;
            line-height: 1.4;
            width: 100%;
            box-sizing: border-box;
        }
        /* å­åˆ†é¡æŒ‰éˆ•æ¨£å¼ */
        .sub-tag {
            background: white;
            color: #666;
            padding: 4px 12px;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            font-size: 0.85rem;
            transition: 0.2s;
        }
        .sub-tag:hover { border-color: var(--primary); color: var(--primary); }
        .sub-tag.active { 
            background: var(--accent); 
            color: var(--primary-dark); 
            border-color: var(--primary); 
            font-weight: bold;
        }

        /* æ¯”è¼ƒè¡¨æ ¼ */
        .compare-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .compare-table th, .compare-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .compare-table th { background: var(--accent); color: var(--primary-dark); width: 30%; }

        /* Rich Text Note */
        .rich-content table { width: 100%; border-collapse: collapse; }
        .rich-content th, .rich-content td { border: 1px solid #ddd; padding: 8px; }
        .rich-content img { max-width: 100%; height: auto; }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 768px) {
            .hero-title { font-size: 1.5rem; }
            .modal-content { max-height: 95vh; }
            .grid { grid-template-columns: 1fr; }

            /* === æ–°å¢ï¼šæˆåˆ†è©³æƒ…å°è¦–çª— === */
.chem-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 2000; /* æ¯”åŸæœ¬çš„ modal æ›´é«˜å±¤ */
    display: none; justify-content: center; align-items: center;
}
.chem-modal-box {
    background: white; padding: 25px; border-radius: 15px;
    width: 300px; text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.2s ease-out;
}
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.chem-detail-img { max-width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 15px; }
.chem-detail-note { background: #fff3e0; color: #d32f2f; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.95rem; display: inline-block; }
        }
        /* === åŒ–å­¸æˆåˆ†å½ˆçª—å°ˆç”¨æ¨£å¼ === */
        .chem-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); /* åŠé€æ˜é»‘åº• */
            z-index: 2000; /* â˜… é—œéµï¼šæ¯”åŸæœ¬çš„ 1000 å¤§ï¼Œæ‰€ä»¥æœƒç–Šåœ¨ä¸Šé¢ */
            display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
            backdrop-filter: blur(2px); /* è®“èƒŒæ™¯ç¨å¾®æ¨¡ç³Šï¼Œå‡¸é¡¯é€™å€‹è¦–çª— */
        }
        
        .chem-modal-box {
            background: white; width: 100%; max-width: 400px;
            padding: 20px; border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆè·³ç‰¹æ•ˆ */
        }

        @keyframes popIn { 
            from { opacity: 0; transform: scale(0.8); } 
            to { opacity: 1; transform: scale(1); } 
        }
        /* === åˆ†é¡ä»‹ç´¹å…§å®¹æ¨£å¼ === */
  /* === ğŸš‘ ä¿®æ­£ï¼šè®“è©³ç´°ä»‹ç´¹å°Šé‡å¾Œå°æ’ç‰ˆ (ä¸è¦å¼·åˆ¶ç½®ä¸­) === */
    .rich-content {
        text-align: left; /* 1. é è¨­é å·¦å°é½Š */
        color: #333 !important; /* 2. ç¢ºä¿æ–‡å­—æ˜¯é»‘è‰²çš„ */
        font-size: 1.1rem;      /* 3. å­—é«”ç¨å¾®å¤§ä¸€é»ï¼Œé–±è®€èˆ’é© */
        line-height: 1.8;       /* 4. è¡Œé«˜æ‹‰é–‹ï¼Œä¸è¦æ“ åœ¨ä¸€èµ· */
    }

    /* è®“ç·¨è¼¯å™¨è¨­å®šçš„ç½®ä¸­ã€ç½®å³ç”Ÿæ•ˆ */
    .rich-content p, .rich-content div, .rich-content h1, .rich-content h2 {
        /* å¦‚æœæ¨™ç±¤æœ¬èº«æœ‰ style="text-align: center"ï¼Œé€™è£¡æœƒç¹¼æ‰¿ï¼Œä¸æœƒè¢«å¼·åˆ¶è“‹æ‰ */
        /* ä¸éœ€è¦é¡å¤–å¯« codeï¼Œç€è¦½å™¨é è¨­å°±æœƒå°Šé‡ inline style */
    }

    /* åœ–ç‰‡é€šå¸¸ç½®ä¸­æ¯”è¼ƒå¥½çœ‹ï¼Œé€™è£¡å¯ä»¥è¨­å€‹é è¨­å€¼ï¼Œæˆ–æ˜¯æ‚¨åœ¨å¾Œå°è‡ªå·±èª¿ */
    .rich-content img {
        display: block;
        margin: 10px auto; /* é è¨­åœ–ç‰‡ç½®ä¸­ */
        max-width: 100%;
    }

        /* === ğŸš‘ ä¿®æ­£ï¼šå¼·åˆ¶å½ˆçª—å…§å®¹é¡¯ç¤ºé»‘å­— === */
    
    /* 1. é‡å°æ‰€æœ‰å½ˆçª—å…§å®¹å€åŸŸ */
    .modal-body {
        color: #333 !important; /* å¼·åˆ¶æ·±ç°è‰² */
    }

    /* 2. é‡å°åˆ†é¡ä»‹ç´¹çš„å¯Œæ–‡æœ¬å€åŸŸ */
    .rich-content, 
    .rich-content p, 
    .rich-content li, 
    .rich-content span {
        color: #333 !important;
    }

    /* 3. é‡å°ç”Ÿè—¥è©³æƒ…çš„ç­†è¨˜å€åŸŸ */
    #modal-note, 
    #modal-note p {
        color: #333 !important;
    }

    /* 4. ç¢ºä¿æ¨™é¡Œä¾ç„¶æ˜¯ç™½å­— (ä¸è¢«å½±éŸ¿) */
    .modal-header, 
    .modal-header h2, 
    .modal-header h3 {
        color: white !important;
    }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ğŸŒ¿ æœ¬è‰å­¸åœ’</a>
        <div class="nav-links">
            <a href="index.html">ä¸­è—¥åº«</a>
            <a href="pharmacognosy.html">ç”Ÿè—¥åº«</a>
            <a href="quiz.html">è‡ªæˆ‘æ¸¬é©—</a>
            <a href="admin_menu.html">å¾Œå°ç®¡ç†</a>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="hero-title">ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸</h1>
        <div class="search-container">
            <input type="text" id="search-input" class="search-box" placeholder="ğŸ” æœå°‹ç”Ÿè—¥åç¨±ã€å­¸åã€é—œéµæˆåˆ†..." oninput="filterData()">
        </div>
        <div id="filter-container" class="filter-tags">
        <div class="filter-tag active" onclick="resetFilter(this)">å…¨éƒ¨</div>
    </div>

    <div id="sub-filter-container" class="filter-tags" style="margin-top:10px; min-height:10px;"></div>

    <div style="text-align:center; margin: 15px 0; height: 40px;">
        <button id="btn-cat-info" onclick="openCategoryModal()" style="display:none; background: linear-gradient(135deg, #4A7C59, #2C5E4F); color:white; border:none; padding:10px 25px; border-radius:30px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition:0.3s; align-items:center; gap:8px;">
            ğŸ“– æŸ¥çœ‹ã€Œ<span id="current-cat-name"></span>ã€è©³ç´°ä»‹ç´¹
        </button>
    </div>

    <div id="cat-modal" class="modal-overlay" onclick="closeCategoryModal(event)">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h2 id="cat-modal-title" style="margin:0;">åˆ†é¡ä»‹ç´¹</h2>
                <button onclick="document.getElementById('cat-modal').style.display='none'" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer;">Ã—</button>
            </div>
            <div class="modal-body rich-content" id="cat-modal-body" style="line-height:1.8; font-size:1.05rem;">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px; color:#888;">
            <h2>â³ æ­£åœ¨è¼‰å…¥ç”Ÿè—¥è³‡æ–™åº«...</h2>
        </div>
        
        <div id="pharma-grid" class="grid"></div>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h2 id="modal-title">éº»é»ƒ</h2>
                    <span id="modal-subtitle">Ephedra</span>
                </div>
                <button class="close-btn" onclick="closeModalDirect()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tag-cloud" id="modal-tags"></div>
                
                <div class="detail-section">
                    <div class="section-title">ğŸ“Œ åŸºæœ¬è³‡è¨Š</div>
                    <table class="compare-table">
                        <tr><th>åŸºåŸ (Origin)</th><td id="modal-origin"></td></tr>
                        <tr><th>ç§‘åˆ¥ (Family)</th><td id="modal-family"></td></tr>
                        <tr><th>ä½¿ç”¨éƒ¨ä½ (Part)</th><td id="modal-part"></td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">âš—ï¸ åŒ–å­¸æˆåˆ† (Components)</div>
                    <div id="modal-chem-grid" class="chem-grid"></div>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ’¡ ç‰¹æ€§èˆ‡åŠŸæ•ˆ</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <strong>æ€§ç‹€/ç‰¹æ€§ï¼š</strong>
                            <p id="modal-char" style="color:#555;"></p>
                        </div>
                        <div>
                            <strong>åŠŸæ•ˆï¼š</strong>
                            <p id="modal-efficacy" style="color:#555;"></p>
                        </div>
                    </div>
                </div>

                <div class="detail-section" style="background:#fff3e0; padding:15px; border-radius:10px;">
                    <strong>ğŸ’Š æ²»ç™‚/é©æ‡‰ç—‡ï¼š</strong> <span id="modal-treat"></span><br><br>
                    <strong>ğŸ§  è¨˜æ³•/å£è¨£ï¼š</strong> <span id="modal-mnemonic" style="color:#d32f2f; font-weight:bold;"></span>
                </div>

                <div class="detail-section" id="compare-section">
                    <div class="section-title">âš–ï¸ æ˜“æ··æ·†æ¯”è¼ƒ</div>
                    <table class="compare-table">
                        <thead><tr><th>æ¯”è¼ƒå°è±¡</th><th>å·®ç•°é»</th></tr></thead>
                        <tbody id="modal-compare-body"></tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ“ è©³ç´°ç­†è¨˜</div>
                    <div id="modal-note" class="rich-content"></div>
                </div>
            </div>
        </div>
    </div>
<div id="chem-detail-modal" class="chem-modal-overlay" onclick="closeChemModal()">
        <div class="chem-modal-box" onclick="event.stopPropagation()">
            <div style="text-align:right;">
                <button onclick="closeChemModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">Ã—</button>
            </div>
            
            <h3 id="chem-popup-name" style="margin-top:0; color:#4A7C59;">æˆåˆ†åç¨±</h3>
            
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px;">
                <img id="chem-popup-img" src="" style="max-width:100%; max-height:250px; object-fit:contain;">
            </div>

            <div id="chem-popup-note-box" style="display:none; background:#fff3e0; padding:15px; border-radius:10px; text-align:left; border-left:5px solid #ff9800;">
                <strong style="color:#e65100;">ğŸ“ å‚™è¨»ï¼š</strong>
               <div id="chem-popup-note" class="rich-content" style="color:#333; margin-top:5px; font-size:0.95rem;"></div>
            </div>
        </div>
    </div>

</div>
    <script src="pharma_config.js"></script>
<script>
    // === å…¨åŸŸè®Šæ•¸ ===
    let allData = [];
    let categoryData = {}; 
    let currentMainCat = 'all'; // ç›®å‰é¸çš„å¤§åˆ†é¡
    let currentSubCat = '';     // ç›®å‰é¸çš„ä¸­åˆ†é¡

    // === 1. åˆå§‹åŒ–èˆ‡è³‡æ–™è¼‰å…¥ ===
    document.addEventListener('DOMContentLoaded', () => {
        initFilters();
        
        // ä½¿ç”¨ Promise.all åŒæ™‚è¼‰å…¥å…©ä»½è³‡æ–™
        Promise.all([
            // A. è¼‰å…¥ç”Ÿè—¥åˆ—è¡¨ (â˜… åŠ å…¥æ™‚é–“æˆ³è¨˜ï¼Œé¿å…å¿«å–)
            fetch('data/pharma.json?t=' + Date.now()).then(r => r.ok ? r.json() : []).then(json => {
                if (json.content && json.encoding === 'base64') {
                    return JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                }
                return json;
            }),
            // B. è¼‰å…¥åˆ†é¡ä»‹ç´¹ (â˜… åŠ å…¥æ™‚é–“æˆ³è¨˜ï¼Œè§£æ±ºå¾Œå°æ›´æ–°å‰å°çœ‹ä¸åˆ°çš„å•é¡Œ)
            fetch('data/categories.json?t=' + Date.now()).then(r => r.ok ? r.json() : {}).then(json => {
                if (json.content && json.encoding === 'base64') {
                    return JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                }
                return json;
            }).catch(() => ({})) 
        ]).then(([pharmaList, catInfo]) => {
            // è³‡æ–™è¼‰å…¥å®Œæˆ
            allData = pharmaList || [];
            categoryData = catInfo || {};
            
            document.getElementById('loading').style.display = 'none';
            renderGrid(allData);

            // C. æª¢æŸ¥ç¶²å€åƒæ•¸ (ä¸­è—¥åº«è·³è½‰é‚è¼¯)
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            
            if (query) {
                const input = document.getElementById('search-input');
                input.value = query;
                filterData(); // åŸ·è¡Œæœå°‹

                // å¦‚æœç²¾ç¢ºåŒ¹é…åˆ°åªæœ‰ä¸€ç­†ï¼Œè‡ªå‹•é»é–‹è©³æƒ…
                const filtered = allData.filter(item => 
                    (item.name_en||"").toLowerCase().includes(query.toLowerCase()) || 
                    (item.components||[]).some(c => c.name.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filtered.length === 1) {
                    openDetail(filtered[0]);
                }
            }
        }).catch(err => {
            console.error("è³‡æ–™è¼‰å…¥éŒ¯èª¤:", err);
            document.getElementById('loading').innerHTML = "<p>è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub è¨­å®šã€‚</p>";
        });
    });

    // === 2. åˆ†é¡ç¯©é¸é‚è¼¯ (é›™å±¤é¸å–®æ ¸å¿ƒ) ===

    // åˆå§‹åŒ–ï¼šåªç”¢ç”Ÿå¤§åˆ†é¡æŒ‰éˆ•
   function initFilters() {
        const container = document.getElementById('filter-container');
        // æ¸…ç©ºä¸¦åŠ å…¥"å…¨éƒ¨"
        container.innerHTML = '<div class="filter-tag active" onclick="resetFilter(this)">å…¨éƒ¨ (All)</div>';
        
        if (typeof PHARMA_CATEGORIES !== 'undefined') {
            PHARMA_CATEGORIES.forEach(cat => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                
                // â˜… ä¿®æ”¹é»ï¼šé¡¯ç¤º "ä¸­æ–‡ (è‹±æ–‡)"
                tag.innerText = `${cat.name_ch} (${cat.name_en})`; 
                
                // é»æ“Šæ™‚å‚³å…¥åŸæœ¬çš„ä¸­æ–‡ key å³å¯
                tag.onclick = () => selectMainCategory(cat.name_ch, tag);
                container.appendChild(tag);
            });
        }
    }

    // é»æ“Šã€Œå…¨éƒ¨ã€
    function resetFilter(el) {
        currentMainCat = 'all';
        currentSubCat = '';
        updateActiveTag(el, 'filter-tag');
        document.getElementById('sub-filter-container').innerHTML = ""; // æ¸…ç©ºå­åˆ†é¡
        checkIntroButton();
        filterData();
    }

    // é»æ“Šã€Œå¤§åˆ†é¡ã€
    function selectMainCategory(mainCatName, el) {
        currentMainCat = mainCatName;
        currentSubCat = ''; // é‡ç½®å­åˆ†é¡
        updateActiveTag(el, 'filter-tag');

        // ç”¢ç”Ÿå­åˆ†é¡æŒ‰éˆ•
        renderSubCategories(mainCatName);
        
        checkIntroButton(); // æª¢æŸ¥æ˜¯å¦æœ‰ä»‹ç´¹æ–‡
        filterData();
    }

    // ç”¢ç”Ÿå­åˆ†é¡æŒ‰éˆ• UI
   function renderSubCategories(mainName) {
        const container = document.getElementById('sub-filter-container');
        container.innerHTML = ""; 

        // å¾ config æ‰¾è©²åˆ†é¡çš„å­åˆ†é¡
        const catConfig = PHARMA_CATEGORIES.find(c => c.name_ch === mainName);
        
        if (catConfig && catConfig.subcategories) {
            catConfig.subcategories.forEach(sub => {
                const btn = document.createElement('div');
                btn.className = 'sub-tag';
                
                // â˜… ä¿®æ”¹é»ï¼šé¡¯ç¤º "ä¸­æ–‡ (è‹±æ–‡)"
                btn.innerText = `${sub.ch} (${sub.en})`; 
                
                // é»æ“Šæ™‚å‚³å…¥åŸæœ¬çš„ä¸­æ–‡ key
                btn.onclick = () => selectSubCategory(sub.ch, btn);
                container.appendChild(btn);
            });
        }
    }

    // é»æ“Šã€Œä¸­åˆ†é¡ã€
    function selectSubCategory(subName, el) {
        currentSubCat = subName;
        updateActiveTag(el, 'sub-tag');
        
        checkIntroButton(); 
        filterData();
    }

    // æª¢æŸ¥ä¸¦é¡¯ç¤ºã€ŒğŸ“– æŸ¥çœ‹ä»‹ç´¹ã€æŒ‰éˆ• (â˜… é€™è£¡ä¿®å¾©äº†æŒ‰éˆ•äº‚è·‘çš„å•é¡Œ)
   // === ä¿®æ­£ç‰ˆï¼šæª¢æŸ¥ä¸¦é¡¯ç¤ºä»‹ç´¹æŒ‰éˆ• (å¤§åˆ†é¡/ä¸­åˆ†é¡é€šåƒ) ===
    function checkIntroButton() {
        const btnInfo = document.getElementById('btn-cat-info');
        const spanName = document.getElementById('current-cat-name');
        
        // 1. æ±ºå®šç›®æ¨™ï¼š
        // å¦‚æœæœ‰é¸ä¸­åˆ†é¡ (currentSubCat)ï¼Œç›®æ¨™å°±æ˜¯ä¸­åˆ†é¡
        // å¦‚æœæ²’é¸ä¸­åˆ†é¡ï¼Œä½†æœ‰é¸å¤§åˆ†é¡ (currentMainCat)ï¼Œç›®æ¨™å°±æ˜¯å¤§åˆ†é¡
        let targetKey = '';
        
        if (currentSubCat) {
            targetKey = currentSubCat;
        } else if (currentMainCat !== 'all') {
            targetKey = currentMainCat;
        }
        
        // å¦‚æœé‚„æ˜¯æ²’ç›®æ¨™ (ä¾‹å¦‚é¸å…¨éƒ¨)ï¼Œå°±éš±è—æŒ‰éˆ•
        if (!targetKey) {
            btnInfo.style.display = 'none';
            return;
        }

        // 2. æ¯”å°è³‡æ–™åº« (æ¨¡ç³Šæ¯”å°ï¼Œè§£æ±ºæ‹¬è™Ÿå•é¡Œ)
        // é‚è¼¯ï¼šè³‡æ–™åº«çš„ Key å¿…é ˆåŒ…å« targetKey
        // ä¾‹å¦‚ï¼šé¸ã€Œé…ç³–é«”ã€ï¼Œå¯ä»¥å°æ‡‰åˆ°ã€Œé…ç³–é«” (Glycoside)ã€
        const matchKey = Object.keys(categoryData).find(k => k.includes(targetKey));

        // 3. é¡¯ç¤ºæŒ‰éˆ•
        if (matchKey && categoryData[matchKey]) {
            // æŒ‰éˆ•ä¸Šé¡¯ç¤ºæˆ‘å€‘çœŸæ­£æ‰¾åˆ°çš„é‚£å€‹æ¨™é¡Œ (ä¾‹å¦‚ "é…ç³–é«” (Glycoside)")
            spanName.innerText = matchKey; 
            btnInfo.style.display = 'inline-flex';
            btnInfo.dataset.realKey = matchKey; // ç¶å®šçœŸå¯¦ Key ä¾›å½ˆçª—ä½¿ç”¨
        } else {
            btnInfo.style.display = 'none';
        }
    }

    // === 3. åŸ·è¡Œç¯©é¸èˆ‡æ¸²æŸ“ (è¶…ç´šæœå°‹ç‰ˆ) ===
    function filterData() {
        // å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„é—œéµå­—ï¼Œä¸¦è½‰å°å¯« (ç‚ºäº†ä¸åˆ†å¤§å°å¯«)
        const term = document.getElementById('search-input').value.toLowerCase().trim();
        
        const filtered = allData.filter(item => {
            // === A. æ™ºæ…§æœå°‹é‚è¼¯ (åªè¦ç¬¦åˆå…¶ä¸­ä¸€é …å°±ç®—æ•¸) ===
            const matchText = 
                // 1. ä¸­æ–‡å
                (item.name_ch || "").includes(term) || 
                // 2. è‹±æ–‡å (è½‰å°å¯«æ¯”å°)
                (item.name_en || "").toLowerCase().includes(term) ||
                // 3. åŸºåŸ/å­¸å
                (item.origin || "").toLowerCase().includes(term) ||
                // 4. â˜… æˆåˆ† (æƒæé™£åˆ—ä¸­çš„æ¯ä¸€å€‹æˆåˆ†å)
                (item.components || []).some(c => c.name.toLowerCase().includes(term)) ||
                // 5. â˜… [æ–°å¢] ç§‘å (ä¸­æ–‡æˆ–è‹±æ–‡)
                (item.family_ch || "").includes(term) ||
                (item.family_en || "").toLowerCase().includes(term) ||
                // 6. â˜… [æ–°å¢] åŠŸæ•ˆ/é©æ‡‰ç—‡ (ä¾‹å¦‚æœ "æ­¢ç—›")
                (item.efficacy || "").includes(term) ||
                // 7. â˜… [æ–°å¢] åˆ¥å (æƒæåˆ¥åé™£åˆ—)
                (item.aliases || []).some(a => a.includes(term));
            
            // === B. åˆ†é¡ç¯©é¸é‚è¼¯ (ä¸è®Š) ===
            let matchCat = true;
            if (currentMainCat !== 'all') {
                matchCat = (item.category_main || "").includes(currentMainCat);
                if (currentSubCat) {
                    matchCat = matchCat && (item.category_sub || "").includes(currentSubCat);
                }
            }

            // å…©å€‹æ¢ä»¶éƒ½è¦ç¬¦åˆ (æ–‡å­—æœ‰å°åˆ° AND åˆ†é¡æœ‰å°åˆ°)
            return matchText && matchCat;
        });

        renderGrid(filtered);
    }
    // 3. æ¸²æŸ“å¡ç‰‡ç¶²æ ¼ (å·²ä¿®æ”¹ï¼šç›´æ¥é¡¯ç¤ºæˆåˆ†åç¨±)
    function renderGrid(data) {
        const grid = document.getElementById('pharma-grid');
        grid.innerHTML = "";

        if (data.length === 0) {
            grid.innerHTML = "<p style='text-align:center; width:100%; grid-column:1/-1;'>æ‰¾ä¸åˆ°ç›¸é—œè—¥æ</p>";
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openDetail(item);
            
            const family = item.family_ch || item.family_en || "æœªåˆ†é¡";
            const part = item.part_ch || "-";

            // â˜… ä¿®æ”¹é‡é»ï¼šè™•ç†æˆåˆ†åç¨±
            let compText = "ç„¡";
            if (item.components && item.components.length > 0) {
                // æŠŠæ‰€æœ‰æˆåˆ†çš„åå­—æŠ“å‡ºä¾†ï¼Œç”¨é “è™Ÿä¸²æ¥
                // ä¾‹å¦‚ï¼š "Morphineã€Codeineã€Thebaine"
                compText = item.components.map(c => c.name).join('ã€');
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="card-category">${item.category_main} / ${item.category_sub || ""}</div>
                    <h3 class="card-title">${item.name_ch}</h3>
                    <div class="card-subtitle">${item.name_en}</div>
                    
                    <div class="info-row">
                        <span class="info-label">ç§‘åˆ¥</span> <span>${family}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">éƒ¨ä½</span> <span>${part}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æˆåˆ†</span> 
                        <span style="display:inline-block; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom;" title="${compText}">
                            ${compText}
                        </span>
                    </div>
                </div>
                <div class="card-footer">æŸ¥çœ‹è©³æƒ… â”</div>
            `;
            grid.appendChild(card);
        });
    }
    // === 4. ç”Ÿè—¥è©³æƒ… Modal ===
    function openDetail(item) {
        const modal = document.getElementById('detail-modal');
        
        document.getElementById('modal-title').innerText = item.name_ch;
        document.getElementById('modal-subtitle').innerText = item.name_en;
        document.getElementById('modal-origin').innerText = item.origin || "-";
        document.getElementById('modal-family').innerText = `${item.family_ch || ""} (${item.family_en || ""})`;
        document.getElementById('modal-part').innerText = `${item.part_ch || ""} (${item.part_en || ""})`;

        // æ¨™ç±¤é›²
        const tagContainer = document.getElementById('modal-tags');
        tagContainer.innerHTML = "";
        [item.category_main, ...(item.aliases || [])].forEach(tagText => {
            if(tagText) {
                const tag = document.createElement('span');
                tag.className = 'tag'; tag.innerText = tagText;
                tagContainer.appendChild(tag);
            }
        });

        // æˆåˆ†ç¶²æ ¼ (é»æ“Šé–‹å•Ÿå°è¦–çª—)
        const chemGrid = document.getElementById('modal-chem-grid');
        chemGrid.innerHTML = "";
        if (item.components && item.components.length > 0) {
            item.components.forEach(c => {
                const div = document.createElement('div');
                div.className = 'chem-item';
                div.style.cursor = "pointer"; 
                
                // é»æ“Šå‘¼å« showChemDetail
                div.onclick = () => showChemDetail(c);

                const imgSrc = c.image || 'https://via.placeholder.com/150x100?text=No+Structure';
                div.innerHTML = `
                    <img src="${imgSrc}" alt="${c.name}">
                    <div class="chem-name">${c.name}</div>
                    ${c.note ? '<span style="font-size:0.8rem; color:#ff9800;">(æœ‰å‚™è¨»)</span>' : ''}
                `;
                chemGrid.appendChild(div);
            });
        } else {
            chemGrid.innerHTML = "<span style='color:#999'>ç„¡æˆåˆ†è³‡æ–™</span>";
        }

        // æ–‡å­—å€å¡Š
        document.getElementById('modal-char').innerText = item.characteristics || "æš«ç„¡";
        document.getElementById('modal-efficacy').innerText = item.efficacy || "æš«ç„¡";
        document.getElementById('modal-treat').innerText = item.treatment || "-";
        document.getElementById('modal-mnemonic').innerText = item.mnemonic || "-";

        // æ¯”è¼ƒè¡¨
        const compBody = document.getElementById('modal-compare-body');
        compBody.innerHTML = "";
        if (item.comparisons && item.comparisons.length > 0) {
            item.comparisons.forEach(cmp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${cmp.target}</td><td>${cmp.diff}</td>`;
                compBody.appendChild(tr);
            });
            document.getElementById('compare-section').style.display = 'block';
        } else {
            document.getElementById('compare-section').style.display = 'none';
        }

        // ç­†è¨˜
        document.getElementById('modal-note').innerHTML = item.note || "<p style='color:#ccc'>ç„¡è©³ç´°ç­†è¨˜</p>";

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModalDirect() {
        document.getElementById('detail-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    function closeModal(event) {
        if (event.target.id === 'detail-modal') closeModalDirect();
    }

    // === 5. æˆåˆ†è©³æƒ…å°è¦–çª— (Popup) - ä¿®æ­£ç‰ˆ ===
    function showChemDetail(c) {
        // å¡«å…¥åå­—
        document.getElementById('chem-popup-name').innerText = c.name;
        
        // å¡«å…¥åœ–ç‰‡
        const img = document.getElementById('chem-popup-img');
        img.src = c.image || 'https://via.placeholder.com/300x200?text=No+Image';
        
        // å¡«å…¥å‚™è¨»
        const noteBox = document.getElementById('chem-popup-note-box');
        const noteContent = document.getElementById('chem-popup-note');

        if (c.note && c.note.trim() !== "") {
            // â˜… é—œéµä¿®æ”¹ï¼šé€™è£¡æ”¹æˆ innerHTMLï¼Œç€è¦½å™¨æ‰æœƒæŠŠ <ul> è®Šæˆåˆ—è¡¨ï¼Œè€Œä¸æ˜¯é¡¯ç¤ºæ–‡å­—
            noteContent.innerHTML = c.note; 
            noteBox.style.display = 'block';
        } else {
            noteBox.style.display = 'none';
        }

        // é¡¯ç¤ºå½ˆçª—
        document.getElementById('chem-detail-modal').style.display = 'flex';
    }

    function closeChemModal() {
        document.getElementById('chem-detail-modal').style.display = 'none';
    }

    // === 6. åˆ†é¡ä»‹ç´¹è¦–çª— (Intro Modal) ===
    function openCategoryModal() {
        const btn = document.getElementById('btn-cat-info');
        const realKey = btn.dataset.realKey;
        if (!realKey) return;
        
        document.getElementById('cat-modal-title').innerText = `${realKey} - è©³ç´°ä»‹ç´¹`;
        document.getElementById('cat-modal-body').innerHTML = categoryData[realKey] || "è¼‰å…¥å¤±æ•—";
        document.getElementById('cat-modal').style.display = 'flex';
    }

    function closeCategoryModal(e) {
        if (e.target.id === 'cat-modal') {
            document.getElementById('cat-modal').style.display = 'none';
        }
    }

    // è¼”åŠ©ï¼šæ›´æ–°æŒ‰éˆ•æ¨£å¼
    function updateActiveTag(el, className) {
        document.querySelectorAll('.' + className).forEach(e => e.classList.remove('active'));
        if(el) el.classList.add('active');
    }
</script>
</body>
</html>
