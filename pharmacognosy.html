<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸ | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* === å…¨å±€è®Šæ•¸ === */
        :root {
            --primary: #4A7C59;
            --primary-dark: #2C5E4F;
            --accent: #E8F5E9;
            --text-dark: #333;
            --text-light: #666;
            --bg-color: #f4f7f6;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            color: var(--text-dark);
        }

        /* === å°è¦½åˆ— === */
        nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-links a { text-decoration: none; color: var(--text-light); margin-left: 20px; font-weight: 500; transition: 0.2s; }
        .nav-links a:hover { color: var(--primary); }

        /* === æœå°‹èˆ‡ç¯©é¸å€ === */
        .hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 3rem 1rem;
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        .hero-title { font-size: 2rem; margin-bottom: 1rem; font-weight: 300; }
        
        .search-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        .search-box {
            width: 100%;
            padding: 15px 25px;
            border-radius: 50px;
            border: none;
            font-size: 1.1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            outline: none;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        .filter-tag {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9rem;
        }
        .filter-tag:hover, .filter-tag.active {
            background: white;
            color: var(--primary-dark);
            font-weight: bold;
        }

        /* === å¡ç‰‡ç¶²æ ¼å€ === */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 50px 20px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        /* === è—¥å­¸å¡ç‰‡è¨­è¨ˆ === */
        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover);
            border-color: var(--primary);
        }
        /* å·¦å´è£é£¾æ¢ (ä¾åˆ†é¡è®Šè‰²ï¼Œç›®å‰çµ±ä¸€ç¶ è‰²) */
        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--primary);
        }

        .card-body { padding: 20px; flex: 1; }
        
        .card-category {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            line-height: 1.2;
        }
        
        .card-subtitle {
            font-size: 0.95rem;
            color: #888;
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-top: 8px;
            color: var(--text-light);
            border-bottom: 1px dashed #eee;
            padding-bottom: 4px;
        }
        .info-label { font-weight: 500; color: #555; }

        .card-footer {
            padding: 15px 20px;
            background: #fafafa;
            border-top: 1px solid #eee;
            text-align: right;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* === è©³æƒ… Modal === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        
        .modal-content {
            background: white;
            width: 100%; max-width: 900px;
            max-height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            position: sticky; top: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title-group h2 { margin: 0; font-size: 1.8rem; }
        .modal-title-group span { font-family: 'Roboto Mono', monospace; opacity: 0.9; }
        .close-btn { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; }

        .modal-body { padding: 30px; }

        /* è©³æƒ…å€å¡Šæ¨£å¼ */
        .detail-section { margin-bottom: 30px; }
        .section-title {
            font-size: 1.2rem; font-weight: bold; color: var(--primary-dark);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }

        /* æ¨™ç±¤é›² */
        .tag-cloud { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .tag { background: var(--accent); color: var(--primary-dark); padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }

        /* æˆåˆ†åœ–ç‰‡ç¶²æ ¼ */
        .chem-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .chem-item { text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 10px; transition: 0.2s; }
        .chem-item:hover { border-color: var(--primary); transform: scale(1.02); }
        .chem-item img { max-width: 100%; max-height: 100px; object-fit: contain; margin-bottom: 5px; }
        .chem-name { font-size: 0.9rem; font-weight: bold; color: #444; }

        /* æ¯”è¼ƒè¡¨æ ¼ */
        .compare-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .compare-table th, .compare-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .compare-table th { background: var(--accent); color: var(--primary-dark); width: 30%; }

        /* Rich Text Note */
        .rich-content table { width: 100%; border-collapse: collapse; }
        .rich-content th, .rich-content td { border: 1px solid #ddd; padding: 8px; }
        .rich-content img { max-width: 100%; height: auto; }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 768px) {
            .hero-title { font-size: 1.5rem; }
            .modal-content { max-height: 95vh; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ğŸŒ¿ æœ¬è‰å­¸åœ’</a>
        <div class="nav-links">
            <a href="index.html">ä¸­è—¥åº«</a>
            <a href="pharmacognosy.html" style="color:var(--primary);">ç”Ÿè—¥åº«</a>
            <a href="admin_menu.html">å¾Œå°ç®¡ç†</a>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="hero-title">ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸</h1>
        <div class="search-container">
            <input type="text" id="search-input" class="search-box" placeholder="ğŸ” æœå°‹ç”Ÿè—¥åç¨±ã€å­¸åã€é—œéµæˆåˆ†..." oninput="filterData()">
        </div>
        <div id="filter-container" class="filter-tags">
            <div class="filter-tag active" onclick="setFilter('all', this)">å…¨éƒ¨</div>
        </div>
    </div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px; color:#888;">
            <h2>â³ æ­£åœ¨è¼‰å…¥ç”Ÿè—¥è³‡æ–™åº«...</h2>
        </div>
        
        <div id="pharma-grid" class="grid"></div>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h2 id="modal-title">éº»é»ƒ</h2>
                    <span id="modal-subtitle">Ephedra</span>
                </div>
                <button class="close-btn" onclick="closeModalDirect()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tag-cloud" id="modal-tags"></div>
                
                <div class="detail-section">
                    <div class="section-title">ğŸ“Œ åŸºæœ¬è³‡è¨Š</div>
                    <table class="compare-table">
                        <tr><th>åŸºåŸ (Origin)</th><td id="modal-origin"></td></tr>
                        <tr><th>ç§‘åˆ¥ (Family)</th><td id="modal-family"></td></tr>
                        <tr><th>ä½¿ç”¨éƒ¨ä½ (Part)</th><td id="modal-part"></td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">âš—ï¸ åŒ–å­¸æˆåˆ† (Components)</div>
                    <div id="modal-chem-grid" class="chem-grid"></div>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ’¡ ç‰¹æ€§èˆ‡åŠŸæ•ˆ</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <strong>æ€§ç‹€/ç‰¹æ€§ï¼š</strong>
                            <p id="modal-char" style="color:#555;"></p>
                        </div>
                        <div>
                            <strong>åŠŸæ•ˆï¼š</strong>
                            <p id="modal-efficacy" style="color:#555;"></p>
                        </div>
                    </div>
                </div>

                <div class="detail-section" style="background:#fff3e0; padding:15px; border-radius:10px;">
                    <strong>ğŸ’Š æ²»ç™‚/é©æ‡‰ç—‡ï¼š</strong> <span id="modal-treat"></span><br><br>
                    <strong>ğŸ§  è¨˜æ³•/å£è¨£ï¼š</strong> <span id="modal-mnemonic" style="color:#d32f2f; font-weight:bold;"></span>
                </div>

                <div class="detail-section" id="compare-section">
                    <div class="section-title">âš–ï¸ æ˜“æ··æ·†æ¯”è¼ƒ</div>
                    <table class="compare-table">
                        <thead><tr><th>æ¯”è¼ƒå°è±¡</th><th>å·®ç•°é»</th></tr></thead>
                        <tbody id="modal-compare-body"></tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ“ è©³ç´°ç­†è¨˜</div>
                    <div id="modal-note" class="rich-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="pharma_config.js"></script>

    <script>
        let allData = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            loadData();
        });

        // 1. åˆå§‹åŒ–ç¯©é¸æŒ‰éˆ• (å¾ pharma_config.js è®€å–)
        function initFilters() {
            const container = document.getElementById('filter-container');
            // å¦‚æœæœ‰ PHARMA_CATEGORIES è®Šæ•¸ (ä¾†è‡ª pharma_config.js)
            if (typeof PHARMA_CATEGORIES !== 'undefined') {
                PHARMA_CATEGORIES.forEach(cat => {
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    tag.innerText = cat.name_ch; // åªé¡¯ç¤ºå¤§åˆ†é¡
                    tag.onclick = () => setFilter(cat.name_ch, tag);
                    container.appendChild(tag);
                });
            }
        }

        // 2. è¼‰å…¥è³‡æ–™
        async function loadData() {
            try {
                // ç›´æ¥è®€å–ç›¸å°è·¯å¾‘çš„ JSON
                const res = await fetch('data/pharma.json');
                if (!res.ok) throw new Error("å°šæœªå»ºç«‹è³‡æ–™åº«");
                
                // GitHub API å‚³å›ä¾†çš„æ˜¯ base64ï¼Œå¦‚æœæ˜¯ç›´æ¥ fetch raw/file å‰‡æ˜¯ json
                // é€™è£¡å‡è¨­æ˜¯ç›´æ¥ fetch æª”æ¡ˆï¼Œå¦‚æœæ˜¯ GitHub API æ ¼å¼éœ€è§£ç¢¼
                const json = await res.json();
                
                // åˆ¤æ–·æ˜¯å¦ç‚º GitHub API å›å‚³æ ¼å¼ (å« content æ¬„ä½)
                if (json.content && json.encoding === 'base64') {
                    allData = JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                } else {
                    allData = json; // é€™æ˜¯ç›´æ¥å­˜å–çš„æ ¼å¼
                }

                document.getElementById('loading').style.display = 'none';
                renderGrid(allData);

            } catch (e) {
                document.getElementById('loading').innerHTML = `
                    <h3>å°šç„¡è³‡æ–™</h3>
                    <p>è«‹å…ˆè‡³å¾Œå°æ–°å¢ç”Ÿè—¥è³‡æ–™</p>
                    <a href="admin_menu.html" style="color:var(--primary);">å‰å¾€å¾Œå° ></a>
                `;
                console.error(e);
            }
        }

        // 3. æ¸²æŸ“å¡ç‰‡ç¶²æ ¼
        function renderGrid(data) {
            const grid = document.getElementById('pharma-grid');
            grid.innerHTML = "";

            if (data.length === 0) {
                grid.innerHTML = "<p style='text-align:center; width:100%; grid-column:1/-1;'>æ‰¾ä¸åˆ°ç›¸é—œè—¥æ</p>";
                return;
            }

            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openDetail(item);
                
                // è™•ç†å¯èƒ½çš„ç©ºå€¼
                const family = item.family_ch || item.family_en || "æœªåˆ†é¡";
                const part = item.part_ch || "-";

                card.innerHTML = `
                    <div class="card-body">
                        <div class="card-category">${item.category_main} / ${item.category_sub || ""}</div>
                        <h3 class="card-title">${item.name_ch}</h3>
                        <div class="card-subtitle">${item.name_en}</div>
                        
                        <div class="info-row">
                            <span class="info-label">ç§‘åˆ¥</span>
                            <span>${family}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">éƒ¨ä½</span>
                            <span>${part}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æˆåˆ†</span>
                            <span>${item.components ? item.components.length : 0} ç¨®</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        æŸ¥çœ‹è©³æƒ… â”
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 4. ç¯©é¸é‚è¼¯
        function filterData() {
            const term = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = allData.filter(item => {
                // æœå°‹æ–‡å­—åŒ¹é… (ä¸­æ–‡ã€è‹±æ–‡ã€å­¸åã€æˆåˆ†å)
                const matchText = (item.name_ch || "").includes(term) || 
                                  (item.name_en || "").toLowerCase().includes(term) ||
                                  (item.origin || "").toLowerCase().includes(term) ||
                                  (item.components || []).some(c => c.name.toLowerCase().includes(term));
                
                // åˆ†é¡åŒ¹é…
                const matchCat = currentFilter === 'all' ? true : item.category_main === currentFilter;

                return matchText && matchCat;
            });

            renderGrid(filtered);
        }

        function setFilter(category, element) {
            currentFilter = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.filter-tag').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            filterData();
        }

        // 5. Modal è©³æƒ…é‚è¼¯
        function openDetail(item) {
            const modal = document.getElementById('detail-modal');
            
            // å¡«å…¥æ¨™é¡Œ
            document.getElementById('modal-title').innerText = item.name_ch;
            document.getElementById('modal-subtitle').innerText = item.name_en;

            // å¡«å…¥åŸºæœ¬è¡¨
            document.getElementById('modal-origin').innerText = item.origin || "-";
            document.getElementById('modal-family').innerText = `${item.family_ch || ""} (${item.family_en || ""})`;
            document.getElementById('modal-part').innerText = `${item.part_ch || ""} (${item.part_en || ""})`;

            // å¡«å…¥æ¨™ç±¤é›² (åˆ¥å + åˆ†é¡)
            const tagContainer = document.getElementById('modal-tags');
            tagContainer.innerHTML = "";
            [item.category_main, ...(item.aliases || [])].forEach(tagText => {
                if(tagText) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerText = tagText;
                    tagContainer.appendChild(tag);
                }
            });

            // å¡«å…¥æˆåˆ†ç¶²æ ¼
            const chemGrid = document.getElementById('modal-chem-grid');
            chemGrid.innerHTML = "";
            if (item.components && item.components.length > 0) {
                item.components.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'chem-item';
                    // å¦‚æœæœ‰åœ–é¡¯ç¤ºåœ–ï¼Œæ²’åœ–é¡¯ç¤º placeholder
                    const imgSrc = c.image || 'https://via.placeholder.com/150x100?text=No+Structure';
                    div.innerHTML = `
                        <img src="${imgSrc}" alt="${c.name}" onclick="window.open('${imgSrc}')" style="cursor:zoom-in">
                        <div class="chem-name">${c.name}</div>
                    `;
                    chemGrid.appendChild(div);
                });
            } else {
                chemGrid.innerHTML = "<span style='color:#999'>ç„¡æˆåˆ†è³‡æ–™</span>";
            }

            // å¡«å…¥æ–‡å­—å€å¡Š
            document.getElementById('modal-char').innerText = item.characteristics || "æš«ç„¡";
            document.getElementById('modal-efficacy').innerText = item.efficacy || "æš«ç„¡";
            document.getElementById('modal-treat').innerText = item.treatment || "-";
            document.getElementById('modal-mnemonic').innerText = item.mnemonic || "-";

            // å¡«å…¥æ¯”è¼ƒè¡¨
            const compBody = document.getElementById('modal-compare-body');
            compBody.innerHTML = "";
            if (item.comparisons && item.comparisons.length > 0) {
                item.comparisons.forEach(cmp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${cmp.target}</td><td>${cmp.diff}</td>`;
                    compBody.appendChild(tr);
                });
                document.getElementById('compare-section').style.display = 'block';
            } else {
                document.getElementById('compare-section').style.display = 'none';
            }

            // å¡«å…¥ Rich Note (HTML)
            document.getElementById('modal-note').innerHTML = item.note || "<p style='color:#ccc'>ç„¡è©³ç´°ç­†è¨˜</p>";

            // é¡¯ç¤º Modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»¾å‹•
        }

        function closeModalDirect() {
            document.getElementById('detail-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeModal(event) {
            if (event.target.id === 'detail-modal') {
                closeModalDirect();
            }
        }
    </script>
</body>
</html>
