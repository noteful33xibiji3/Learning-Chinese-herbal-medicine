<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸ | æœ¬è‰å­¸åœ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
   <style>
    /* === 1. å…¨å±€è®Šæ•¸èˆ‡åŸºç¤è¨­å®š === */
    :root {
        --primary: #4A7C59;
        --primary-dark: #2C5E4F;
        --accent: #E8F5E9;
        --text-dark: #333;
        --text-light: #666;
        --bg-color: #f4f7f6;
        /* æ›´ç´°è†©çš„é™°å½±ç³»çµ± */
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --card-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; }

    body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        color: var(--text-dark);
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* ç¢ºä¿ footer ç½®åº• */
    }

    /* === 2. å°è¦½åˆ— (ç»ç’ƒæ“¬æ…‹) === */
    nav {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 0.8rem 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        transition: 0.3s;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-dark); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-links a { 
        text-decoration: none; color: var(--text-light); margin-left: 20px; font-weight: 500; transition: 0.2s; position: relative;
    }
    .nav-links a:hover, .nav-links a.active { color: var(--primary); }
    /* é€£çµä¸‹åŠƒç·šå‹•ç•« */
    .nav-links a::after {
        content: ''; position: absolute; width: 0; height: 2px; bottom: -4px; left: 0;
        background: var(--primary); transition: width 0.3s;
    }
    .nav-links a:hover::after { width: 100%; }

    /* === 3. æœå°‹èˆ‡ç¯©é¸å€ (Hero Section) === */
    .hero-section {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        padding: 4rem 1rem 5rem 1rem; /* åº•éƒ¨ç•™ç™½çµ¦å¡ç‰‡ä¸Šæµ® */
        text-align: center;
        color: white;
        margin-bottom: -40px; /* è®“å…§å®¹å€å¾€ä¸Šè“‹ */
        border-radius: 0 0 30px 30px;
    }
    .hero-title { font-size: 2.2rem; margin-bottom: 1.5rem; font-weight: 300; letter-spacing: 1px; }
    
    .search-container {
        max-width: 800px; margin: 0 auto; position: relative;
    }
    .search-box {
        width: 100%; padding: 15px 25px;
        border-radius: 50px; border: none;
        font-size: 1.1rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        outline: none; transition: transform 0.2s;
    }
    .search-box:focus { transform: scale(1.02); }
    
    .filter-tags {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
        margin-top: 25px; max-width: 1000px; margin-left: auto; margin-right: auto;
    }
    .filter-tag {
        background: rgba(255,255,255,0.15); color: white;
        padding: 8px 18px; border-radius: 20px;
        cursor: pointer; transition: 0.2s;
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 0.95rem; backdrop-filter: blur(5px);
    }
    .filter-tag:hover, .filter-tag.active {
        background: white; color: var(--primary-dark); font-weight: bold; transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* === 4. å¡ç‰‡ç¶²æ ¼å€ === */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 50px 20px; position: relative; z-index: 10; }
    
    /* æ¬¡ç´šç¯©é¸å€ */
    #sub-filter-container { 
        display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; 
        background: white; padding: 15px; border-radius: 12px; box-shadow: var(--card-shadow);
        justify-content: center;
    }
    .sub-tag {
        background: white; color: #666; padding: 6px 16px; border-radius: 20px;
        cursor: pointer; border: 1px solid #ddd; font-size: 0.9rem; transition: 0.2s;
    }
    .sub-tag:hover { border-color: var(--primary); color: var(--primary); }
    .sub-tag.active { 
        background: var(--accent); color: var(--primary-dark); border-color: var(--primary); font-weight: bold; 
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
    }

    /* === 5. è—¥æå¡ç‰‡ (æ•ˆèƒ½å„ªåŒ–) === */
    .card {
        background: white; border-radius: 16px; overflow: hidden;
        box-shadow: var(--card-shadow); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative; cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
        display: flex; flex-direction: column;
        /* â˜… è¨˜æ†¶é«”å„ªåŒ–ï¼šåªæ¸²æŸ“å¯è¦‹å€åŸŸ */
        content-visibility: auto; contain-intrinsic-size: 0 250px;
    }
    .card:hover { 
        transform: translateY(-8px); 
        box-shadow: var(--card-hover); 
        border-color: var(--primary); 
    }
    /* å·¦å´è£é£¾æ¢ */
    .card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; 
        background: var(--primary); transition: width 0.2s;
    }
    .card:hover::before { width: 8px; }

    .card-body { padding: 25px 20px 20px 25px; flex: 1; }
    
    .card-category {
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
        color: var(--primary); font-weight: 700; margin-bottom: 5px;
        background: var(--accent); display: inline-block; padding: 2px 8px; border-radius: 4px;
    }
    
    .card-title { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); margin: 5px 0 0 0; line-height: 1.2; }
    .card-subtitle { font-size: 0.95rem; color: #888; font-family: 'Roboto Mono', monospace; margin-bottom: 15px; font-style: italic; }

    .info-row {
        display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 8px;
        color: var(--text-light); border-bottom: 1px dashed #eee; padding-bottom: 4px;
    }
    .info-label { font-weight: 600; color: #555; }

    .card-footer {
        padding: 12px 20px; background: #fafafa; border-top: 1px solid #eee;
        text-align: right; font-size: 0.85rem; color: var(--primary); font-weight: bold;
        transition: 0.2s;
    }
    .card:hover .card-footer { background: var(--primary); color: white; }

    /* === 6. è©³æƒ…èˆ‡åˆ†é¡å½ˆçª— (Modals) === */
    .modal-overlay, .chem-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.75); /* æ·±è‰²èƒŒæ™¯ */
        backdrop-filter: blur(5px);
        z-index: 1000; display: none; justify-content: center; align-items: center;
        padding: 20px;
    }
    /* æˆåˆ†å½ˆçª—å±¤ç´šæ›´é«˜ */
    .chem-modal-overlay { z-index: 2000; background: rgba(0,0,0,0.6); }
    
    .modal-content {
        background: white; width: 100%; max-width: 900px; max-height: 90vh;
        border-radius: 20px; overflow-y: auto; position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .chem-modal-box {
        background: white; width: 100%; max-width: 350px;
        padding: 30px; border-radius: 16px; text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* å½ˆè·³æ•ˆæœ */
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .modal-header {
        background: var(--primary); color: white; padding: 20px 30px;
        position: sticky; top: 0; z-index: 10;
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title-group h2 { margin: 0; font-size: 1.8rem; }
    .modal-title-group span { font-family: 'Roboto Mono', monospace; opacity: 0.9; }
    .close-btn { background: none; border: none; color: white; font-size: 2rem; cursor: pointer; opacity: 0.8; transition: 0.2s; }
    .close-btn:hover { opacity: 1; transform: scale(1.1); }

    .modal-body { padding: 30px; color: #333; }

    /* è©³æƒ…å…§æ–‡æ’ç‰ˆ */
    .section-title {
        font-size: 1.2rem; font-weight: bold; color: var(--primary-dark);
        border-bottom: 2px solid var(--accent); padding-bottom: 8px; margin: 25px 0 15px;
        display: flex; align-items: center; gap: 8px;
    }
    .section-title:first-child { margin-top: 0; }

    .tag-cloud { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .tag { background: var(--accent); color: var(--primary-dark); padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; }

    /* æˆåˆ†ç¶²æ ¼ */
    .chem-grid { 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; 
    }
    .chem-item { 
        text-align: center; border: 1px solid #eee; padding: 15px 10px; border-radius: 12px;
        transition: 0.2s; background: #fff; cursor: pointer;
    }
    .chem-item:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-3px); }
    .chem-item img { max-width: 100%; max-height: 100px; object-fit: contain; margin-bottom: 8px; }
    .chem-name { font-size: 0.95rem; font-weight: bold; color: #444; }

    /* æ¯”è¼ƒè¡¨æ ¼ */
    .compare-table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; }
    .compare-table th, .compare-table td { border: 1px solid #eee; padding: 12px; text-align: left; }
    .compare-table th { background: var(--accent); color: var(--primary-dark); width: 30%; font-weight: bold; }

    /* Rich Text (HTML å…§å®¹) å„ªåŒ– */
    .rich-content { text-align: left; color: #333 !important; font-size: 1.05rem; line-height: 1.8; }
    .rich-content img { display: block; margin: 15px auto; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .rich-content ul, .rich-content ol { margin-left: 20px; padding-left: 0; }
    .rich-content table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .rich-content th, .rich-content td { border: 1px solid #ddd; padding: 10px; }
    .rich-content th { background-color: #f9f9f9; }

    /* æˆåˆ†å°è¦–çª—æ¨£å¼ */
    .chem-detail-img { max-width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 15px; }
    .chem-detail-note { 
        background: #fff3e0; color: #d32f2f; padding: 12px; border-radius: 8px; 
        margin-top: 10px; font-size: 0.95rem; text-align: left;
    }

    /* === 7. æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– === */
    @media (max-width: 768px) {
        nav { padding: 10px 15px; flex-wrap: wrap; }
        .logo { width: 100%; justify-content: center; margin-bottom: 10px; }
        .nav-links { width: 100%; justify-content: space-around; padding-top: 10px; border-top: 1px solid #eee; }
        .nav-links a { margin: 0; font-size: 0.9rem; }

        .hero-title { font-size: 1.6rem; }
        .filter-tags { justify-content: flex-start; overflow-x: auto; padding-bottom: 10px; white-space: nowrap; } /* æ¨™ç±¤å¯æ©«å‘æ»‘å‹• */
        
        .container { padding: 10px; margin-top: 10px; }
        .grid { grid-template-columns: 1fr; gap: 15px; } /* æ‰‹æ©Ÿè½‰å–®æ¬„ */

        /* å¡ç‰‡ç¶­æŒç›´å¼ï¼Œä½†èª¿æ•´ padding */
        .card-body { padding: 20px; }
        
        .modal-content { max-height: 85vh; width: 95%; }
        .chem-modal-box { width: 90%; }
    }
</style>
</head>
<body>

    <nav>
        <a href="index.html" class="logo">ğŸŒ¿ æœ¬è‰å­¸åœ’</a>
        <div class="nav-links">
            <a href="index.html">ä¸­è—¥åº«</a>
            <a href="pharmacognosy.html">ç”Ÿè—¥åº«</a>
            <a href="quiz.html">è‡ªæˆ‘æ¸¬é©—</a>
            <a href="admin_menu.html">å¾Œå°ç®¡ç†</a>
        </div>
    </nav>

    <div class="hero-section">
        <h1 class="hero-title">ç”Ÿè—¥å­¸æ•¸ä½è—¥å…¸</h1>
        <div class="search-container">
            <input type="text" id="search-input" class="search-box" placeholder="ğŸ” æœå°‹ç”Ÿè—¥åç¨±ã€å­¸åã€é—œéµæˆåˆ†..." oninput="filterData()">
        </div>
        <div id="filter-container" class="filter-tags">
        <div class="filter-tag active" onclick="resetFilter(this)">å…¨éƒ¨</div>
    </div>

    <div id="sub-filter-container" class="filter-tags" style="margin-top:10px; min-height:10px;"></div>

    <div style="text-align:center; margin: 15px 0; height: 40px;">
        <button id="btn-cat-info" onclick="openCategoryModal()" style="display:none; background: linear-gradient(135deg, #4A7C59, #2C5E4F); color:white; border:none; padding:10px 25px; border-radius:30px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition:0.3s; align-items:center; gap:8px;">
            ğŸ“– æŸ¥çœ‹ã€Œ<span id="current-cat-name"></span>ã€è©³ç´°ä»‹ç´¹
        </button>
    </div>

    <div id="cat-modal" class="modal-overlay" onclick="closeCategoryModal(event)">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h2 id="cat-modal-title" style="margin:0;">åˆ†é¡ä»‹ç´¹</h2>
                <button onclick="document.getElementById('cat-modal').style.display='none'" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer;">Ã—</button>
            </div>
            <div class="modal-body rich-content" id="cat-modal-body" style="line-height:1.8; font-size:1.05rem;">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px; color:#888;">
            <h2>â³ æ­£åœ¨è¼‰å…¥ç”Ÿè—¥è³‡æ–™åº«...</h2>
        </div>
        
        <div id="pharma-grid" class="grid"></div>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h2 id="modal-title">éº»é»ƒ</h2>
                    <span id="modal-subtitle">Ephedra</span>
                </div>
                <button class="close-btn" onclick="closeModalDirect()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tag-cloud" id="modal-tags"></div>
                
                <div class="detail-section">
                    <div class="section-title">ğŸ“Œ åŸºæœ¬è³‡è¨Š</div>
                    <table class="compare-table">
                        <tr><th>åŸºåŸ (Origin)</th><td id="modal-origin"></td></tr>
                        <tr><th>ç§‘åˆ¥ (Family)</th><td id="modal-family"></td></tr>
                        <tr><th>ä½¿ç”¨éƒ¨ä½ (Part)</th><td id="modal-part"></td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">âš—ï¸ åŒ–å­¸æˆåˆ† (Components)</div>
                    <div id="modal-chem-grid" class="chem-grid"></div>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ’¡ ç‰¹æ€§èˆ‡åŠŸæ•ˆ</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div>
                            <strong>æ€§ç‹€/ç‰¹æ€§ï¼š</strong>
                            <p id="modal-char" style="color:#555;"></p>
                        </div>
                        <div>
                            <strong>åŠŸæ•ˆï¼š</strong>
                            <p id="modal-efficacy" style="color:#555;"></p>
                        </div>
                    </div>
                </div>

                <div class="detail-section" style="background:#fff3e0; padding:15px; border-radius:10px;">
                    <strong>ğŸ’Š æ²»ç™‚/é©æ‡‰ç—‡ï¼š</strong> <span id="modal-treat"></span><br><br>
                    <strong>ğŸ§  è¨˜æ³•/å£è¨£ï¼š</strong> <span id="modal-mnemonic" style="color:#d32f2f; font-weight:bold;"></span>
                </div>

                <div class="detail-section" id="compare-section">
                    <div class="section-title">âš–ï¸ æ˜“æ··æ·†æ¯”è¼ƒ</div>
                    <table class="compare-table">
                        <thead><tr><th>æ¯”è¼ƒå°è±¡</th><th>å·®ç•°é»</th></tr></thead>
                        <tbody id="modal-compare-body"></tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="section-title">ğŸ“ è©³ç´°ç­†è¨˜</div>
                    <div id="modal-note" class="rich-content"></div>
                </div>
            </div>
        </div>
    </div>
<div id="chem-detail-modal" class="chem-modal-overlay" onclick="closeChemModal()">
        <div class="chem-modal-box" onclick="event.stopPropagation()">
            <div style="text-align:right;">
                <button onclick="closeChemModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">Ã—</button>
            </div>
            
            <h3 id="chem-popup-name" style="margin-top:0; color:#4A7C59;">æˆåˆ†åç¨±</h3>
            
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px;">
                <img id="chem-popup-img" src="" style="max-width:100%; max-height:250px; object-fit:contain;">
            </div>

            <div id="chem-popup-note-box" style="display:none; background:#fff3e0; padding:15px; border-radius:10px; text-align:left; border-left:5px solid #ff9800;">
                <strong style="color:#e65100;">ğŸ“ å‚™è¨»ï¼š</strong>
               <div id="chem-popup-note" class="rich-content" style="color:#333; margin-top:5px; font-size:0.95rem;"></div>
            </div>
        </div>
    </div>

</div>
    <footer style="background: #333; color: #ccc; padding: 40px 20px; text-align: center; font-size: 0.9rem; margin-top: 50px;">
        <div style="max-width: 800px; margin: 0 auto; line-height: 1.8;">
            
            <div style="font-weight: bold; font-size: 1.1rem; color: #fff; margin-bottom: 15px;">
                <span id="footer-year"></span> Â© æœ¬è‰å­¸åœ’ (Pharma Garden)
            </div>

            <p style="margin-bottom: 20px;">
                æœ¬ç¶²ç«™å…§å®¹ç”±å­¸ç”Ÿç·´ç¿’è£½ä½œï¼Œ<br>
                <strong>åƒ…ä¾›å­¸è¡“äº¤æµã€åœ‹è€ƒè¤‡ç¿’èˆ‡æ•™è‚²ç”¨é€”ä½¿ç”¨</strong>ã€‚
            </p>

            <hr style="border: 0; border-top: 1px solid #555; margin: 20px 0;">

            <div style="text-align: left; font-size: 0.85rem; color: #aaa;">
                <p style="color: #ddd; margin-bottom: 8px;"><strong>âš ï¸ å…è²¬èˆ‡è‘—ä½œæ¬Šè²æ˜ï¼š</strong></p>
                <ul style="padding-left: 20px; margin: 0;">
                    <li><strong>è³‡æ–™ä¾†æºï¼š</strong>å…§å®¹å½™æ•´è‡ªè—¥å­¸æ•™ç§‘æ›¸ã€å­¸è¡“è¬›ç¾©åŠç¶²è·¯å…¬é–‹è³‡è¨Šï¼Œè‘—ä½œæ¬Šæ­¸åŸä½œè€…æ‰€æœ‰ã€‚</li>
                    <li><strong>åœ–ç‰‡ä¾†æºï¼š</strong>åŒ–å­¸çµæ§‹åœ–èˆ‡æ¤ç‰©åœ–ç‰‡å¼•ç”¨è‡ª <strong>Wikimedia Commons</strong> åŠå…¬æœ‰é ˜åŸŸè³‡æºï¼Œåƒ…ä½œæ•™å­¸ç¤ºæ„ã€‚</li>
                    <li><strong>éé†«ç™‚å»ºè­°ï¼š</strong>æœ¬ç«™è³‡è¨Šåƒ…ä¾›å­¸ç¿’åƒè€ƒï¼Œä¸æ§‹æˆé†«ç™‚å»ºè­°æˆ–è¨ºæ–·ï¼Œç”¨è—¥å•é¡Œè«‹è«®è©¢å°ˆæ¥­é†«å¸«è—¥å¸«ã€‚</li>
                </ul>
            </div>

            <div style="margin-top: 30px; font-size: 0.8rem; color: #666;">
                Designed with â¤ï¸ by Pharmacy Student Lucas
            </div>
        </div>
    </footer>

    <script>
        document.getElementById('footer-year').innerText = new Date().getFullYear();
    </script>
    <script src="pharma_config.js"></script>
<script>
    // === å…¨åŸŸè®Šæ•¸ ===
    let allData = [];
    let categoryData = {}; 
    let currentMainCat = 'all'; // ç›®å‰é¸çš„å¤§åˆ†é¡
    let currentSubCat = '';     // ç›®å‰é¸çš„ä¸­åˆ†é¡

    // === 1. åˆå§‹åŒ–èˆ‡è³‡æ–™è¼‰å…¥ ===
    document.addEventListener('DOMContentLoaded', () => {
         // æ›´æ–°é å°¾å¹´ä»½
            document.getElementById('footer-year').innerText = new Date().getFullYear();
        initFilters();
        
        // ä½¿ç”¨ Promise.all åŒæ™‚è¼‰å…¥å…©ä»½è³‡æ–™
        Promise.all([
            // A. è¼‰å…¥ç”Ÿè—¥åˆ—è¡¨ (â˜… åŠ å…¥æ™‚é–“æˆ³è¨˜ï¼Œé¿å…å¿«å–)
            fetch('data/pharma.json?t=' + Date.now()).then(r => r.ok ? r.json() : []).then(json => {
                if (json.content && json.encoding === 'base64') {
                    return JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                }
                return json;
            }),
            // B. è¼‰å…¥åˆ†é¡ä»‹ç´¹ (â˜… åŠ å…¥æ™‚é–“æˆ³è¨˜ï¼Œè§£æ±ºå¾Œå°æ›´æ–°å‰å°çœ‹ä¸åˆ°çš„å•é¡Œ)
            fetch('data/categories.json?t=' + Date.now()).then(r => r.ok ? r.json() : {}).then(json => {
                if (json.content && json.encoding === 'base64') {
                    return JSON.parse(decodeURIComponent(escape(window.atob(json.content))));
                }
                return json;
            }).catch(() => ({})) 
        ]).then(([pharmaList, catInfo]) => {
            // è³‡æ–™è¼‰å…¥å®Œæˆ
            allData = pharmaList || [];
            categoryData = catInfo || {};
            
            document.getElementById('loading').style.display = 'none';
            renderGrid(allData);

            // C. æª¢æŸ¥ç¶²å€åƒæ•¸ (ä¸­è—¥åº«è·³è½‰é‚è¼¯)
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            
            if (query) {
                const input = document.getElementById('search-input');
                input.value = query;
                filterData(); // åŸ·è¡Œæœå°‹

                // å¦‚æœç²¾ç¢ºåŒ¹é…åˆ°åªæœ‰ä¸€ç­†ï¼Œè‡ªå‹•é»é–‹è©³æƒ…
                const filtered = allData.filter(item => 
                    (item.name_en||"").toLowerCase().includes(query.toLowerCase()) || 
                    (item.components||[]).some(c => c.name.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filtered.length === 1) {
                    openDetail(filtered[0]);
                }
            }
        }).catch(err => {
            console.error("è³‡æ–™è¼‰å…¥éŒ¯èª¤:", err);
            document.getElementById('loading').innerHTML = "<p>è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub è¨­å®šã€‚</p>";
        });
    });

    // === 2. åˆ†é¡ç¯©é¸é‚è¼¯ (é›™å±¤é¸å–®æ ¸å¿ƒ) ===

    // åˆå§‹åŒ–ï¼šåªç”¢ç”Ÿå¤§åˆ†é¡æŒ‰éˆ•
   function initFilters() {
        const container = document.getElementById('filter-container');
        // æ¸…ç©ºä¸¦åŠ å…¥"å…¨éƒ¨"
        container.innerHTML = '<div class="filter-tag active" onclick="resetFilter(this)">å…¨éƒ¨ (All)</div>';
        
        if (typeof PHARMA_CATEGORIES !== 'undefined') {
            PHARMA_CATEGORIES.forEach(cat => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                
                // â˜… ä¿®æ”¹é»ï¼šé¡¯ç¤º "ä¸­æ–‡ (è‹±æ–‡)"
                tag.innerText = `${cat.name_ch} (${cat.name_en})`; 
                
                // é»æ“Šæ™‚å‚³å…¥åŸæœ¬çš„ä¸­æ–‡ key å³å¯
                tag.onclick = () => selectMainCategory(cat.name_ch, tag);
                container.appendChild(tag);
            });
        }
    }

    // é»æ“Šã€Œå…¨éƒ¨ã€
    function resetFilter(el) {
        currentMainCat = 'all';
        currentSubCat = '';
        updateActiveTag(el, 'filter-tag');
        document.getElementById('sub-filter-container').innerHTML = ""; // æ¸…ç©ºå­åˆ†é¡
        checkIntroButton();
        filterData();
    }

    // é»æ“Šã€Œå¤§åˆ†é¡ã€
    function selectMainCategory(mainCatName, el) {
        currentMainCat = mainCatName;
        currentSubCat = ''; // é‡ç½®å­åˆ†é¡
        updateActiveTag(el, 'filter-tag');

        // ç”¢ç”Ÿå­åˆ†é¡æŒ‰éˆ•
        renderSubCategories(mainCatName);
        
        checkIntroButton(); // æª¢æŸ¥æ˜¯å¦æœ‰ä»‹ç´¹æ–‡
        filterData();
    }

    // ç”¢ç”Ÿå­åˆ†é¡æŒ‰éˆ• UI
   function renderSubCategories(mainName) {
        const container = document.getElementById('sub-filter-container');
        container.innerHTML = ""; 

        // å¾ config æ‰¾è©²åˆ†é¡çš„å­åˆ†é¡
        const catConfig = PHARMA_CATEGORIES.find(c => c.name_ch === mainName);
        
        if (catConfig && catConfig.subcategories) {
            catConfig.subcategories.forEach(sub => {
                const btn = document.createElement('div');
                btn.className = 'sub-tag';
                
                // â˜… ä¿®æ”¹é»ï¼šé¡¯ç¤º "ä¸­æ–‡ (è‹±æ–‡)"
                btn.innerText = `${sub.ch} (${sub.en})`; 
                
                // é»æ“Šæ™‚å‚³å…¥åŸæœ¬çš„ä¸­æ–‡ key
                btn.onclick = () => selectSubCategory(sub.ch, btn);
                container.appendChild(btn);
            });
        }
    }

    // é»æ“Šã€Œä¸­åˆ†é¡ã€
    function selectSubCategory(subName, el) {
        currentSubCat = subName;
        updateActiveTag(el, 'sub-tag');
        
        checkIntroButton(); 
        filterData();
    }

    // æª¢æŸ¥ä¸¦é¡¯ç¤ºã€ŒğŸ“– æŸ¥çœ‹ä»‹ç´¹ã€æŒ‰éˆ• (â˜… é€™è£¡ä¿®å¾©äº†æŒ‰éˆ•äº‚è·‘çš„å•é¡Œ)
   // === ä¿®æ­£ç‰ˆï¼šæª¢æŸ¥ä¸¦é¡¯ç¤ºä»‹ç´¹æŒ‰éˆ• (å¤§åˆ†é¡/ä¸­åˆ†é¡é€šåƒ) ===
    function checkIntroButton() {
        const btnInfo = document.getElementById('btn-cat-info');
        const spanName = document.getElementById('current-cat-name');
        
        // 1. æ±ºå®šç›®æ¨™ï¼š
        // å¦‚æœæœ‰é¸ä¸­åˆ†é¡ (currentSubCat)ï¼Œç›®æ¨™å°±æ˜¯ä¸­åˆ†é¡
        // å¦‚æœæ²’é¸ä¸­åˆ†é¡ï¼Œä½†æœ‰é¸å¤§åˆ†é¡ (currentMainCat)ï¼Œç›®æ¨™å°±æ˜¯å¤§åˆ†é¡
        let targetKey = '';
        
        if (currentSubCat) {
            targetKey = currentSubCat;
        } else if (currentMainCat !== 'all') {
            targetKey = currentMainCat;
        }
        
        // å¦‚æœé‚„æ˜¯æ²’ç›®æ¨™ (ä¾‹å¦‚é¸å…¨éƒ¨)ï¼Œå°±éš±è—æŒ‰éˆ•
        if (!targetKey) {
            btnInfo.style.display = 'none';
            return;
        }

        // 2. æ¯”å°è³‡æ–™åº« (æ¨¡ç³Šæ¯”å°ï¼Œè§£æ±ºæ‹¬è™Ÿå•é¡Œ)
        // é‚è¼¯ï¼šè³‡æ–™åº«çš„ Key å¿…é ˆåŒ…å« targetKey
        // ä¾‹å¦‚ï¼šé¸ã€Œé…ç³–é«”ã€ï¼Œå¯ä»¥å°æ‡‰åˆ°ã€Œé…ç³–é«” (Glycoside)ã€
        const matchKey = Object.keys(categoryData).find(k => k.includes(targetKey));

        // 3. é¡¯ç¤ºæŒ‰éˆ•
        if (matchKey && categoryData[matchKey]) {
            // æŒ‰éˆ•ä¸Šé¡¯ç¤ºæˆ‘å€‘çœŸæ­£æ‰¾åˆ°çš„é‚£å€‹æ¨™é¡Œ (ä¾‹å¦‚ "é…ç³–é«” (Glycoside)")
            spanName.innerText = matchKey; 
            btnInfo.style.display = 'inline-flex';
            btnInfo.dataset.realKey = matchKey; // ç¶å®šçœŸå¯¦ Key ä¾›å½ˆçª—ä½¿ç”¨
        } else {
            btnInfo.style.display = 'none';
        }
    }

    // === 3. åŸ·è¡Œç¯©é¸èˆ‡æ¸²æŸ“ (è¶…ç´šæœå°‹ç‰ˆ) ===
    function filterData() {
        // å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„é—œéµå­—ï¼Œä¸¦è½‰å°å¯« (ç‚ºäº†ä¸åˆ†å¤§å°å¯«)
        const term = document.getElementById('search-input').value.toLowerCase().trim();
        
        const filtered = allData.filter(item => {
            // === A. æ™ºæ…§æœå°‹é‚è¼¯ (åªè¦ç¬¦åˆå…¶ä¸­ä¸€é …å°±ç®—æ•¸) ===
            const matchText = 
                // 1. ä¸­æ–‡å
                (item.name_ch || "").includes(term) || 
                // 2. è‹±æ–‡å (è½‰å°å¯«æ¯”å°)
                (item.name_en || "").toLowerCase().includes(term) ||
                // 3. åŸºåŸ/å­¸å
                (item.origin || "").toLowerCase().includes(term) ||
                // 4. â˜… æˆåˆ† (æƒæé™£åˆ—ä¸­çš„æ¯ä¸€å€‹æˆåˆ†å)
                (item.components || []).some(c => c.name.toLowerCase().includes(term)) ||
                // 5. â˜… [æ–°å¢] ç§‘å (ä¸­æ–‡æˆ–è‹±æ–‡)
                (item.family_ch || "").includes(term) ||
                (item.family_en || "").toLowerCase().includes(term) ||
                // 6. â˜… [æ–°å¢] åŠŸæ•ˆ/é©æ‡‰ç—‡ (ä¾‹å¦‚æœ "æ­¢ç—›")
                (item.efficacy || "").includes(term) ||
                // 7. â˜… [æ–°å¢] åˆ¥å (æƒæåˆ¥åé™£åˆ—)
                (item.aliases || []).some(a => a.includes(term));
            
            // === B. åˆ†é¡ç¯©é¸é‚è¼¯ (ä¸è®Š) ===
            let matchCat = true;
            if (currentMainCat !== 'all') {
                matchCat = (item.category_main || "").includes(currentMainCat);
                if (currentSubCat) {
                    matchCat = matchCat && (item.category_sub || "").includes(currentSubCat);
                }
            }

            // å…©å€‹æ¢ä»¶éƒ½è¦ç¬¦åˆ (æ–‡å­—æœ‰å°åˆ° AND åˆ†é¡æœ‰å°åˆ°)
            return matchText && matchCat;
        });

        renderGrid(filtered);
    }
    // 3. æ¸²æŸ“å¡ç‰‡ç¶²æ ¼ (å·²ä¿®æ”¹ï¼šç›´æ¥é¡¯ç¤ºæˆåˆ†åç¨±)
    function renderGrid(data) {
        const grid = document.getElementById('pharma-grid');
        grid.innerHTML = "";

        if (data.length === 0) {
            grid.innerHTML = "<p style='text-align:center; width:100%; grid-column:1/-1;'>æ‰¾ä¸åˆ°ç›¸é—œè—¥æ</p>";
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openDetail(item);
            
            const family = item.family_ch || item.family_en || "æœªåˆ†é¡";
            const part = item.part_ch || "-";

            // â˜… ä¿®æ”¹é‡é»ï¼šè™•ç†æˆåˆ†åç¨±
            let compText = "ç„¡";
            if (item.components && item.components.length > 0) {
                // æŠŠæ‰€æœ‰æˆåˆ†çš„åå­—æŠ“å‡ºä¾†ï¼Œç”¨é “è™Ÿä¸²æ¥
                // ä¾‹å¦‚ï¼š "Morphineã€Codeineã€Thebaine"
                compText = item.components.map(c => c.name).join('ã€');
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="card-category">${item.category_main} / ${item.category_sub || ""}</div>
                    <h3 class="card-title">${item.name_ch}</h3>
                    <div class="card-subtitle">${item.name_en}</div>
                    
                    <div class="info-row">
                        <span class="info-label">ç§‘åˆ¥</span> <span>${family}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">éƒ¨ä½</span> <span>${part}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æˆåˆ†</span> 
                        <span style="display:inline-block; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:bottom;" title="${compText}">
                            ${compText}
                        </span>
                    </div>
                </div>
                <div class="card-footer">æŸ¥çœ‹è©³æƒ… â”</div>
            `;
            grid.appendChild(card);
        });
    }
    // === 4. ç”Ÿè—¥è©³æƒ… Modal ===
    function openDetail(item) {
        const modal = document.getElementById('detail-modal');
        
        document.getElementById('modal-title').innerText = item.name_ch;
        document.getElementById('modal-subtitle').innerText = item.name_en;
        document.getElementById('modal-origin').innerText = item.origin || "-";
        document.getElementById('modal-family').innerText = `${item.family_ch || ""} (${item.family_en || ""})`;
        document.getElementById('modal-part').innerText = `${item.part_ch || ""} (${item.part_en || ""})`;

        // æ¨™ç±¤é›²
        const tagContainer = document.getElementById('modal-tags');
        tagContainer.innerHTML = "";
        [item.category_main, ...(item.aliases || [])].forEach(tagText => {
            if(tagText) {
                const tag = document.createElement('span');
                tag.className = 'tag'; tag.innerText = tagText;
                tagContainer.appendChild(tag);
            }
        });

        // æˆåˆ†ç¶²æ ¼ (é»æ“Šé–‹å•Ÿå°è¦–çª—)
        const chemGrid = document.getElementById('modal-chem-grid');
        chemGrid.innerHTML = "";
        if (item.components && item.components.length > 0) {
            item.components.forEach(c => {
                const div = document.createElement('div');
                div.className = 'chem-item';
                div.style.cursor = "pointer"; 
                
                // é»æ“Šå‘¼å« showChemDetail
                div.onclick = () => showChemDetail(c);

                const imgSrc = c.image || 'https://via.placeholder.com/150x100?text=No+Structure';
                div.innerHTML = `
                    <img src="${imgSrc}" alt="${c.name}">
                    <div class="chem-name">${c.name}</div>
                    ${c.note ? '<span style="font-size:0.8rem; color:#ff9800;">(æœ‰å‚™è¨»)</span>' : ''}
                `;
                chemGrid.appendChild(div);
            });
        } else {
            chemGrid.innerHTML = "<span style='color:#999'>ç„¡æˆåˆ†è³‡æ–™</span>";
        }

        // æ–‡å­—å€å¡Š
        document.getElementById('modal-char').innerText = item.characteristics || "æš«ç„¡";
        document.getElementById('modal-efficacy').innerText = item.efficacy || "æš«ç„¡";
        document.getElementById('modal-treat').innerText = item.treatment || "-";
        document.getElementById('modal-mnemonic').innerText = item.mnemonic || "-";

        // æ¯”è¼ƒè¡¨
        const compBody = document.getElementById('modal-compare-body');
        compBody.innerHTML = "";
        if (item.comparisons && item.comparisons.length > 0) {
            item.comparisons.forEach(cmp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${cmp.target}</td><td>${cmp.diff}</td>`;
                compBody.appendChild(tr);
            });
            document.getElementById('compare-section').style.display = 'block';
        } else {
            document.getElementById('compare-section').style.display = 'none';
        }

        // ç­†è¨˜
        document.getElementById('modal-note').innerHTML = item.note || "<p style='color:#ccc'>ç„¡è©³ç´°ç­†è¨˜</p>";

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModalDirect() {
        document.getElementById('detail-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    function closeModal(event) {
        if (event.target.id === 'detail-modal') closeModalDirect();
    }

    // === 5. æˆåˆ†è©³æƒ…å°è¦–çª— (Popup) - ä¿®æ­£ç‰ˆ ===
    function showChemDetail(c) {
        // å¡«å…¥åå­—
        document.getElementById('chem-popup-name').innerText = c.name;
        
        // å¡«å…¥åœ–ç‰‡
        const img = document.getElementById('chem-popup-img');
        img.src = c.image || 'https://via.placeholder.com/300x200?text=No+Image';
        
        // å¡«å…¥å‚™è¨»
        const noteBox = document.getElementById('chem-popup-note-box');
        const noteContent = document.getElementById('chem-popup-note');

        if (c.note && c.note.trim() !== "") {
            // â˜… é—œéµä¿®æ”¹ï¼šé€™è£¡æ”¹æˆ innerHTMLï¼Œç€è¦½å™¨æ‰æœƒæŠŠ <ul> è®Šæˆåˆ—è¡¨ï¼Œè€Œä¸æ˜¯é¡¯ç¤ºæ–‡å­—
            noteContent.innerHTML = c.note; 
            noteBox.style.display = 'block';
        } else {
            noteBox.style.display = 'none';
        }

        // é¡¯ç¤ºå½ˆçª—
        document.getElementById('chem-detail-modal').style.display = 'flex';
    }

    function closeChemModal() {
        document.getElementById('chem-detail-modal').style.display = 'none';
    }

    // === 6. åˆ†é¡ä»‹ç´¹è¦–çª— (Intro Modal) ===
    function openCategoryModal() {
        const btn = document.getElementById('btn-cat-info');
        const realKey = btn.dataset.realKey;
        if (!realKey) return;
        
        document.getElementById('cat-modal-title').innerText = `${realKey} - è©³ç´°ä»‹ç´¹`;
        document.getElementById('cat-modal-body').innerHTML = categoryData[realKey] || "è¼‰å…¥å¤±æ•—";
        document.getElementById('cat-modal').style.display = 'flex';
    }

    function closeCategoryModal(e) {
        if (e.target.id === 'cat-modal') {
            document.getElementById('cat-modal').style.display = 'none';
        }
    }

    // è¼”åŠ©ï¼šæ›´æ–°æŒ‰éˆ•æ¨£å¼
    function updateActiveTag(el, className) {
        document.querySelectorAll('.' + className).forEach(e => e.classList.remove('active'));
        if(el) el.classList.add('active');
    }
</script>
</body>
</html>
